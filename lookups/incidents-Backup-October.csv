AbertoTT,Cidade,Cliente,ClienteId,Estado,Localidade,Servico,Solucao,TipoNegocio,TipoServico,"_key",alert,"alert_close_time","alert_time",app,category,"display_fields",extras,host,impact,"incident_id",index,"job_id",metric,owner,priority,"result_id",search,siebel,status,subcategory,tags,thresholdSeverityCode,title,ttl,urgency
"Não","","","","","N/A","","","","",616f061480a98715a02db004,"OPEN - GENERAL - V3",0,1634665803,"alert_manager","","","{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}",20197443,high,,408,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634665980_2692_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,23,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"20197443 - Edge 408 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",616f072ef96ef44b7a11e3be,"OPEN - GENERAL - V3",0,1634666103,"alert_manager","","","{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}",20197443,medium,,GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666280_2660_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f072ff96ef44b7a11e3c0,"OPEN - GENERAL - V3",0,1634666103,"alert_manager","","","{""edgeId"": ""408"", ""linkId"": ""1184"", ""interface"": ""GE4""}",20197443,medium,"81f1691d-1a65-4ec5-be32-c6cf08a59670",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666280_2660_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f098680a98715a02db030,"OPEN - GENERAL - V3",0,1634666403,"alert_manager","","","{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}",20197443,medium,"a2ea496a-09bd-4370-9245-acdc9509e6fb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666880_2728_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",616f098780a98715a02db032,"OPEN - GENERAL - V3",0,1634666403,"alert_manager","","","{""edgeId"": ""408"", ""linkId"": ""1184"", ""interface"": ""GE4""}",20197443,medium,"ceda5f8a-207c-4637-8b1b-58db58b9372b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666880_2728_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",616f63c780a98715a02db273,"OPEN - GENERAL - V3",0,1634689803,"alert_manager","","","{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}",202187680,high,"132ac232-f1c8-411c-acb5-80eccdef58b7",2081,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634689980_3585_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"202187680 - Edge 2081 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",616f64ee80a98715a02db281,"OPEN - GENERAL - V3",0,1634690103,"alert_manager","","","{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}",202187680,medium,"1e89c5d9-9073-4de4-b371-23cfa259551d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634690280_3599_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202187680 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f6745f96ef44b7a11e6bf,"OPEN - GENERAL - V3",0,1634690404,"alert_manager","","","{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}",202187680,medium,"c9e59c47-79a8-4ba5-999b-123676b4b577",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634690880_3575_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202187680 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617081ae80a98715a02db69e,"OPEN - GENERAL - V3",0,1634762704,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,performance,"199fba0d-914b-4402-8592-7b0c116148f3",4487,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634763180_6134_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,unassigned,critical,0,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""199fba0d-914b-4402-8592-7b0c116148f3"", ""Descricao"": ""__201749053 --- 2021out21/TESTE 6, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",new,"","",4,"null - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",6170b1bcf96ef44b7a11ec02,"OPEN - GENERAL - V3",1634858702,1634775305,"alert_manager","","","{""edgeId"": ""416"", ""linkId"": ""1039"", ""interface"": ""GE4""}",20197423,medium,"9f6e32e8-3244-4a3e-a238-4f44de251afe",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634775480_6531_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197423 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6170b1bdf96ef44b7a11ec04,"OPEN - GENERAL - V3",1634858702,1634775305,"alert_manager","","","{""edgeId"": ""419"", ""linkId"": ""1594"", ""interface"": ""GE4""}",20197428,medium,"240a75ce-6404-423c-aa4d-2b4d7237ef4c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634775480_6531_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197428 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6171468f80a98715a02db82d,"OPEN - GENERAL - V3",1634901303,1634813403,"alert_manager","","","{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",202062017,medium,"23c21e60-a507-431b-9e6f-f4b9de524b74",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634813580_7687_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617148e6f96ef44b7a11ed5d,"OPEN - GENERAL - V3",1634901604,1634813704,"alert_manager","","","{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",202062017,medium,"ca046e66-7b14-4f1e-8dcb-67c4353318d7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634814180_7726_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617148ebf96ef44b7a11ed63,"OPEN - GENERAL - V3",1634907304,1634813704,"alert_manager","","","{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",202062017,performance,"d58a0bea-7d8b-41fb-b7f2-b0047e796fc2",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634814180_7726_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61714c7180a98715a02db843,"OPEN - GENERAL - V3",1634882404,1634814604,"alert_manager","","","{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",202041335,performance,"87ec1633-118b-42ca-a36b-c11ad2f65f90",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634815080_7731_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61715cdaf96ef44b7a11ed9b,"OPEN - GENERAL - V3",1634853902,1634818802,"alert_manager","","","{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",201922181,performance,"c41387e7-07e2-4dbe-ae66-38a676aebfc2",2561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634819280_7892_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922181 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61717578f96ef44b7a11eddc,"OPEN - GENERAL - V3",1634849703,1634825104,"alert_manager","","","{""edgeId"": ""928"", ""linkId"": ""3431"", ""interface"": ""GE4""}",202041324,performance,"048b31c7-0db4-4de7-bc42-c10fa666bdca",3431,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634825580_8084_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041324 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171a90580a98715a02db9a6,"OPEN - GENERAL - V3",1634848803,1634838303,"alert_manager","","","{""edgeId"": ""1575"", ""linkId"": ""4257"", ""interface"": ""GE4""}",202162231,performance,"e4fbdffb-228b-46cd-9595-8f217936b4be",4257,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634838780_8487_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162231 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171a90680a98715a02db9a8,"OPEN - GENERAL - V3",1634848803,1634838303,"alert_manager","","","{""edgeId"": ""1575"", ""linkId"": ""4258"", ""interface"": ""GE3""}",202162231,performance,"59b03a51-de02-4b67-8c33-d12fdaa83320",4258,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634838780_8487_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162231 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa2ef96ef44b7a11ee89,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""1007"", ""linkId"": ""2277"", ""interface"": ""GE4""}",202040671,performance,"25012a26-4225-4ad0-bac2-720c6731db03",2277,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040671 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa2ff96ef44b7a11ee8c,"OPEN - GENERAL - V3",1634849103,1634838632,"alert_manager","","","{""edgeId"": ""1564"", ""linkId"": ""4046"", ""interface"": ""GE3""}",202061987,performance,"24e765cb-d5f6-4275-92ba-ed7bce746ede",4046,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061987 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa34f96ef44b7a11ee93,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""941"", ""linkId"": ""2326"", ""interface"": ""GE3""}",202040625,performance,"8cf65449-b0c0-4ee8-b1ad-20b3aaa4b644",2326,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040625 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa35f96ef44b7a11ee95,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""941"", ""linkId"": ""2327"", ""interface"": ""GE4""}",202040625,performance,"67bb4c60-bec2-4b59-a9dc-54e54f7cac7d",2327,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040625 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa36f96ef44b7a11ee97,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}",202041386,performance,"6b0a26e2-faea-479b-9b43-6f5c48ca2e07",2096,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041386 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa37f96ef44b7a11ee99,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""951"", ""linkId"": ""2097"", ""interface"": ""GE4""}",202041386,performance,"08c147fc-cca7-444f-a4a9-15961604fb0b",2097,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041386 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa38f96ef44b7a11ee9b,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""959"", ""linkId"": ""1876"", ""interface"": ""GE3""}",202040659,performance,"8a7d1a00-c154-49d7-b568-7bfb06f73854",1876,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040659 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa39f96ef44b7a11ee9d,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""959"", ""linkId"": ""2778"", ""interface"": ""GE4""}",202040659,performance,"2d1e09bc-dc5f-4229-8f94-a214b3179b2e",2778,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040659 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa3af96ef44b7a11ee9f,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""979"", ""linkId"": ""3181"", ""interface"": ""GE3""}",202040627,performance,"555c7f84-dca4-44e0-8cab-66e8496a440b",3181,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,19,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040627 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa3bf96ef44b7a11eea1,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""979"", ""linkId"": ""5411"", ""interface"": ""GE4""}",202040627,performance,"dd1eefa9-41c6-46f3-9b37-5546a5e9539f",5411,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,20,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040627 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa3bf96ef44b7a11eea3,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",202041369,performance,"9aff8bfb-a89e-41f8-b73a-92b07cef814d",2121,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,21,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041369 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa3cf96ef44b7a11eea5,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2183"", ""interface"": ""GE3""}",202041375,performance,"4046bc4e-9130-4f6e-b544-3e77b9a5a59e",2183,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,22,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041375 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171aa3df96ef44b7a11eea7,"OPEN - GENERAL - V3",1634849405,1634838632,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}",202041375,performance,"a062f36c-87f6-4721-a2ce-667e7a094f80",2185,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634839080_8510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,23,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041375 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171b4bbf96ef44b7a11eef5,"OPEN - GENERAL - V3",1634849405,1634841303,"alert_manager","","","{""edgeId"": ""1499"", ""linkId"": ""3878"", ""interface"": ""GE3""}",202058771,performance,"580b50d4-6b8d-407d-bd09-d330f4058353",3878,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634841780_8597_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058771 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171b96df96ef44b7a11ef27,"OPEN - GENERAL - V3",1634853302,1634842504,"alert_manager","","","{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}",202061985,performance,"d69a3fb0-7144-4f26-b4c5-b688349ec779",4121,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634842980_8630_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061985 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171bf57f96ef44b7a11ef6e,"OPEN - GENERAL - V3",1634881504,1634844304,"alert_manager","","","{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",20197432,high,"fd41b4f7-8749-4117-abee-540755797b2e",410,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634844480_8674_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,25,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197432 - Edge 410 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6171c0701742d7102602d56d,"OPEN - GENERAL - V3",1634881504,1634844602,"alert_manager","","","{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",20197432,medium,"b79edc02-bdb4-4938-8da1-e9731b64f8b9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634844780_8702_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6171c0711742d7102602d56f,"OPEN - GENERAL - V3",1634881504,1634844602,"alert_manager","","","{""edgeId"": ""410"", ""linkId"": ""969"", ""interface"": ""GE3""}",20197432,medium,"7238591c-c151-4319-91da-b3852e29b37e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634844780_8702_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6171c1b380a98715a02dba41,"OPEN - GENERAL - V3",1634881802,1634844602,"alert_manager","","","{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",20197432,high,"89365279-a019-4ac4-863e-079f944c1e49",410,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634845080_8695_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,27,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197432 - Edge 410 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6171c2c780a98715a02dba45,"OPEN - GENERAL - V3",1634848803,1634845202,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,medium,"0fb091cb-cb04-47cf-bcad-2f1266f70f07",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634845380_8705_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6171c2c980a98715a02dba48,"OPEN - GENERAL - V3",1634881802,1634844904,"alert_manager","","","{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",20197432,medium,"6f32c552-474f-4438-a4d0-5e2df6f66ef5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634845380_8705_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6171c2ca80a98715a02dba4a,"OPEN - GENERAL - V3",1634881802,1634844904,"alert_manager","","","{""edgeId"": ""410"", ""linkId"": ""969"", ""interface"": ""GE3""}",20197432,medium,"05b335dd-9abd-469f-adcd-e750ebf10723",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634845380_8705_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6171c2e080a98715a02dba63,"OPEN - GENERAL - V3",1634848803,1634845202,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,high,"4fe1adaf-e1ef-48f0-a042-24a974fec3c6",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634845380_8705_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,28,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6171c51f80a98715a02dba68,"OPEN - GENERAL - V3",1634849103,1634845504,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,medium,"42a25f95-c265-483f-a0ab-41b9d0b3fcca",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634845980_8725_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6171d0da80a98715a02dbb09,"OPEN - GENERAL - V3",1634849103,1634848803,"alert_manager","","","{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",20197450,medium,"3c7c1bac-2f68-4ade-b0c4-9c3bb45d39a9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634848980_8824_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6171da41f96ef44b7a11eff2,"OPEN - GENERAL - V3",1634852103,1634851203,"alert_manager","","","{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",202040643,high,"f7180a41-d1a8-4a1a-868f-6331686e1e5d",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634851380_8901_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6171dc921742d7102602d606,"OPEN - GENERAL - V3",1634852103,1634851802,"alert_manager","","","{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",202040643,medium,"692f0478-abc3-4a8b-938a-b59da90d3995",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634851980_8927_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6171dc931742d7102602d608,"OPEN - GENERAL - V3",1634852103,1634851802,"alert_manager","","","{""edgeId"": ""980"", ""linkId"": ""3119"", ""interface"": ""GE4""}",202040628,medium,"e0b531e5-87ff-4ca3-9730-da95fd6bb63c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634851980_8927_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040628 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6171dc991742d7102602d610,"OPEN - GENERAL - V3",1634852404,1634851504,"alert_manager","","","{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",202040643,high,"76d84247-9d82-46b5-83e9-f87c14c15aef",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634851980_8927_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6171e274f96ef44b7a11f01a,"OPEN - GENERAL - V3",1634853604,1634853302,"alert_manager","","","{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",202040644,high,"81a8f4a1-26f9-41a0-8b92-8130f1ccf4be",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634853480_8967_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040644 - Edge 918 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6171e39bf96ef44b7a11f023,"OPEN - GENERAL - V3",1634853902,1634853604,"alert_manager","","","{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}",202058022,medium,"e8fc4a2a-2f5a-4385-a103-690c7e168dc3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634853780_8976_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058022 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6171e39cf96ef44b7a11f025,"OPEN - GENERAL - V3",1634853902,1634853604,"alert_manager","","","{""edgeId"": ""512"", ""linkId"": ""2755"", ""interface"": ""SFP2""}",202058023,medium,"51ac6fab-3b06-4248-928a-d7e3657ca45f",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634853780_8976_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058023 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6171f52e1742d7102602d637,"OPEN - GENERAL - V3",1634946002,1634858103,"alert_manager","","","{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",20197450,medium,"b54a8ce5-f61f-49a8-86a4-3db4ae6fa0ba",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634858280_9129_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6171f657f96ef44b7a11f037,"OPEN - GENERAL - V3",1634946002,1634858404,"alert_manager","","","{""edgeId"": ""1319"", ""linkId"": ""3617"", ""interface"": ""GE4""}",202050954,medium,"fe1c08a8-901f-44b5-9708-ef27a89946c1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634858580_9125_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""fe1c08a8-901f-44b5-9708-ef27a89946c1"", ""Descricao"": ""__201749053 --- 2021out22/TESTE 1, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",closed,"","",2,"202050954 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6171f65cf96ef44b7a11f03e,"OPEN - GENERAL - V3",1634880002,1634858103,"alert_manager","","","{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",201912648,performance,"75025bd7-7147-4176-bfc9-4b0c3982afc0",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634858580_9125_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171fc36f96ef44b7a11f053,"OPEN - GENERAL - V3",1634860204,1634859604,"alert_manager","","","{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",202046760,performance,"1544ceff-6c67-4ccf-b656-c2042b584124",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634860080_9175_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6171fc37f96ef44b7a11f056,"OPEN - GENERAL - V3",1634890804,1634859604,"alert_manager","","","{""edgeId"": ""413"", ""linkId"": ""1057"", ""interface"": ""GE3""}",20197427,performance,"6004badd-af0e-4a39-8598-d08aa803b3fc",1057,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634860080_9175_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"20197427 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61721f6180a98715a02dbc28,"OPEN - GENERAL - V3",1634869203,1634868904,"alert_manager","","","{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",202040640,high,"a9f5999f-d93b-4ad4-8502-1734d854f6d1",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634869080_9503_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61722668f96ef44b7a11f0ba,"OPEN - GENERAL - V3",1634898904,1634870703,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,high,"132c85e5-5ed8-47f1-a38f-29fde146c85f",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634870880_9516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202188378 - Edge 2107 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617227901742d7102602d694,"OPEN - GENERAL - V3",1634898904,1634871003,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,medium,"2a6fe2c3-11fe-403f-b321-db4891659ea9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634871180_9530_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617227911742d7102602d696,"OPEN - GENERAL - V3",1634898603,1634871003,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5428"", ""interface"": ""GE4""}",202188378,medium,"e7abf88f-507f-4bdb-8807-f5d27e08c34d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634871180_9530_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617228c2f96ef44b7a11f0c7,"OPEN - GENERAL - V3",1634899202,1634871003,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,high,"5b2ba08a-8625-409d-a01c-a2557a947364",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634871480_9537_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202188378 - Edge 2107 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617229e8f96ef44b7a11f0cd,"OPEN - GENERAL - V3",1634899202,1634871303,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,medium,"10caf9ec-f9b4-44f1-b077-772415388026",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634871780_9549_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617229e9f96ef44b7a11f0cf,"OPEN - GENERAL - V3",1634898904,1634871303,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5428"", ""interface"": ""GE4""}",202188378,medium,"df4719fa-f49e-4da8-b308-46eeff914b2a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634871780_9549_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61722e9b80a98715a02dbc41,"OPEN - GENERAL - V3",1634924402,1634872802,"alert_manager","","","{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",202040640,medium,"33077e9b-eb8d-4d97-8b0c-246ea2ea9203",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634872980_9626_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040640 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617230f380a98715a02dbc4f,"OPEN - GENERAL - V3",1634924704,1634873102,"alert_manager","","","{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",202040640,medium,"06a7010a-794a-4802-9836-f428fd0d1415",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634873580_9644_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040640 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172321b1742d7102602d6ac,"OPEN - GENERAL - V3",1634875802,1634873704,"alert_manager","","","{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",202040637,medium,"61d7904a-e518-480e-9a97-1a774091b4bb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634873880_9622_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617232231742d7102602d6b8,"OPEN - GENERAL - V3",1634874603,1634873704,"alert_manager","","","{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",202059979,high,"868e6c21-faa1-4db8-8e23-6ddcb82520e6",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634873880_9622_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61723346f96ef44b7a11f0fe,"OPEN - GENERAL - V3",1634874603,1634874002,"alert_manager","","","{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",202059979,medium,"ed0a198e-4a33-4f25-a16f-8babdf2e6636",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634874180_9625_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059979 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617235a3f96ef44b7a11f114,"OPEN - GENERAL - V3",1634874904,1634874603,"alert_manager","","","{""edgeId"": ""413"", ""linkId"": ""1057"", ""interface"": ""GE3""}",20197427,medium,"05d791c2-5475-4f9f-8c19-492bf14944c4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634874780_9644_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197427 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61723cab1742d7102602d6d1,"OPEN - GENERAL - V3",1634893204,1634876104,"alert_manager","","","{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",202059979,performance,"28c6212a-d773-4dfd-9673-61126be206e6",3316,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634876580_9711_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202059979 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172415780a98715a02dbc85,"OPEN - GENERAL - V3",1634877903,1634877603,"alert_manager","","","{""edgeId"": ""1582"", ""linkId"": ""4914"", ""interface"": ""GE3""}",202062013,medium,"2b0e5f2e-b7df-4357-9511-ba8e5beb4b1c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634877780_9778_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062013 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172416180a98715a02dbc91,"OPEN - GENERAL - V3",1634877903,1634877603,"alert_manager","","","{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",202059979,high,"140a3c93-11b8-4641-802c-a54534c54b57",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634877780_9778_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617243b980a98715a02dbcaf,"OPEN - GENERAL - V3",1634878503,1634878203,"alert_manager","","","{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",202059979,high,"9fec0ed8-1a6e-4d23-9374-53e92cc781f7",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634878380_9799_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6172498bf96ef44b7a11f167,"OPEN - GENERAL - V3",1634880603,1634879704,"alert_manager","","","{""edgeId"": ""1582"", ""linkId"": ""4914"", ""interface"": ""GE3""}",202062013,medium,"034d366e-f397-4649-b411-a564d212172f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634879880_9807_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062013 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61724991f96ef44b7a11f16e,"OPEN - GENERAL - V3",1634880603,1634879704,"alert_manager","","","{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",202041378,medium,"a28ba1c3-3a09-446e-9329-ff1cf947a46d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634879880_9807_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61726a5d80a98715a02dbd19,"OPEN - GENERAL - V3",1634889603,1634887802,"alert_manager","","","{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",202046760,performance,"68f6f29e-0892-4b38-b6f0-b39e7858e264",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634888280_10135_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172854f80a98715a02dbd49,"OPEN - GENERAL - V3",1634895303,1634895003,"alert_manager","","","{""edgeId"": ""1577"", ""linkId"": ""5068"", ""interface"": ""GE3""}",202185145,medium,"4529cc47-095d-4434-83f5-7a7b9d04291d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634895180_10358_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202185145 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61728c5b80a98715a02dbd58,"OPEN - GENERAL - V3",1634901303,1634896803,"alert_manager","","","{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",202062017,high,"822e9e2f-050a-4878-a1ec-5522509ac2a5",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634896980_10417_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61728fdd1742d7102602d780,"OPEN - GENERAL - V3",1634906703,1634897402,"alert_manager","","","{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",201912648,performance,"4cec6467-6a69-481f-8097-d204de6b7c0b",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634897880_10377_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61729cc3f96ef44b7a11f23e,"OPEN - GENERAL - V3",1634901303,1634901003,"alert_manager","","","{""edgeId"": ""972"", ""linkId"": ""2780"", ""interface"": ""GE4""}",202040640,high,"8453e8ad-c946-4834-a5de-13c9bcc8f5a5",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634901180_10489_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61729dee80a98715a02dbd7a,"OPEN - GENERAL - V3",1634919902,1634901003,"alert_manager","","","{""edgeId"": ""987"", ""linkId"": ""2679"", ""interface"": ""GE4""}",202041370,performance,"380185fe-a0cd-4fe8-a15f-d4e3abccfdc3",2679,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634901480_10573_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041370 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172a29e80a98715a02dbd87,"OPEN - GENERAL - V3",1634962203,1634902204,"alert_manager","","","{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",202041335,performance,"aa7e6948-1898-43db-82e7-0a2d478093fd",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634902680_10615_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172a3cb1742d7102602d7ac,"OPEN - GENERAL - V3",1634916603,1634902803,"alert_manager","","","{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",202040665,high,"057f4f0d-daa2-4494-a844-054ffca7558c",969,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634902980_10530_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040665 - Edge 969 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6172a4f4f96ef44b7a11f249,"OPEN - GENERAL - V3",1634916603,1634903102,"alert_manager","","","{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",202040665,medium,"1b6e5916-1c9a-4bd9-bec6-8ff5a340c0f0",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634903280_10559_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6172a4f5f96ef44b7a11f24b,"OPEN - GENERAL - V3",1634916603,1634903102,"alert_manager","","","{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",202040665,medium,"8f555768-5610-40f9-aa16-8d5c5522647a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634903280_10559_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6172a626f96ef44b7a11f25c,"OPEN - GENERAL - V3",1634903702,1634903404,"alert_manager","","","{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",202061989,high,"6f79c497-2c9a-40aa-b459-0def7d8430d8",1567,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634903580_10569_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202061989 - Edge 1567 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6172a74c1742d7102602d7b2,"OPEN - GENERAL - V3",1634916903,1634903404,"alert_manager","","","{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",202040665,medium,"a07f6484-bf2f-47cd-a980-3a4b375ea08b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634903880_10565_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172a74c1742d7102602d7b4,"OPEN - GENERAL - V3",1634916903,1634903404,"alert_manager","","","{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",202040665,medium,"f26c50cf-e56e-4858-bf45-353e4ec96709",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634903880_10565_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040665 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172aad6f96ef44b7a11f269,"OPEN - GENERAL - V3",1634904903,1634904602,"alert_manager","","","{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",202062017,high,"102483fa-c3dd-4ae1-920f-aed34383312a",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634904780_10605_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6172ac02f96ef44b7a11f276,"OPEN - GENERAL - V3",1634905203,1634904903,"alert_manager","","","{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}",202059974,high,"bbeaed91-3f1f-45c3-9a02-ad74ea600118",1265,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634905080_10615_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059974 - Edge 1265 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6172af82f96ef44b7a11f27f,"OPEN - GENERAL - V3",1634908803,1634905803,"alert_manager","","","{""edgeId"": ""987"", ""linkId"": ""2679"", ""interface"": ""GE4""}",202041370,medium,"a9a01b0f-d0b3-4d16-bab0-27a0f32632b6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634905980_10638_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041370 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172ba0c80a98715a02dbdaf,"OPEN - GENERAL - V3",1634908803,1634908504,"alert_manager","","","{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}",202040644,medium,"6d496935-da3a-40f5-862f-b0f98e8033d7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634908680_10811_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172bd9480a98715a02dbdd1,"OPEN - GENERAL - V3",1634911803,1634909403,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,high,"7542deb5-0555-4cdb-a44f-dcfdc736e7df",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634909580_10840_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6172bebcf96ef44b7a11f2a9,"OPEN - GENERAL - V3",1634911803,1634909704,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,medium,"bc53749a-dc15-45c1-a1d1-f9161a21619e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634909880_10760_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6172bfebf96ef44b7a11f2b9,"OPEN - GENERAL - V3",1634914803,1634909704,"alert_manager","","","{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",202162229,performance,"bd2b2c83-be88-44dc-ab25-07828423671b",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634910180_10768_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172bfedf96ef44b7a11f2bd,"OPEN - GENERAL - V3",1634912104,1634909704,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,high,"d384fd97-90e6-47b7-a04b-7091ff544ba4",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634910180_10768_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6172c114f96ef44b7a11f2c3,"OPEN - GENERAL - V3",1634912104,1634910002,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,medium,"873be4e9-1fdf-4e93-bbe9-8b68d627f9a9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634910480_10779_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172c240f96ef44b7a11f2d1,"OPEN - GENERAL - V3",1634910904,1634910603,"alert_manager","","","{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}",202061985,medium,"ba483d47-27e8-4369-b8d3-7aa59c0f124d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634910780_10787_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061985 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172c36f80a98715a02dbddb,"OPEN - GENERAL - V3",1634915403,1634910603,"alert_manager","","","{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",201922181,performance,"e02c8a58-f9dd-4f9b-84ed-11b3723fb90b",2561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634911080_10888_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922181 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172c81b1742d7102602d80b,"OPEN - GENERAL - V3",1634922904,1634912104,"alert_manager","","","{""edgeId"": ""1580"", ""linkId"": ""5422"", ""interface"": ""GE3""}",202062009,medium,"f65fe3d5-6491-4b9b-b4e0-f8f4e8f40e0f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634912280_10835_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172cba0f96ef44b7a11f2de,"OPEN - GENERAL - V3",1634922603,1634913002,"alert_manager","","","{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",202062009,medium,"974a84e3-eeb2-4e5a-969b-d19d8f2c9151",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634913180_10867_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6172cba8f96ef44b7a11f2e8,"OPEN - GENERAL - V3",1634922603,1634913002,"alert_manager","","","{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",202062009,high,"4ab84089-a219-4b7d-8f51-a1557699bf3a",1580,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634913180_10867_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062009 - Edge 1580 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6172cdf8f96ef44b7a11f2ef,"OPEN - GENERAL - V3",1634922904,1634913303,"alert_manager","","","{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",202062009,medium,"96d3b53a-1aa9-4abe-bcf9-f12446a3d602",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634913780_10887_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062009 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6172e312f96ef44b7a11f336,"OPEN - GENERAL - V3",1634929502,1634918702,"alert_manager","","","{""edgeId"": ""1273"", ""linkId"": ""3200"", ""interface"": ""GE3""}",202040637,performance,"7e0a2146-8e84-42f6-9681-def9d3c66611",3200,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634919180_11066_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040637 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172e313f96ef44b7a11f338,"OPEN - GENERAL - V3",1634929804,1634918702,"alert_manager","","","{""edgeId"": ""914"", ""linkId"": ""2054"", ""interface"": ""GE3""}",202040641,performance,"85909761-09cf-44b2-980b-369c1e8337a1",2054,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634919180_11066_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040641 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172e4401742d7102602d86e,"OPEN - GENERAL - V3",1634929502,1634919003,"alert_manager","","","{""edgeId"": ""914"", ""linkId"": ""2056"", ""interface"": ""GE4""}",202040641,performance,"5871cb77-de74-468b-9196-1f8f3286627d",2056,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634919480_11054_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040641 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172e4421742d7102602d872,"OPEN - GENERAL - V3",1634929502,1634919003,"alert_manager","","","{""edgeId"": ""994"", ""linkId"": ""1991"", ""interface"": ""GE4""}",202041377,performance,"b991bed7-d7fb-4a76-8b45-c7ff0d4ba18d",1991,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634919480_11054_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041377 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6172fe0980a98715a02dbeb2,"OPEN - GENERAL - V3",1634926202,1634925902,"alert_manager","","","{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",202040669,high,"df633734-a21a-4f63-996b-1f978a75706d",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634926080_11401_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040669 - Edge 999 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6173005cf96ef44b7a11f379,"OPEN - GENERAL - V3",1634933702,1634926503,"alert_manager","","","{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",202040669,medium,"729a9535-f310-4f82-8add-b7af9ece3e05",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634926680_11299_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173005df96ef44b7a11f37b,"OPEN - GENERAL - V3",1634933702,1634926503,"alert_manager","","","{""edgeId"": ""999"", ""linkId"": ""2766"", ""interface"": ""GE3""}",202040669,medium,"45831e4b-318f-4c17-bf01-ebc40179f089",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634926680_11299_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61730062f96ef44b7a11f382,"OPEN - GENERAL - V3",1634933702,1634926503,"alert_manager","","","{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",202040669,high,"31106e42-05d3-4cb1-8787-875a13b26e5d",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634926680_11299_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040669 - Edge 999 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617309bb80a98715a02dbee6,"OPEN - GENERAL - V3",1634930702,1634928902,"alert_manager","","","{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}",202046758,medium,"eff236d4-48ad-4ab6-89c7-45097eb1c379",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634929080_11497_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617309bd80a98715a02dbee9,"OPEN - GENERAL - V3",0,1634928902,"alert_manager","","","{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",202061989,medium,"27a8930a-9344-440b-9215-21d57cc5a2aa",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634929080_11497_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202061989 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617309c580a98715a02dbef3,"OPEN - GENERAL - V3",0,1634928902,"alert_manager","","","{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",202061989,high,"0c0f93af-0f3e-4b4b-ad00-e4442e2bd8dd",1567,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634929080_11497_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"202061989 - Edge 1567 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61730aeb1742d7102602d8d8,"OPEN - GENERAL - V3",1634939403,1634928902,"alert_manager","","","{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}",202046758,performance,"283f44e6-3ee7-4db3-825d-8ec204cc85d6",2843,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634929380_11357_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046758 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61730c1480a98715a02dbefa,"OPEN - GENERAL - V3",0,1634929202,"alert_manager","","","{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",202061989,medium,"e42a68cd-4b44-4ae6-8969-6009f2422a5a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634929680_11517_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202061989 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617310c41742d7102602d8f2,"OPEN - GENERAL - V3",1634931003,1634930702,"alert_manager","","","{""edgeId"": ""961"", ""linkId"": ""2195"", ""interface"": ""GE3""}",202040660,medium,"999f5775-5136-4a65-adea-a14c4b92293d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634930880_11404_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040660 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617311eff96ef44b7a11f392,"OPEN - GENERAL - V3",1634934304,1634931003,"alert_manager","","","{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}",202046758,medium,"dbf7b482-beb3-4725-9927-de08f55e6075",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634931180_11448_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202046758 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173132180a98715a02dbf26,"OPEN - GENERAL - V3",1634931602,1634931304,"alert_manager","","","{""edgeId"": ""1007"", ""linkId"": ""2277"", ""interface"": ""GE4""}",202040671,high,"764d0ed8-9c97-45e5-a678-0f861efde3b6",1007,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634931480_11580_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040671 - Edge 1007 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617316a280a98715a02dbf30,"OPEN - GENERAL - V3",1634933102,1634932203,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}",202184561,medium,"f1f61fa5-be74-4ef0-8555-385f30e2831f",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634932380_11612_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617316a280a98715a02dbf32,"OPEN - GENERAL - V3",1634933102,1634932203,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5002"", ""interface"": ""GE2""}",202184561,medium,"8fea2b29-773c-4d60-87bb-46af60249c32",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634932380_11612_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617316a380a98715a02dbf34,"OPEN - GENERAL - V3",1634933102,1634932203,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}",202184561,medium,"fdb0ae58-9930-4022-ac55-69e679dbc08e",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634932380_11612_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617316aa80a98715a02dbf3c,"OPEN - GENERAL - V3",1634951703,1634932203,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}",202184561,high,"34c93bd4-782a-4489-8b36-f8c89268a019",1926,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634932380_11612_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202184561 - Edge 1926 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617318f91742d7102602d90b,"OPEN - GENERAL - V3",1634951703,1634932504,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}",202184561,medium,"b1c16e5b-5981-47c4-a98f-71914e53eba1",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634932980_11473_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617318fa1742d7102602d90d,"OPEN - GENERAL - V3",1634933402,1634932504,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5002"", ""interface"": ""GE2""}",202184561,medium,"494d2b32-a012-4e20-ba07-1cfb47022942",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634932980_11473_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617318fa1742d7102602d90f,"OPEN - GENERAL - V3",1634933402,1634932504,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}",202184561,medium,"e77783ca-b744-4564-890d-5503985f0f1b",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634932980_11473_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61731b57f96ef44b7a11f3c4,"OPEN - GENERAL - V3",1634952003,1634933102,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}",202184561,high,"5e4faaec-b294-4caf-8e30-90dda5e756f0",1926,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634933580_11522_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202184561 - Edge 1926 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61731c7c1742d7102602d91f,"OPEN - GENERAL - V3",1634935503,1634933702,"alert_manager","","","{""edgeId"": ""1563"", ""linkId"": ""4123"", ""interface"": ""GE3""}",202061985,medium,"e4ae482f-6612-4c37-ac66-8082dc557bce",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634933880_11500_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061985 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61731c7f1742d7102602d923,"OPEN - GENERAL - V3",1634951403,1634933702,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5002"", ""interface"": ""GE2""}",202184561,medium,"0bdd3b98-faad-44e4-a682-36d07214849e",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634933880_11500_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61731c801742d7102602d925,"OPEN - GENERAL - V3",1634951103,1634933702,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}",202184561,medium,"8d427b48-5d5c-4464-a1e0-e4cd49ed3c05",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634933880_11500_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61731ed31742d7102602d930,"OPEN - GENERAL - V3",1634935802,1634934003,"alert_manager","","","{""edgeId"": ""1563"", ""linkId"": ""4123"", ""interface"": ""GE3""}",202061985,medium,"557abbc3-b0f6-4df7-8d31-68c5e0652720",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634934480_11522_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061985 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61731ed51742d7102602d934,"OPEN - GENERAL - V3",1634951703,1634934003,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5002"", ""interface"": ""GE2""}",202184561,medium,"ce326ec0-78f3-4dbb-a1cf-7a97e531cfbf",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634934480_11522_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61731ed61742d7102602d936,"OPEN - GENERAL - V3",1634951403,1634934003,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}",202184561,medium,"611c46ca-d693-4d33-95bc-7cd55c586119",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634934480_11522_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61732a9080a98715a02dbf83,"OPEN - GENERAL - V3",1634937603,1634937304,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}",202041375,medium,"f3d62939-2873-4289-b64d-37f329673205",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634937480_11780_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173351f1742d7102602d9a4,"OPEN - GENERAL - V3",1634940303,1634940003,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2183"", ""interface"": ""GE3""}",202041375,high,"ef576bda-efef-41f9-9709-db395ab91ab0",992,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634940180_11702_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041375 - Edge 992 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617341fef96ef44b7a11f43f,"OPEN - GENERAL - V3",1635157804,1634943303,"alert_manager","","","{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",202041369,medium,"6fe1ecdf-f16f-4c91-b6c4-2bfa7f6d8f6a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634943480_11826_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617341fff96ef44b7a11f441,"OPEN - GENERAL - V3",1635158102,1634943303,"alert_manager","","","{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",202041369,medium,"02d9d1eb-1d02-44c4-a404-fca8f1a1632f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634943480_11826_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61734203f96ef44b7a11f447,"OPEN - GENERAL - V3",1635157804,1634943303,"alert_manager","","","{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",202041369,high,"335a6b98-150f-47cd-a6d8-0678717250a9",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634943480_11826_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041369 - Edge 986 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617344561742d7102602d9ca,"OPEN - GENERAL - V3",1635158102,1634943604,"alert_manager","","","{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",202041369,medium,"261c2628-e9c1-45ad-bc3a-faf459e920a7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634944080_11830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617344571742d7102602d9cc,"OPEN - GENERAL - V3",1635158403,1634943604,"alert_manager","","","{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",202041369,medium,"38d61d3a-2c8c-4dcf-bb8e-04039d92066d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634944080_11830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617344581742d7102602d9ce,"OPEN - GENERAL - V3",1634954702,1634943604,"alert_manager","","","{""edgeId"": ""1577"", ""linkId"": ""5068"", ""interface"": ""GE3""}",202185145,performance,"d3f959e6-71b2-4299-87c2-7a2eb5bd07c5",5068,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634944080_11830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202185145 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6173500d80a98715a02dbfff,"OPEN - GENERAL - V3",1635005402,1634946604,"alert_manager","","","{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",201912648,performance,"31d8ea85-fec5-4c1f-bf16-5567410361a1",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634947080_12107_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6173619e1742d7102602da1d,"OPEN - GENERAL - V3",1634955303,1634951403,"alert_manager","","","{""edgeId"": ""982"", ""linkId"": ""2178"", ""interface"": ""GE4""}",202040668,medium,"f4174e37-a7e1-4546-9223-73688be18459",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634951580_12077_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040668 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61737206f96ef44b7a11f49c,"OPEN - GENERAL - V3",1634958303,1634955604,"alert_manager","","","{""edgeId"": ""982"", ""linkId"": ""2178"", ""interface"": ""GE4""}",202040668,medium,"f569c909-b9b5-46da-8530-3e33df641e15",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634955780_12204_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040668 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61738017f96ef44b7a11f4a5,"OPEN - GENERAL - V3",1634959504,1634959203,"alert_manager","","","{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",202183678,medium,"9506f562-4a1e-4e03-a5c1-d08e3c5c231a",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634959380_12325_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617384c780a98715a02dc05a,"OPEN - GENERAL - V3",1634962502,1634960402,"alert_manager","","","{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",202040637,medium,"9c435f52-33ec-4b06-a9bf-ea679ecb5571",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634960580_12540_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61738bd080a98715a02dc061,"OPEN - GENERAL - V3",1634962502,1634962203,"alert_manager","","","{""edgeId"": ""1585"", ""linkId"": ""5242"", ""interface"": ""GE2""}",202062023,medium,"cd70417d-d779-47d6-b7ed-ff24b29a266c",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634962380_12598_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062023 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173a46b1742d7102602da9b,"OPEN - GENERAL - V3",1634968803,1634968503,"alert_manager","","","{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",202040637,medium,"1794010c-95c0-403a-bfab-89b1c0653ffa",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634968680_12637_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173a46c1742d7102602da9d,"OPEN - GENERAL - V3",1634968803,1634968503,"alert_manager","","","{""edgeId"": ""1560"", ""linkId"": ""4016"", ""interface"": ""GE3""}",202061994,medium,"485f9ac1-2c01-4b37-9996-e1d3dcc6a13f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634968680_12637_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061994 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173a7ef80a98715a02dc069,"OPEN - GENERAL - V3",1634980202,1634969103,"alert_manager","","","{""edgeId"": ""1560"", ""linkId"": ""4016"", ""interface"": ""GE3""}",202061994,performance,"3053eee5-6efb-4359-8f01-f9ebf7fbcf04",4016,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634969580_12825_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061994 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6173a7f080a98715a02dc06c,"OPEN - GENERAL - V3",1634986503,1634969403,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,high,"1d73ecaa-a089-4b26-90d1-63cec3c78ac0",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634969580_12825_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202188378 - Edge 2107 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6173a91b80a98715a02dc070,"OPEN - GENERAL - V3",1634986503,1634969704,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,medium,"39e8e92a-b5f8-4ea8-8000-0359896d6955",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634969880_12834_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173a91c80a98715a02dc072,"OPEN - GENERAL - V3",1634986503,1634969704,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5428"", ""interface"": ""GE4""}",202188378,medium,"fce1d743-fbf2-4849-bb24-09930a46f456",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634969880_12834_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173ab73f96ef44b7a11f4d0,"OPEN - GENERAL - V3",1634986803,1634970002,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,medium,"d23c388d-82d8-41e7-8383-39f95ef2d399",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634970480_12686_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173ab74f96ef44b7a11f4d2,"OPEN - GENERAL - V3",1634986803,1634970002,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5428"", ""interface"": ""GE4""}",202188378,medium,"26d91274-a560-4717-9400-02d0feced6a6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634970480_12686_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173aef81742d7102602daae,"OPEN - GENERAL - V3",1634971504,1634971203,"alert_manager","","","{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}",202040644,medium,"10b78df3-cdc7-4f89-96a0-9fa601b90014",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634971380_12722_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040644 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173bab280a98715a02dc0a7,"OPEN - GENERAL - V3",1634989504,1634973903,"alert_manager","","","{""edgeId"": ""987"", ""linkId"": ""2679"", ""interface"": ""GE4""}",202041370,performance,"b0e8890f-ef4c-4266-a532-65b2251b8f31",2679,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634974380_12981_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041370 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6173c1be80a98715a02dc0c3,"OPEN - GENERAL - V3",1634976303,1634976003,"alert_manager","","","{""edgeId"": ""431"", ""linkId"": ""1072"", ""interface"": ""GE4""}",20197442,high,"c6ebf86b-99e9-4604-8192-afdc3046ec79",431,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634976180_13044_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197442 - Edge 431 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6173c53c80a98715a02dc0d1,"OPEN - GENERAL - V3",1634977203,1634976903,"alert_manager","","","{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}",202040638,medium,"510da78d-7cfe-46de-8357-7961bfe994b4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634977080_13074_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040638 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173c667f96ef44b7a11f4ef,"OPEN - GENERAL - V3",1635162302,1634977203,"alert_manager","","","{""edgeId"": ""1003"", ""linkId"": ""2301"", ""interface"": ""GE3""}",202041383,medium,"15c37215-1757-4be7-a32e-a110e77df57d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634977380_12904_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041383 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173c668f96ef44b7a11f4f1,"OPEN - GENERAL - V3",1635162302,1634977203,"alert_manager","","","{""edgeId"": ""1003"", ""linkId"": ""2838"", ""interface"": ""GE4""}",202041383,medium,"a2f8f6dc-e9fe-46d0-86e8-196829f4bbc7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634977380_12904_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041383 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173c66df96ef44b7a11f4f8,"OPEN - GENERAL - V3",1635162302,1634977203,"alert_manager","","","{""edgeId"": ""1003"", ""linkId"": ""2301"", ""interface"": ""GE3""}",202041383,high,"64a4628b-19c3-41a4-a991-58eb33d1b9dc",1003,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634977380_12904_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041383 - Edge 1003 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6173c8be1742d7102602dae7,"OPEN - GENERAL - V3",1635162604,1634977503,"alert_manager","","","{""edgeId"": ""1003"", ""linkId"": ""2301"", ""interface"": ""GE3""}",202041383,medium,"32a530ea-cada-4515-b122-39629a335053",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634977980_12934_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041383 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173c8bf1742d7102602dae9,"OPEN - GENERAL - V3",1635162604,1634977503,"alert_manager","","","{""edgeId"": ""1003"", ""linkId"": ""2838"", ""interface"": ""GE4""}",202041383,medium,"4ee9c71f-7b94-4a2a-9ba7-dee25ea0dcb1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634977980_12934_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041383 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173e60df96ef44b7a11f53f,"OPEN - GENERAL - V3",0,1634985304,"alert_manager","","","{""edgeId"": ""1580"", ""linkId"": ""5422"", ""interface"": ""GE3""}",202062009,medium,"1243009f-d1cd-4d7a-b1c4-a2c074e5c8e9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634985480_13157_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202062009 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173e611f96ef44b7a11f545,"OPEN - GENERAL - V3",1635008104,1634985304,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",202040658,high,"c09d40f8-31d0-4e1c-872d-371ec4499109",958,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634985480_13157_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040658 - Edge 958 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6173e73980a98715a02dc127,"OPEN - GENERAL - V3",1635008104,1634985602,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",202040658,medium,"9b20a92e-43d5-49e2-8792-0fd843128dfc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634985780_13368_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173e73a80a98715a02dc129,"OPEN - GENERAL - V3",1635008104,1634985602,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2231"", ""interface"": ""GE3""}",202040658,medium,"4534c3d8-96e7-4ac9-be0a-a79254b7d926",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634985780_13368_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173e991f96ef44b7a11f54c,"OPEN - GENERAL - V3",1635008402,1634985903,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",202040658,medium,"01d75487-5d50-482d-a4ef-9e7984984aaa",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634986380_13182_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173e992f96ef44b7a11f54e,"OPEN - GENERAL - V3",1635008402,1634985903,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2231"", ""interface"": ""GE3""}",202040658,medium,"11d44d0d-5938-4de2-ad15-36ca27406ef8",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634986380_13182_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173eac380a98715a02dc13b,"OPEN - GENERAL - V3",1635162003,1634986503,"alert_manager","","","{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}",201912633,high,"6d560326-3cb6-4cd1-865f-c40bcf0046de",407,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634986680_13398_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201912633 - Edge 407 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6173ebe980a98715a02dc144,"OPEN - GENERAL - V3",1635162003,1634986803,"alert_manager","","","{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}",201912633,medium,"471b0958-d560-429f-b230-8ce738a5988c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634986980_13407_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201912633 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173ebea80a98715a02dc146,"OPEN - GENERAL - V3",1635162302,1634986803,"alert_manager","","","{""edgeId"": ""407"", ""linkId"": ""1230"", ""interface"": ""GE4""}",201912633,medium,"6c9624eb-7f69-4789-8f57-119f926b3d95",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634986980_13407_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201912633 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173ee41f96ef44b7a11f55a,"OPEN - GENERAL - V3",1635162302,1634987103,"alert_manager","","","{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}",201912633,medium,"212f1bd5-8187-4687-b471-6d46eda91a49",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634987580_13220_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201912633 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173ee42f96ef44b7a11f55c,"OPEN - GENERAL - V3",1635162604,1634987103,"alert_manager","","","{""edgeId"": ""407"", ""linkId"": ""1230"", ""interface"": ""GE4""}",201912633,medium,"b1d28096-6573-4a1b-ada6-d1c0ea8b6b89",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634987580_13220_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201912633 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173f1cd80a98715a02dc16e,"OPEN - GENERAL - V3",1634988902,1634988302,"alert_manager","","","{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",202062017,high,"edce688b-82e6-4eb0-825d-fdd9686916ae",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634988480_13455_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6173f9fd1742d7102602db7b,"OPEN - GENERAL - V3",1634991902,1634990404,"alert_manager","","","{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",201912648,high,"8bd80058-0ab4-4443-8f52-891db10a7998",502,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634990580_13345_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201912648 - Edge 502 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6173fb2580a98715a02dc1a6,"OPEN - GENERAL - V3",1634991902,1634990703,"alert_manager","","","{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",201912648,medium,"3159b1e9-09c5-4e98-b731-dbf4c0eb62f0",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634990880_13537_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201912648 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6173fc551742d7102602db89,"OPEN - GENERAL - V3",1634992204,1634990703,"alert_manager","","","{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",201912648,high,"e4a74561-4d7e-4647-9af8-5be1b94b3912",502,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634991180_13363_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201912648 - Edge 502 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6173fd7df96ef44b7a11f587,"OPEN - GENERAL - V3",1634992204,1634991004,"alert_manager","","","{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",201912648,medium,"f108ab5e-e453-46ff-a396-0016cec30da8",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634991480_13341_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201912648 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617401031742d7102602db94,"OPEN - GENERAL - V3",1635048603,1634991902,"alert_manager","","","{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",202041335,performance,"e8314d7f-d7c0-4b0e-9bc6-c70f5fb73230",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634992380_13403_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6174048980a98715a02dc1c5,"OPEN - GENERAL - V3",0,1634993102,"alert_manager","","","{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",202062017,high,"f79e990c-499d-4bcf-95c6-82ef972f846c",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634993280_13618_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6174048c80a98715a02dc1c9,"OPEN - GENERAL - V3",1634993404,1634993102,"alert_manager","","","{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",202040644,high,"95419ef6-58bf-4f71-8bcd-b18ae117fd57",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634993280_13618_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617405af80a98715a02dc1d0,"OPEN - GENERAL - V3",0,1634993404,"alert_manager","","","{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",202062017,medium,"53fc04fe-53fa-441e-8150-d8e12d48cd02",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634993580_13628_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174080780a98715a02dc1ed,"OPEN - GENERAL - V3",0,1634993703,"alert_manager","","","{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",202062017,medium,"f2a6ba12-686f-4231-aa9b-b40a618e6021",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634994180_13644_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617409391742d7102602dbaf,"OPEN - GENERAL - V3",1634997902,1634994003,"alert_manager","","","{""edgeId"": ""987"", ""linkId"": ""2679"", ""interface"": ""GE4""}",202041370,performance,"d9afd873-5065-4000-9915-010c97bb6758",2679,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634994480_13468_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041370 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61741874f96ef44b7a11f5dc,"OPEN - GENERAL - V3",1634999703,1634998204,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"657372d9-9099-421a-b84b-e9aaf3fc8bb0",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634998380_13563_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61741acaf96ef44b7a11f5e6,"OPEN - GENERAL - V3",1635000003,1634998502,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"d90ba73d-f2d6-47fe-8e2f-a871786e1eaf",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634998980_13581_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61741e4b80a98715a02dc235,"OPEN - GENERAL - V3",1635000003,1634999703,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"c6b136f8-6864-4dfe-9614-c65a4d360cb9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634999880_13827_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617422fe80a98715a02dc241,"OPEN - GENERAL - V3",1635001204,1635000903,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"c23bacb9-c8bb-435c-8ea0-75fc3b1313a8",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635001080_13862_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617427aaf96ef44b7a11f5f7,"OPEN - GENERAL - V3",1635002402,1635002102,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"a6a695c3-a3d1-4b78-a5f5-b616c5ecee73",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635002280_13690_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617427aff96ef44b7a11f5fd,"OPEN - GENERAL - V3",1635003602,1635002102,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"8809848f-69a1-4575-ad9c-da3ac0d9ec09",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635002280_13690_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61742a02f96ef44b7a11f601,"OPEN - GENERAL - V3",1635003302,1635002703,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"a2078022-c7ae-4ef4-ba4c-638ca7443b49",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635002880_13710_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61742a06f96ef44b7a11f607,"OPEN - GENERAL - V3",1635005104,1635002402,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"6e1ab36a-f502-475f-b674-4f3405928d33",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635002880_13710_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61742fdef96ef44b7a11f620,"OPEN - GENERAL - V3",1635005104,1635004202,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"9d76e1a9-aca9-4527-aa0e-47197029754d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635004380_13755_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059977 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617432371742d7102602dc2b,"OPEN - GENERAL - V3",1635005402,1635004502,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"07fc36c1-5959-416b-9826-d5f9a26ec39f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635004980_13817_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61743363f96ef44b7a11f62a,"OPEN - GENERAL - V3",1635033903,1635005104,"alert_manager","","","{""edgeId"": ""416"", ""linkId"": ""961"", ""interface"": ""GE3""}",20197423,medium,"99931a51-a036-486a-9c3f-2f3c67aa9499",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635005280_13782_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197423 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61743815f96ef44b7a11f636,"OPEN - GENERAL - V3",1635006904,1635006304,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"2eb27832-ccfd-4e38-b78c-55cd6fc0e585",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635006480_13824_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61743942f96ef44b7a11f63d,"OPEN - GENERAL - V3",1635007203,1635006603,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,high,"3e7c7288-7cb4-4699-be35-a61aad5619cd",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635006780_13834_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202188378 - Edge 2107 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61743a6cf96ef44b7a11f642,"OPEN - GENERAL - V3",1635007203,1635006904,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,medium,"113d6ba3-abbf-43c1-b4e5-fa2bf99cb1fd",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635007080_13843_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61743a6df96ef44b7a11f644,"OPEN - GENERAL - V3",1635007203,1635006904,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5428"", ""interface"": ""GE4""}",202188378,medium,"08590225-9f2a-443b-aa2f-b2869607ceb9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635007080_13843_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61743b99f96ef44b7a11f64e,"OPEN - GENERAL - V3",1635008104,1635007203,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"46f0a650-48f6-4824-89e9-71b941218ee9",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635007380_13852_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61743cc7f96ef44b7a11f655,"OPEN - GENERAL - V3",1635007803,1635007504,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,high,"0775b6e1-defb-4742-976b-c995fdab18ce",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635007680_13861_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202188378 - Edge 2107 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61743df080a98715a02dc25d,"OPEN - GENERAL - V3",1635056403,1635007504,"alert_manager","","","{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",201912648,performance,"e29450fa-fe45-444a-8ea7-f6365b0fc3f6",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635007980_14092_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61743f1d80a98715a02dc264,"OPEN - GENERAL - V3",1635008402,1635008104,"alert_manager","","","{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}",202040638,medium,"d27bc8fb-362b-4cc5-9eec-4bd77f48e5f0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635008280_14101_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040638 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61744173f96ef44b7a11f659,"OPEN - GENERAL - V3",1635009004,1635008703,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"911e3b69-a474-4a06-b3ab-10d6742f9a28",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635008880_13898_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61744177f96ef44b7a11f65f,"OPEN - GENERAL - V3",1635009004,1635008703,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"66d4bdfb-92a8-4b66-9b5b-3f3f86ad9921",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635008880_13898_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617443ce80a98715a02dc272,"OPEN - GENERAL - V3",1635009603,1635009302,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"b39b78d1-50f1-4626-8b08-aaa1ad978f36",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635009480_14139_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6174475180a98715a02dc281,"OPEN - GENERAL - V3",1635010502,1635010204,"alert_manager","","","{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",20197450,medium,"7b885253-aff0-4968-8588-0ae2410a273f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635010380_14169_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174475480a98715a02dc285,"OPEN - GENERAL - V3",1635010502,1635010204,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"45e44316-7819-4901-b561-de8503ff5b49",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635010380_14169_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617449a91742d7102602dc3b,"OPEN - GENERAL - V3",1635011103,1635010804,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"02f97034-4ada-423a-9ac3-41b122c7ced5",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635010980_14005_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61744c0280a98715a02dc291,"OPEN - GENERAL - V3",1635012602,1635011404,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"c349a0e8-4204-4e0f-9ba2-43f2b0e2b4c0",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635011580_14207_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61744e5780a98715a02dc294,"OPEN - GENERAL - V3",1635012302,1635012004,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"e6228b23-11ae-4486-b68e-d3d79dc33e76",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635012180_14223_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61744e5b80a98715a02dc29a,"OPEN - GENERAL - V3",1635012903,1635011703,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"e4069c48-b1bc-46f1-b877-017ca3b89043",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635012180_14223_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617457ba80a98715a02dc2b6,"OPEN - GENERAL - V3",1635014702,1635014403,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"20aec59b-5076-47d9-87a5-7a3622fe2bb7",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635014580_14305_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617458e61742d7102602dc42,"OPEN - GENERAL - V3",1635030003,1635014403,"alert_manager","","","{""edgeId"": ""987"", ""linkId"": ""2679"", ""interface"": ""GE4""}",202041370,performance,"1ab43727-6970-43cb-a282-36adfbdf3057",2679,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635014880_14129_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041370 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6174611c80a98715a02dc2d0,"OPEN - GENERAL - V3",1635017703,1635016803,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"438e6a80-4ab4-41d0-8e4c-26dd3cdcee3a",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635016980_14384_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6174624380a98715a02dc2d3,"OPEN - GENERAL - V3",1635017403,1635017103,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"3be748d5-8cc7-4e97-a70a-4b0a11f9f739",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635017280_14393_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174649d80a98715a02dc2de,"OPEN - GENERAL - V3",1635021003,1635017703,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}",202041375,medium,"0803baac-5f25-417a-a739-f411470503a3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635017880_14412_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6174695080a98715a02dc2f1,"OPEN - GENERAL - V3",1635019203,1635018903,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"263341df-a560-4001-9926-95304938fce0",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635019080_14449_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61746ba8f96ef44b7a11f690,"OPEN - GENERAL - V3",1635021602,1635019503,"alert_manager","","","{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}",202059974,high,"b8c5a786-2795-4018-87a8-484b3bcccfd3",1265,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635019680_14238_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059974 - Edge 1265 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61746cce1742d7102602dc65,"OPEN - GENERAL - V3",1635021602,1635019803,"alert_manager","","","{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}",202059974,medium,"a4243ca9-7a64-4044-9747-07d4aeaa4b4f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635019980_14303_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059974 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61746dfdf96ef44b7a11f696,"OPEN - GENERAL - V3",1635022203,1635020103,"alert_manager","","","{""edgeId"": ""461"", ""linkId"": ""2395"", ""interface"": ""GE1""}",202058025,medium,"5e9a71b3-2922-4aa9-9fec-2b5f00b8e216",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635020280_14258_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058025 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61746dfef96ef44b7a11f698,"OPEN - GENERAL - V3",1635022203,1635020103,"alert_manager","","","{""edgeId"": ""461"", ""linkId"": ""2408"", ""interface"": ""GE2""}",202058025,medium,"adf7a518-469c-4ee7-b3ec-e4ce3659eeef",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635020280_14258_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058025 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61746e02f96ef44b7a11f69e,"OPEN - GENERAL - V3",1635021904,1635019803,"alert_manager","","","{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}",202059974,high,"ca5644ef-1a26-450c-a8ea-8a3daa89a867",1265,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635020280_14258_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059974 - Edge 1265 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61746f27f96ef44b7a11f6a1,"OPEN - GENERAL - V3",1635023103,1635020403,"alert_manager","","","{""edgeId"": ""1006"", ""linkId"": ""2256"", ""interface"": ""GE4""}",202041385,medium,"3bb2e5ed-3549-48e5-8634-71851a9def85",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635020580_14273_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041385 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61746f28f96ef44b7a11f6a3,"OPEN - GENERAL - V3",1635021904,1635020103,"alert_manager","","","{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}",202059974,medium,"0a3c9988-54a7-40ad-b882-e294a72c2454",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635020580_14273_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059974 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6174717ff96ef44b7a11f6af,"OPEN - GENERAL - V3",1635023404,1635020703,"alert_manager","","","{""edgeId"": ""1006"", ""linkId"": ""2256"", ""interface"": ""GE4""}",202041385,medium,"b3c892dc-2f2b-4422-84ad-12c2f094b7b9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635021180_14289_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6174763480a98715a02dc305,"OPEN - GENERAL - V3",1635036002,1635022203,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",202041365,high,"4874f019-23ae-4190-a501-15e66ff9c20f",981,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635022380_14559_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041365 - Edge 981 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6174775c1742d7102602dc87,"OPEN - GENERAL - V3",1635036002,1635022504,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",202041365,medium,"ecb7a28b-43cc-4bfb-abda-ca39f5070902",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635022680_14385_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041365 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174775d1742d7102602dc89,"OPEN - GENERAL - V3",1635052504,1635022504,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1889"", ""interface"": ""GE4""}",202041365,medium,"d6a4c458-61c1-46f5-b0f8-4b96953063e0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635022680_14385_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041365 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174775e1742d7102602dc8b,"OPEN - GENERAL - V3",1635033003,1635022203,"alert_manager","","","{""edgeId"": ""1499"", ""linkId"": ""3878"", ""interface"": ""GE3""}",202058771,performance,"804ea589-3229-49a3-9992-0bf290895f78",3878,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635022680_14385_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058771 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617477601742d7102602dc8f,"OPEN - GENERAL - V3",1635033003,1635022203,"alert_manager","","","{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}",202041386,performance,"2e18d815-68c1-4679-95aa-1ed01a70474b",2096,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635022680_14385_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041386 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617477611742d7102602dc91,"OPEN - GENERAL - V3",1635033003,1635022203,"alert_manager","","","{""edgeId"": ""951"", ""linkId"": ""2097"", ""interface"": ""GE4""}",202041386,performance,"08f1af25-f778-4f1b-97e6-e8e4d568a820",2097,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635022680_14385_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041386 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617479b580a98715a02dc30b,"OPEN - GENERAL - V3",1635036303,1635022805,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",202041365,medium,"bef34bd2-362f-43b8-87ab-1c9738bb59df",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635023280_14588_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041365 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617479b680a98715a02dc30d,"OPEN - GENERAL - V3",1635052802,1635022805,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1889"", ""interface"": ""GE4""}",202041365,medium,"34b79f4a-0c42-41ea-af93-25dbfcb758a5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635023280_14588_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041365 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61747ae61742d7102602dca1,"OPEN - GENERAL - V3",1635025202,1635023404,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,high,"6ece9858-d22f-40e9-a3a6-9c0a92188320",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635023580_14415_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61747c0b80a98715a02dc318,"OPEN - GENERAL - V3",1635025503,1635023702,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"5f21fed0-b4a7-4051-8836-695e4ff3711c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635023880_14608_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61747e621742d7102602dca6,"OPEN - GENERAL - V3",1635159303,1635024302,"alert_manager","","","{""edgeId"": ""1008"", ""linkId"": ""2042"", ""interface"": ""GE3""}",202040629,medium,"4786f812-c499-44a4-92a1-191f3a5b886e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635024480_14440_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040629 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61747e631742d7102602dca8,"OPEN - GENERAL - V3",1635159604,1635024302,"alert_manager","","","{""edgeId"": ""1008"", ""linkId"": ""2044"", ""interface"": ""GE4""}",202040629,medium,"ffc5f4d3-2ff3-4a11-b2c9-ab21ae0aa52f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635024480_14440_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040629 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61747e641742d7102602dcaa,"OPEN - GENERAL - V3",1635025802,1635024003,"alert_manager","","","{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",202059977,medium,"9171732a-82a7-4db6-bbdf-f1d11febcc6d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635024480_14440_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61747e6c1742d7102602dcb6,"OPEN - GENERAL - V3",1635159303,1635024302,"alert_manager","","","{""edgeId"": ""1008"", ""linkId"": ""2042"", ""interface"": ""GE3""}",202040629,high,"10eacc5d-dd8e-4adf-864e-1b998777787d",1008,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635024480_14440_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040629 - Edge 1008 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617480bbf96ef44b7a11f6e1,"OPEN - GENERAL - V3",1635159604,1635024602,"alert_manager","","","{""edgeId"": ""1008"", ""linkId"": ""2042"", ""interface"": ""GE3""}",202040629,medium,"eacd4e73-b90b-4adf-8205-4bc798929737",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635025080_14417_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040629 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617480bcf96ef44b7a11f6e3,"OPEN - GENERAL - V3",1635159902,1635024602,"alert_manager","","","{""edgeId"": ""1008"", ""linkId"": ""2044"", ""interface"": ""GE4""}",202040629,medium,"a297b239-c14e-41fe-9665-5950b7075735",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635025080_14417_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040629 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617486971742d7102602dd03,"OPEN - GENERAL - V3",1635027004,1635026403,"alert_manager","","","{""edgeId"": ""1006"", ""linkId"": ""2256"", ""interface"": ""GE4""}",202041385,medium,"95a3e480-1ab1-45b8-b94e-10464b126e56",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635026580_14509_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041385 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61748c8080a98715a02dc36a,"OPEN - GENERAL - V3",1635028202,1635027903,"alert_manager","","","{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}",202059974,high,"87f87b00-ea6e-4a70-b151-ed40577b8549",1265,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635028080_14748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059974 - Edge 1265 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617494abf96ef44b7a11f751,"OPEN - GENERAL - V3",1635078002,1635030003,"alert_manager","","","{""edgeId"": ""989"", ""linkId"": ""2244"", ""interface"": ""GE4""}",202041372,medium,"502e2165-5fd8-4cfa-a20e-15b10fd8f4e9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635030180_14581_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041372 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6174b0ca80a98715a02dc40c,"OPEN - GENERAL - V3",1635037504,1635037203,"alert_manager","","","{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",202040640,high,"0da1bc53-3ae2-48d4-8b5a-2103fb70d4ac",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635037380_15048_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6174b322f96ef44b7a11f7a8,"OPEN - GENERAL - V3",1635038104,1635037803,"alert_manager","","","{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",202040640,high,"9efb9b3c-5741-430f-a5c1-bd6b484f6e80",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635037980_14832_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174b7d21742d7102602dd92,"OPEN - GENERAL - V3",1635039302,1635039002,"alert_manager","","","{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",202059976,high,"b54bac7c-4ece-4509-aacb-0ad50d933f99",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635039180_14914_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059976 - Edge 1269 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174b7d31742d7102602dd94,"OPEN - GENERAL - V3",1635039302,1635039002,"alert_manager","","","{""edgeId"": ""1295"", ""linkId"": ""3248"", ""interface"": ""GE1""}",202059972,high,"40ebd151-18c9-4ce7-88ca-827528322963",1295,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635039180_14914_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059972 - Edge 1295 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174b7d31742d7102602dd96,"OPEN - GENERAL - V3",1635039302,1635039002,"alert_manager","","","{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",202040640,high,"7ab72f06-739c-4f73-a38f-98364d78589b",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635039180_14914_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174b7d51742d7102602dd99,"OPEN - GENERAL - V3",1635039302,1635039002,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",202041365,high,"c7e34440-091e-49fa-ad82-b4cc622e737c",981,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635039180_14914_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041365 - Edge 981 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174c004f96ef44b7a11f7b7,"OPEN - GENERAL - V3",1635041403,1635041104,"alert_manager","","","{""edgeId"": ""980"", ""linkId"": ""3119"", ""interface"": ""GE4""}",202040628,medium,"ac2d103f-b53c-4f3e-9f15-87bbe2fe6175",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635041280_14942_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040628 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174c25b80a98715a02dc429,"OPEN - GENERAL - V3",1635042003,1635041704,"alert_manager","","","{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",202059976,medium,"d2f70b4b-0fce-4932-ac70-8120a09522b3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635041880_15191_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059976 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174c25d80a98715a02dc42c,"OPEN - GENERAL - V3",1635042003,1635041704,"alert_manager","","","{""edgeId"": ""980"", ""linkId"": ""3119"", ""interface"": ""GE4""}",202040628,medium,"6bafa36d-cde9-44ff-baa8-290c97b8a910",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635041880_15191_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040628 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174c26180a98715a02dc431,"OPEN - GENERAL - V3",1635042003,1635041704,"alert_manager","","","{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",202059976,high,"c0865e07-3799-45f2-8d55-f8a07f7935e8",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635041880_15191_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059976 - Edge 1269 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174c4b780a98715a02dc438,"OPEN - GENERAL - V3",1635084902,1635042304,"alert_manager","","","{""edgeId"": ""1733"", ""linkId"": ""4285"", ""interface"": ""GE3""}",202060096,high,"dfaa3c55-5fad-4703-a31e-1dd6e3f3cff3",1733,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635042480_15212_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202060096 - Edge 1733 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6174c5df1742d7102602ddac,"OPEN - GENERAL - V3",1635084902,1635042602,"alert_manager","","","{""edgeId"": ""1733"", ""linkId"": ""4285"", ""interface"": ""GE3""}",202060096,medium,"3b19ab3f-f1aa-4d95-87a4-4e6d7edf53a2",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635042780_15033_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202060096 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174c5e01742d7102602ddae,"OPEN - GENERAL - V3",1635084902,1635042602,"alert_manager","","","{""edgeId"": ""1733"", ""linkId"": ""4286"", ""interface"": ""GE4""}",202060096,medium,"82d2a13b-239c-4d9f-a96c-a59053f8373d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635042780_15033_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202060096 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174c5e31742d7102602ddb3,"OPEN - GENERAL - V3",1635043203,1635042602,"alert_manager","","","{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",202059976,high,"7db43943-cc1c-4ba2-ad3e-f461f84ceb71",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635042780_15033_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059976 - Edge 1269 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174c8371742d7102602ddc3,"OPEN - GENERAL - V3",1635085204,1635042903,"alert_manager","","","{""edgeId"": ""1733"", ""linkId"": ""4285"", ""interface"": ""GE3""}",202060096,medium,"ec6ad397-1236-480e-a477-b580daf30eed",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635043380_15053_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202060096 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6174c8381742d7102602ddc5,"OPEN - GENERAL - V3",1635085204,1635042903,"alert_manager","","","{""edgeId"": ""1733"", ""linkId"": ""4286"", ""interface"": ""GE4""}",202060096,medium,"32682f90-637a-49c4-8a48-6415e1fb4220",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635043380_15053_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202060096 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6174c96580a98715a02dc43f,"OPEN - GENERAL - V3",1635043802,1635043504,"alert_manager","","","{""edgeId"": ""980"", ""linkId"": ""2477"", ""interface"": ""GE3""}",202040628,medium,"a8275efe-2f18-4eee-9ccb-e8999976a398",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635043680_15248_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040628 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6174dd5380a98715a02dc48c,"OPEN - GENERAL - V3",1635048904,1635048603,"alert_manager","","","{""edgeId"": ""1568"", ""linkId"": ""4268"", ""interface"": ""GE4""}",202061992,high,"38b1aca7-c793-4c03-8ea0-ddb10620d982",1568,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635048780_15409_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202061992 - Edge 1568 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174e58380a98715a02dc492,"OPEN - GENERAL - V3",1635051003,1635050704,"alert_manager","","","{""edgeId"": ""1572"", ""linkId"": ""4562"", ""interface"": ""GE3""}",202061999,medium,"9fcb65b5-23f2-4a6b-a047-319ff5fe9644",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635050880_15474_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061999 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174f2681742d7102602de40,"OPEN - GENERAL - V3",1635098703,1635054003,"alert_manager","","","{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}",202040664,medium,"cd9457f8-91f4-4efd-86d0-e1ab13ea7e81",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635054180_15410_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040664 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6174f26d1742d7102602de46,"OPEN - GENERAL - V3",1635054304,1635054003,"alert_manager","","","{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",202041378,high,"f36fc293-d354-4a44-a4e7-b8bd1ea81e01",995,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635054180_15410_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041378 - Edge 995 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174f8451742d7102602de53,"OPEN - GENERAL - V3",1635055802,1635055503,"alert_manager","","","{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",202041378,high,"cd5a8244-e82c-4cd2-b774-5b56a6f4499b",995,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635055680_15462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041378 - Edge 995 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6174fa9af96ef44b7a11f81c,"OPEN - GENERAL - V3",1635058203,1635056102,"alert_manager","","","{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",202040637,medium,"90865655-9d7f-44bd-8ab0-cba5ea310804",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635056280_15406_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61750c31f96ef44b7a11f842,"OPEN - GENERAL - V3",1635071402,1635060604,"alert_manager","","","{""edgeId"": ""1295"", ""linkId"": ""3248"", ""interface"": ""GE1""}",202059972,high,"f027844c-61e7-4f3f-a1a9-376e1766c533",1295,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635060780_15554_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059972 - Edge 1295 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61750c32f96ef44b7a11f844,"OPEN - GENERAL - V3",1635071402,1635060604,"alert_manager","","","{""edgeId"": ""977"", ""linkId"": ""2156"", ""interface"": ""GE4""}",202041363,high,"9ce45bcf-366a-4d82-9205-62573cfee673",977,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635060780_15554_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041363 - Edge 977 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61750c34f96ef44b7a11f847,"OPEN - GENERAL - V3",1635071402,1635060604,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",202041365,high,"27f093b1-e05f-442b-b7c9-bd1fd89f7ed3",981,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635060780_15554_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041365 - Edge 981 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61750d5af96ef44b7a11f84b,"OPEN - GENERAL - V3",1635071702,1635060902,"alert_manager","","","{""edgeId"": ""1295"", ""linkId"": ""3248"", ""interface"": ""GE1""}",202059972,medium,"8b3df2d2-f6ef-4d84-9952-3fcaf66aabe0",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061080_15566_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059972 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61750d5df96ef44b7a11f84f,"OPEN - GENERAL - V3",1635071702,1635060902,"alert_manager","","","{""edgeId"": ""977"", ""linkId"": ""2156"", ""interface"": ""GE4""}",202041363,medium,"ecafc16f-b8b5-477b-8a81-112b5149ac6e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061080_15566_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041363 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61750d5ef96ef44b7a11f851,"OPEN - GENERAL - V3",1635071702,1635060902,"alert_manager","","","{""edgeId"": ""977"", ""linkId"": ""2158"", ""interface"": ""GE3""}",202041363,medium,"b116cf4e-9b14-4698-901a-8f55669ed54d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061080_15566_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041363 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61750d5ef96ef44b7a11f853,"OPEN - GENERAL - V3",1635071402,1635060902,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",202041365,medium,"5073649e-d2cc-4ce3-a690-6d430fdd83ba",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061080_15566_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041365 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61750d5ff96ef44b7a11f855,"OPEN - GENERAL - V3",1635077702,1635060902,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1889"", ""interface"": ""GE4""}",202041365,medium,"35983c38-3025-4fae-b372-2bd1b45074a5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061080_15566_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041365 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61750fb3f96ef44b7a11f86c,"OPEN - GENERAL - V3",1635072004,1635061203,"alert_manager","","","{""edgeId"": ""1295"", ""linkId"": ""3248"", ""interface"": ""GE1""}",202059972,medium,"39fc2d40-7bcf-44a9-aa19-55ca9a4386c7",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061680_15585_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059972 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61750fb6f96ef44b7a11f870,"OPEN - GENERAL - V3",1635072004,1635061203,"alert_manager","","","{""edgeId"": ""977"", ""linkId"": ""2156"", ""interface"": ""GE4""}",202041363,medium,"1be6aa2f-1b42-4c41-be1d-3ab9043625cb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061680_15585_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041363 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61750fb7f96ef44b7a11f872,"OPEN - GENERAL - V3",1635072004,1635061203,"alert_manager","","","{""edgeId"": ""977"", ""linkId"": ""2158"", ""interface"": ""GE3""}",202041363,medium,"865326bf-3620-496b-ab7d-3584cdd479f8",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061680_15585_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041363 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61750fb7f96ef44b7a11f874,"OPEN - GENERAL - V3",1635071702,1635061203,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",202041365,medium,"490439f7-3b90-4aa1-92f5-56fb70e6cc6b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061680_15585_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041365 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61750fb8f96ef44b7a11f876,"OPEN - GENERAL - V3",1635078002,1635061203,"alert_manager","","","{""edgeId"": ""981"", ""linkId"": ""1889"", ""interface"": ""GE4""}",202041365,medium,"c756d7ab-29da-42bd-b85e-ef50d3d36336",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635061680_15585_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041365 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175214e1742d7102602dec0,"OPEN - GENERAL - V3",1635066304,1635066003,"alert_manager","","","{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",202040640,high,"e18e7f10-27ff-494d-920c-b3af67ef1afa",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635066180_15794_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61752aa8f96ef44b7a11f8d5,"OPEN - GENERAL - V3",1635069002,1635068403,"alert_manager","","","{""edgeId"": ""947"", ""linkId"": ""3254"", ""interface"": ""GE4""}",202040650,medium,"ffd8c1df-aa5e-4707-bc36-b0de87ad720e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635068580_15809_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040650 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61752d07f96ef44b7a11f8fb,"OPEN - GENERAL - V3",1635069604,1635069002,"alert_manager","","","{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",202040643,high,"9a671139-1c31-4924-8bb7-6243d87d8a1b",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635069180_15831_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61752e2c1742d7102602df02,"OPEN - GENERAL - V3",1635069604,1635069303,"alert_manager","","","{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",202040643,medium,"9c25e2c2-3cd0-4d05-9984-755c3f8af139",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635069480_15904_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61752e2c1742d7102602df04,"OPEN - GENERAL - V3",1635069604,1635069303,"alert_manager","","","{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",202040643,medium,"66a26dc4-1e1c-4d03-b8c0-86699d0044d3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635069480_15904_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617532e380a98715a02dc519,"OPEN - GENERAL - V3",1635090602,1635070502,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",202040658,high,"aa80b0e6-add1-48ba-9f16-cf86b24efec9",958,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635070680_16120_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040658 - Edge 958 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61753409f96ef44b7a11f913,"OPEN - GENERAL - V3",1635090602,1635070802,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",202040658,medium,"72d0acd7-9fd1-4d66-9e0d-eb510231b63c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635070980_15888_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6175340af96ef44b7a11f915,"OPEN - GENERAL - V3",1635090602,1635070802,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2231"", ""interface"": ""GE3""}",202040658,medium,"4eb94098-5ccd-4f7d-bbcb-804b9968e077",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635070980_15888_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617536601742d7102602df44,"OPEN - GENERAL - V3",1635090903,1635071104,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",202040658,medium,"01b0d197-01a6-4790-84b4-3ae4242eb3c0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635071580_15980_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617536611742d7102602df46,"OPEN - GENERAL - V3",1635090903,1635071104,"alert_manager","","","{""edgeId"": ""958"", ""linkId"": ""2231"", ""interface"": ""GE3""}",202040658,medium,"b2be8f7b-bbf9-4991-8e69-071719d010bb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635071580_15980_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617540f080a98715a02dc54b,"OPEN - GENERAL - V3",0,1635073804,"alert_manager","","","{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",201912648,performance,"7957407c-fc7b-419f-aea0-8ad14916541c",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635074280_16235_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6175434380a98715a02dc55a,"OPEN - GENERAL - V3",1635075602,1635074702,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,medium,"45b59329-a543-406f-870d-b5f2eba4a5ca",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635074880_16252_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6175434980a98715a02dc563,"OPEN - GENERAL - V3",1635075602,1635074702,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,high,"f5c62c2e-6ad1-4249-99d7-a0c5959b1ef3",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635074880_16252_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6175459af96ef44b7a11f937,"OPEN - GENERAL - V3",1635075903,1635075003,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,medium,"3df13ef2-7f6d-4a18-a7a0-6ce19a0a2f8d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635075480_16034_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61754b7d80a98715a02dc599,"OPEN - GENERAL - V3",1635131702,1635076502,"alert_manager","","","{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",202041335,performance,"1e5e6c0d-2679-4a27-aebb-90b3b13e4a11",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635076980_16323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61754b7e80a98715a02dc59b,"OPEN - GENERAL - V3",1635080703,1635076502,"alert_manager","","","{""edgeId"": ""987"", ""linkId"": ""2679"", ""interface"": ""GE4""}",202041370,performance,"2fa328b2-2173-442d-bc9a-2a04edd09582",2679,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635076980_16323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041370 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61754ca41742d7102602df63,"OPEN - GENERAL - V3",1635077402,1635077102,"alert_manager","","","{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",202062011,medium,"3ad36564-c0d9-4aa5-8f80-6cc9b711fb27",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635077280_16159_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062011 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61754cab1742d7102602df6d,"OPEN - GENERAL - V3",1635077402,1635077102,"alert_manager","","","{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",null,high,"c1cf3c67-7de1-4d9c-8fd9-70a7a404e748",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635077280_16159_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61755e37f96ef44b7a11f976,"OPEN - GENERAL - V3",1635084302,1635081603,"alert_manager","","","{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}",202058022,medium,"20f4dd3e-b833-430b-9eef-27150768a148",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635081780_16225_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058022 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61755e38f96ef44b7a11f978,"OPEN - GENERAL - V3",1635081902,1635081603,"alert_manager","","","{""edgeId"": ""512"", ""linkId"": ""1148"", ""interface"": ""GE1""}",202058023,medium,"42ccb0ad-347b-47bc-8105-67947b49263d",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635081780_16225_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058023 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61755e39f96ef44b7a11f97a,"OPEN - GENERAL - V3",1635084603,1635081603,"alert_manager","","","{""edgeId"": ""512"", ""linkId"": ""2755"", ""interface"": ""SFP2""}",202058023,medium,"1d0a3339-eac6-431e-9d78-c324073f2a60",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635081780_16225_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058023 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61755e3ef96ef44b7a11f981,"OPEN - GENERAL - V3",1635081902,1635081603,"alert_manager","","","{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",202059976,high,"fc90770b-5e08-4edb-9c45-0561ddd5fa1b",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635081780_16225_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059976 - Edge 1269 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61755f63f96ef44b7a11f986,"OPEN - GENERAL - V3",1635082202,1635081902,"alert_manager","","","{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}",202059974,medium,"091a66c8-799e-4365-8d82-85dbc41bf749",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635082080_16236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059974 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61755f6af96ef44b7a11f990,"OPEN - GENERAL - V3",1635082202,1635081902,"alert_manager","","","{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}",202059974,high,"d17e0edd-79d7-4381-b25a-a52a7a7849f5",1265,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635082080_16236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059974 - Edge 1265 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6175608f80a98715a02dc5f2,"OPEN - GENERAL - V3",1635084603,1635081902,"alert_manager","","","{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}",202058022,medium,"e440f53d-71d4-41a5-9ca4-bfdb9fd4ee49",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635082380_16505_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058022 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175609080a98715a02dc5f4,"OPEN - GENERAL - V3",1635099604,1635082202,"alert_manager","","","{""edgeId"": ""461"", ""linkId"": ""2407"", ""interface"": ""GE2""}",202058025,medium,"c89b2811-4b7e-45cd-9bbe-389d7321b8de",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635082380_16505_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058025 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175666ff96ef44b7a11f99a,"OPEN - GENERAL - V3",1635094204,1635083402,"alert_manager","","","{""edgeId"": ""1570"", ""linkId"": ""4451"", ""interface"": ""GE3""}",202061996,performance,"ab85726f-d780-4421-835a-2c2c3ab76fc2",4451,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635083880_16286_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202061996 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6175679880a98715a02dc608,"OPEN - GENERAL - V3",1635098104,1635084004,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}",202184561,medium,"e558d7b5-2ef8-4e5a-9b16-ca7df8149095",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635084180_16569_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6175679980a98715a02dc60a,"OPEN - GENERAL - V3",1635097802,1635084004,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5002"", ""interface"": ""GE2""}",202184561,medium,"ecdd2350-7de1-429f-819d-6253ed7cd02a",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635084180_16569_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6175679a80a98715a02dc60c,"OPEN - GENERAL - V3",1635097203,1635084004,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}",202184561,medium,"79dfcddd-3d85-4c21-b8d0-7ec136b5b5f9",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635084180_16569_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617567a180a98715a02dc615,"OPEN - GENERAL - V3",1635098104,1635084004,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}",202184561,high,"2a21386f-7278-46af-9f8a-25fb19f97972",1926,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635084180_16569_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202184561 - Edge 1926 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617568c780a98715a02dc61f,"OPEN - GENERAL - V3",1635084603,1635084302,"alert_manager","","","{""edgeId"": ""512"", ""linkId"": ""1178"", ""interface"": ""GE2""}",202058023,medium,"294808f5-b86c-4ba1-bf40-c548af425959",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635084480_16578_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058023 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617569ef1742d7102602df9f,"OPEN - GENERAL - V3",1635098402,1635084302,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}",202184561,medium,"4db105d8-67db-45c7-866b-7ad91a8946c3",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635084780_16399_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617569f01742d7102602dfa1,"OPEN - GENERAL - V3",1635098104,1635084302,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5002"", ""interface"": ""GE2""}",202184561,medium,"5c1d07eb-e916-4a3b-9ca7-454b99cd62b7",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635084780_16399_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617569f11742d7102602dfa3,"OPEN - GENERAL - V3",1635097504,1635084302,"alert_manager","","","{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}",202184561,medium,"bfbd38d8-afa9-421b-b849-6c709258642b",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635084780_16399_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61756d76f96ef44b7a11f9b1,"OPEN - GENERAL - V3",1635085804,1635085502,"alert_manager","","","{""edgeId"": ""467"", ""linkId"": ""1628"", ""interface"": ""GE3""}",202058101,medium,"fcec546d-4908-4257-a312-82eda2d3e5a0",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635085680_16347_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058101 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617575aa1742d7102602dfd9,"OPEN - GENERAL - V3",1635088203,1635087603,"alert_manager","","","{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",20197432,medium,"27abc8a5-0d12-4935-879d-50bc1d575372",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635087780_16491_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617575ab1742d7102602dfdb,"OPEN - GENERAL - V3",1635088203,1635087603,"alert_manager","","","{""edgeId"": ""410"", ""linkId"": ""969"", ""interface"": ""GE3""}",20197432,medium,"ba33d58a-7c58-4057-8e3c-fbdec7de14e5",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635087780_16491_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197432 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617575b11742d7102602dfe5,"OPEN - GENERAL - V3",1635088203,1635087603,"alert_manager","","","{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",20197432,high,"04376dc9-3bf8-4d8d-83d1-cc9243f23ca2",410,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635087780_16491_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197432 - Edge 410 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61757a61f96ef44b7a11f9f2,"OPEN - GENERAL - V3",1635089102,1635088802,"alert_manager","","","{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}",202058022,high,"b475c4ba-8b33-485a-b69b-20ef6a02d691",458,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635088980_16453_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202058022 - Edge 458 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617584e61742d7102602e007,"OPEN - GENERAL - V3",1635091803,1635091503,"alert_manager","","","{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",20197447,medium,"1043695b-5504-4255-bda7-376733120183",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635091680_16623_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61758e451742d7102602e030,"OPEN - GENERAL - V3",1635094204,1635093903,"alert_manager","","","{""edgeId"": ""418"", ""linkId"": ""1043"", ""interface"": ""GE4""}",20197426,medium,"58dce51f-2ca0-4b84-9b5c-6411076b9c66",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635094080_16697_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197426 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175909ff96ef44b7a11fa2e,"OPEN - GENERAL - V3",1635094803,1635094502,"alert_manager","","","{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",20197450,medium,"a09b4891-d56a-4986-b491-9e5eae686da9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635094680_16636_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617596781742d7102602e03d,"OPEN - GENERAL - V3",1635096302,1635096003,"alert_manager","","","{""edgeId"": ""953"", ""linkId"": ""1867"", ""interface"": ""GE3""}",202040654,medium,"2d04bcdf-6c37-4283-b9af-1e6b8aff02f5",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635096180_16765_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040654 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61759d7ff96ef44b7a11fa50,"OPEN - GENERAL - V3",1635116103,1635097802,"alert_manager","","","{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",202062009,medium,"14ba054e-eb8c-466c-ac4e-637796981548",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635097980_16739_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61759d84f96ef44b7a11fa57,"OPEN - GENERAL - V3",1635116103,1635097802,"alert_manager","","","{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",202062009,high,"9b7f0f47-fe49-48a3-b421-58e937da3ca7",1580,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635097980_16739_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062009 - Edge 1580 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61759d86f96ef44b7a11fa5a,"OPEN - GENERAL - V3",1635101403,1635097802,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2183"", ""interface"": ""GE3""}",202041375,high,"677f6f3f-c6ed-46b9-86fe-21f2809cfee2",992,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635097980_16739_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041375 - Edge 992 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61759eab1742d7102602e056,"OPEN - GENERAL - V3",0,1635097802,"alert_manager","","","{""edgeId"": ""1580"", ""linkId"": ""5422"", ""interface"": ""GE3""}",202062009,medium,"b992479b-b21f-4125-bfe3-d19c191cba2b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635098280_16830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202062009 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61759ead1742d7102602e05a,"OPEN - GENERAL - V3",1635101403,1635098104,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2183"", ""interface"": ""GE3""}",202041375,medium,"2f479547-f943-4753-95e5-ff74c41e4ce0",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635098280_16830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61759eae1742d7102602e05c,"OPEN - GENERAL - V3",1635106502,1635098104,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}",202041375,medium,"2f4070e4-f714-4395-8c5d-074cd4d486ae",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635098280_16830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61759fd780a98715a02dc6e5,"OPEN - GENERAL - V3",1635116404,1635098104,"alert_manager","","","{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",202062009,medium,"862f5afc-d57f-4e97-a310-4d0d97d0d597",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635098580_17040_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175a105f96ef44b7a11fa61,"OPEN - GENERAL - V3",1635101703,1635098402,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2183"", ""interface"": ""GE3""}",202041375,medium,"f38f3a37-6cc0-4c93-9056-be6d66e64be9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635098880_16768_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041375 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175a106f96ef44b7a11fa63,"OPEN - GENERAL - V3",1635106802,1635098402,"alert_manager","","","{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}",202041375,medium,"c0f06cd2-ff64-4e0f-9238-522b48139431",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635098880_16768_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175a23280a98715a02dc6f6,"OPEN - GENERAL - V3",1635105902,1635099004,"alert_manager","","","{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}",202040664,medium,"f2ecb7bb-10d4-42e9-a880-3ee9b1d7fe89",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635099180_17060_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040664 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6175a4881742d7102602e067,"OPEN - GENERAL - V3",0,1635099604,"alert_manager","","","{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",202188378,medium,"a4e92e55-0c8d-412b-b72c-82cd5ff591c6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635099780_16879_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202188378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175a4891742d7102602e069,"OPEN - GENERAL - V3",1635106202,1635099302,"alert_manager","","","{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}",202040664,medium,"a63f5174-5193-47ff-b5f5-190d10d2b92e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635099780_16879_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040664 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175acba1742d7102602e081,"OPEN - GENERAL - V3",1635102004,1635101703,"alert_manager","","","{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",201922181,medium,"77fa6599-7c54-4ab2-81d1-671f1225cd0f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635101880_16942_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201922181 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6175b3c3f96ef44b7a11fa9d,"OPEN - GENERAL - V3",1635159604,1635103502,"alert_manager","","","{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",201922181,medium,"eda5c1f7-ae9b-4691-876f-eff2ce756022",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635103680_16926_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"201922181 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6175b3c9f96ef44b7a11faa6,"OPEN - GENERAL - V3",1635159604,1635103502,"alert_manager","","","{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",201922181,high,"26752bc8-111a-4cf0-8a3d-37c2095477d9",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635103680_16926_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"201922181 - Edge 1105 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6175b61a80a98715a02dc73b,"OPEN - GENERAL - V3",1635159902,1635103804,"alert_manager","","","{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",201922181,medium,"768ada88-5afc-495a-be86-e068a902cd58",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635104280_17228_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201922181 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175bf7f80a98715a02dc74c,"OPEN - GENERAL - V3",1635107403,1635106502,"alert_manager","","","{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}",202040664,medium,"c93b8af4-e692-4501-8145-c84b579beff4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635106680_17306_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040664 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6175f0b3f96ef44b7a11fb2f,"OPEN - GENERAL - V3",1635119404,1635119102,"alert_manager","","","{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}",202040644,medium,"8fdcbf6c-90db-470d-8bf0-d5f499ec7587",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635119280_17420_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6176256e1742d7102602e145,"OPEN - GENERAL - V3",1635132902,1635132604,"alert_manager","","","{""edgeId"": ""972"", ""linkId"": ""2780"", ""interface"": ""GE4""}",202040640,medium,"feaacd47-9213-4f70-b4f8-4f6bbb4c0fd6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635132780_17937_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040640 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61762ecf1742d7102602e14c,"OPEN - GENERAL - V3",1635135603,1635134702,"alert_manager","","","{""edgeId"": ""1564"", ""linkId"": ""4046"", ""interface"": ""GE3""}",202061987,performance,"898e5e3f-1b1a-4e4d-a9c3-308c28d32e98",4046,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635135180_18018_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061987 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6176395b80a98715a02dc7d4,"OPEN - GENERAL - V3",1635138002,1635137702,"alert_manager","","","{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",202183678,medium,"a50d493d-f649-4017-8a72-8437c25418ab",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635137880_18311_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617678a3f96ef44b7a11fb92,"OPEN - GENERAL - V3",1635163803,1635153604,"alert_manager","","","{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",202046760,performance,"c2daabb9-efac-437e-97db-55a7af1e4549",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635154080_18562_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61767facf96ef44b7a11fb9b,"OPEN - GENERAL - V3",1635156302,1635155703,"alert_manager","","","{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",202040643,high,"c7d1baca-6488-4328-9126-b170d068703a",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635155880_18622_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617680d71742d7102602e180,"OPEN - GENERAL - V3",1635156302,1635156004,"alert_manager","","","{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",202040643,medium,"49e5ec7e-4f75-4c4c-ad5a-641c3606918a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635156180_18697_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617680d71742d7102602e182,"OPEN - GENERAL - V3",1635156302,1635156004,"alert_manager","","","{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",202040643,medium,"878f5fcc-d18f-40c2-8fd5-7e7f57bca66d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635156180_18697_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617680da1742d7102602e186,"OPEN - GENERAL - V3",1635156302,1635156004,"alert_manager","","","{""edgeId"": ""1007"", ""linkId"": ""2277"", ""interface"": ""GE4""}",202040671,high,"28325ae8-6bb0-4f25-878e-9149f74103a4",1007,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635156180_18697_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040671 - Edge 1007 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617687def96ef44b7a11fba5,"OPEN - GENERAL - V3",1635158102,1635157804,"alert_manager","","","{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",202040637,medium,"b1fe9783-7874-478d-8dbe-39024dceb481",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635157980_18690_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61768c91f96ef44b7a11fbaf,"OPEN - GENERAL - V3",0,1635158704,"alert_manager","","","{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",202041335,performance,"00eafcdb-c8b2-4e4a-b9a5-96fc8725695c",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635159180_18734_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61768dba1742d7102602e18f,"OPEN - GENERAL - V3",0,1635159303,"alert_manager","","","{""edgeId"": ""1004"", ""linkId"": ""1978"", ""interface"": ""GE3""}",202041384,medium,"60ab77c3-3a41-4acd-b00f-c17b2d3cfa87",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635159480_18798_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202041384 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617695f280a98715a02dc817,"OPEN - GENERAL - V3",1635161704,1635161403,"alert_manager","","","{""edgeId"": ""1295"", ""linkId"": ""3248"", ""interface"": ""GE1""}",202059972,high,"b7303a9c-eee1-47b1-8fb6-3379050d500f",1295,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635161580_19064_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059972 - Edge 1295 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61769bcb1742d7102602e1a5,"OPEN - GENERAL - V3",1635163204,1635162902,"alert_manager","","","{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}",202046758,medium,"21af38a3-5a64-427b-a0d4-65a89eaf17eb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635163080_18913_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61769e23f96ef44b7a11fbcc,"OPEN - GENERAL - V3",1635163803,1635163502,"alert_manager","","","{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}",202046758,medium,"0b9e88c6-9611-4ac4-915c-ebd27001cb22",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635163680_18885_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61769f50f96ef44b7a11fbd3,"OPEN - GENERAL - V3",0,1635163803,"alert_manager","","","{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",202040637,medium,"47f8df48-c87f-41ea-95e8-0fefd99072ba",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635163980_18893_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
