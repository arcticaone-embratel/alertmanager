AbertoTT,Cidade,Cliente,ClienteId,Estado,Localidade,Servico,Solucao,TipoNegocio,TipoServico,"_key",alert,"alert_close_time","alert_time",app,category,"display_fields","external_reference_id",extras,"group_id",host,impact,"incident_id",index,"job_id",metric,owner,"preserve_owner",priority,"result_id",search,siebel,status,subcategory,tags,thresholdSeverityCode,title,ttl,urgency
"Não","","","","","N/A","","","","",616f061480a98715a02db004,"OPEN - GENERAL - V3",0,1634665803,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}",,20197443,high,,408,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634665980_2692_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,23,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"20197443 - Edge 408 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",616f072ef96ef44b7a11e3be,"OPEN - GENERAL - V3",0,1634666103,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}",,20197443,medium,,GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666280_2660_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f072ff96ef44b7a11e3c0,"OPEN - GENERAL - V3",0,1634666103,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1184"", ""interface"": ""GE4""}",,20197443,medium,"81f1691d-1a65-4ec5-be32-c6cf08a59670",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666280_2660_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f098680a98715a02db030,"OPEN - GENERAL - V3",0,1634666403,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}",,20197443,medium,"a2ea496a-09bd-4370-9245-acdc9509e6fb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666880_2728_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",616f098780a98715a02db032,"OPEN - GENERAL - V3",0,1634666403,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1184"", ""interface"": ""GE4""}",,20197443,medium,"ceda5f8a-207c-4637-8b1b-58db58b9372b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666880_2728_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",616f63c780a98715a02db273,"OPEN - GENERAL - V3",0,1634689803,"alert_manager","","",,"{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}",,202187680,high,"132ac232-f1c8-411c-acb5-80eccdef58b7",2081,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634689980_3585_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"202187680 - Edge 2081 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",616f64ee80a98715a02db281,"OPEN - GENERAL - V3",0,1634690103,"alert_manager","","",,"{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}",,202187680,medium,"1e89c5d9-9073-4de4-b371-23cfa259551d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634690280_3599_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202187680 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f6745f96ef44b7a11e6bf,"OPEN - GENERAL - V3",0,1634690404,"alert_manager","","",,"{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}",,202187680,medium,"c9e59c47-79a8-4ba5-999b-123676b4b577",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634690880_3575_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202187680 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617081ae80a98715a02db69e,"OPEN - GENERAL - V3",0,1634762704,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,null,performance,"199fba0d-914b-4402-8592-7b0c116148f3",4487,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634763180_6134_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,unassigned,,critical,0,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""199fba0d-914b-4402-8592-7b0c116148f3"", ""Descricao"": ""__201749053 --- 2021out21/TESTE 6, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",new,"","",4,"null - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617309bd80a98715a02dbee9,"OPEN - GENERAL - V3",1635174904,1634928902,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",,202061989,medium,"27a8930a-9344-440b-9215-21d57cc5a2aa",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634929080_11497_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061989 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617309c580a98715a02dbef3,"OPEN - GENERAL - V3",1635174904,1634928902,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",,202061989,high,"0c0f93af-0f3e-4b4b-ad00-e4442e2bd8dd",1567,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634929080_11497_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202061989 - Edge 1567 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61730c1480a98715a02dbefa,"OPEN - GENERAL - V3",1635175202,1634929202,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}",,202061989,medium,"e42a68cd-4b44-4ae6-8969-6009f2422a5a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634929680_11517_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061989 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6173e60df96ef44b7a11f53f,"OPEN - GENERAL - V3",1635448805,1634985304,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""5422"", ""interface"": ""GE3""}",,202062009,medium,"1243009f-d1cd-4d7a-b1c4-a2c074e5c8e9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634985480_13157_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062009 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6174048980a98715a02dc1c5,"OPEN - GENERAL - V3",1635191402,1634993102,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"f79e990c-499d-4bcf-95c6-82ef972f846c",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634993280_13618_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617405af80a98715a02dc1d0,"OPEN - GENERAL - V3",1635191402,1634993404,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"53fc04fe-53fa-441e-8150-d8e12d48cd02",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634993580_13628_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6174080780a98715a02dc1ed,"OPEN - GENERAL - V3",1635191702,1634993703,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"f2a6ba12-686f-4231-aa9b-b40a618e6021",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634994180_13644_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617540f080a98715a02dc54b,"OPEN - GENERAL - V3",1635169803,1635073804,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"7957407c-fc7b-419f-aea0-8ad14916541c",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635074280_16235_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61759eab1742d7102602e056,"OPEN - GENERAL - V3",1635449103,1635097802,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""5422"", ""interface"": ""GE3""}",,202062009,medium,"b992479b-b21f-4125-bfe3-d19c191cba2b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635098280_16830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6175a4881742d7102602e067,"OPEN - GENERAL - V3",1635167704,1635099604,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",,202188378,medium,"a4e92e55-0c8d-412b-b72c-82cd5ff591c6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635099780_16879_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61768c91f96ef44b7a11fbaf,"OPEN - GENERAL - V3",1635221703,1635158704,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",,202041335,performance,"00eafcdb-c8b2-4e4a-b9a5-96fc8725695c",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635159180_18734_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61768dba1742d7102602e18f,"OPEN - GENERAL - V3",1635166804,1635159303,"alert_manager","","",,"{""edgeId"": ""1004"", ""linkId"": ""1978"", ""interface"": ""GE3""}",,202041384,medium,"60ab77c3-3a41-4acd-b00f-c17b2d3cfa87",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635159480_18798_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041384 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61769f50f96ef44b7a11fbd3,"OPEN - GENERAL - V3",1635166204,1635163803,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"47f8df48-c87f-41ea-95e8-0fefd99072ba",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635163980_18893_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6176a8af80a98715a02dc825,"OPEN - GENERAL - V3",1635166503,1635166204,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}",,202040655,medium,"18363d2b-21b7-4ce9-b2c6-8a49df0b2314",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635166380_19224_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040655 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6176a9dd80a98715a02dc82d,"OPEN - GENERAL - V3",1635166804,1635166503,"alert_manager","","",,"{""edgeId"": ""1004"", ""linkId"": ""1978"", ""interface"": ""GE3""}",,202041384,high,"3ef70abc-78f4-4aae-b168-e8b10123f452",1004,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635166680_19234_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041384 - Edge 1004 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6176b7ebf96ef44b7a11fbf5,"OPEN - GENERAL - V3",1635170702,1635170103,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,medium,"b972319d-4a6c-4165-817a-2da8f52e42ca",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635170280_19101_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040643 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6176b7ecf96ef44b7a11fbf7,"OPEN - GENERAL - V3",1635170702,1635170103,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",,202040643,medium,"d5d9350a-cec8-49a5-a9f4-9f5ace738feb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635170280_19101_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040643 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6176b7edf96ef44b7a11fbf9,"OPEN - GENERAL - V3",1635179104,1635169803,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,202162229,performance,"e6d4548c-5d8a-4a0c-a7c1-f2bb98e66029",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635170280_19101_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6176b7eef96ef44b7a11fbfc,"OPEN - GENERAL - V3",1635170702,1635170103,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"ea86383d-5c21-42d8-9846-b9b48aeb23d9",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635170280_19101_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6176ba431742d7102602e1c2,"OPEN - GENERAL - V3",1635172802,1635170702,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}",,202059973,medium,"3c8234bf-80c7-4f85-a9ae-50299d3c754e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635170880_19162_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059973 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6176ba451742d7102602e1c6,"OPEN - GENERAL - V3",1635172802,1635170702,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}",,202059973,high,"6d4c6e50-0210-4385-a873-db10715d10c9",1264,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635170880_19162_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059973 - Edge 1264 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6176bb7280a98715a02dc845,"OPEN - GENERAL - V3",1635171303,1635171003,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"d3511249-f84d-414d-8d02-b65d3dd75e84",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635171180_19375_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6176bc9a1742d7102602e1c9,"OPEN - GENERAL - V3",1635173103,1635171003,"alert_manager","","",,"{""edgeId"": ""1264"", ""linkId"": ""3443"", ""interface"": ""GE3""}",,202059973,medium,"4fcf7b79-e575-4e30-a879-4f89d6e3509f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635171480_19182_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059973 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6176c02080a98715a02dc84a,"OPEN - GENERAL - V3",1635174302,1635172203,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2326"", ""interface"": ""GE3""}",,202040625,medium,"6e8bbc8a-2eff-4ccd-959b-317043eed849",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635172380_19404_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040625 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6176c02180a98715a02dc84c,"OPEN - GENERAL - V3",1635174302,1635172203,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2327"", ""interface"": ""GE4""}",,202040625,medium,"40d20e5c-e9b4-4b2f-a668-8f6619d7b9ed",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635172380_19404_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040625 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6176c02280a98715a02dc84e,"OPEN - GENERAL - V3",1635199502,1635171902,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,201922181,performance,"9550afee-1a8a-4e2a-bc88-92b933913d7f",2561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635172380_19404_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922181 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6176c02680a98715a02dc853,"OPEN - GENERAL - V3",1635174663,1635172203,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2326"", ""interface"": ""GE3""}",,202040625,high,"0a68e0a1-068f-46bf-b092-b2cca244da8f",941,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635172380_19404_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040625 - Edge 941 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6176c2771742d7102602e1cf,"OPEN - GENERAL - V3",1635174663,1635172502,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2326"", ""interface"": ""GE3""}",,202040625,medium,"23be2489-2b5a-46fa-a292-8481ba403bf9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635172980_19237_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040625 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6176c2781742d7102602e1d1,"OPEN - GENERAL - V3",1635174663,1635172502,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2327"", ""interface"": ""GE4""}",,202040625,medium,"2d75987a-6c97-46ab-8e43-c5adffca982b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635172980_19237_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040625 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6176cbd980a98715a02dc877,"OPEN - GENERAL - V3",1635185403,1635174904,"alert_manager","","",,"{""edgeId"": ""622"", ""linkId"": ""1418"", ""interface"": ""GE3""}",,201922763,performance,"05f9c295-3bca-4865-a25a-eabc8a6886d6",1418,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635175380_19501_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922763 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6176cf5b1742d7102602e1e7,"OPEN - GENERAL - V3",1635176402,1635176104,"alert_manager","","",,"{""edgeId"": ""1560"", ""linkId"": ""4016"", ""interface"": ""GE3""}",,202061994,medium,"4988b79b-285e-4b76-adc6-621d9c3b6f78",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635176280_19340_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061994 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6176d1b61742d7102602e1f2,"OPEN - GENERAL - V3",1635179703,1635176402,"alert_manager","","",,"{""edgeId"": ""978"", ""linkId"": ""3207"", ""interface"": ""GE4""}",,202041364,performance,"f2835e9c-b58d-4085-bd72-f8cf4433962b",3207,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635176880_19362_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041364 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6176de9780a98715a02dc8a1,"OPEN - GENERAL - V3",1635180302,1635180004,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""5242"", ""interface"": ""GE2""}",,202062023,medium,"ea6adb7a-4cd6-4482-8c8f-5eebf5206215",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635180180_19668_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062023 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6176edd5f96ef44b7a11fc36,"OPEN - GENERAL - V3",1635184204,1635183903,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2148"", ""interface"": ""GE3""}",,202040640,high,"c295a24e-808d-484d-8d52-7da5c203c907",972,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635184080_19544_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040640 - Edge 972 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61770fcff96ef44b7a11fc67,"OPEN - GENERAL - V3",1635192904,1635192602,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"6c566afa-7de7-45de-9fc5-aa683c07bac8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635192780_19816_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61770fd1f96ef44b7a11fc6b,"OPEN - GENERAL - V3",1635192904,1635192602,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"4bd698fc-532a-4d7c-8cf7-4dc70b5589ca",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635192780_19816_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617715acf96ef44b7a11fc72,"OPEN - GENERAL - V3",1635204604,1635193803,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4560"", ""interface"": ""GE4""}",,202061999,performance,"d13d4fe6-fd59-4a10-be8a-e98a2b9602db",4560,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635194280_19871_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202061999 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617716d680a98715a02dc8e0,"OPEN - GENERAL - V3",1635204902,1635194104,"alert_manager","","",,"{""edgeId"": ""1003"", ""linkId"": ""2301"", ""interface"": ""GE3""}",,202041383,performance,"3ed5123b-74c2-4f3d-9024-bba4db15bcc8",2301,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635194580_20135_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041383 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617716d780a98715a02dc8e2,"OPEN - GENERAL - V3",1635204902,1635194104,"alert_manager","","",,"{""edgeId"": ""1003"", ""linkId"": ""2838"", ""interface"": ""GE4""}",,202041383,performance,"40f7915a-e9e8-4826-80df-297a9e3c8915",2838,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635194580_20135_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041383 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617716da80a98715a02dc8e6,"OPEN - GENERAL - V3",1635204604,1635194104,"alert_manager","","",,"{""edgeId"": ""1575"", ""linkId"": ""4257"", ""interface"": ""GE4""}",,202162231,performance,"6a6bd2d9-fc85-4042-8469-1d239a77a303",4257,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635194580_20135_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162231 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617716db80a98715a02dc8e8,"OPEN - GENERAL - V3",1635204604,1635194104,"alert_manager","","",,"{""edgeId"": ""1575"", ""linkId"": ""4258"", ""interface"": ""GE3""}",,202162231,performance,"f2b87e41-3525-443d-8e6b-4746bd0bcd85",4258,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635194580_20135_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162231 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617716dc80a98715a02dc8eb,"OPEN - GENERAL - V3",1635204902,1635194104,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2183"", ""interface"": ""GE3""}",,202041375,performance,"d88b3b93-9803-4988-b007-f22c278c4b74",2183,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635194580_20135_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041375 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617716dd80a98715a02dc8ed,"OPEN - GENERAL - V3",1635204902,1635194104,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}",,202041375,performance,"dfe0542e-dc0e-4bb1-8e19-225a8374e9db",2185,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635194580_20135_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041375 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617734251742d7102602e25f,"OPEN - GENERAL - V3",1635215404,1635201603,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4562"", ""interface"": ""GE3""}",,202061999,performance,"fc5406bd-aa44-4481-b01c-fb8d29bb8e81",4562,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635202080_20152_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061999 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61773b30f96ef44b7a11fcde,"OPEN - GENERAL - V3",1635220203,1635203402,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"09794cf8-03fd-490f-a5f1-8a3708a9fec7",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635203880_20178_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61773fdc80a98715a02dc977,"OPEN - GENERAL - V3",1635215404,1635204604,"alert_manager","","",,"{""edgeId"": ""1577"", ""linkId"": ""5068"", ""interface"": ""GE3""}",,202185145,performance,"deef6d79-f65e-4338-9a36-822279e3229b",5068,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635205080_20498_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202185145 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61774a671742d7102602e27c,"OPEN - GENERAL - V3",1635216902,1635207304,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""5301"", ""interface"": ""GE3""}",,202062005,performance,"99858e49-3021-4f0a-a193-96e7f2223650",5301,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635207780_20326_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062005 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6177529a1742d7102602e29a,"OPEN - GENERAL - V3",1635210002,1635209704,"alert_manager","","",,"{""edgeId"": ""1564"", ""linkId"": ""4046"", ""interface"": ""GE3""}",,202061987,medium,"f635b103-8b1d-4916-af8f-6b1b65c3965c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635209880_20393_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061987 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6177529f1742d7102602e2a1,"OPEN - GENERAL - V3",1635244203,1635209704,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,202041369,high,"309d689d-2d1a-446c-b5cb-8e323df8aafc",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635209880_20393_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041369 - Edge 986 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617753c880a98715a02dc991,"OPEN - GENERAL - V3",1635244203,1635210002,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,202041369,medium,"d292abb7-9308-4998-a4e1-907867c35504",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635210180_20661_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617753c880a98715a02dc993,"OPEN - GENERAL - V3",1635244502,1635210002,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",,202041369,medium,"4db18c2d-ebb0-4f6e-b8f1-c3620b0c4cdd",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635210180_20661_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617754f81742d7102602e2ac,"OPEN - GENERAL - V3",1635244502,1635210002,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,202041369,high,"e30951b7-d604-4d86-8030-539380752a4b",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635210480_20412_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041369 - Edge 986 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6177561f1742d7102602e2b0,"OPEN - GENERAL - V3",1635244502,1635210302,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}",,202041369,medium,"86c7c4de-e793-466d-a3a4-d687102d44d4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635210780_20419_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617756201742d7102602e2b2,"OPEN - GENERAL - V3",1635244802,1635210302,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}",,202041369,medium,"a82c6555-2ebd-409e-88ef-107b7da74605",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635210780_20419_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041369 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61776689f96ef44b7a11fd2e,"OPEN - GENERAL - V3",1635226803,1635214502,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"cef7abba-87e9-496d-ae8b-acde5a359967",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635214980_20543_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6177805180a98715a02dc9f8,"OPEN - GENERAL - V3",1635228903,1635221103,"alert_manager","","",,"{""edgeId"": ""1564"", ""linkId"": ""4046"", ""interface"": ""GE3""}",,202061987,performance,"83d95e8b-3bbf-4878-8845-c7baffb26af8",4046,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635221580_21030_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061987 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617782a8f96ef44b7a11fd77,"OPEN - GENERAL - V3",1635222903,1635222003,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,high,"db0d10ee-7f78-48fc-8369-d215db89809d",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635222180_20778_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059976 - Edge 1269 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617783d380a98715a02dca01,"OPEN - GENERAL - V3",1635222903,1635222303,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,medium,"f23229a1-a8cc-44e0-9ac6-a8a694c00b24",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635222480_21058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059976 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617790b980a98715a02dca15,"OPEN - GENERAL - V3",1635225903,1635225603,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,202040644,high,"c8a7ec47-e9e7-4182-b669-0abc400b49d9",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635225780_21159_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617791e280a98715a02dca19,"OPEN - GENERAL - V3",1635227403,1635225903,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""4011"", ""interface"": ""GE3""}",,202046760,medium,"fbb07534-7333-4191-a945-de5cfb6305bd",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635226080_21171_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046760 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617797c0f96ef44b7a11fd94,"OPEN - GENERAL - V3",1635227703,1635227403,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,high,"0a37c239-c917-4f7c-9ca9-a409047b506b",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635227580_20958_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059976 - Edge 1269 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6177a3761742d7102602e339,"OPEN - GENERAL - V3",1635231002,1635230403,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}",,202041375,medium,"1001b801-b3a1-4039-96d0-c013380f4334",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635230580_21051_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6177a6fbf96ef44b7a11fd9b,"OPEN - GENERAL - V3",1635231603,1635231303,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"4d96bb84-3179-479d-85ba-5527a5d0c36c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635231480_21089_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6177a953f96ef44b7a11fd9e,"OPEN - GENERAL - V3",1635232202,1635231902,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,high,"f9289757-7d5c-4fbe-b326-79c43d4d9d1d",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635232080_21106_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059976 - Edge 1269 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6177ae021742d7102602e33f,"OPEN - GENERAL - V3",1635233703,1635233103,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3331"", ""interface"": ""GE4""}",,202041335,medium,"f56e36e2-54e8-437c-8849-07cd7e373e6d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635233280_21140_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041335 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6177ae031742d7102602e341,"OPEN - GENERAL - V3",1635233703,1635233103,"alert_manager","","",,"{""edgeId"": ""919"", ""linkId"": ""1958"", ""interface"": ""GE3""}",,202040645,high,"6a5c5290-7d88-44f7-9bdb-d0c4e741ed12",919,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635233280_21140_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040645 - Edge 919 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6177c0c21742d7102602e34e,"OPEN - GENERAL - V3",1635238202,1635237904,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}",,null,medium,"865ebe9c-92f3-43f3-9f1d-1d040637b41d",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635238080_21292_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6177cfff80a98715a02dca33,"OPEN - GENERAL - V3",1635242103,1635241803,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}",,null,medium,"b8412ea7-8ef8-4be9-b8e4-c0719ed3ab02",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635241980_21687_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6177d383f96ef44b7a11fdaa,"OPEN - GENERAL - V3",1635246902,1635242402,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"a68c404c-19be-43ab-a0a6-833f414c1174",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635242880_21451_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6177dce380a98715a02dca3d,"OPEN - GENERAL - V3",1635250804,1635244802,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"2ef3cb33-d4a4-4f7a-85ca-2b72d4d8bf66",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635245280_21792_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6177eaf4f96ef44b7a11fdbe,"OPEN - GENERAL - V3",1635310803,1635248402,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",,202041335,performance,"409222c1-6fa4-48e6-b379-43ee34b71c27",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635248880_21638_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6177f0cf1742d7102602e364,"OPEN - GENERAL - V3",1635250503,1635250203,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"7030c4b5-ba50-4219-ae58-f6b7910c8068",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635250380_21702_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6177f57f80a98715a02dca4e,"OPEN - GENERAL - V3",1635252903,1635251103,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"fa0a9b32-561a-4c7f-bc07-545d5a72e9b8",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635251580_21990_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617802631742d7102602e370,"OPEN - GENERAL - V3",1635289205,1635254403,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,201922181,performance,"a9109e71-d0cb-46ad-aab4-bae36507ce1a",2561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635254880_21851_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922181 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617802651742d7102602e373,"OPEN - GENERAL - V3",1635255003,1635254702,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}",,201912633,high,"65a5bca5-299d-4a65-9b2c-58d27326b020",407,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635254880_21851_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201912633 - Edge 407 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617802661742d7102602e376,"OPEN - GENERAL - V3",1635255302,1635254702,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""1867"", ""interface"": ""GE3""}",,202040654,high,"cc502c04-a048-45dc-81f4-a5b13403b88c",953,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635254880_21851_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040654 - Edge 953 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617807141742d7102602e37f,"OPEN - GENERAL - V3",1635256802,1635255903,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",,202040658,high,"282cb65f-e2da-4fac-8216-3ea2a9ad248d",958,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635256080_21887_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040658 - Edge 958 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6178083f1742d7102602e383,"OPEN - GENERAL - V3",1635256802,1635256202,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",,202040658,medium,"7950738d-7ac8-4da7-b851-aaacf2e8924f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635256380_21894_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617808401742d7102602e385,"OPEN - GENERAL - V3",1635256802,1635256202,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2231"", ""interface"": ""GE3""}",,202040658,medium,"acd7624f-df45-4eff-9e3c-1efd032dcd76",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635256380_21894_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040658 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61780cf180a98715a02dca5c,"OPEN - GENERAL - V3",1635258004,1635257404,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,202041378,high,"01f36ee1-8589-4541-bf1c-ed38c3518f3d",995,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635257580_22190_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041378 - Edge 995 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61780e1a1742d7102602e396,"OPEN - GENERAL - V3",1635258004,1635257703,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}",,202041378,medium,"51c80f22-cf29-48ac-83c1-78543ef10a85",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635257880_21940_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61780e1b1742d7102602e398,"OPEN - GENERAL - V3",1635258004,1635257703,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""2740"", ""interface"": ""GE4""}",,202041378,medium,"d6da7d8d-36f6-44c4-9b7b-70417fc1f614",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635257880_21940_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041378 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61782910f96ef44b7a11fdee,"OPEN - GENERAL - V3",1635264904,1635264603,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"6d0524bf-a86c-4deb-92b3-a4e12b237295",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635264780_22150_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617840801742d7102602e3d4,"OPEN - GENERAL - V3",1635270904,1635270603,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,202040644,high,"8a0eaa99-100b-42cb-86b6-482ed8c885e4",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635270780_22373_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6178440580a98715a02dca8c,"OPEN - GENERAL - V3",1635271804,1635271504,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}",,202058022,high,"a7f09bbe-7173-4f20-9cd7-68799ed7548d",458,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635271680_22632_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202058022 - Edge 458 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6178440780a98715a02dca8f,"OPEN - GENERAL - V3",1635280204,1635271504,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,high,"d2ec0928-f040-4eda-a1ff-81b74f474a42",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635271680_22632_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040669 - Edge 999 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6178452ef96ef44b7a11fe09,"OPEN - GENERAL - V3",1635272106,1635271804,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",,202062011,medium,"f17add7b-eec1-47db-b979-377964a31c7b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635271980_22384_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062011 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6178452ff96ef44b7a11fe0b,"OPEN - GENERAL - V3",1635272405,1635271804,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",,202183678,medium,"2425f54f-aab0-400e-88c2-b343bababaa4",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635271980_22384_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61784530f96ef44b7a11fe0d,"OPEN - GENERAL - V3",1635280204,1635271804,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,medium,"a7d70862-6ff6-423b-a907-ca604e0fa614",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635271980_22384_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61784531f96ef44b7a11fe0f,"OPEN - GENERAL - V3",1635280204,1635271804,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2766"", ""interface"": ""GE3""}",,202040669,medium,"e31f1c34-71ee-4fa6-a5fc-c3951a2e76ba",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635271980_22384_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6178465f1742d7102602e3dd,"OPEN - GENERAL - V3",1635280502,1635271804,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,high,"39e714d3-4b39-4861-b13b-914dfe7b0936",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635272280_22423_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040669 - Edge 999 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617847871742d7102602e3e1,"OPEN - GENERAL - V3",1635280502,1635272106,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,medium,"00fd5232-b54c-4741-9e48-f9a5720b4f7d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635272580_22432_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617847881742d7102602e3e3,"OPEN - GENERAL - V3",1635280502,1635272106,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2766"", ""interface"": ""GE3""}",,202040669,medium,"e7cb3e41-97fa-4ae9-b6d3-ca892ed66bfe",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635272580_22432_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61784fbdf96ef44b7a11fe20,"OPEN - GENERAL - V3",1635284704,1635274203,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,202162229,performance,"d4d30f17-c981-4d61-b612-069150537676",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635274680_22470_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","paulo.bianchi",1,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617853431742d7102602e40b,"OPEN - GENERAL - V3",1635283803,1635275103,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2225"", ""interface"": ""GE4""}",,202040664,performance,"bfe13b88-15fa-4822-a4b0-6bc1b4d27f37",2225,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635275580_22523_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","danilo.capitol",1,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040664 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6178614f80a98715a02dcacf,"OPEN - GENERAL - V3",1635279303,1635279003,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"ea7565ee-7683-4de7-9591-5f9f0819d1c8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635279180_22886_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6178615080a98715a02dcad1,"OPEN - GENERAL - V3",1635279303,1635279003,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",,202183678,medium,"b6b9811b-dd8c-48e2-a966-d51558764b41",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635279180_22886_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6178615680a98715a02dcad9,"OPEN - GENERAL - V3",1635279303,1635279003,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"cc9828c5-079c-4be0-a192-3b76b6083ed4",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635279180_22886_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617863a780a98715a02dcade,"OPEN - GENERAL - V3",1635308404,1635279606,"alert_manager","","",,"{""edgeId"": ""945"", ""linkId"": ""2215"", ""interface"": ""GE4""}",,202040648,medium,"3ea29f76-ef6f-4de2-96a7-ce652fe033e7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635279780_22902_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040648 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617864d2f96ef44b7a11fe52,"OPEN - GENERAL - V3",1635280204,1635279904,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"9a50848f-d802-46eb-8a7b-022c20b32f2b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635280080_22643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61786e3380a98715a02dcae9,"OPEN - GENERAL - V3",1635282904,1635282306,"alert_manager","","",,"{""edgeId"": ""926"", ""linkId"": ""3379"", ""interface"": ""GE4""}",,202041337,medium,"c4ffbf90-1e25-495a-a1c5-260d382179c8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635282480_22985_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041337 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61786f64f96ef44b7a11fe7c,"OPEN - GENERAL - V3",1635285905,1635282602,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}",,202058024,high,"8ee26bf4-1f06-41fb-b4c7-a9e14621014d",460,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635282780_22722_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058024 - Edge 460 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6178708b80a98715a02dcaf1,"OPEN - GENERAL - V3",1635283803,1635282904,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}",,202058024,medium,"a84ff509-dee9-4ac5-9f31-e224452999ee",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635283080_23007_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058024 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6178708c80a98715a02dcaf3,"OPEN - GENERAL - V3",1635283803,1635282904,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3692"", ""interface"": ""GE1""}",,202058024,medium,"c449db10-49fe-4238-adc0-8ff2decc5b79",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635283080_23007_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058024 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617872e380a98715a02dcafd,"OPEN - GENERAL - V3",1635284104,1635283203,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}",,202058024,medium,"f5061834-ac58-43bf-a5ea-52898537f079",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635283680_23026_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058024 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617872e480a98715a02dcaff,"OPEN - GENERAL - V3",1635284104,1635283203,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3692"", ""interface"": ""GE1""}",,202058024,medium,"47cd678f-e4a8-4200-b2ae-dcdfffc8cf2f",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635283680_23026_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058024 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617872e680a98715a02dcb02,"OPEN - GENERAL - V3",1635283803,1635283504,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,medium,"56bb7372-8223-4e3c-b316-1ea32701f3c7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635283680_23026_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617872e780a98715a02dcb04,"OPEN - GENERAL - V3",1635283803,1635283504,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2766"", ""interface"": ""GE3""}",,202040669,medium,"bb5d86a1-c7c9-4b15-af1f-1e2e63cfcaeb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635283680_23026_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617872ee80a98715a02dcb0c,"OPEN - GENERAL - V3",1635283803,1635283504,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,high,"f1b27f36-a96a-477b-818b-9f502927fa29",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635283680_23026_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040669 - Edge 999 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6178766780a98715a02dcb17,"OPEN - GENERAL - V3",1635284704,1635284402,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}",,202058024,medium,"f1701deb-3d2c-4807-85f5-c00e7906022a",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635284580_23054_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058024 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6178766880a98715a02dcb19,"OPEN - GENERAL - V3",1635284704,1635284402,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3692"", ""interface"": ""GE1""}",,202058024,medium,"99a8bd34-eb67-44fb-9538-af6c069d7b6c",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635284580_23054_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058024 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617878bef96ef44b7a11fe87,"OPEN - GENERAL - V3",1635285305,1635285004,"alert_manager","","",,"{""edgeId"": ""427"", ""linkId"": ""911"", ""interface"": ""GE3""}",,20197449,medium,"a42d3e1c-76ff-4ac6-9052-bd35b9dc0d9c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635285180_22797_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197449 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617878bff96ef44b7a11fe89,"OPEN - GENERAL - V3",1635285905,1635285004,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}",,202058024,medium,"9ef5c32b-4be2-4b01-9a1d-796188ee1fdc",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635285180_22797_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058024 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617878c0f96ef44b7a11fe8b,"OPEN - GENERAL - V3",1635285905,1635285004,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3692"", ""interface"": ""GE1""}",,202058024,medium,"060caa57-0803-42c2-837b-43d497e56634",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635285180_22797_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058024 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617878c4f96ef44b7a11fe90,"OPEN - GENERAL - V3",1635286204,1635284704,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}",,202058024,high,"d2a98bff-9ab6-44d0-968f-75a00bba0270",460,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635285180_22797_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202058024 - Edge 460 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61787b1880a98715a02dcb22,"OPEN - GENERAL - V3",1635286204,1635285305,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}",,202058024,medium,"257e5ee9-9027-44b2-a204-4fd60e984933",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635285780_23091_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058024 - Link SFP2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61787b1980a98715a02dcb24,"OPEN - GENERAL - V3",1635286204,1635285305,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3692"", ""interface"": ""GE1""}",,202058024,medium,"ded378e8-3b4a-4c58-becc-99bc2c2eb322",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635285780_23091_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058024 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61787c441742d7102602e457,"OPEN - GENERAL - V3",1635296403,1635285604,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"7e87cf20-9fe4-45ff-bce0-74ec99914ad9",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635286080_22876_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61787c461742d7102602e45a,"OPEN - GENERAL - V3",1635286503,1635285905,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,high,"9788f52b-4262-431c-a3b4-abaa57926489",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635286080_22876_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040669 - Edge 999 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61787d70f96ef44b7a11fe95,"OPEN - GENERAL - V3",1635286503,1635286204,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,medium,"55b2b046-5b5e-43bf-9ba8-6bfbedd4ea0d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635286380_22836_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61787d71f96ef44b7a11fe97,"OPEN - GENERAL - V3",1635286503,1635286204,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2766"", ""interface"": ""GE3""}",,202040669,medium,"27346600-a3af-4790-8409-f82dd41b5615",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635286380_22836_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617880f780a98715a02dcb30,"OPEN - GENERAL - V3",1635287404,1635287105,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"719e0c37-c29e-467e-afd1-b88ac8c509a4",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635287280_23140_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6178847b80a98715a02dcb38,"OPEN - GENERAL - V3",1635289205,1635288003,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}",,202058024,high,"14efb908-21a5-4a13-aea6-4ccf1dcd835c",460,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635288180_23170_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202058024 - Edge 460 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617885a2f96ef44b7a11fe9f,"OPEN - GENERAL - V3",1635288904,1635288303,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}",,202058024,medium,"7745313d-9584-43e2-87a3-0b5f5b867463",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635288480_22901_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058024 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617885a3f96ef44b7a11fea1,"OPEN - GENERAL - V3",1635288904,1635288303,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3692"", ""interface"": ""GE1""}",,202058024,medium,"22e0f219-b632-49b6-9038-0d76425484e5",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635288480_22901_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058024 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61788a551742d7102602e479,"OPEN - GENERAL - V3",1635289805,1635289504,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"603e469c-2f61-4d8d-bf54-91e670784cc2",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635289680_22986_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61788dd7f96ef44b7a11febb,"OPEN - GENERAL - V3",1635291003,1635290405,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}",,null,medium,"2d086991-b07e-48e8-9389-4aa1c780b9e7",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635290580_22974_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617893b3f96ef44b7a11fec5,"OPEN - GENERAL - V3",1635292205,1635291903,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"8845bc55-ccc6-4c5f-bdf7-3ddf5e6c1c92",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635292080_23023_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617894de1742d7102602e486,"OPEN - GENERAL - V3",1635341103,1635292205,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",,202183678,medium,"749e9e84-b16b-4d3a-af64-b87f3ac98d8f",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635292380_23071_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61789739f96ef44b7a11fed2,"OPEN - GENERAL - V3",1635293103,1635292803,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2225"", ""interface"": ""GE4""}",,202040664,medium,"54e436ad-69a3-40fc-8d22-745720f5664f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635292980_23053_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040664 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61789abc1742d7102602e48e,"OPEN - GENERAL - V3",1635295204,1635293403,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"a7d7567a-32e3-4110-8069-cc547c89fdca",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635293880_23125_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6178a2f180a98715a02dcb54,"OPEN - GENERAL - V3",1635305703,1635295504,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"e893f0db-ebd6-49f4-aed8-e991ced7adb8",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635295980_23427_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6178ab2780a98715a02dcb62,"OPEN - GENERAL - V3",1635298202,1635297904,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,high,"09dd8a02-fd5d-42b5-a2c9-b93eb9cc1467",502,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635298080_23498_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201912648 - Edge 502 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6178ac5380a98715a02dcb68,"OPEN - GENERAL - V3",1635321303,1635297904,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"90d3dc68-0599-4365-8ab8-150852811232",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635298380_23510_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6178b6dbf96ef44b7a11fefe,"OPEN - GENERAL - V3",1635322202,1635300904,"alert_manager","","",,"{""edgeId"": ""409"", ""linkId"": ""1064"", ""interface"": ""GE3""}",,20197439,medium,"cb982d38-6bdd-492f-957f-1da469a8a08f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635301080_23303_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197439 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6178bde6f96ef44b7a11ff16,"OPEN - GENERAL - V3",1635303002,1635302702,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}",,202040655,medium,"fade3da8-38a6-4ba1-b958-4353ec2c6171",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635302880_23356_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040655 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6178caca1742d7102602e4f3,"OPEN - GENERAL - V3",1635306303,1635306003,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,high,"01b4d5fb-cc53-490d-b157-8998cd9afa52",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635306180_23524_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6178d42680a98715a02dcba8,"OPEN - GENERAL - V3",1635313203,1635308404,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"1ace00a4-b8d3-491c-819a-aa9e2899b7d5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635308580_23834_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61791118f96ef44b7a11ff8e,"OPEN - GENERAL - V3",1635333902,1635323704,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"bf226eef-7989-4a64-87f9-8e8fa98e4037",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635324180_24055_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61791371f96ef44b7a11ff96,"OPEN - GENERAL - V3",1635325203,1635324603,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"319e7b0a-6e83-4223-ad1d-a84644d4f878",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635324780_24074_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6179149b1742d7102602e559,"OPEN - GENERAL - V3",1635325203,1635324904,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,medium,"d2ffceb5-9e8e-4c4d-9d66-0dec072b02da",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635325080_24140_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179149c1742d7102602e55b,"OPEN - GENERAL - V3",1635325203,1635324904,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",,202040643,medium,"263941f1-73c1-42c5-9e4b-f25d65e79900",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635325080_24140_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617915c980a98715a02dcbe6,"OPEN - GENERAL - V3",1635330902,1635325203,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}",,202041380,high,"272a810e-238a-41f0-a31f-269e45be9c03",998,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635325380_24364_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041380 - Edge 998 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617916f31742d7102602e562,"OPEN - GENERAL - V3",1635330902,1635325504,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}",,202041380,medium,"ccbe3d57-3462-4c87-8f45-8988335c62de",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635325680_24161_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041380 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617916f41742d7102602e564,"OPEN - GENERAL - V3",1635330902,1635325504,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2603"", ""interface"": ""GE4""}",,202041380,medium,"c743876b-3197-4b96-bd44-9826cdb1053b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635325680_24161_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041380 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179194c80a98715a02dcbeb,"OPEN - GENERAL - V3",1635331204,1635325803,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}",,202041380,medium,"1eebf696-0730-48c1-bbb1-1090ead24eba",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635326280_24393_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041380 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179194d80a98715a02dcbed,"OPEN - GENERAL - V3",1635331204,1635325803,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2603"", ""interface"": ""GE4""}",,202041380,medium,"e9d60d07-b74a-4c16-9a1b-cfede42fb3d9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635326280_24393_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041380 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61791a77f96ef44b7a11ffa2,"OPEN - GENERAL - V3",1635326704,1635326402,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}",,null,medium,"55594cba-244b-4025-8cdc-d43ddc7b387b",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635326580_24134_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617921811742d7102602e57c,"OPEN - GENERAL - V3",1635329103,1635327904,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"7a1f43e8-7a25-47af-88b1-ffe19baa9ea2",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635328380_24248_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179275d1742d7102602e585,"OPEN - GENERAL - V3",1635341103,1635329404,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"ea5ad738-0aae-432e-9d70-9a71ba00286e",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635329880_24300_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61792ae480a98715a02dcc0f,"OPEN - GENERAL - V3",1635330902,1635330603,"alert_manager","","",,"{""edgeId"": ""425"", ""linkId"": ""1029"", ""interface"": ""GE4""}",,20197436,high,"cdd8ec31-0e42-4d0d-b790-3625ebe8535a",425,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635330780_24535_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197436 - Edge 425 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617931e7f96ef44b7a11ffce,"OPEN - GENERAL - V3",1635332704,1635332404,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"dcbe2625-0edf-46d6-9352-b33f8074e042",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635332580_24323_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179356ef96ef44b7a11ffd7,"OPEN - GENERAL - V3",1635333603,1635333302,"alert_manager","","",,"{""edgeId"": ""962"", ""linkId"": ""2357"", ""interface"": ""GE4""}",,202040638,high,"434d622b-b8c3-4d13-a438-3859774ff8c9",962,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635333480_24355_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040638 - Edge 962 entrou em status OFFLINE",86400,high
,,,,,,,,,,617937f6f96ef44b7a11ffda,title,,1635344934,"alert_manager",unknown,"","",,"",,low,"91d5954d-d9e5-4132-8d98-3f5db596980c",,bb57e30e74f00d0d9c6976b430cb24f0,,unassigned,,"",0,"|noop",,new,unknown,"[Untagged]",,title,3600,low
"Não","","","","","N/A","","","","",61793a1c80a98715a02dcc2a,"OPEN - GENERAL - V3",1635334803,1635334503,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,202041366,medium,"307bf409-5759-4afc-abe1-7e04c294963f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635334680_24659_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61793a1e80a98715a02dcc2d,"OPEN - GENERAL - V3",1635392402,1635334204,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",,202041335,performance,"2d143fed-bea5-4e16-8452-9acc5ebbb6e8",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635334680_24659_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61793b471742d7102602e5a2,"OPEN - GENERAL - V3",1635335105,1635334803,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}",,202041380,medium,"f151353e-f270-4ca3-9159-63b19e2d511f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635334980_24462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041380 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61793b481742d7102602e5a4,"OPEN - GENERAL - V3",1635335105,1635334803,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2603"", ""interface"": ""GE4""}",,202041380,medium,"a4ba8f18-e9bd-4225-8df6-3d75a81e49a6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635334980_24462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041380 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61793b4a1742d7102602e5a8,"OPEN - GENERAL - V3",1635335105,1635334803,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}",,202041380,high,"f133d95f-8f2c-4e9c-8a47-d813e5e1a791",998,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635334980_24462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041380 - Edge 998 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61793c751742d7102602e5af,"OPEN - GENERAL - V3",1635345603,1635334803,"alert_manager","","",,"{""edgeId"": ""952"", ""linkId"": ""2203"", ""interface"": ""GE4""}",,202040636,performance,"d1caa91c-9073-4895-bfc2-322b64cda61e",2203,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635335280_24473_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040636 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61793ff91742d7102602e5bb,"OPEN - GENERAL - V3",1635341702,1635336003,"alert_manager","","",,"{""edgeId"": ""947"", ""linkId"": ""1987"", ""interface"": ""GE3""}",,202040650,high,"7dd26f7f-0eea-4921-a979-9f636a4cf91d",947,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635336180_24499_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040650 - Edge 947 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617941231742d7102602e5c0,"OPEN - GENERAL - V3",1635342002,1635336304,"alert_manager","","",,"{""edgeId"": ""947"", ""linkId"": ""1987"", ""interface"": ""GE3""}",,202040650,medium,"ceb3bdf2-09f7-49c7-9851-e838cf11f39d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635336480_24508_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040650 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617941241742d7102602e5c2,"OPEN - GENERAL - V3",1635341702,1635336304,"alert_manager","","",,"{""edgeId"": ""947"", ""linkId"": ""3254"", ""interface"": ""GE4""}",,202040650,medium,"4d840ffb-3e54-4d45-8380-405d020364e7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635336480_24508_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040650 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61794254f96ef44b7a11ffea,"OPEN - GENERAL - V3",1635336905,1635336603,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",,202183678,high,"1113dd4b-3cb5-4748-ba8b-28fd362b7edd",1935,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635336780_24455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202183678 - Edge 1935 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6179437b1742d7102602e5cb,"OPEN - GENERAL - V3",1635342304,1635336603,"alert_manager","","",,"{""edgeId"": ""947"", ""linkId"": ""1987"", ""interface"": ""GE3""}",,202040650,medium,"979451ea-ef5b-4587-be5a-d2f5901cd40c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635337080_24531_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040650 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179437c1742d7102602e5cd,"OPEN - GENERAL - V3",1635342002,1635336603,"alert_manager","","",,"{""edgeId"": ""947"", ""linkId"": ""3254"", ""interface"": ""GE4""}",,202040650,medium,"f2d91581-9265-47da-9a6a-03577cfe179b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635337080_24531_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040650 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61794959f96ef44b7a11fffc,"OPEN - GENERAL - V3",1635348902,1635338104,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5051"", ""interface"": ""GE2""}",,202183678,performance,"7a2ba194-74c5-4a7b-a4c6-ddf0a09bcd6f",5051,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635338580_24518_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202183678 - A perda de pacotes da interface GE2 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61794bb1f96ef44b7a120007,"OPEN - GENERAL - V3",1635339304,1635339003,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}",,202040655,medium,"bcb86f75-15a6-4cd6-8bb4-2cd929bb140d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635339180_24536_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040655 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61794cdc1742d7102602e5eb,"OPEN - GENERAL - V3",1635345603,1635339003,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,202162229,performance,"78307117-4714-46a4-810a-2c8de5327ebb",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635339480_24609_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179550e1742d7102602e613,"OPEN - GENERAL - V3",1635341702,1635341404,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"d6af1f05-8e4a-4060-a4fa-1ae9abfdb119",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635341580_24676_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61795640f96ef44b7a12002b,"OPEN - GENERAL - V3",1635342002,1635341702,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"bdba6e19-347b-4733-8115-91d32109e111",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635341880_24629_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6179589380a98715a02dcc52,"OPEN - GENERAL - V3",1635370203,1635342002,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,201922181,performance,"aac17af9-5a1c-4e2e-9f72-466cd68f1cd9",2561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635342480_24908_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922181 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179589580a98715a02dcc55,"OPEN - GENERAL - V3",1635364804,1635342002,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,performance,"b591e713-14d2-4e7b-ab8e-13f09eaaa5c3",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635342480_24908_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617959bf80a98715a02dcc5b,"OPEN - GENERAL - V3",1635342903,1635342604,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"5caa2694-ebc9-46ba-9bce-27f3b502564c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635342780_24917_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617959c580a98715a02dcc63,"OPEN - GENERAL - V3",1635342903,1635342604,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"75b20c80-f51b-406d-827c-d1fcdbc45f0b",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635342780_24917_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61795f9e1742d7102602e631,"OPEN - GENERAL - V3",1635360004,1635343802,"alert_manager","","",,"{""edgeId"": ""947"", ""linkId"": ""1987"", ""interface"": ""GE3""}",,202040650,performance,"da80f3ef-867f-4fd5-b768-762e0d9c6afb",1987,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635344280_24770_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040650 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61796ed7f96ef44b7a12005d,"OPEN - GENERAL - V3",1635348303,1635348004,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"5ffc5ea7-b09b-454d-b275-e1474e820ca5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635348180_24832_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179700980a98715a02dcc82,"OPEN - GENERAL - V3",1635348604,1635348303,"alert_manager","","",,"{""edgeId"": ""1930"", ""linkId"": ""5144"", ""interface"": ""GE3""}",,202183874,high,"3b85b16b-5ce7-4d87-88f5-31b93dc4e9db",1930,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635348480_25100_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202183874 - Edge 1930 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6179712e1742d7102602e64d,"OPEN - GENERAL - V3",1635365704,1635348604,"alert_manager","","",,"{""edgeId"": ""409"", ""linkId"": ""1064"", ""interface"": ""GE3""}",,20197439,medium,"afa4036c-2523-41c7-81f3-c1b9e7f774fe",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635348780_24909_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197439 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179725bf96ef44b7a120065,"OPEN - GENERAL - V3",1635349204,1635348902,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"fb7adb5e-bdcc-4209-a18d-a451bfb616c8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635349080_24863_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61797386f96ef44b7a12006d,"OPEN - GENERAL - V3",1635366004,1635348902,"alert_manager","","",,"{""edgeId"": ""409"", ""linkId"": ""1064"", ""interface"": ""GE3""}",,20197439,medium,"5951c2a6-1946-4820-a1b8-c0b29c1c1199",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635349380_24871_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197439 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179738bf96ef44b7a120073,"OPEN - GENERAL - V3",1635349804,1635349204,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"8fd04cb8-4aa5-4613-b8f9-b0dbd94b4412",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635349380_24871_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617975dff96ef44b7a12007e,"OPEN - GENERAL - V3",1635350102,1635349804,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"981a7a4b-7494-42ca-aa2c-8366cb3b95a5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635349980_24891_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179771080a98715a02dcc8a,"OPEN - GENERAL - V3",1635360604,1635349804,"alert_manager","","",,"{""edgeId"": ""956"", ""linkId"": ""1871"", ""interface"": ""GE3""}",,202040656,performance,"49336e7e-95d0-467a-bebe-8e3f0fbc39ee",1871,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635350280_25160_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040656 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617978371742d7102602e655,"OPEN - GENERAL - V3",1635351906,1635350102,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,202041366,performance,"f8b3fe8a-3e5f-43a2-9432-5878ed8c00a7",2235,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635350580_24966_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041366 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617978391742d7102602e658,"OPEN - GENERAL - V3",1635357603,1635350102,"alert_manager","","",,"{""edgeId"": ""1008"", ""linkId"": ""2042"", ""interface"": ""GE3""}",,202040629,performance,"7c3eee9b-ba94-4c98-a418-2c3bac2d4336",2042,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635350580_24966_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040629 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179783c1742d7102602e65e,"OPEN - GENERAL - V3",1635360604,1635350102,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}",,202040655,performance,"438238ac-2a6d-4d93-b992-7c171041bf53",1870,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635350580_24966_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040655 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179783e1742d7102602e661,"OPEN - GENERAL - V3",1635360904,1635350102,"alert_manager","","",,"{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",,202041365,performance,"e22debe1-1a31-428f-bfc7-aa9cfe4e2c3a",1853,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635350580_24966_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041365 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61797a94f96ef44b7a12008a,"OPEN - GENERAL - V3",1635361502,1635350703,"alert_manager","","",,"{""edgeId"": ""927"", ""linkId"": ""3318"", ""interface"": ""GE3""}",,202041338,performance,"0914c98b-99ab-4646-84e7-c67c6a3bf50d",3318,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635351180_24928_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041338 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61797e1380a98715a02dcc98,"OPEN - GENERAL - V3",1635352203,1635351906,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",,202062011,medium,"d3c57c51-75f7-4816-9b3a-1f94a2b10e43",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635352080_25215_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062011 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61798197f96ef44b7a12009e,"OPEN - GENERAL - V3",1635353103,1635352802,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"3170ce00-5e8f-4ec9-aa6d-27b0473263fc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635352980_24988_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617983f080a98715a02dcca6,"OPEN - GENERAL - V3",1635353702,1635353404,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"5d8c1de8-ced2-4dac-819f-4b0ff29fdce0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635353580_25271_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179851e1742d7102602e695,"OPEN - GENERAL - V3",1635371704,1635353404,"alert_manager","","",,"{""edgeId"": ""409"", ""linkId"": ""1150"", ""interface"": ""GE4""}",,20197439,performance,"6a918303-d0a5-4ee9-be96-98737715f759",1150,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635353880_25069_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"20197439 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617986471742d7102602e69e,"OPEN - GENERAL - V3",1635354305,1635354007,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"1c185afe-257a-47fa-be11-7558238e56b9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635354180_25078_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617986501742d7102602e6ab,"OPEN - GENERAL - V3",1635354602,1635354007,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"a3cd7d2f-5970-40d2-8355-73cef32708be",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635354180_25078_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6179889f80a98715a02dccbf,"OPEN - GENERAL - V3",1635354904,1635354602,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"50e332e0-b56f-49d8-8245-1b7926fecc6b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635354780_25311_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617988aa80a98715a02dcccb,"OPEN - GENERAL - V3",1635360604,1635354305,"alert_manager","","",,"{""edgeId"": ""956"", ""linkId"": ""1874"", ""interface"": ""GE4""}",,202040656,performance,"311b8593-d70a-47ae-9de5-8c0992c1031f",1874,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635354780_25311_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040656 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989ccf96ef44b7a1200ac,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""1000"", ""linkId"": ""1944"", ""interface"": ""GE3""}",,202040670,performance,"fe8a842a-3002-4306-ab1f-8ecc09bc7bdb",1944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040670 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989cdf96ef44b7a1200ae,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""1001"", ""linkId"": ""2125"", ""interface"": ""GE4""}",,202041382,performance,"2fa414ac-551c-40b9-b4cb-5945a714fa61",2125,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041382 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989cef96ef44b7a1200b0,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""1001"", ""linkId"": ""2129"", ""interface"": ""GE3""}",,202041382,performance,"c6d19951-1be1-44ce-90fb-94de0f8ecc3f",2129,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041382 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989d1f96ef44b7a1200b4,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""1132"", ""linkId"": ""2787"", ""interface"": ""GE3""}",,202040653,performance,"72b8c07d-0867-4a2e-a91a-c30b3398c400",2787,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040653 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989d2f96ef44b7a1200b6,"OPEN - GENERAL - V3",1635361204,1635354602,"alert_manager","","",,"{""edgeId"": ""1560"", ""linkId"": ""4016"", ""interface"": ""GE3""}",,202061994,performance,"2a923e4d-e97a-4213-bfc2-2fd1482979a4",4016,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202061994 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989d5f96ef44b7a1200ba,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""916"", ""linkId"": ""2220"", ""interface"": ""GE3""}",,202040639,performance,"7e42ab63-c48f-4e53-8b58-7d865fd57d9f",2220,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040639 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989d5f96ef44b7a1200bc,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""916"", ""linkId"": ""2222"", ""interface"": ""GE4""}",,202040639,performance,"f3177d73-d213-4416-b947-dc5298060d09",2222,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040639 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989d8f96ef44b7a1200c0,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""944"", ""linkId"": ""2006"", ""interface"": ""GE4""}",,202040647,performance,"e9016ce7-e0da-4601-8a7a-3bda0f0df30a",2006,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040647 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989dbf96ef44b7a1200c4,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""2753"", ""interface"": ""GE4""}",,202040655,performance,"fa8906a8-497d-482c-81d3-ed7194154300",2753,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040655 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989def96ef44b7a1200c8,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",,202040658,performance,"ae0c47f7-3647-443a-a0fb-2fccbfc4d056",2228,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,21,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040658 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989dff96ef44b7a1200ca,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2231"", ""interface"": ""GE3""}",,202040658,performance,"cb7b352a-129c-49cf-82bd-512eb92e33d0",2231,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,22,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040658 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989dff96ef44b7a1200cc,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""963"", ""linkId"": ""1961"", ""interface"": ""GE3""}",,202041387,performance,"5b7e70f5-ead9-47ef-b66a-a80700a16082",1961,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,23,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041387 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e0f96ef44b7a1200ce,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}",,202040664,performance,"1e9736e1-a895-40d7-bb35-14a7aff3e61d",2224,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,24,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040664 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e1f96ef44b7a1200d0,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2225"", ""interface"": ""GE4""}",,202040664,performance,"d6f1636a-efda-4604-bcee-4741b6580daf",2225,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,25,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040664 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e2f96ef44b7a1200d2,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2062"", ""interface"": ""GE3""}",,202040635,performance,"f2aa7155-0ed0-40c7-ba75-2dc2211c5ad6",2062,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,26,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040635 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e3f96ef44b7a1200d4,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2275"", ""interface"": ""GE4""}",,202040635,performance,"918d95e2-6eb6-47b0-9a8b-97b31a495d85",2275,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,27,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040635 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e4f96ef44b7a1200d6,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""975"", ""linkId"": ""2063"", ""interface"": ""GE4""}",,202041389,performance,"8d33d344-55a3-4ca0-ba39-8c59f95ac40e",2063,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,28,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041389 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e6f96ef44b7a1200d9,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""981"", ""linkId"": ""1889"", ""interface"": ""GE4""}",,202041365,performance,"e8a84750-f189-4a08-9054-023a5df6fb45",1889,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,30,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041365 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e7f96ef44b7a1200db,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2218"", ""interface"": ""GE3""}",,202041368,performance,"f2c76ad3-5161-4884-8c22-c4d5201ae3a8",2218,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,31,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041368 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e8f96ef44b7a1200dd,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2219"", ""interface"": ""GE4""}",,202041368,performance,"f31c6403-5db5-44af-8c28-e108e208e9f7",2219,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,32,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041368 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e9f96ef44b7a1200df,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""987"", ""linkId"": ""2237"", ""interface"": ""GE2""}",,202041370,performance,"d91a4a19-f02f-4534-9521-f5e01ee254b4",2237,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,33,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041370 - A perda de pacotes da interface GE2 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989e9f96ef44b7a1200e1,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""987"", ""linkId"": ""2679"", ""interface"": ""GE4""}",,202041370,performance,"db2d3b98-851b-4885-a81d-742e83cfa98d",2679,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,34,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041370 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989eaf96ef44b7a1200e3,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""988"", ""linkId"": ""2086"", ""interface"": ""GE3""}",,202041371,performance,"bdb26fa4-b378-4e56-abb2-e1aa0e3ae3c5",2086,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,35,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041371 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989ebf96ef44b7a1200e5,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""988"", ""linkId"": ""2087"", ""interface"": ""GE4""}",,202041371,performance,"30c18a82-5fb1-49b0-bfb3-8ab6e83b4b31",2087,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,36,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041371 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989ecf96ef44b7a1200e7,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""989"", ""linkId"": ""2248"", ""interface"": ""GE3""}",,202041372,performance,"ddadda7c-cd6d-4e4d-affd-06e38ef14c24",2248,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,37,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041372 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989edf96ef44b7a1200e9,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,performance,"391d60c6-d96e-4d8f-886e-3c5e622b2d71",1831,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,38,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041373 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989eef96ef44b7a1200eb,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,202041373,performance,"5c5e88a6-42cd-42ef-9cf2-b260cb2f4bd9",1846,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,39,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041373 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989eff96ef44b7a1200ed,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""991"", ""linkId"": ""1914"", ""interface"": ""GE4""}",,202041374,performance,"cb4458c5-e6b1-4b17-88c7-a71a21655408",1914,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,40,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041374 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989f0f96ef44b7a1200ef,"OPEN - GENERAL - V3",1635360604,1635354602,"alert_manager","","",,"{""edgeId"": ""991"", ""linkId"": ""3416"", ""interface"": ""GE3""}",,202041374,performance,"2675fe54-1006-46bd-b714-95dc915f9bd3",3416,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,41,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041374 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617989f1f96ef44b7a1200f1,"OPEN - GENERAL - V3",1635360904,1635354602,"alert_manager","","",,"{""edgeId"": ""997"", ""linkId"": ""1942"", ""interface"": ""GE3""}",,202041390,performance,"963c0d9e-c668-45b5-a9a3-0fc0e0c04c8c",1942,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635355080_25056_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,42,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041390 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179922680a98715a02dcd23,"OPEN - GENERAL - V3",1635365102,1635356703,"alert_manager","","",,"{""edgeId"": ""994"", ""linkId"": ""2264"", ""interface"": ""GE3""}",,202041377,performance,"5007fe1e-a069-4a2f-98c0-2589610b9314",2264,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635357180_25392_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,42,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041377 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179935480a98715a02dcd52,"OPEN - GENERAL - V3",1635357604,1635357303,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,null,high,"6eb36074-bdff-47a3-a6bb-cbfadcc7df7d",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635357480_25403_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,44,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617999071742d7102602e72f,"OPEN - GENERAL - V3",1635363302,1635358804,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}",,202061985,medium,"54de1452-9fea-4c11-8bfc-816a475ed519",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635358980_25232_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061985 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179a13e80a98715a02dce06,"OPEN - GENERAL - V3",1635379803,1635360604,"alert_manager","","",,"{""edgeId"": ""1499"", ""linkId"": ""3878"", ""interface"": ""GE3""}",,202058771,performance,"77231b6b-1bc7-4b1d-bba5-8ddb62a20f57",3878,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635361080_25513_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058771 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179a39780a98715a02dce13,"OPEN - GENERAL - V3",1635371404,1635361204,"alert_manager","","",,"{""edgeId"": ""1577"", ""linkId"": ""5068"", ""interface"": ""GE3""}",,202185145,performance,"00fe1043-fc59-4f4b-b835-16a0b4846206",5068,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635361680_25535_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202185145 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179acfaf96ef44b7a12021e,"OPEN - GENERAL - V3",1635365102,1635363904,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"2f256348-71ed-400e-ae92-a522c4b6531a",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635364080_25343_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6179af4cf96ef44b7a120223,"OPEN - GENERAL - V3",1635365102,1635364503,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,medium,"2c4c725b-27bf-4282-ae3b-da28fc180a59",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635364680_25362_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040643 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179af4cf96ef44b7a120225,"OPEN - GENERAL - V3",1635365102,1635364503,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",,202040643,medium,"5bdcd77a-2036-4dcc-a7ae-3cac11294aff",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635364680_25362_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040643 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179af54f96ef44b7a12022e,"OPEN - GENERAL - V3",1635365404,1635364204,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"c6db80d7-6c73-48e9-af47-f9783200b0ff",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635364680_25362_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6179bd5bf96ef44b7a120257,"OPEN - GENERAL - V3",1635368404,1635368102,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",,20197447,medium,"a35ec64e-6ace-4f8c-8a36-41e75ada6463",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635368280_25477_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179c20cf96ef44b7a120261,"OPEN - GENERAL - V3",1635379803,1635369002,"alert_manager","","",,"{""edgeId"": ""1568"", ""linkId"": ""4270"", ""interface"": ""GE3""}",,202061992,performance,"4a0ddab6-f098-47f6-8099-017d1e1a7506",4270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635369480_25510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061992 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179c20df96ef44b7a120263,"OPEN - GENERAL - V3",1635379803,1635369002,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4560"", ""interface"": ""GE4""}",,202061999,performance,"9e0458de-dfc7-4bcd-a431-2b83e409105d",4560,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635369480_25510_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061999 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179c33d1742d7102602e7e1,"OPEN - GENERAL - V3",1635369905,1635369604,"alert_manager","","",,"{""edgeId"": ""998"", ""linkId"": ""2003"", ""interface"": ""GE3""}",,202041380,high,"3ddc4e20-315e-43c4-a0d6-4b36dfb1e5db",998,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635369780_25576_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041380 - Edge 998 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6179c463f96ef44b7a120269,"OPEN - GENERAL - V3",1635370505,1635369905,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",,20197447,medium,"82ecc58a-9c69-4bbb-9cd6-1de16ec4e1f4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635370080_25531_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179c6bf1742d7102602e7eb,"OPEN - GENERAL - V3",1635372003,1635370505,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",,202062009,high,"6cc3760b-2edb-41b7-9e41-efa0ca9e4739",1580,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635370680_25602_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062009 - Edge 1580 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6179c9151742d7102602e7f2,"OPEN - GENERAL - V3",1635381902,1635370805,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",,202062009,performance,"c2cf2646-fec5-4292-8670-4dacc2298ff4",4254,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635371280_25622_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062009 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179ca3ff96ef44b7a12027b,"OPEN - GENERAL - V3",1635371704,1635371404,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",,202062009,medium,"5d2dc755-f1cc-4ae2-87c8-e8e704e576d9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635371580_25580_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062009 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179ca45f96ef44b7a120283,"OPEN - GENERAL - V3",1635372302,1635371104,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}",,202062009,high,"65894266-edcc-453d-8a29-daa39f1c441f",1580,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635371580_25580_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062009 - Edge 1580 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6179d39f80a98715a02dce67,"OPEN - GENERAL - V3",1635374102,1635373802,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}",,202040644,medium,"630002ae-d559-462e-92f5-421e9ddc0c85",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635373980_25937_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179dd04f96ef44b7a12029d,"OPEN - GENERAL - V3",1635423603,1635376204,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",,20197432,high,"c8e7aa25-4432-4660-8a20-371ef70d68b8",410,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635376380_25729_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197432 - Edge 410 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6179de2bf96ef44b7a1202a1,"OPEN - GENERAL - V3",1635423603,1635376504,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",,20197432,medium,"5d5ed19e-ae97-4800-90af-910b087e2006",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635376680_25738_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197432 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179de2cf96ef44b7a1202a3,"OPEN - GENERAL - V3",1635423603,1635376504,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""969"", ""interface"": ""GE3""}",,20197432,medium,"cd6fc23d-c819-4868-9ff7-83b7d48d9e9f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635376680_25738_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197432 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179df5780a98715a02dce87,"OPEN - GENERAL - V3",1635377104,1635376805,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"ccff0231-09bd-45e0-9c90-72fcece7f587",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635376980_26040_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179df5f80a98715a02dce90,"OPEN - GENERAL - V3",1635377104,1635376805,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"aa1425fe-df73-4b3d-9641-eac094537005",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635376980_26040_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6179e083f96ef44b7a1202ad,"OPEN - GENERAL - V3",1635423904,1635376805,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",,20197432,medium,"f5828e60-802d-403d-95f7-2387a9be0129",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635377280_25757_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197432 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179e084f96ef44b7a1202af,"OPEN - GENERAL - V3",1635423904,1635376805,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""969"", ""interface"": ""GE3""}",,20197432,medium,"0130f31d-8687-4128-a1e5-d76d4cd2641f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635377280_25757_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197432 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179e08bf96ef44b7a1202b8,"OPEN - GENERAL - V3",1635378005,1635377104,"alert_manager","","",,"{""edgeId"": ""996"", ""linkId"": ""2427"", ""interface"": ""GE3""}",,202041379,high,"4634ceca-8cf7-4d80-b999-4dbc42c24fee",996,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635377280_25757_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041379 - Edge 996 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6179e1af80a98715a02dce95,"OPEN - GENERAL - V3",1635378903,1635377404,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"c480d74f-6623-4394-b4bd-ab8249d128b6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635377580_26059_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179e1b880a98715a02dce9e,"OPEN - GENERAL - V3",1635379204,1635377404,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"4c32d364-dc13-4467-9abb-76e8f0a9da15",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635377580_26059_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6179e40f80a98715a02dceb7,"OPEN - GENERAL - V3",1635379504,1635377703,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"c7705654-1e03-4ce8-b7b2-45d7ef4aeaa6",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635378180_26078_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6179e5331742d7102602e810,"OPEN - GENERAL - V3",1635379204,1635378005,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"0d61e86a-716c-48f2-b573-b7ad6909e007",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635378480_25857_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6179e8bd80a98715a02dced9,"OPEN - GENERAL - V3",1635389703,1635378903,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,performance,"2fc6bde2-7978-4703-b0bd-37cb7958c224",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635379380_26121_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179f4711742d7102602e84f,"OPEN - GENERAL - V3",1635402903,1635381902,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"2d770c4d-03a1-47f5-b0e2-00d1e13de697",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635382380_25982_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6179fdcf80a98715a02dceef,"OPEN - GENERAL - V3",1635384903,1635384605,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",,202062011,medium,"ea6575dc-1d22-4aa4-8287-bdb39cf49500",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635384780_26298_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062011 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6179fefb1742d7102602e86d,"OPEN - GENERAL - V3",1635385203,1635384903,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"3319ea65-11ec-4cb4-957d-777e1f2cd88c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635385080_26067_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a027e1742d7102602e87f,"OPEN - GENERAL - V3",1635387904,1635385803,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"f9fac216-e03f-40ca-be0c-f10b86986f6c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635385980_26094_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a02831742d7102602e886,"OPEN - GENERAL - V3",1635387604,1635385803,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"41b80080-ef19-4de5-820f-bcc7820dae93",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635385980_26094_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617a060380a98715a02dcf0b,"OPEN - GENERAL - V3",1635397804,1635386405,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"b29f556b-4fb9-4e54-920a-6b934d43335d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635386880_26362_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a098df96ef44b7a1202f9,"OPEN - GENERAL - V3",1635387904,1635387603,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,202040644,high,"c5b01a82-5ca4-48c6-a69c-57d0cd7a1877",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635387780_26098_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a0bde1742d7102602e89f,"OPEN - GENERAL - V3",1635399604,1635388204,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"e511fe58-1daa-4c31-b53e-b82a2fa9570e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635388380_26174_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a0be11742d7102602e8a4,"OPEN - GENERAL - V3",1635397804,1635388204,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"315835de-aace-4099-9759-c94691ed6c29",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635388380_26174_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617a108ff96ef44b7a120303,"OPEN - GENERAL - V3",1635389703,1635389403,"alert_manager","","",,"{""edgeId"": ""1581"", ""linkId"": ""4080"", ""interface"": ""GE4""}",,202062011,medium,"fd60093b-edd1-40c8-baa8-d2b1f8dfec26",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635389580_26158_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062011 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a1b1e80a98715a02dcf31,"OPEN - GENERAL - V3",1635399303,1635392102,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,high,"83186333-45dd-4b7f-8c03-c5459e6250a8",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635392280_26533_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a1c4780a98715a02dcf35,"OPEN - GENERAL - V3",1635399303,1635392402,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,medium,"050222bb-1618-4d3c-b0f3-c55620563997",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635392580_26543_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059979 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a1d75f96ef44b7a12031d,"OPEN - GENERAL - V3",1635399604,1635392402,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,high,"f9ca648c-dd79-4a82-a4e1-c2ff814cc93b",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635392880_26258_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617a1e9f80a98715a02dcf3c,"OPEN - GENERAL - V3",1635399604,1635392705,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,medium,"fa4b5163-550d-497e-9570-b7f7323c452b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635393180_26563_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059979 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a1ea180a98715a02dcf3f,"OPEN - GENERAL - V3",1635393306,1635393003,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",,202183678,medium,"f7db549f-d8fd-4f7c-af50-2107418e1359",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635393180_26563_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a20f980a98715a02dcf48,"OPEN - GENERAL - V3",1635408303,1635393602,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,medium,"4d65035d-ed90-4b97-b0d3-3f99c08b8dba",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635393780_26581_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a329080a98715a02dcf68,"OPEN - GENERAL - V3",1635399604,1635398102,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"3c4dd23e-dfab-4fb2-bea5-fbdbcd062998",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635398280_26721_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a34e61742d7102602e8ec,"OPEN - GENERAL - V3",1635399905,1635398402,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"136a43be-413e-4f4b-919a-33e60d4c7d94",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635398880_26522_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617a360f1742d7102602e8f0,"OPEN - GENERAL - V3",1635399905,1635398704,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"1e1204ca-e10b-42bf-b996-1d61e16f34dc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635399180_26532_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a39921742d7102602e8f7,"OPEN - GENERAL - V3",1635400204,1635399905,"alert_manager","","",,"{""edgeId"": ""1586"", ""linkId"": ""4224"", ""interface"": ""GE4""}",,202162233,medium,"d7546501-05d4-4fb8-8cf9-50e7f5e927fd",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635400080_26558_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202162233 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a39941742d7102602e8fa,"OPEN - GENERAL - V3",1635400503,1635399604,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,performance,"2e3f2deb-9594-4c90-94ca-f2a2efe6cbcc",3316,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635400080_26558_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202059979 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617a39951742d7102602e8fd,"OPEN - GENERAL - V3",1635400204,1635399905,"alert_manager","","",,"{""edgeId"": ""1586"", ""linkId"": ""4224"", ""interface"": ""GE4""}",,202162233,high,"9a3f7c8c-1fa9-4fd5-b886-ea69cd6ca9cd",1586,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635400080_26558_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202162233 - Edge 1586 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617a454a80a98715a02dcf77,"OPEN - GENERAL - V3",1635403203,1635402903,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",,20197447,medium,"c567e620-019e-448d-b96b-34f64508a296",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635403080_26884_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a47a41742d7102602e90d,"OPEN - GENERAL - V3",1635405303,1635403503,"alert_manager","","",,"{""edgeId"": ""993"", ""linkId"": ""2046"", ""interface"": ""GE3""}",,202041376,medium,"1f5a47c4-f11d-4687-a5b5-2ab7c731044e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635403680_26671_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041376 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a548880a98715a02dcf7e,"OPEN - GENERAL - V3",1635425104,1635406503,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"5514e432-bbd5-40b4-983a-05a06e83c278",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635406980_27005_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617a64f080a98715a02dcf8c,"OPEN - GENERAL - V3",1635411904,1635411003,"alert_manager","","",,"{""edgeId"": ""1586"", ""linkId"": ""4224"", ""interface"": ""GE4""}",,202162233,high,"4df5c5d1-b5fa-4e22-a267-6ac3e2051f75",1586,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635411180_27137_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202162233 - Edge 1586 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a661a1742d7102602e925,"OPEN - GENERAL - V3",1635411603,1635411303,"alert_manager","","",,"{""edgeId"": ""1586"", ""linkId"": ""4224"", ""interface"": ""GE4""}",,202162233,medium,"93b38eb8-7d2d-41a5-85f4-0b17100ce058",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635411480_26939_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202162233 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a67481742d7102602e92b,"OPEN - GENERAL - V3",1635412203,1635411303,"alert_manager","","",,"{""edgeId"": ""1586"", ""linkId"": ""4224"", ""interface"": ""GE4""}",,202162233,high,"4274c223-f26a-4095-9de0-6a7af831db6b",1586,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635411780_26949_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202162233 - Edge 1586 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617a6acbf96ef44b7a120377,"OPEN - GENERAL - V3",1635412803,1635412503,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"ba3a88d7-4a7c-4a98-8109-e6d4ebb9df9b",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635412680_26891_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a6bf7f96ef44b7a12037b,"OPEN - GENERAL - V3",1635413103,1635412803,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}",,null,medium,"ea46f7ac-510b-41d2-82e8-f167eaea4b5d",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635412980_26903_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a6e4f1742d7102602e92f,"OPEN - GENERAL - V3",1635414303,1635413403,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"755eaa4e-f0c4-42a3-a869-2add7edc4ec7",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635413580_27004_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a6f7a1742d7102602e933,"OPEN - GENERAL - V3",1635414003,1635413704,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",,20197447,medium,"97261ef5-e248-44cf-a4c0-7bd3ca92b30f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635413880_27010_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a6f7b1742d7102602e935,"OPEN - GENERAL - V3",1635414303,1635413705,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,medium,"3def201f-b50c-4265-b60f-f5c5502e8c85",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635413880_27010_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a6f7c1742d7102602e937,"OPEN - GENERAL - V3",1635414303,1635413705,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",,202040643,medium,"47e32908-2c18-4c72-8f07-db817cd3c121",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635413880_27010_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a70aaf96ef44b7a120382,"OPEN - GENERAL - V3",1635414604,1635413705,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"28ea44bb-31be-4fcd-87a4-386361e5a825",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635414180_26945_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617a7b331742d7102602e941,"OPEN - GENERAL - V3",1635417004,1635416702,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",,202183678,medium,"b97cfe11-9c27-4642-bc57-01baa14ae8d7",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635416880_27108_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202183678 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a810e1742d7102602e949,"OPEN - GENERAL - V3",1635418502,1635418202,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"1e115f27-cee0-4420-b4eb-b1d6d94f9fc7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635418380_27153_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a81101742d7102602e94c,"OPEN - GENERAL - V3",1635418502,1635418202,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"c042e0d8-5dba-42c6-b63e-6e4d0a32f538",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635418380_27153_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a86ec1742d7102602e956,"OPEN - GENERAL - V3",1635480304,1635419404,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",,202041335,performance,"a148db6d-e5ad-4573-a9bf-04dbc950b2ab",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635419880_27205_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617a8943f96ef44b7a12038e,"OPEN - GENERAL - V3",1635420603,1635420302,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2196"", ""interface"": ""GE4""}",,202040660,medium,"25b6185b-5677-4112-80d0-3b67e9c33d63",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635420480_27147_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040660 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a8cc61742d7102602e959,"OPEN - GENERAL - V3",1635421503,1635421203,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2185"", ""interface"": ""GE4""}",,202041375,medium,"b51f2575-4546-4069-8173-1db81590f53a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635421380_27252_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041375 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a8f1f80a98715a02dcfa0,"OPEN - GENERAL - V3",1635422104,1635421804,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"0bfb2fd5-0d76-47dc-acba-d1d6842b33fb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635421980_27500_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a917780a98715a02dcfa5,"OPEN - GENERAL - V3",1635422704,1635422403,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"92d64a4c-da7f-48b2-a870-989fab9656e5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635422580_27520_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a917a80a98715a02dcfa9,"OPEN - GENERAL - V3",1635423002,1635422403,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"20dbcd97-fc43-4369-89bf-95deecf5582e",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635422580_27520_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a92a3f96ef44b7a12039c,"OPEN - GENERAL - V3",1635437103,1635422704,"alert_manager","","",,"{""edgeId"": ""989"", ""linkId"": ""2244"", ""interface"": ""GE4""}",,202041372,medium,"551d59a7-7896-4c7b-9497-165a57d49024",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635422880_27219_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041372 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a92a6f96ef44b7a1203a1,"OPEN - GENERAL - V3",1635423002,1635422704,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,202040644,high,"fe838459-3015-4a19-9dce-57e3a590cd87",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635422880_27219_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a93d0f96ef44b7a1203a6,"OPEN - GENERAL - V3",1635440703,1635422704,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,performance,"2bc1ece3-f9ae-4579-90c7-098331d03db0",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635423180_27229_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617a94fa1742d7102602e961,"OPEN - GENERAL - V3",1635437403,1635423002,"alert_manager","","",,"{""edgeId"": ""989"", ""linkId"": ""2244"", ""interface"": ""GE4""}",,202041372,medium,"1144e021-a4a3-42d2-aa1c-153dcbcc9dbd",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635423480_27320_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041372 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617a962b80a98715a02dcfb0,"OPEN - GENERAL - V3",1635424503,1635423603,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"8e30b93c-b69b-483e-beaf-6c6fb8077dec",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635423780_27557_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a97521742d7102602e967,"OPEN - GENERAL - V3",1635424205,1635423904,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,medium,"4fdc11d2-f5ed-4b49-8fdc-72bded052827",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635424080_27341_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a97531742d7102602e969,"OPEN - GENERAL - V3",1635424205,1635423904,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",,202040643,medium,"7e9c5765-373a-4c7a-ab78-44cea3bdb9b4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635424080_27341_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617a97591742d7102602e971,"OPEN - GENERAL - V3",1635424205,1635423904,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,202040644,high,"e96193bc-6010-4f8e-8b46-9c8597123245",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635424080_27341_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617a98821742d7102602e979,"OPEN - GENERAL - V3",1635424805,1635423904,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"624cd9d9-c32c-4f03-b3e6-f6af3cd4504c",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635424380_27352_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617a9ad71742d7102602e982,"OPEN - GENERAL - V3",1635425104,1635424805,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"c96cb353-0c1a-40f9-8aad-e3534b5952ea",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635424980_27371_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617aa5621742d7102602e991,"OPEN - GENERAL - V3",1635427804,1635427505,"alert_manager","","",,"{""edgeId"": ""461"", ""linkId"": ""2407"", ""interface"": ""GE2""}",,202058025,medium,"c2293d5e-f886-48a8-bc7b-837311e63eb5",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635427680_27465_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058025 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617aad97f96ef44b7a1203c3,"OPEN - GENERAL - V3",1635429905,1635429602,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"343a2c00-97ec-4ad8-9dbc-707bcd223240",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635429780_27435_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617aad98f96ef44b7a1203c6,"OPEN - GENERAL - V3",1635460804,1635429304,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,201922181,performance,"2959c71e-e0f4-423a-a169-0012394b12d2",2561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635429780_27435_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922181 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617aad9bf96ef44b7a1203ca,"OPEN - GENERAL - V3",1635429905,1635429602,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"49a5ed62-2485-4c8d-8bd2-69167c4d99c5",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635429780_27435_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617ac2ae1742d7102602e9be,"OPEN - GENERAL - V3",1635439203,1635435003,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,202162229,medium,"0543d4fb-b1be-4ecd-8a29-d56d1ce24169",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635435180_27712_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202162229 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617ac2b21742d7102602e9c4,"OPEN - GENERAL - V3",1635439203,1635435003,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,202162229,high,"62f30265-b2f3-4504-83d5-f88172021587",1566,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635435180_27712_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202162229 - Edge 1566 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617ac50880a98715a02dcfe6,"OPEN - GENERAL - V3",1635439503,1635435305,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,202162229,medium,"d3b365ef-2af7-4a6f-bfdb-c173e5da5e36",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635435780_27947_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202162229 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ac9bcf96ef44b7a1203ed,"OPEN - GENERAL - V3",1635437103,1635436804,"alert_manager","","",,"{""edgeId"": ""1265"", ""linkId"": ""3293"", ""interface"": ""GE3""}",,202059974,high,"0f87b36a-ad02-4159-b8e5-9e5365fe2035",1265,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635436980_27663_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059974 - Edge 1265 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617acae4f96ef44b7a1203f2,"OPEN - GENERAL - V3",1635437403,1635437103,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"f2e19833-e3d4-4bd0-91a9-d462ee917eae",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635437280_27672_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617acd4080a98715a02dcffa,"OPEN - GENERAL - V3",1635438005,1635437703,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,high,"33b87256-29ed-4a13-b186-9c7d3d0f4457",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635437880_28007_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040669 - Edge 999 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617acf931742d7102602e9e2,"OPEN - GENERAL - V3",1635438605,1635438304,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""2779"", ""interface"": ""GE4""}",,202040654,medium,"b04474d5-6588-4b80-a68d-e76d4296b416",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635438480_27820_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040654 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617acf971742d7102602e9e8,"OPEN - GENERAL - V3",1635441603,1635438304,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,high,"66e902ae-9fd9-4dc3-bd1b-8d6c99771b91",999,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635438480_27820_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040669 - Edge 999 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617ad0c01742d7102602e9ed,"OPEN - GENERAL - V3",1635441603,1635438605,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,medium,"270a3587-bfed-4b0f-8a50-da8e8eee91eb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635438780_27830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617ad0c01742d7102602e9ef,"OPEN - GENERAL - V3",1635441603,1635438605,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2766"", ""interface"": ""GE3""}",,202040669,medium,"4022b253-74c8-43b6-a36e-2c61b6373f56",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635438780_27830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617ad0c41742d7102602e9f5,"OPEN - GENERAL - V3",1635438905,1635438605,"alert_manager","","",,"{""edgeId"": ""415"", ""linkId"": ""1112"", ""interface"": ""GE3""}",,20197421,high,"468a15a0-e2ab-494f-b2d5-10970e49f5b1",415,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635438780_27830_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197421 - Edge 415 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617ad31780a98715a02dcffe,"OPEN - GENERAL - V3",1635441904,1635438905,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}",,202040669,medium,"886e90ae-0bf9-46ac-bf6a-ff08f4850c05",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635439380_28058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ad31880a98715a02dd000,"OPEN - GENERAL - V3",1635441904,1635438905,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2766"", ""interface"": ""GE3""}",,202040669,medium,"067b49ee-b1c8-4c7e-953e-208b97eea1b6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635439380_28058_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040669 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ae1271742d7102602ea20,"OPEN - GENERAL - V3",1635458102,1635442802,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",,20197447,medium,"ccc5bc67-d7c3-4786-8597-04c32f593969",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635442980_27968_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ae4ad1742d7102602ea2c,"OPEN - GENERAL - V3",1635444004,1635443704,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,202040644,high,"9905d7c5-7c95-4a6d-b2d3-a7ee3f3c501f",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635443880_27998_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617af06380a98715a02dd02d,"OPEN - GENERAL - V3",1635448805,1635446704,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""5242"", ""interface"": ""GE2""}",,202062023,medium,"5d24b61c-1845-4a68-9112-0ddc6a47228c",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635446880_28308_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062023 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617af2bdf96ef44b7a120418,"OPEN - GENERAL - V3",1635447604,1635447303,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"4995f386-ca1d-4566-8ac2-79f2348f4267",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635447480_27987_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617af76d80a98715a02dd03a,"OPEN - GENERAL - V3",1635448805,1635448503,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}",,202040655,medium,"b80c393e-b4ed-4f68-b9da-12c214be865d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635448680_28361_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040655 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b032480a98715a02dd048,"OPEN - GENERAL - V3",1635468602,1635451502,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}",,202040664,medium,"413a5284-9b0a-4d1f-8566-97982fad6b08",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635451680_28462_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040664 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b032580a98715a02dd04b,"OPEN - GENERAL - V3",1635461104,1635451202,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}",,202061983,performance,"dbf41329-73ca-4f71-ae17-3f0cca8a5954",4132,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635451680_28462_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061983 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617b0a2ff96ef44b7a120458,"OPEN - GENERAL - V3",1635453603,1635453303,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"19b40113-d298-4c72-9485-8fab977685e5",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635453480_28181_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040643 - Edge 917 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617b0b57f96ef44b7a12045c,"OPEN - GENERAL - V3",1635547504,1635453303,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,202162229,performance,"a81d3bf8-2b3a-4923-bc56-326bb56f1aec",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635453780_28188_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202162229 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617b0db21742d7102602ea4e,"OPEN - GENERAL - V3",1635547203,1635453903,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}",,202162229,performance,"70537549-d61b-41da-ac11-bc3822fb1a70",4245,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635454380_28339_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202162229 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617b1968f96ef44b7a120481,"OPEN - GENERAL - V3",1635457503,1635457204,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",,20197432,medium,"98c8f1e9-1ab2-4b3a-8f5a-f14f6cc4f8d3",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635457380_28299_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197432 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b1a9980a98715a02dd078,"OPEN - GENERAL - V3",1635457802,1635457504,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"907badb0-f15a-4471-a09d-022edbb3b81e",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635457680_28661_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617b27781742d7102602ea77,"OPEN - GENERAL - V3",1635471903,1635460804,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",,20197447,medium,"10b814ff-0620-48ed-a200-0ee5380ca4a6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635460980_28550_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617b29d01742d7102602ea7f,"OPEN - GENERAL - V3",1635472203,1635461104,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",,20197447,medium,"4828e7bb-0209-435d-8c4e-3941cc0eb6c0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635461580_28573_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b2fab80a98715a02dd0a5,"OPEN - GENERAL - V3",1635463803,1635462903,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"59db2213-f2cf-4c58-a0ee-586cfd259f36",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635463080_28838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b345d1742d7102602eaa7,"OPEN - GENERAL - V3",1635475803,1635464104,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}",,202041366,medium,"3868c274-e6bb-4d5e-893a-2515e2a75efc",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635464280_28661_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041366 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b345f1742d7102602eaaa,"OPEN - GENERAL - V3",1635475803,1635463803,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1583"", ""interface"": ""GE4""}",,202058019,performance,"1658186c-eb05-4fd8-a93e-0efd63a1fdd7",1583,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635464280_28661_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058019 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617b44c3f96ef44b7a1204cf,"OPEN - GENERAL - V3",1635469202,1635468303,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"c37e8cbe-3e9a-4fb3-8281-f91f07715d2b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635468480_28649_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b471d1742d7102602ead9,"OPEN - GENERAL - V3",1635469502,1635468902,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2196"", ""interface"": ""GE4""}",,202040660,medium,"76088b59-1914-4861-ac6a-34fc726031d5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635469080_28814_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040660 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b60e780a98715a02dd0f0,"OPEN - GENERAL - V3",1635484203,1635475202,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"3ee84189-51de-4990-ba8f-57ae3768427a",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635475680_29252_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617b65961742d7102602eb0a,"OPEN - GENERAL - V3",1635504304,1635476705,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",,202188378,high,"511ff89f-dd20-4c63-8a72-b6bcf9b178df",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635476880_29068_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202188378 - Edge 2107 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617b66c080a98715a02dd0fa,"OPEN - GENERAL - V3",1635504304,1635477004,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",,202188378,medium,"cac9de1e-073f-4f19-9bba-eca5440f84c6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635477180_29300_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617b66c180a98715a02dd0fc,"OPEN - GENERAL - V3",1635504304,1635477004,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5428"", ""interface"": ""GE4""}",,202188378,medium,"b372f592-43ce-4998-98df-38c0f1505085",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635477180_29300_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617b67ec80a98715a02dd105,"OPEN - GENERAL - V3",1635477904,1635477304,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,medium,"05537ecd-b064-4857-a9af-3130541717d4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635477480_29310_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059979 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617b67f280a98715a02dd10c,"OPEN - GENERAL - V3",1635477904,1635477304,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,high,"c3b91c5f-6b47-45ab-87fa-1416f2e9150e",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635477480_29310_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617b67f380a98715a02dd10e,"OPEN - GENERAL - V3",1635504602,1635477004,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",,202188378,high,"cfab9547-ff39-410c-98cf-330a01a3e846",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635477480_29310_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202188378 - Edge 2107 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617b69181742d7102602eb10,"OPEN - GENERAL - V3",1635504602,1635477304,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}",,202188378,medium,"d6da486a-2327-48dd-b845-f3efb5003265",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635477780_29093_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b69181742d7102602eb12,"OPEN - GENERAL - V3",1635504602,1635477304,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5428"", ""interface"": ""GE4""}",,202188378,medium,"c1122b47-57de-4124-9754-62e2a185aeb4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635477780_29093_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202188378 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b6a46f96ef44b7a120527,"OPEN - GENERAL - V3",1635503703,1635477904,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2196"", ""interface"": ""GE4""}",,202040660,medium,"6798593e-348e-4c5f-8257-ab6dea02f5dd",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635478080_28954_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040660 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b772c1742d7102602eb3e,"OPEN - GENERAL - V3",1635481505,1635481202,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,high,"2ca239de-720c-469b-992a-4f1624a0302e",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635481380_29208_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617b798280a98715a02dd13e,"OPEN - GENERAL - V3",1635485403,1635481803,"alert_manager","","",,"{""edgeId"": ""938"", ""linkId"": ""3386"", ""interface"": ""GE3""}",,202041334,medium,"aed97ddb-7ae1-4e18-8977-eb75034ac837",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635481980_29472_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041334 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b7aac80a98715a02dd147,"OPEN - GENERAL - V3",1635482404,1635482103,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,medium,"3b2dbcfa-d6a6-44ef-bb22-cb7c9ad4bbf9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635482280_29479_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059979 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617b7ab280a98715a02dd14f,"OPEN - GENERAL - V3",1635483304,1635482103,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,high,"a91caa72-ec3f-4553-8b5d-ad19047a0e3d",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635482280_29479_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617b7d031742d7102602eb44,"OPEN - GENERAL - V3",1635483004,1635482703,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,medium,"f616b9a0-9ebc-4e42-9922-2dad53f800ec",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635482880_29256_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059979 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617b7d081742d7102602eb4c,"OPEN - GENERAL - V3",1635483904,1635482404,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,high,"fb462030-8bad-40a4-98a4-8614e0f2de22",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635482880_29256_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617b7e3080a98715a02dd160,"OPEN - GENERAL - V3",1635484203,1635483004,"alert_manager","","",,"{""edgeId"": ""1004"", ""linkId"": ""2265"", ""interface"": ""GE4""}",,202041384,medium,"626b2edf-15c5-4945-91e6-3eadaca60c9c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635483180_29513_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041384 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b8089f96ef44b7a120558,"OPEN - GENERAL - V3",1635483904,1635483605,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,medium,"736ef217-4ada-4e76-8ab5-8127aafde5ac",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635483780_29124_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059979 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b808ff96ef44b7a120560,"OPEN - GENERAL - V3",1635484203,1635483605,"alert_manager","","",,"{""edgeId"": ""1270"", ""linkId"": ""3316"", ""interface"": ""GE3""}",,202059979,high,"9591ec0c-58da-4861-b692-07012504b7c7",1270,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635483780_29124_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059979 - Edge 1270 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617b840b1742d7102602eb5b,"OPEN - GENERAL - V3",1635484805,1635484505,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}",,202184561,medium,"2739916a-81da-42ba-b112-2e6d86d99e36",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635484680_29310_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202184561 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617b85371742d7102602eb66,"OPEN - GENERAL - V3",1635513604,1635484505,"alert_manager","","",,"{""edgeId"": ""952"", ""linkId"": ""2202"", ""interface"": ""GE3""}",,202040636,performance,"c702ca81-9be1-43d0-8b8e-135b3a07e85a",2202,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635484980_29322_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040636 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617b8d6d80a98715a02dd18c,"OPEN - GENERAL - V3",1635487204,1635486905,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}",,202046758,medium,"fe8ec968-ef1b-4adc-b86f-2d234ccba40a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635487080_29643_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617b8fc41742d7102602eb8d,"OPEN - GENERAL - V3",1635487804,1635487504,"alert_manager","","",,"{""edgeId"": ""1118"", ""linkId"": ""2843"", ""interface"": ""GE3""}",,202046758,medium,"d1bef8eb-4c98-4216-8898-517f71235554",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635487680_29414_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202046758 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617b90f3f96ef44b7a120587,"OPEN - GENERAL - V3",1635488104,1635487804,"alert_manager","","",,"{""edgeId"": ""978"", ""linkId"": ""3207"", ""interface"": ""GE4""}",,202041364,medium,"1e0c027d-d4a7-4ac5-b935-407311bf4e5c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635487980_29252_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041364 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617bb6701742d7102602ebde,"OPEN - GENERAL - V3",1635498005,1635497405,"alert_manager","","",,"{""edgeId"": ""938"", ""linkId"": ""3386"", ""interface"": ""GE3""}",,202041334,medium,"88a7ae9d-16d8-4562-a48d-72a4af60a41b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635497580_29743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041334 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617bb7a080a98715a02dd1d5,"OPEN - GENERAL - V3",1635498605,1635497704,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"b1ba8019-fedf-4983-9177-f6cf3fefa0a2",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635497880_30001_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617bb8c81742d7102602ebe5,"OPEN - GENERAL - V3",1635498605,1635498005,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,medium,"f072c5ef-45d7-40d8-a02e-63f7d49dc6dc",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635498180_29764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617bb8c91742d7102602ebe7,"OPEN - GENERAL - V3",1635498605,1635498005,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",,202040643,medium,"53c5b735-4b2c-4e17-bd41-3b39b9a5f6b6",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635498180_29764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617bbb20f96ef44b7a1205b1,"OPEN - GENERAL - V3",1635505503,1635498605,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}",,202061983,medium,"a6cc9e84-662c-4c04-bf5c-a249d83d4278",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635498780_29581_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061983 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617bc22af96ef44b7a1205cb,"OPEN - GENERAL - V3",1635500705,1635500404,"alert_manager","","",,"{""edgeId"": ""461"", ""linkId"": ""2407"", ""interface"": ""GE2""}",,202058025,medium,"60cd45ff-3127-4204-8a1a-4a48ff90d8b6",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635500580_29645_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202058025 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617bc93380a98715a02dd1ef,"OPEN - GENERAL - V3",1635503105,1635502204,"alert_manager","","",,"{""edgeId"": ""982"", ""linkId"": ""2177"", ""interface"": ""GE3""}",,202040668,medium,"c005b5a1-6cdd-451c-9d5f-3e7eab94a3ff",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635502380_30148_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040668 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617bc93480a98715a02dd1f1,"OPEN - GENERAL - V3",1635503105,1635502204,"alert_manager","","",,"{""edgeId"": ""982"", ""linkId"": ""2178"", ""interface"": ""GE4""}",,202040668,medium,"cec28e8b-922a-415e-9129-1a45ea5059ad",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635502380_30148_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040668 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617bc93680a98715a02dd1f4,"OPEN - GENERAL - V3",1635503105,1635502204,"alert_manager","","",,"{""edgeId"": ""982"", ""linkId"": ""2177"", ""interface"": ""GE3""}",,202040668,high,"54db1e84-d075-47ea-b02e-05d46e2154b6",982,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635502380_30148_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040668 - Edge 982 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617bcb8af96ef44b7a1205d4,"OPEN - GENERAL - V3",1635503404,1635502505,"alert_manager","","",,"{""edgeId"": ""982"", ""linkId"": ""2177"", ""interface"": ""GE3""}",,202040668,medium,"4dce29bb-b004-4647-8f6a-93556bc17892",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635502980_29723_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040668 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617bcb8bf96ef44b7a1205d6,"OPEN - GENERAL - V3",1635503404,1635502505,"alert_manager","","",,"{""edgeId"": ""982"", ""linkId"": ""2178"", ""interface"": ""GE4""}",,202040668,medium,"56e53458-8ebc-4bfc-a42c-51d2095c6221",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635502980_29723_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040668 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617bccb6f96ef44b7a1205e0,"OPEN - GENERAL - V3",1635503404,1635503105,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2780"", ""interface"": ""GE4""}",,202040640,medium,"75a79a71-23ff-430a-91d6-727a68d2b8d9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635503280_29732_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040640 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617bcde21742d7102602ec14,"OPEN - GENERAL - V3",1635511803,1635503105,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"5750b4ab-20d4-43d9-bff0-087e03d5d62b",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635503580_29931_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617bdac41742d7102602ec2a,"OPEN - GENERAL - V3",1635507005,1635506704,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""5242"", ""interface"": ""GE2""}",,202062023,medium,"979b0abb-4057-4824-b6c1-0fc7e8f7afcf",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635506880_30045_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062023 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617bdd1e1742d7102602ec38,"OPEN - GENERAL - V3",0,1635507005,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}",,202041335,performance,"16d51dfb-6acf-4b7c-800a-14a11c3b4c72",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635507480_30061_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617be67d80a98715a02dd21a,"OPEN - GENERAL - V3",1635510005,1635509703,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"9722af52-c494-4e08-95a9-3415c5cdd67d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635509880_30393_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617bf1081742d7102602ec61,"OPEN - GENERAL - V3",1635512702,1635512403,"alert_manager","","",,"{""edgeId"": ""1575"", ""linkId"": ""4257"", ""interface"": ""GE4""}",,202162231,medium,"e5529ac0-bd0e-43dc-b095-6fc3b9c463a1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635512580_30228_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202162231 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617bf23580a98715a02dd233,"OPEN - GENERAL - V3",1635513004,1635512702,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"ebfc005e-b822-4f72-b792-e1405a5f91ca",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635512880_30482_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617bfcc080a98715a02dd24a,"OPEN - GENERAL - V3",1635517203,1635515105,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,201922181,performance,"6f6b89b0-da00-42c3-a5b8-959fb644f91e",2561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635515580_30571_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922181 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617bff171742d7102602ec6b,"OPEN - GENERAL - V3",1635516305,1635516004,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"f1512028-d0d4-4b27-98e3-d4cf26c3f02a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635516180_30345_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c029b1742d7102602ec72,"OPEN - GENERAL - V3",1635517203,1635516902,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"5f3025e8-5efb-4b5a-8a8e-aa2c6c52801d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635517080_30378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c04f41742d7102602ec79,"OPEN - GENERAL - V3",1635517802,1635517504,"alert_manager","","",,"{""edgeId"": ""424"", ""linkId"": ""1031"", ""interface"": ""GE4""}",,20197447,medium,"240fee43-9053-442f-ae1e-6ad63ad9bd2e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635517680_30395_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197447 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c062080a98715a02dd259,"OPEN - GENERAL - V3",1635524103,1635517802,"alert_manager","","",,"{""edgeId"": ""973"", ""linkId"": ""2060"", ""interface"": ""GE3""}",,202040666,medium,"70be5441-86da-402c-84b2-b5c5b78f7696",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635517980_30646_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040666 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c0877f96ef44b7a120630,"OPEN - GENERAL - V3",1635530104,1635518104,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,202040665,performance,"7fca42c1-fc87-460d-8de1-6d2f6fcb5564",2723,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635518580_30225_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040665 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c09a480a98715a02dd264,"OPEN - GENERAL - V3",1635530405,1635518405,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,202040665,performance,"aa7cfbc4-6192-471e-86a4-2125285c6a90",2722,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635518880_30675_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c0bfe80a98715a02dd26e,"OPEN - GENERAL - V3",1635522304,1635519305,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"1d547ed4-8f8f-491a-b1de-3b77f5838c23",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635519480_30691_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c0c0180a98715a02dd272,"OPEN - GENERAL - V3",1635537904,1635519004,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,performance,"19db0adc-4515-4435-91a5-f08a24d49040",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635519480_30691_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c0c0280a98715a02dd275,"OPEN - GENERAL - V3",1635522304,1635519305,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"1b0fbb6c-89b2-4b14-89d8-fc296ce24ad4",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635519480_30691_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617c0f811742d7102602ec88,"OPEN - GENERAL - V3",1635522602,1635519906,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"73ef0556-2241-4517-be14-d21a9d3272ee",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635520380_30486_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c10aa1742d7102602ec8f,"OPEN - GENERAL - V3",1635528304,1635520204,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}",,202041381,performance,"983a2b76-88fd-4958-89c6-9fa79b76dee2",1950,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635520680_30496_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,unassigned,,critical,0,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041381 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c10ab1742d7102602ec91,"OPEN - GENERAL - V3",1635528304,1635520204,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}",,202041381,performance,"94134d11-8963-41e0-934a-5bdd766a384d",2233,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635520680_30496_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041381 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c11dd80a98715a02dd293,"OPEN - GENERAL - V3",1635541204,1635520505,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,201922181,performance,"5b73ea43-2508-4344-bed9-1a1350d8d05c",2561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635520980_30740_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922181 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c1feb80a98715a02dd2e5,"OPEN - GENERAL - V3",1635524706,1635524404,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"4a2f1065-f214-4fb8-9e68-3a53c04ff925",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635524580_30852_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c1ff080a98715a02dd2eb,"OPEN - GENERAL - V3",1635524706,1635524404,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"316ca32c-51ed-4ac3-a6e9-2c3a22340347",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635524580_30852_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617c294c1742d7102602ecc5,"OPEN - GENERAL - V3",1635536704,1635526504,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"c537b5a1-9e90-4cd0-a3ea-85a19d048200",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635526980_30703_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c2a761742d7102602ecd0,"OPEN - GENERAL - V3",1635527405,1635527104,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"9128a522-fa78-483c-85ca-1838d60a2926",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635527280_30718_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c2ba880a98715a02dd316,"OPEN - GENERAL - V3",1635527705,1635527405,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"a9f95e82-4d83-423e-9b6b-2999b8362ecc",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635527580_30954_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617c32aaf96ef44b7a12068e,"OPEN - GENERAL - V3",1635529504,1635529204,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"2780b558-772c-4101-83b2-4286412ed67e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635529380_30560_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c3c08f96ef44b7a1206af,"OPEN - GENERAL - V3",1635531903,1635531606,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"dae2d922-c241-403f-8ddc-094ac706fe92",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635531780_30635_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c3e6080a98715a02dd355,"OPEN - GENERAL - V3",1635532505,1635532204,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}",,202040655,medium,"f577ef20-e02f-42fe-bbc9-8b411d9a4507",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635532380_31112_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040655 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c3e6580a98715a02dd35c,"OPEN - GENERAL - V3",1635533105,1635532204,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}",,202041381,high,"08c69986-3b72-462e-91ee-55765bfe3210",1002,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635532380_31112_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041381 - Edge 1002 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617c3e6780a98715a02dd35f,"OPEN - GENERAL - V3",1635533105,1635532204,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,202040665,high,"1ed4807e-70ef-401f-a949-1dbeb15e78ab",969,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635532380_31112_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040665 - Edge 969 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617c40b7f96ef44b7a1206b8,"OPEN - GENERAL - V3",1635543903,1635532505,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}",,202041381,performance,"72261633-a6d0-4e0e-8913-edf1cf48e7d4",1950,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635532980_30674_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041381 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c40b8f96ef44b7a1206ba,"OPEN - GENERAL - V3",1635543903,1635532505,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}",,202041381,performance,"58504066-5649-4651-b8e2-12ecf4ce449e",2233,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635532980_30674_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041381 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c40bdf96ef44b7a1206c0,"OPEN - GENERAL - V3",1635543903,1635532505,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""971"", ""interface"": ""GE3""}",,20197442,performance,"1e273c08-1954-461c-ba7e-cde432761375",971,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635532980_30674_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"20197442 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c40bef96ef44b7a1206c3,"OPEN - GENERAL - V3",1635543903,1635532505,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,202040665,performance,"d9f944f3-72d2-4b41-bb0c-00dd0ba84890",2722,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635532980_30674_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040665 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c40bff96ef44b7a1206c5,"OPEN - GENERAL - V3",1635543903,1635532505,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,202040665,performance,"fa1a1e7a-eb07-480a-b770-93aa0fc94c92",2723,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635532980_30674_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040665 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c40c2f96ef44b7a1206c9,"OPEN - GENERAL - V3",1635536105,1635532803,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"3982f8f0-0457-45a6-8be4-61d92785253e",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635532980_30674_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617c41e480a98715a02dd36f,"OPEN - GENERAL - V3",1635533402,1635533105,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"cc9a7b50-dd1f-4ffd-a8f4-88c23f34995a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635533280_31141_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c41e580a98715a02dd371,"OPEN - GENERAL - V3",1635536105,1635533105,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,medium,"78e1dc48-5413-4a11-9782-34207900895e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635533280_31141_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c41e680a98715a02dd373,"OPEN - GENERAL - V3",1635536105,1635533105,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",,202040643,medium,"118709ab-33a4-4018-8540-ce2a16859c1f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635533280_31141_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c430f1742d7102602ece0,"OPEN - GENERAL - V3",1635533703,1635533402,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"49d08729-f2c8-4243-9a60-ba8b2e3fa83d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635533580_30925_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c443c80a98715a02dd383,"OPEN - GENERAL - V3",1635536405,1635533402,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,medium,"c7dd36b9-8e64-4ace-bcde-84ace96bfc7d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635533880_31159_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c443d80a98715a02dd385,"OPEN - GENERAL - V3",1635536405,1635533402,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2318"", ""interface"": ""GE4""}",,202040643,medium,"4b7e8ca9-f104-49ff-a678-afba42a9e969",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635533880_31159_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040643 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c4693f96ef44b7a1206d0,"OPEN - GENERAL - V3",1635534603,1635534304,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"976ed655-382f-4b73-83e8-fcbb39a10301",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635534480_30720_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c4b43f96ef44b7a1206f2,"OPEN - GENERAL - V3",1635535804,1635535505,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"07b1fd52-1ce7-4b88-bb12-ae6bf1a083d4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635535680_30754_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c4ec880a98715a02dd3b5,"OPEN - GENERAL - V3",1635536704,1635536405,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"8bb840e5-ef97-4c70-9566-9f74b5893d61",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635536580_31247_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c5254f96ef44b7a12072f,"OPEN - GENERAL - V3",1635537604,1635537304,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}",,202040643,high,"072c330b-b6b1-447c-9e14-f8eb2fa8c627",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635537480_30809_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617c5378f96ef44b7a120734,"OPEN - GENERAL - V3",1635572103,1635537304,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2722"", ""interface"": ""GE3""}",,202040665,performance,"fc54152e-c994-4b80-9660-b220d2f556a8",2722,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635537780_30819_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040665 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c5378f96ef44b7a120736,"OPEN - GENERAL - V3",1635571503,1635537304,"alert_manager","","",,"{""edgeId"": ""969"", ""linkId"": ""2723"", ""interface"": ""GE4""}",,202040665,performance,"0a597fd0-0768-4502-a1ba-80d12a968022",2723,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635537780_30819_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202040665 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c5379f96ef44b7a120738,"OPEN - GENERAL - V3",1635537904,1635537604,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"2ec75656-7702-441f-b614-a5dd743f103c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635537780_30819_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c55cef96ef44b7a120743,"OPEN - GENERAL - V3",1635570303,1635537904,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}",,202041381,performance,"4995b1ce-1920-4a45-b127-0682d39d71b7",1950,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635538380_30840_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,unassigned,,critical,0,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041381 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c56fb80a98715a02dd3ce,"OPEN - GENERAL - V3",1635570003,1635538204,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}",,202041381,performance,"1058a7e6-18c2-435e-b1e3-ce2e02ba0a1b",2233,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635538680_31315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041381 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c570080a98715a02dd3d4,"OPEN - GENERAL - V3",1635538806,1635538504,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"2c843079-038d-4138-bbef-d1ba237ffe5c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635538680_31315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c58301742d7102602ed1e,"OPEN - GENERAL - V3",1635539104,1635538806,"alert_manager","","",,"{""edgeId"": ""959"", ""linkId"": ""1876"", ""interface"": ""GE3""}",,202040659,high,"88e8926b-7e11-4638-8a45-4ebba17b1adc",959,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635538980_31109_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040659 - Edge 959 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617c5a811742d7102602ed25,"OPEN - GENERAL - V3",1635564602,1635539104,"alert_manager","","",,"{""edgeId"": ""431"", ""linkId"": ""971"", ""interface"": ""GE3""}",,20197442,performance,"20aa8309-d62f-4a69-a699-7ac5a3502821",971,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635539580_31128_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"20197442 - A Latência da interface GE3 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c5a871742d7102602ed2e,"OPEN - GENERAL - V3",1635558002,1635539104,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1583"", ""interface"": ""GE4""}",,202058019,performance,"30baa6c4-786f-4d3b-b9a8-9369bff8867a",1583,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635539580_31128_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202058019 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c5bad1742d7102602ed37,"OPEN - GENERAL - V3",1635564304,1635539406,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,performance,"2ced02b2-17a3-4852-80f8-eb6ab8aa28f2",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635539880_31138_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062017 - A Latência da interface GE4 excedeu o valor de 100",86400,low
"Não","","","","","N/A","","","","",617c5bb01742d7102602ed3c,"OPEN - GENERAL - V3",1635540005,1635539704,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"45b07bcf-f403-4187-90be-bb229f4e46a2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635539880_31138_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c606280a98715a02dd408,"OPEN - GENERAL - V3",1635541204,1635540904,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"9a2320dd-dac4-414b-ac12-c709742519cd",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635541080_31393_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c6194f96ef44b7a12076f,"OPEN - GENERAL - V3",1635541504,1635541204,"alert_manager","","",,"{""edgeId"": ""992"", ""linkId"": ""2183"", ""interface"": ""GE3""}",,202041375,high,"4f1116c8-fe95-48fc-8549-ce9396cc39fb",992,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635541380_30928_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041375 - Edge 992 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617c65101742d7102602ed70,"OPEN - GENERAL - V3",1635542404,1635542103,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"8316bb45-32c9-438a-b6d1-c7e686f0166e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635542280_31218_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c68941742d7102602ed92,"OPEN - GENERAL - V3",1635543302,1635543004,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"ef85d334-7dd8-4e8c-849a-9b45e00c2754",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635543180_31246_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c6c19f96ef44b7a12077a,"OPEN - GENERAL - V3",1635544204,1635543903,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"8204a731-e28a-406f-8d3b-34780acb9a81",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635544080_31005_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c70c81742d7102602edcf,"OPEN - GENERAL - V3",1635545405,1635545103,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"1c3c417e-34a1-4d91-9926-5529c93fdcc7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635545280_31315_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c7579f96ef44b7a12079d,"OPEN - GENERAL - V3",1635546605,1635546302,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"34efe397-b9bb-462a-acc9-80cd4a0b71cc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635546480_31081_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c7a271742d7102602edf1,"OPEN - GENERAL - V3",1635547805,1635547504,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"7231877d-a933-4b3b-ba37-9a2b576fd25b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635547680_31393_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c7dab1742d7102602ee05,"OPEN - GENERAL - V3",1635548703,1635548404,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"f621ba91-11de-43a9-87b0-e1d4ebd91b09",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635548580_31430_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c825cf96ef44b7a1207b2,"OPEN - GENERAL - V3",1635549903,1635549603,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"6d0b8dea-4952-4fbc-95fb-64fcf739abb8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635549780_31182_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c8389f96ef44b7a1207be,"OPEN - GENERAL - V3",1635572404,1635549603,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"d4aa5b63-1ee5-41c6-8447-5d1d6376c3b7",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635550080_31189_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c88381742d7102602ee22,"OPEN - GENERAL - V3",1635551403,1635551103,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"01c09149-5fc4-45df-8ae1-23e915343126",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635551280_31521_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c8a90f96ef44b7a1207dc,"OPEN - GENERAL - V3",1635552604,1635551705,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"6e58613e-21af-4819-a126-45c9f3097547",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635551880_31245_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c8ce9f96ef44b7a1207e9,"OPEN - GENERAL - V3",1635552604,1635552304,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"cf1d7b85-312c-4fc2-8a8f-fdfb2e76b249",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635552480_31263_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c906cf96ef44b7a1207f5,"OPEN - GENERAL - V3",1635553503,1635553203,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"efcc1c65-b9c1-4987-a511-0d26b88ed612",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635553380_31295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c93f01742d7102602ee6b,"OPEN - GENERAL - V3",1635554404,1635554102,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"728f59f6-3135-40a9-bdcf-314fe9dbf0ba",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635554280_31623_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c96481742d7102602ee77,"OPEN - GENERAL - V3",1635555005,1635554703,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"e075d162-cd9a-47a0-aa66-492b8b018172",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635554880_31644_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c977480a98715a02dd478,"OPEN - GENERAL - V3",1635568505,1635554703,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}",,202061983,performance,"13b27794-0fee-4232-b3c9-fa285b49f4c6",4133,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635555180_31853_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061983 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c989f1742d7102602ee83,"OPEN - GENERAL - V3",1635568505,1635555005,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""4011"", ""interface"": ""GE3""}",,202046760,performance,"292dfb63-9df7-42b5-b95a-0f01b08c0f74",4011,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635555480_31664_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c98a11742d7102602ee86,"OPEN - GENERAL - V3",1635568203,1635555005,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""5186"", ""interface"": ""GE3""}",,202062003,performance,"e1c2ca49-2f6e-48f8-9212-4e682dcd9c77",5186,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635555480_31664_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202062003 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617c99cb1742d7102602ee92,"OPEN - GENERAL - V3",1635559505,1635555603,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"bc17855c-324f-4cd0-9fad-8df6a0dbbd8b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635555780_31673_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617c9af9f96ef44b7a12080c,"OPEN - GENERAL - V3",1635556203,1635555904,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"6d86d843-43f3-42ee-8195-b87023216e94",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635556080_31378_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617c9fa9f96ef44b7a12081c,"OPEN - GENERAL - V3",1635557403,1635557103,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"96cab626-214e-409a-a1e0-f6a8c5ae1d20",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635557280_31416_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617ca32c1742d7102602eeda,"OPEN - GENERAL - V3",1635558303,1635558002,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"f78a69c3-29d9-4c5e-aa95-8bf0d9a42cea",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635558180_31753_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617caa34f96ef44b7a12082b,"OPEN - GENERAL - V3",1635560103,1635559803,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"a1b8bf41-530f-4deb-8fce-4a3d7a520666",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635559980_31502_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617cb010f96ef44b7a120851,"OPEN - GENERAL - V3",1635561603,1635561303,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,medium,"7af55549-538b-4223-b8c8-4b4d0ea30293",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635561480_31546_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617cb71c1742d7102602ef1e,"OPEN - GENERAL - V3",1635563403,1635563103,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"3e56ab39-2f61-4211-9c33-dd22f08e1570",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635563280_31927_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617cc8ae1742d7102602ef73,"OPEN - GENERAL - V3",1635567905,1635567604,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"da874bba-fa30-49d2-9d71-ca054373a38f",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635567780_32079_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617cf2d81742d7102602efb3,"OPEN - GENERAL - V3",0,1635578406,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",,20197432,high,"4e589fa0-45fa-4621-a3f9-eec9d33adca6",410,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635578580_32446_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"20197432 - Edge 410 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617cf40380a98715a02dd546,"OPEN - GENERAL - V3",0,1635578702,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",,20197432,medium,"6c9243e7-cdf2-4469-a344-faba99d01df0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635578880_32631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197432 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617cf40480a98715a02dd548,"OPEN - GENERAL - V3",0,1635578702,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""969"", ""interface"": ""GE3""}",,20197432,medium,"ff06c91f-eaeb-4a82-8272-239fba0bf35f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635578880_32631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197432 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617cf65b80a98715a02dd554,"OPEN - GENERAL - V3",0,1635579004,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""1066"", ""interface"": ""GE4""}",,20197432,medium,"8c4103a9-9c2e-452c-91f2-7ed8ce425c1b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635579480_32658_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197432 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617cf65c80a98715a02dd556,"OPEN - GENERAL - V3",0,1635579004,"alert_manager","","",,"{""edgeId"": ""410"", ""linkId"": ""969"", ""interface"": ""GE3""}",,20197432,medium,"13da98bf-1e7d-4906-80b4-2cfac2e9ac17",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635579480_32658_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197432 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d06c580a98715a02dd577,"OPEN - GENERAL - V3",1635583804,1635583504,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}",,202062007,high,"f09b370e-5934-40b9-9565-ae0150604291",1578,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635583680_32797_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062007 - Edge 1578 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617d1bdd80a98715a02dd59d,"OPEN - GENERAL - V3",1635605702,1635588603,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"d5a47990-6897-4b45-bc69-c11e9e822f6d",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635589080_32968_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d1d0980a98715a02dd5a5,"OPEN - GENERAL - V3",1635599103,1635588903,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"eedd3a43-3855-461f-8c48-765f9557708f",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635589380_32977_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d1f6380a98715a02dd5b1,"OPEN - GENERAL - V3",1635590102,1635589802,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"1512eeb0-d325-4922-a9ef-ac950c03164e",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635589980_32995_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617d240ff96ef44b7a1208ee,"OPEN - GENERAL - V3",1635591302,1635591003,"alert_manager","","",,"{""edgeId"": ""1570"", ""linkId"": ""4294"", ""interface"": ""GE4""}",,202061996,medium,"283f9ad3-75bc-4ace-8bc0-90655923685e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635591180_32464_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061996 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617d240ff96ef44b7a1208f0,"OPEN - GENERAL - V3",1635591302,1635591003,"alert_manager","","",,"{""edgeId"": ""1570"", ""linkId"": ""4451"", ""interface"": ""GE3""}",,202061996,medium,"9cc2381e-4865-4d39-bda4-a035edb019fa",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635591180_32464_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202061996 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617d2413f96ef44b7a1208f5,"OPEN - GENERAL - V3",1635591302,1635591003,"alert_manager","","",,"{""edgeId"": ""1570"", ""linkId"": ""4294"", ""interface"": ""GE4""}",,202061996,high,"d55b8b84-fe93-43e4-94c5-1ea5036afac4",1570,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635591180_32464_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202061996 - Edge 1570 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617d27951742d7102602eff8,"OPEN - GENERAL - V3",1635592204,1635591902,"alert_manager","","",,"{""edgeId"": ""1570"", ""linkId"": ""4294"", ""interface"": ""GE4""}",,202061996,high,"9f49dc65-5490-4cc3-8509-6ff50e478f03",1570,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635592080_32879_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202061996 - Edge 1570 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617d29ea1742d7102602f000,"OPEN - GENERAL - V3",1635592802,1635592502,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,medium,"27f3aff5-0e27-4afe-b01a-7d284b8bb771",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635592680_32900_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617d29ed1742d7102602f005,"OPEN - GENERAL - V3",1635592802,1635592502,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"e82845fc-640e-4d9d-994c-c436bd88dab4",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635592680_32900_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617d2d7280a98715a02dd5bd,"OPEN - GENERAL - V3",1635593705,1635593403,"alert_manager","","",,"{""edgeId"": ""429"", ""linkId"": ""1042"", ""interface"": ""GE4""}",,20197441,high,"cf10aa67-98e3-4fd2-a556-b239f6cd455b",429,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635593580_33110_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197441 - Edge 429 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617d37faf96ef44b7a120905,"OPEN - GENERAL - V3",1635596403,1635596105,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"873fbcd9-4c73-4aaa-9292-ed2fd409ffe0",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635596280_32618_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617d3a5380a98715a02dd5d5,"OPEN - GENERAL - V3",1635599704,1635596703,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,medium,"b0a170b4-7f61-4fdd-9cad-3afa55a7e70f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635596880_33217_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d3cae80a98715a02dd5df,"OPEN - GENERAL - V3",1635599405,1635597304,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,high,"4778501c-e62b-4395-9e49-92f4caac1f59",990,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635597480_33241_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041373 - Edge 990 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617d3dd880a98715a02dd5e4,"OPEN - GENERAL - V3",1635599405,1635597603,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,202041373,medium,"719b412c-f333-49b0-a4c5-528cb438251d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635597780_33248_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617d403080a98715a02dd5ed,"OPEN - GENERAL - V3",1635599704,1635597905,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,202041373,medium,"72326b57-04fd-4667-9201-30c25c2222d2",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635598380_33271_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d498f80a98715a02dd603,"OPEN - GENERAL - V3",1635643804,1635600605,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,202041373,medium,"c99eca0c-a6c9-401c-b67f-730c5a867233",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635600780_33349_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d499280a98715a02dd607,"OPEN - GENERAL - V3",1635643804,1635600605,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,high,"89382007-3858-44a5-944d-a69b6f3f7cc2",990,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635600780_33349_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041373 - Edge 990 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617d4abbf96ef44b7a12091b,"OPEN - GENERAL - V3",1635643804,1635600902,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,medium,"f6d19477-56d2-4540-bb22-cb2823b7833f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635601080_32773_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617d4d131742d7102602f032,"OPEN - GENERAL - V3",1635644104,1635601204,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,medium,"525bdafb-8006-4497-bc82-98af8eafa95d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635601680_33192_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d554780a98715a02dd619,"OPEN - GENERAL - V3",1635604202,1635603603,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2327"", ""interface"": ""GE4""}",,202040625,medium,"965cd0e9-bff5-48a0-ab93-d1fc8981b900",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635603780_33439_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040625 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d5fd6f96ef44b7a120943,"OPEN - GENERAL - V3",1635606602,1635606302,"alert_manager","","",,"{""edgeId"": ""957"", ""linkId"": ""2065"", ""interface"": ""GE3""}",,202040657,high,"bcd9849b-8255-4eb1-bcd4-f3125dd0f7b2",957,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635606480_32953_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040657 - Edge 957 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617d5fd8f96ef44b7a120946,"OPEN - GENERAL - V3",1635606602,1635606302,"alert_manager","","",,"{""edgeId"": ""963"", ""linkId"": ""1961"", ""interface"": ""GE3""}",,202041387,high,"7a1f74eb-d50e-4023-b9f3-83dc0cccd1ca",963,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635606480_32953_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041387 - Edge 963 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617d6101f96ef44b7a12094e,"OPEN - GENERAL - V3",1635617705,1635606302,"alert_manager","","",,"{""edgeId"": ""489"", ""linkId"": ""1073"", ""interface"": ""GE3""}",,201920830,performance,"4abc7842-a9a8-4871-8b35-e1af99ae0957",1073,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635606780_32962_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201920830 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d6102f96ef44b7a120950,"OPEN - GENERAL - V3",1635618602,1635606302,"alert_manager","","",,"{""edgeId"": ""622"", ""linkId"": ""1647"", ""interface"": ""GE4""}",,201922763,performance,"8a8821de-7957-45e0-8d99-3db105c899f2",1647,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635606780_32962_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201922763 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d6104f96ef44b7a120953,"OPEN - GENERAL - V3",1635618304,1635606302,"alert_manager","","",,"{""edgeId"": ""977"", ""linkId"": ""2156"", ""interface"": ""GE4""}",,202041363,performance,"9d5967b3-960e-49bf-836f-0060ea4d33a8",2156,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635606780_32962_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041363 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d6105f96ef44b7a120955,"OPEN - GENERAL - V3",1635618304,1635606302,"alert_manager","","",,"{""edgeId"": ""977"", ""linkId"": ""2158"", ""interface"": ""GE3""}",,202041363,performance,"1756dfdc-3ee8-4bfe-9d87-26a9603e42f7",2158,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635606780_32962_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041363 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d6106f96ef44b7a120957,"OPEN - GENERAL - V3",1635606904,1635606602,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}",,202040664,high,"5dfaf305-aee4-47a0-8fb6-6b1c6894efac",968,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635606780_32962_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040664 - Edge 968 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617d622c80a98715a02dd63e,"OPEN - GENERAL - V3",1635618602,1635606602,"alert_manager","","",,"{""edgeId"": ""1132"", ""linkId"": ""2802"", ""interface"": ""GE4""}",,202040653,performance,"bf61707e-f68a-4b42-adef-3be1d3720820",2802,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040653 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d622d80a98715a02dd640,"OPEN - GENERAL - V3",1635618602,1635606602,"alert_manager","","",,"{""edgeId"": ""1560"", ""linkId"": ""4016"", ""interface"": ""GE3""}",,202061994,performance,"92bc38d1-2011-410b-af4d-a6cb36a0bee4",4016,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202061994 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d622e80a98715a02dd642,"OPEN - GENERAL - V3",1635618304,1635606602,"alert_manager","","",,"{""edgeId"": ""333"", ""linkId"": ""645"", ""interface"": ""GE3""}",,20199724,performance,"70c5fde6-cb74-477b-be07-2e384803793e",645,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"20199724 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623280a98715a02dd647,"OPEN - GENERAL - V3",1635618304,1635606602,"alert_manager","","",,"{""edgeId"": ""956"", ""linkId"": ""1871"", ""interface"": ""GE3""}",,202040656,performance,"8654f70e-3eed-44b8-91fa-55bffbd1b7bd",1871,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040656 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623380a98715a02dd649,"OPEN - GENERAL - V3",1635618304,1635606602,"alert_manager","","",,"{""edgeId"": ""957"", ""linkId"": ""2065"", ""interface"": ""GE3""}",,202040657,performance,"8c02a7cf-1b20-4107-8c3e-e8855d80269f",2065,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040657 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623480a98715a02dd64b,"OPEN - GENERAL - V3",1635618304,1635606602,"alert_manager","","",,"{""edgeId"": ""957"", ""linkId"": ""2066"", ""interface"": ""GE4""}",,202040657,performance,"91d7c43a-566d-435b-b975-04853182b88a",2066,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040657 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623580a98715a02dd64d,"OPEN - GENERAL - V3",1635618602,1635606602,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}",,202040664,performance,"6fe14c9c-5021-45cd-9b0a-3109f18e75ac",2224,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040664 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623680a98715a02dd64f,"OPEN - GENERAL - V3",1635618304,1635606602,"alert_manager","","",,"{""edgeId"": ""975"", ""linkId"": ""2063"", ""interface"": ""GE4""}",,202041389,performance,"87c57191-15e4-4158-b506-d839f5d5bfad",2063,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041389 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623780a98715a02dd651,"OPEN - GENERAL - V3",1635618304,1635606602,"alert_manager","","",,"{""edgeId"": ""975"", ""linkId"": ""2285"", ""interface"": ""GE3""}",,202041389,performance,"7c82dcf4-7377-463b-8e37-438432cd1bd3",2285,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041389 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623980a98715a02dd655,"OPEN - GENERAL - V3",1635618304,1635606602,"alert_manager","","",,"{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",,202041365,performance,"971f2d60-53fe-402a-970d-84ac9d938c09",1853,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041365 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623a80a98715a02dd657,"OPEN - GENERAL - V3",1635618304,1635606602,"alert_manager","","",,"{""edgeId"": ""981"", ""linkId"": ""1889"", ""interface"": ""GE4""}",,202041365,performance,"50e09309-4c0b-4822-894e-d6605321f8b9",1889,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041365 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623b80a98715a02dd659,"OPEN - GENERAL - V3",1635618304,1635606602,"alert_manager","","",,"{""edgeId"": ""987"", ""linkId"": ""2237"", ""interface"": ""GE2""}",,202041370,performance,"991f828c-01d1-4e09-a334-7af2e1f39d6b",2237,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,19,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041370 - A perda de pacotes da interface GE2 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d623c80a98715a02dd65b,"OPEN - GENERAL - V3",1635607202,1635606904,"alert_manager","","",,"{""edgeId"": ""981"", ""linkId"": ""1853"", ""interface"": ""GE3""}",,202041365,high,"58bfe628-80c3-4908-9c9c-6f44015bb8ec",981,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607080_33541_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,20,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041365 - Edge 981 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617d63581742d7102602f058,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""1000"", ""linkId"": ""1944"", ""interface"": ""GE3""}",,202040670,performance,"9ff98a74-46ba-4fcb-985e-a80b2a9d5fc8",1944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040670 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63591742d7102602f05a,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""1000"", ""linkId"": ""2343"", ""interface"": ""GE4""}",,202040670,performance,"7fe44a41-b99c-494c-9b8d-199d9f2bc93e",2343,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040670 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d635a1742d7102602f05c,"OPEN - GENERAL - V3",1635618602,1635606904,"alert_manager","","",,"{""edgeId"": ""1001"", ""linkId"": ""2125"", ""interface"": ""GE4""}",,202041382,performance,"981ea5f2-9c3f-4496-ae1a-7a572c4ebca0",2125,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041382 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d635b1742d7102602f05e,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""1001"", ""linkId"": ""2129"", ""interface"": ""GE3""}",,202041382,performance,"d5e792a2-d3f2-4b8f-83cd-e3eecb1af023",2129,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041382 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d635c1742d7102602f060,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""1008"", ""linkId"": ""2042"", ""interface"": ""GE3""}",,202040629,performance,"d2bcd1b7-f447-45fd-8ffd-5fc8bedb0553",2042,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040629 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d635c1742d7102602f062,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""1008"", ""linkId"": ""2044"", ""interface"": ""GE4""}",,202040629,performance,"af1dd809-2955-4b37-9a8f-2966baea2da0",2044,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040629 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d635d1742d7102602f064,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""1132"", ""linkId"": ""2787"", ""interface"": ""GE3""}",,202040653,performance,"c14dc0d6-ff8b-4523-9c95-e829b52fbbba",2787,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040653 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63621742d7102602f06b,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""916"", ""linkId"": ""2220"", ""interface"": ""GE3""}",,202040639,performance,"7d47d2fc-29c9-4358-a96d-4881982ddf6c",2220,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040639 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63631742d7102602f06d,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""916"", ""linkId"": ""2222"", ""interface"": ""GE4""}",,202040639,performance,"889901b0-e809-4e57-b710-2df0b3469f55",2222,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040639 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63641742d7102602f070,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""943"", ""linkId"": ""1879"", ""interface"": ""GE4""}",,202040646,performance,"50b3a1f3-a212-4321-be15-28525495ff9f",1879,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040646 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63651742d7102602f072,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""943"", ""linkId"": ""1884"", ""interface"": ""GE3""}",,202040646,performance,"6f806d56-6f2a-403f-b552-ce7d5ea8fb18",1884,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,19,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040646 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63661742d7102602f074,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""944"", ""linkId"": ""2006"", ""interface"": ""GE4""}",,202040647,performance,"d0595c89-5aa6-4736-a3d9-2b6ded07667c",2006,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,20,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040647 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63671742d7102602f076,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}",,202040655,performance,"9801560e-799d-40f8-bf07-7d7670de8ea0",1870,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,21,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040655 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63681742d7102602f078,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""2753"", ""interface"": ""GE4""}",,202040655,performance,"5de4443e-eb14-498b-b120-0a03960a92c5",2753,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,22,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040655 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63691742d7102602f07b,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""956"", ""linkId"": ""1874"", ""interface"": ""GE4""}",,202040656,performance,"7c6a7d34-444b-4ed7-bfa9-554ef65e66e3",1874,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,24,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040656 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d636b1742d7102602f07f,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}",,202040658,performance,"e13488a5-edf5-4728-bc65-741a735d0ae8",2228,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,27,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040658 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d636c1742d7102602f081,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2231"", ""interface"": ""GE3""}",,202040658,performance,"c5079b39-f46b-464f-9aba-984fed11ae05",2231,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,28,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040658 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d636d1742d7102602f083,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""963"", ""linkId"": ""1961"", ""interface"": ""GE3""}",,202041387,performance,"ae75441e-af71-4cb0-a8a8-eda509bc4e01",1961,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,29,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041387 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d636f1742d7102602f086,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2225"", ""interface"": ""GE4""}",,202040664,performance,"1cc56968-4a03-43e0-b627-f09b1f6d8cca",2225,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,31,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040664 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63701742d7102602f088,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2062"", ""interface"": ""GE3""}",,202040635,performance,"929de671-623c-45c0-b0ba-3f223eabb267",2062,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,32,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040635 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63701742d7102602f08a,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2275"", ""interface"": ""GE4""}",,202040635,performance,"ade8fd75-3513-4146-8617-361e087707e3",2275,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,33,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040635 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63761742d7102602f092,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2218"", ""interface"": ""GE3""}",,202041368,performance,"050e7e37-0df9-4937-9380-474489dbb3df",2218,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,40,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041368 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63771742d7102602f094,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2219"", ""interface"": ""GE4""}",,202041368,performance,"d8993586-b092-4f00-a2e7-a4a364e09886",2219,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,41,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041368 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63781742d7102602f097,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""987"", ""linkId"": ""2679"", ""interface"": ""GE4""}",,202041370,performance,"3ebce7c6-8f5c-4340-97d1-e3079a5881ac",2679,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,43,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041370 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d63791742d7102602f099,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""988"", ""linkId"": ""2086"", ""interface"": ""GE3""}",,202041371,performance,"546a0bd5-7cab-44ca-9f46-3a90fa5bca6f",2086,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,44,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041371 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d637a1742d7102602f09b,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""988"", ""linkId"": ""2087"", ""interface"": ""GE4""}",,202041371,performance,"c772ca12-ca96-48dd-a409-0d6c90236ff7",2087,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,45,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041371 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d637b1742d7102602f09d,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""989"", ""linkId"": ""2244"", ""interface"": ""GE4""}",,202041372,performance,"044f0224-c804-4615-b282-a5952a60f688",2244,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,46,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041372 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d637b1742d7102602f09f,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""989"", ""linkId"": ""2248"", ""interface"": ""GE3""}",,202041372,performance,"739ddc54-eee7-4923-941c-3077f69245e2",2248,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,47,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041372 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d637c1742d7102602f0a1,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""991"", ""linkId"": ""1914"", ""interface"": ""GE4""}",,202041374,performance,"00a5f295-e861-419d-9790-6cb9625052ce",1914,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,48,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041374 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d637d1742d7102602f0a3,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""991"", ""linkId"": ""3416"", ""interface"": ""GE3""}",,202041374,performance,"aa2a6496-b0cf-4d5f-a342-353ace9e1f0c",3416,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,49,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041374 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d637e1742d7102602f0a5,"OPEN - GENERAL - V3",1635618304,1635606904,"alert_manager","","",,"{""edgeId"": ""997"", ""linkId"": ""1942"", ""interface"": ""GE3""}",,202041390,performance,"18b3642f-f69e-48de-8ff3-d4d68629a705",1942,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,50,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041390 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d637f1742d7102602f0a7,"OPEN - GENERAL - V3",1635618602,1635606904,"alert_manager","","",,"{""edgeId"": ""997"", ""linkId"": ""2100"", ""interface"": ""GE4""}",,202041390,performance,"2b0d00af-25c6-445a-9e59-b7d9f9916d88",2100,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607380_33378_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,51,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202041390 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d65af80a98715a02dd661,"OPEN - GENERAL - V3",1635608402,1635607803,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2327"", ""interface"": ""GE4""}",,202040625,medium,"142c7197-3c8e-4d18-81a2-f95add50cd01",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607980_33570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040625 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d65bc80a98715a02dd670,"OPEN - GENERAL - V3",1635662402,1635607503,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"7072ef3f-0b6d-4fcc-9dcf-a85ae496fb15",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607980_33570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d65e080a98715a02dd698,"OPEN - GENERAL - V3",1635608402,1635607803,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,high,"7d414c81-bac9-4d58-9898-c5bea2c3e13b",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635607980_33570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,54,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617d6811f96ef44b7a12099e,"OPEN - GENERAL - V3",1635618904,1635608104,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,202062017,performance,"27afcfd0-c923-43cf-88a7-3826a0c63d31",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635608580_33030_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d7f7780a98715a02dd743,"OPEN - GENERAL - V3",1635614705,1635614404,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2196"", ""interface"": ""GE4""}",,202040660,medium,"3ee10939-90e6-4088-abd4-1086f0d09b3b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635614580_33779_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040660 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d88fd1742d7102602f370,"OPEN - GENERAL - V3",1635618602,1635616802,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,null,high,"f112d61b-4609-4a0c-b0bd-2233e158ba26",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635616980_33694_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,52,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617d8a021742d7102602f373,"OPEN - GENERAL - V3",1635618602,1635617104,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,null,medium,"23cc4aea-dc8e-4c0e-8ac7-d31f08163cba",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635617280_33704_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617d8b341742d7102602f3b1,"OPEN - GENERAL - V3",1635627303,1635617104,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"d276d5b4-33bd-420f-8003-be0588dd2859",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635617580_33714_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d8c5bf96ef44b7a120bac,"OPEN - GENERAL - V3",1635618904,1635617405,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,null,medium,"ca3a18cc-ab1f-4fd2-b083-c2e17ebc8f7c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635617880_33320_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d8fdff96ef44b7a120be3,"OPEN - GENERAL - V3",1635618904,1635618602,"alert_manager","","",,"{""edgeId"": ""1312"", ""linkId"": ""3525"", ""interface"": ""GE3""}",,202059393,medium,"cda5bdce-dfaa-4c35-a551-150b31c158f1",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635618780_33347_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059393 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d8fe3f96ef44b7a120be8,"OPEN - GENERAL - V3",1635629104,1635618304,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""3773"", ""interface"": ""GE4""}",,202040642,performance,"887e62f5-a4f1-4f7b-a11d-1cb86eaf0ae5",3773,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635618780_33347_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202040642 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617d93631742d7102602f425,"OPEN - GENERAL - V3",0,1635619504,"alert_manager","","",,"{""edgeId"": ""961"", ""linkId"": ""2196"", ""interface"": ""GE4""}",,202040660,medium,"8ba31aa9-158a-4bf8-9341-668a92c8cf95",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635619680_33786_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202040660 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617d9817f96ef44b7a120bfc,"OPEN - GENERAL - V3",1635621903,1635620704,"alert_manager","","",,"{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",,202059977,high,"8b1d716e-2b0f-485f-b8e3-59ddb187a9a1",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635620880_33412_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617d9a6b80a98715a02dd820,"OPEN - GENERAL - V3",1635621603,1635621306,"alert_manager","","",,"{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",,202059977,medium,"1dde6654-93ea-4872-834f-6651fc806435",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635621480_34003_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617d9cc380a98715a02dd829,"OPEN - GENERAL - V3",1635622803,1635621903,"alert_manager","","",,"{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",,202059977,medium,"3c4ab981-33ac-48ee-a85a-2b0c1e7f3232",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635622080_34027_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059977 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617d9df41742d7102602f446,"OPEN - GENERAL - V3",1635622503,1635622203,"alert_manager","","",,"{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}",,202059977,high,"899718b9-3a71-4ffb-b493-dc004f43b2bc",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635622380_33869_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059977 - Edge 1266 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617db1dbf96ef44b7a120c11,"OPEN - GENERAL - V3",1635627603,1635627303,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"012bcb11-187e-494b-958c-edf8dd0838d2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635627480_33619_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617dc3711742d7102602f49a,"OPEN - GENERAL - V3",1635632403,1635631802,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,high,"e7095874-ac5b-4eb4-a071-89aa18c89bcb",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635631980_34183_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059976 - Edge 1269 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617dc6f5f96ef44b7a120c3d,"OPEN - GENERAL - V3",1635633605,1635632703,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,high,"999f9885-296d-4486-9252-f3a22f516ded",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635632880_33793_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059976 - Edge 1269 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617dc94b1742d7102602f4a2,"OPEN - GENERAL - V3",1635633903,1635633303,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,medium,"c122dc10-83f9-4a74-b812-ba60e03e1d07",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635633480_34230_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059976 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617dc94e1742d7102602f4a7,"OPEN - GENERAL - V3",1635633903,1635633005,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,high,"34ba25dd-e12c-43b2-94a1-0eebc514be17",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635633480_34230_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059976 - Edge 1269 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617dcdfbf96ef44b7a120c45,"OPEN - GENERAL - V3",1635634803,1635634503,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"92a8ead8-ab1f-42f2-8354-3ed973fe45ab",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635634680_33849_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617dd0551742d7102602f4ba,"OPEN - GENERAL - V3",1635635405,1635635103,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,high,"2b517d7e-19ac-4be0-bd68-16951ce325ad",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635635280_34291_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059976 - Edge 1269 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617dd88a80a98715a02dd85c,"OPEN - GENERAL - V3",1635637505,1635637203,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,high,"91782c88-b393-4129-add4-49e19d75c87e",1269,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635637380_34513_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059976 - Edge 1269 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617df123f96ef44b7a120c77,"OPEN - GENERAL - V3",1635643804,1635643502,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}",,202059976,medium,"3d8fa01a-e09d-4735-856c-90d11da1c8a3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635643680_34125_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059976 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617df125f96ef44b7a120c7a,"OPEN - GENERAL - V3",1635653404,1635643202,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"71aa02ce-648d-4f98-b3e3-cdd8e5a94638",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635643680_34125_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617e377580a98715a02dd8cd,"OPEN - GENERAL - V3",1635666903,1635661502,"alert_manager","","",,"{""edgeId"": ""1267"", ""linkId"": ""3881"", ""interface"": ""GE3""}",,202059978,high,"b06001ea-cf64-4288-9361-9bb1ca207c20",1267,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635661680_35311_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202059978 - Edge 1267 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617e389f1742d7102602f535,"OPEN - GENERAL - V3",1635666903,1635661802,"alert_manager","","",,"{""edgeId"": ""1267"", ""linkId"": ""3881"", ""interface"": ""GE3""}",,202059978,medium,"4a24c41f-2e33-42fa-bd6a-f52d4d395ff1",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635661980_35182_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059978 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617e3af7f96ef44b7a120ceb,"OPEN - GENERAL - V3",1635667203,1635662103,"alert_manager","","",,"{""edgeId"": ""1267"", ""linkId"": ""3881"", ""interface"": ""GE3""}",,202059978,medium,"6044b1d6-df80-49b6-83fe-97a1c447f764",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635662580_34704_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202059978 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617e4ee31742d7102602f55a,"OPEN - GENERAL - V3",1635669304,1635667504,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"976555e8-2806-4799-8adc-1ce6363f8840",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635667680_35374_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617e54bef96ef44b7a120d0b,"OPEN - GENERAL - V3",1635669304,1635669002,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,201922181,medium,"c55f0829-5cbc-4a14-a1f9-2f9a560c1855",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635669180_34914_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"201922181 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617e54c2f96ef44b7a120d10,"OPEN - GENERAL - V3",1635669304,1635669002,"alert_manager","","",,"{""edgeId"": ""1105"", ""linkId"": ""2561"", ""interface"": ""GE3""}",,201922181,high,"d0fc50f5-63fa-4f4f-8e68-57826827b409",1105,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635669180_34914_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"201922181 - Edge 1105 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617e596f80a98715a02dd8f7,"OPEN - GENERAL - V3",1635670504,1635670202,"alert_manager","","",,"{""edgeId"": ""1585"", ""linkId"": ""5242"", ""interface"": ""GE2""}",,202062023,medium,"18feea36-ad5c-4358-b5e1-41423940f64a",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635670380_35588_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202062023 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617e5a9c1742d7102602f567,"OPEN - GENERAL - V3",1635670803,1635670504,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,202040644,high,"0e6144fe-213f-4b80-92ba-3f7968991729",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635670680_35479_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617e5cf31742d7102602f56c,"OPEN - GENERAL - V3",1635671702,1635670803,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"b828819e-70f6-465b-8fcf-0d943cb13677",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635671280_35498_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617e5f4b1742d7102602f571,"OPEN - GENERAL - V3",1635683704,1635671404,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"89294b58-d6e4-4f44-820f-d263ce61980c",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635671880_35516_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617e607780a98715a02dd8ff,"OPEN - GENERAL - V3",1635675003,1635672004,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"bdaa82c6-2fe3-4e8c-8808-abb0cc66c583",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635672180_35643_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617e61a580a98715a02dd908,"OPEN - GENERAL - V3",1635672904,1635672004,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"f2ca3497-46e8-481d-b54a-5d52ef9f6110",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635672480_35651_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617e6528f96ef44b7a120d1e,"OPEN - GENERAL - V3",1635676802,1635673202,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""1867"", ""interface"": ""GE3""}",,202040654,medium,"5549b18c-008a-4dd1-b6f9-195ce6d51944",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635673380_35052_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040654 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617e6529f96ef44b7a120d20,"OPEN - GENERAL - V3",1635678002,1635673202,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""2779"", ""interface"": ""GE4""}",,202040654,medium,"5405d8fe-89dd-4a5e-8dff-2c880ecdcb3c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635673380_35052_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040654 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617e652cf96ef44b7a120d25,"OPEN - GENERAL - V3",1635676802,1635673202,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""1867"", ""interface"": ""GE3""}",,202040654,high,"fbf1753e-7b84-4e5a-93fc-579358bc35a3",953,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635673380_35052_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040654 - Edge 953 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617e677f1742d7102602f57b,"OPEN - GENERAL - V3",1635677102,1635673504,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""1867"", ""interface"": ""GE3""}",,202040654,medium,"302a586c-76c7-41e0-93e9-642a86bcf70b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635673980_35585_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040654 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617e67801742d7102602f57d,"OPEN - GENERAL - V3",1635678302,1635673504,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""2779"", ""interface"": ""GE4""}",,202040654,medium,"7bb7121d-09be-49cf-8236-600f46f598ad",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635673980_35585_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040654 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617e6c331742d7102602f5a5,"OPEN - GENERAL - V3",1635675302,1635675003,"alert_manager","","",,"{""edgeId"": ""425"", ""linkId"": ""1029"", ""interface"": ""GE4""}",,20197436,high,"03f0eb22-c9d7-4982-8579-3cc786ffb0ff",425,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635675180_35625_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"20197436 - Edge 425 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617e720e1742d7102602f5c8,"OPEN - GENERAL - V3",1635676802,1635676502,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}",,202184561,high,"219e3d00-3f40-48cf-9ec9-ee1e85d6b630",1926,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635676680_35677_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202184561 - Edge 1926 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617e74641742d7102602f5d2,"OPEN - GENERAL - V3",1635679503,1635676802,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"74cfea9f-19c6-453e-8486-c5e28f743197",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635677280_35696_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617e81471742d7102602f5e5,"OPEN - GENERAL - V3",1635681903,1635680403,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,202041373,medium,"4359f924-fbb4-4db2-a036-3cfbdc6da390",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635680580_35802_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617e839ff96ef44b7a120d56,"OPEN - GENERAL - V3",1635682203,1635680703,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,202041373,medium,"17275ca1-160c-4209-89b3-c166f4ab8420",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635681180_35300_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617e87251742d7102602f5f2,"OPEN - GENERAL - V3",1635682203,1635681903,"alert_manager","","",,"{""edgeId"": ""1575"", ""linkId"": ""4257"", ""interface"": ""GE4""}",,202162231,high,"b27034b7-8c7e-4ab3-b77b-89de3264b5ff",1575,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635682080_35858_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202162231 - Edge 1575 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617e884f80a98715a02dd91e,"OPEN - GENERAL - V3",1635682504,1635682203,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"06729bc1-5766-4de8-b687-21c7d69c4cf1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635682380_35959_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617e8f59f96ef44b7a120d65,"OPEN - GENERAL - V3",1635715502,1635684002,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""2255"", ""interface"": ""GE3""}",,202040642,high,"ee9aa8d7-a9f2-4592-9e0d-76f7e6d10c04",915,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635684180_35395_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040642 - Edge 915 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617e9082f96ef44b7a120d69,"OPEN - GENERAL - V3",1635715502,1635684304,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""2255"", ""interface"": ""GE3""}",,202040642,medium,"d90fd2d9-fb3b-428c-8c0b-3e725e9695b7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635684480_35403_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040642 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617e9083f96ef44b7a120d6b,"OPEN - GENERAL - V3",1635715502,1635684304,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""3773"", ""interface"": ""GE4""}",,202040642,medium,"9a576fde-e82c-472e-a889-e03ab5bc1ccc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635684480_35403_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040642 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617e91b11742d7102602f606,"OPEN - GENERAL - V3",1635715802,1635684304,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""2255"", ""interface"": ""GE3""}",,202040642,high,"57abc218-bb98-4e70-8be8-923550da092d",915,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635684780_35943_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202040642 - Edge 915 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617e92db80a98715a02dd928,"OPEN - GENERAL - V3",1635715802,1635684603,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""2255"", ""interface"": ""GE3""}",,202040642,medium,"b8319fbe-6c5d-42e7-81c2-1472da646404",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635685080_36046_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040642 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617e92dc80a98715a02dd92a,"OPEN - GENERAL - V3",1635715802,1635684603,"alert_manager","","",,"{""edgeId"": ""915"", ""linkId"": ""3773"", ""interface"": ""GE4""}",,202040642,medium,"36c8098d-2af8-4486-a0ee-5cd0db1c6722",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635685080_36046_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040642 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ea21980a98715a02dd965,"OPEN - GENERAL - V3",0,1635688504,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}",,201912648,performance,"af17a748-b232-490d-89cf-9e8ef36998cf",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635688980_36170_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617eb3ad80a98715a02dd985,"OPEN - GENERAL - V3",1635693904,1635693303,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}",,202041386,medium,"f315ea64-293f-4e94-95c9-8b6c5182ad93",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635693480_36312_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041386 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617eb98a1742d7102602f64c,"OPEN - GENERAL - V3",1635695104,1635694802,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}",,202062007,high,"2481a3ee-5287-49e0-90e0-8b83273079b2",1578,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635694980_36277_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202062007 - Edge 1578 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",617ebd0d80a98715a02dd997,"OPEN - GENERAL - V3",1635696003,1635695703,"alert_manager","","",,"{""edgeId"": ""942"", ""linkId"": ""1964"", ""interface"": ""GE3""}",,202040624,medium,"3702adfd-38fe-45ae-8f15-69797562743e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635695880_36393_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040624 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617ec2e71742d7102602f662,"OPEN - GENERAL - V3",1635697804,1635697202,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"ce517d88-c7e8-41ec-bcce-bf66b5d51b3a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635697380_36351_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ec8c480a98715a02dd9a8,"OPEN - GENERAL - V3",1635699002,1635698703,"alert_manager","","",,"{""edgeId"": ""972"", ""linkId"": ""2780"", ""interface"": ""GE4""}",,202040640,medium,"4c1d2c14-5fef-4a1f-ad71-5e8258ed88bd",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635698880_36490_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040640 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ecb1b1742d7102602f671,"OPEN - GENERAL - V3",1635704102,1635699304,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3331"", ""interface"": ""GE4""}",,202041335,medium,"ed7675ab-dd36-4429-90ea-985f4e7637f2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635699480_36427_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041335 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ed5a71742d7102602f67e,"OPEN - GENERAL - V3",1635709805,1635701704,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"1663fc31-9f66-4e0d-9b72-ebc847bf6c43",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635702180_36518_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617ed6d580a98715a02dd9be,"OPEN - GENERAL - V3",1635702605,1635702303,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,202041373,medium,"540b5df6-c642-489b-94f8-72d50fa59ac1",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635702480_36599_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ee60ff96ef44b7a120e02,"OPEN - GENERAL - V3",1635706505,1635706204,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}",,20197450,medium,"ef864271-925a-47d2-9c96-a8313853e0c7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635706380_36109_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617eef6e1742d7102602f6ac,"OPEN - GENERAL - V3",1635709503,1635708604,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3331"", ""interface"": ""GE4""}",,202041335,medium,"c236da50-feb2-440b-a631-d1ec847352eb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635708780_36738_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041335 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ef09e1742d7102602f6b8,"OPEN - GENERAL - V3",1635712203,1635708903,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,high,"cac08101-f95b-41da-bb0d-ea4cb88135c1",990,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635709080_36748_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,unassigned,,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041373 - Edge 990 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617ef1c81742d7102602f6be,"OPEN - GENERAL - V3",1635711904,1635709204,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,medium,"62abdc47-722e-422b-acf0-2bfde74083f4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635709380_36758_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617ef1c91742d7102602f6c0,"OPEN - GENERAL - V3",1635711604,1635709204,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,202041373,medium,"1bc80601-7de2-4627-bd42-3d2dd6c7f6c9",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635709380_36758_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617ef42080a98715a02dd9e5,"OPEN - GENERAL - V3",1635712203,1635709503,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,medium,"00d395b8-3159-40ba-b3bb-c6f1b0e8063f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635709980_36848_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617ef42180a98715a02dd9e7,"OPEN - GENERAL - V3",1635713403,1635709503,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}",,202041373,medium,"4e527595-34fc-4db8-bd4c-0730dbda46ed",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635709980_36848_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617efeaef96ef44b7a120e27,"OPEN - GENERAL - V3",1635713403,1635712504,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,high,"c71c3842-d5c5-4408-b9ba-b0e5d0e81428",990,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635712680_36294_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"202041373 - Edge 990 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617effd880a98715a02dda14,"OPEN - GENERAL - V3",1635713403,1635712804,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1831"", ""interface"": ""GE4""}",,202041373,medium,"349c763f-a4c7-46d7-847e-ba7e62745433",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635712980_36943_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041373 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617f0de780a98715a02dda2c,"OPEN - GENERAL - V3",1635720002,1635716403,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3331"", ""interface"": ""GE4""}",,202041335,medium,"64c2d9e7-6eed-48f5-81c5-129dac25d9ff",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635716580_37059_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202041335 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617f187580a98715a02dda4d,"OPEN - GENERAL - V3",1635729603,1635718802,"alert_manager","","",,"{""edgeId"": ""1577"", ""linkId"": ""5068"", ""interface"": ""GE3""}",,202185145,performance,"20518508-464d-463c-a50b-5f6944ac4b81",5068,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635719280_37146_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",unassigned,,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",4,"202185145 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617f2c5f1742d7102602f71d,"OPEN - GENERAL - V3",1635728404,1635724204,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"8dd75c2e-0918-4324-865f-c379531e67bf",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635724380_37260_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617f2eb61742d7102602f72a,"OPEN - GENERAL - V3",1635728702,1635724502,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}",,202040637,medium,"a6bd1fa0-840a-4b01-bd99-14557264e007",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635724980_37276_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"202040637 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617f35c01742d7102602f73e,"OPEN - GENERAL - V3",1635726904,1635726606,"alert_manager","","",,"{""edgeId"": ""418"", ""linkId"": ""1013"", ""interface"": ""GE3""}",,20197426,medium,"ead2eec5-9f3e-4581-9cbe-c9fab7200dc5",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635726780_37343_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"20197426 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617f381880a98715a02dda6f,"OPEN - GENERAL - V3",1635729303,1635727205,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,null,medium,"a7dc41ff-88f6-44af-b7e1-e1a52302e340",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635727380_37398_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",617f381c80a98715a02dda75,"OPEN - GENERAL - V3",1635729004,1635727205,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,null,high,"06aed8dc-34b0-4358-b442-ee7890b4069d",1543,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635727380_37398_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,unassigned,,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",1,"null - Edge 1543 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",617f3a7080a98715a02dda79,"OPEN - GENERAL - V3",1635729603,1635727502,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}",,null,medium,"0d0b3786-1d30-4a69-89d9-ef387b970542",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635727980_37416_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,unassigned,,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,closed,"","",2,"null - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617f3b9ef96ef44b7a120e6d,"OPEN - GENERAL - V3",0,1635727804,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}",,202046760,performance,"581d117f-d551-4213-ae42-e7e0b958cb83",3944,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635728280_36793_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent",unassigned,,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",4,"202046760 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",617f4adbf96ef44b7a120e96,"OPEN - GENERAL - V3",1635732303,1635732002,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2130"", ""interface"": ""GE3""}",,202040644,high,"c6d30083-7088-4043-a527-11195a7b398a",918,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635732180_36932_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,unassigned,,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040644 - Edge 918 entrou em status DEGRADED",86400,high
