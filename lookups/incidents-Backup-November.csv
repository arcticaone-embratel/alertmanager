AbertoTT,Cidade,Cliente,ClienteId,Estado,Localidade,Servico,Solucao,TipoNegocio,TipoServico,"_key",alert,"alert_close_time","alert_time",app,category,"display_fields","external_reference_id",extras,"falha_datacheck","group_id",host,impact,"incident_id",index,"job_id",metric,"numero_tt_siebel",owner,priority,"result_id",search,siebel,status,subcategory,tags,thresholdSeverityCode,title,ttl,urgency
"Não","","","","","N/A","","","","",616f061480a98715a02db004,"OPEN - GENERAL - V3",0,1634665803,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}","",,20197443,high,,408,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634665980_2692_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,critical,23,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"20197443 - Edge 408 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",616f072ef96ef44b7a11e3be,"OPEN - GENERAL - V3",0,1634666103,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}","",,20197443,medium,,GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666280_2660_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f072ff96ef44b7a11e3c0,"OPEN - GENERAL - V3",0,1634666103,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1184"", ""interface"": ""GE4""}","",,20197443,medium,"81f1691d-1a65-4ec5-be32-c6cf08a59670",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666280_2660_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f098680a98715a02db030,"OPEN - GENERAL - V3",0,1634666403,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1084"", ""interface"": ""GE3""}","",,20197443,medium,"a2ea496a-09bd-4370-9245-acdc9509e6fb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666880_2728_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",616f098780a98715a02db032,"OPEN - GENERAL - V3",0,1634666403,"alert_manager","","",,"{""edgeId"": ""408"", ""linkId"": ""1184"", ""interface"": ""GE4""}","",,20197443,medium,"ceda5f8a-207c-4637-8b1b-58db58b9372b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634666880_2728_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"20197443 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",616f63c780a98715a02db273,"OPEN - GENERAL - V3",0,1634689803,"alert_manager","","",,"{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}","",,202187680,high,"132ac232-f1c8-411c-acb5-80eccdef58b7",2081,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634689980_3585_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",1,"202187680 - Edge 2081 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",616f64ee80a98715a02db281,"OPEN - GENERAL - V3",0,1634690103,"alert_manager","","",,"{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}","",,202187680,medium,"1e89c5d9-9073-4de4-b371-23cfa259551d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634690280_3599_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202187680 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",616f6745f96ef44b7a11e6bf,"OPEN - GENERAL - V3",0,1634690404,"alert_manager","","",,"{""edgeId"": ""2081"", ""linkId"": ""5436"", ""interface"": ""GE3""}","",,202187680,medium,"c9e59c47-79a8-4ba5-999b-123676b4b577",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634690880_3575_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202187680 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",617081ae80a98715a02db69e,"OPEN - GENERAL - V3",0,1634762704,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","",,null,performance,"199fba0d-914b-4402-8592-7b0c116148f3",4487,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1634763180_6134_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"",unassigned,critical,0,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""199fba0d-914b-4402-8592-7b0c116148f3"", ""Descricao"": ""__201749053 --- 2021out21/TESTE 6, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",new,"","",4,"null - A Latência da interface GE3 excedeu o valor de 100",86400,low
,,,,,,,,,,617937f6f96ef44b7a11ffda,title,,1635344934,"alert_manager",unknown,"","",,"","",,low,"91d5954d-d9e5-4132-8d98-3f5db596980c",,bb57e30e74f00d0d9c6976b430cb24f0,,"",unassigned,"",0,"|noop",,new,unknown,"[Untagged]",,title,3600,low
"Não","","","","","N/A","","","","",6182737080a98715a02ddf24,"OPEN - GENERAL - V3",1637095508,1635938705,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}",,,202062017,performance,"1316efa2-989d-4469-b10f-356ca9ac429f",4563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1635939180_44121_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent",,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""1316efa2-989d-4469-b10f-356ca9ac429f"", ""Descricao"": ""__201749053 --- 2021nov04/TESTE 2, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": ""FABIODC"", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",closed,"","",4,"202062017 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
,,,,,,,,,,6183d05ef96ef44b7a12157b,testee,,1636039310,"alert_manager",carte,"","",,"","",,low,"bdb12e88-5f9c-49d0-9264-53858d781cea",,9a60c91029a5badee1ebb602a2c1bd20,,"",unassigned,"",0,"|noop",,new,subcate,tagss,,testee,3600,low
,,,,,,,,,,6183d0cdf96ef44b7a12157c,teste,,1636039421,"alert_manager",unknown,"","",,"","",,low,"19141baf-7c58-4768-95ad-69e30fb56dcb",,887b1058d8b796c27ba66294de74d14a,,"",unassigned,"",0,"|noop",,new,unknown,"[Untagged]",,teste,3600,low
"Não","","","","","N/A","","","","",6184495c86272b76bd56528b,"OPEN - GENERAL - V3",0,1636059303,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}",,,202183678,medium,"25a908a6-ded9-4585-a5fa-27b9e1623fa1",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636059480_686_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_TT_Cliente"": ""25a908a6-ded9-4585-a5fa-27b9e1623fa1"", ""Descricao"": ""__201749053 --- 2021nov08/TESTE 1, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": """", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",new,"","",2,"202183678 - Link GE1 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618453ea86272b76bd5652a8,"OPEN - GENERAL - V3",0,1636062002,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5047"", ""interface"": ""GE1""}","N/A",,202183678,high,"c0de3bd1-c168-4f95-a7ea-5004ac70ac8f",1935,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636062180_781_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202183678 - Edge 1935 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618455157c6d6919ea6b20d6,"OPEN - GENERAL - V3",0,1636062302,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5051"", ""interface"": ""GE2""}",,,202183678,medium,"21535f93-1c6a-4e11-86c0-7f83a3c55ffb",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636062480_850_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202183678 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6184576d86272b76bd5652ae,"OPEN - GENERAL - V3",0,1636062602,"alert_manager","","",,"{""edgeId"": ""1935"", ""linkId"": ""5051"", ""interface"": ""GE2""}","N/A",,202183678,medium,"9e3beeb5-db18-45d9-8209-ad24687fba6d",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636063080_808_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202183678 - Link GE2 entrou em status DISCONNECTED",86400,medium
"Não","Porto Alegre","ICATU SEGUROS S.A.","184103.0000000",RS,"N/A","SDWAN - VELOCLOUD",202191967,"ABORDAGEM SIMPLES",SDWAN,6186d8707c6d6919ea6b2624,"OPEN - GENERAL - V3",0,1636227002,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5547"", ""interface"": ""GE5""}",,,202191967,medium,"9bc88789-cd40-4541-b76e-6d6c4fac66b7",GE5,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636227180_6287_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"202191967 - Link GE5 entrou em status DISCONNECTED",86400,medium
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d01cb3ff371263162f6fa,"OPEN - GENERAL - V3",0,1636630803,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}","N/A",,201912633,medium,"8234583c-b27d-4571-a5fc-c2b232695519",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636630980_16020_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"201912633 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d01cc3ff371263162f6fc,"OPEN - GENERAL - V3",0,1636630803,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1230"", ""interface"": ""GE4""}","N/A",,201912633,medium,"4763ca7c-94ec-4f15-a074-b67db28f27ce",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636630980_16020_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"201912633 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d01cf3ff371263162f701,"OPEN - GENERAL - V3",0,1636630803,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}","N/A",,201912633,high,"fef94bf1-8ff8-4c65-b527-96d877a54548",407,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636630980_16020_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"201912633 - Edge 407 entrou em status OFFLINE",86400,high
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d04227c6d6919ea6b2b71,"OPEN - GENERAL - V3",0,1636631104,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1183"", ""interface"": ""GE3""}",,,201912633,medium,"efaa5dc9-d254-4984-a032-87f0c26608ec",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636631580_19369_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"201912633 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Goiânia","BANCO LOSANGO S.A. - BANCO MULTIPLO","133298.0000000",GO,"N/A",BRAD,201912633,LOSANGO,SDWAN,618d04237c6d6919ea6b2b73,"OPEN - GENERAL - V3",0,1636631104,"alert_manager","","",,"{""edgeId"": ""407"", ""linkId"": ""1230"", ""interface"": ""GE4""}",,,201912633,medium,"3cbdb611-5587-4a15-8637-0203b952f96e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636631580_19369_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,,unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description",,new,"","",2,"201912633 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Hortolândia","GERDAU AÇOS LONGOS SA","157246.0000000",SP,"",GRC,202043846,ALTO,MPLS,618eac5746080a1c83285881,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra097138.igs.gerd",high,"2a70f162-a629-4f1c-9c79-be669aeffe8f","GigabitEthernet0/0/0.40","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,0,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra097138.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/0.40",86400,high
"Não","Hortolândia","GERDAU AÇOS LONGOS SA","157246.0000000",SP,"",GRC,202043846,ALTO,MPLS,618eac5846080a1c83285883,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra097139.igs.gerd",high,"9881dbc8-72a3-40c2-b49c-f33a3fcdd624","GigabitEthernet0/0/0","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,1,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra097139.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/0",86400,high
"Não",Itabirito,"GERDAU AÇOS LONGOS SA","157388.0000000",MG,"",GRC,202043997,DADOS,DADOS,618eac5946080a1c83285885,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096323.igs.gerd",medium,"1bb8aa4c-f5ef-42eb-8e35-b546a26bca99","GigabitEthernet0/4.4","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,2,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096323.igs.gerd - Link Titular com status down na interface GigabitEthernet0/4.4",86400,medium
"Não",Itabirito,"GERDAU AÇOS LONGOS SA","157388.0000000",MG,"",GRC,202043997,DADOS,DADOS,618eac5a46080a1c83285887,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096323.igs.gerd",medium,"d5e7cf37-0fed-4406-b3ae-a5f5f7d72892","GigabitEthernet0/5.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,3,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096323.igs.gerd - Link Backup com status down na interface GigabitEthernet0/5.2",86400,medium
"Não","Ouro Branco","GERDAU ACOMINAS S A","157430.0000000",MG,"",GRC,202044033,ALTO,MPLS,618eac5b46080a1c83285889,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096324.igs.gerd",medium,"11b830f1-2db2-4ed6-9f5f-a4b53bedc7c9","GigabitEthernet0/0/1.4","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,4,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096324.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/1.4",86400,medium
"Não","Ouro Branco","GERDAU ACOMINAS S A","157430.0000000",MG,"",GRC,202044033,ALTO,MPLS,618eac5c46080a1c8328588b,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096324.igs.gerd",medium,"450ed949-85a8-49c3-bf9b-347eba599990","GigabitEthernet0/0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,5,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096324.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/2",86400,medium
"Não","Ouro Branco","GERDAU ACOMINAS S A","157430.0000000",MG,"",GRC,202044033,ALTO,MPLS,618eac5d46080a1c8328588d,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096602.igs.gerd",high,"d7bd6352-7c17-4167-99a4-0ec4367a85a3","GigabitEthernet0/0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,6,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096602.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/2.2",86400,high
"Não",Barueri,"GERDAU AÇOS LONGOS SA","157431.0000000",SP,"",GRC,202044034,ALTO,MPLS,618eac5e46080a1c8328588f,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096325.igs.gerd",high,"fb242617-f9df-4a7e-8a73-db9c48d76a56","GigabitEthernet0/0/2.19","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,7,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096325.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/2.19",86400,high
"Não",Barueri,"GERDAU AÇOS LONGOS SA","157431.0000000",SP,"",GRC,202044034,ALTO,MPLS,618eac5f46080a1c83285891,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096603.igs.gerd",high,"ebb91c4d-f9fb-4823-9212-4226471d44d5","GigabitEthernet0/0/1.5","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,8,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096603.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0/1.5",86400,high
"Não","São Paulo","GERDAU ACOMINAS S A","157432.0000000",SP,"",GRC,202044035,ALTO,MPLS,618eac6046080a1c83285893,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra097158.igs.gerd",medium,"640bc98e-4b8d-4fe2-962d-3cf93a480a9f","GigabitEthernet0/0/1.299","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,9,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra097158.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/1.299",86400,medium
"Não","São Paulo","GERDAU ACOMINAS S A","157432.0000000",SP,"",GRC,202044035,ALTO,MPLS,618eac6146080a1c83285895,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra097158.igs.gerd",medium,"2b5057ad-619f-4ac4-983f-62bcd413ee59","GigabitEthernet0/0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,10,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra097158.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/2",86400,medium
"Não","Sapucaia do Sul","GERDAU AÇOS LONGOS SA","157434.0000000",RS,"",GRC,202044037,ALTO,MPLS,618eac6246080a1c83285897,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096327.igs.gerd",medium,"5a94900a-8eb2-4734-9050-a8921ddaaf95","GigabitEthernet0/1.5","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,11,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096327.igs.gerd - Link Backup com status down na interface GigabitEthernet0/1.5",86400,medium
"Não","Sapucaia do Sul","GERDAU AÇOS LONGOS SA","157434.0000000",RS,"",GRC,202044037,ALTO,MPLS,618eac6346080a1c83285899,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096327.igs.gerd",medium,"4fd7a82b-1863-4b00-975e-38f852bb187c","GigabitEthernet0/2.23","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,12,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096327.igs.gerd - Link Titular com status down na interface GigabitEthernet0/2.23",86400,medium
"Não",Pindamonhangaba,"GERDAU S A","157435.0000000",SP,"",GRC,202044038,ALTO,MPLS,618eac6346080a1c8328589b,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096328.igs.gerd",medium,"135d0ce9-390d-4e68-a379-548af8813a56","GigabitEthernet0/0/0.20","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,13,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096328.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/0.20",86400,medium
"Não",Pindamonhangaba,"GERDAU S A","157435.0000000",SP,"",GRC,202044038,ALTO,MPLS,618eac6446080a1c8328589d,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096328.igs.gerd",medium,"51fe6fca-cc81-4e80-a738-1a43a68331e9","GigabitEthernet0/0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,14,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096328.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/2.2",86400,medium
"Não","Rio de Janeiro","GERDAU ACOMINAS S A","157436.0000000",RJ,"",GRC,202044039,ALTO,MPLS,618eac6546080a1c8328589f,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096329.igs.gerd",medium,"95398089-f05d-478f-ac29-9320ed103fa4","GigabitEthernet0/0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,15,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096329.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/1",86400,medium
"Não","Rio de Janeiro","GERDAU ACOMINAS S A","157436.0000000",RJ,"",GRC,202044039,ALTO,MPLS,618eac6646080a1c832858a1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096329.igs.gerd",medium,"317d38d5-bb22-493d-8d34-401007c65ec9","GigabitEthernet0/0/2.9","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,16,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096329.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/2.9",86400,medium
"Não",Charqueadas,"GERDAU S A","157437.0000000",RS,"",GRC,202044040,ALTO,MPLS,618eac6746080a1c832858a3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096330.igs.gerd",medium,"6d3fd687-a4a3-4ec6-a5c5-f23ddec26342","GigabitEthernet0/0/0","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,17,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096330.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/0",86400,medium
"Não",Charqueadas,"GERDAU S A","157437.0000000",RS,"",GRC,202044040,ALTO,MPLS,618eac6846080a1c832858a5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096330.igs.gerd",medium,"e9d2e732-3cf1-41fb-8a7a-2dd4c3fc908d","GigabitEthernet0/0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,18,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096330.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/1",86400,medium
"Não","São Paulo","GERDAU AÇOS LONGOS SA","157438.0000000",SP,"",GRC,202044041,MEDIO,MPLS,618eac6946080a1c832858a7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096331.igs.gerd",medium,"8efd0160-0c4b-4547-84c8-0c050bb403b9","GigabitEthernet0/1.46","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,19,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096331.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.46",86400,medium
"Não","São Paulo","GERDAU AÇOS LONGOS SA","157438.0000000",SP,"",GRC,202044041,MEDIO,MPLS,618eac6a46080a1c832858a9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096331.igs.gerd",medium,"56255b0b-3b12-4afe-8f2b-374888e4e0e2","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,20,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096331.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não","Aparecida de Goiânia","GERDAU AÇOS LONGOS SA","157439.0000000",GO,"",GRC,202044042,MEDIO,MPLS,618eac6b46080a1c832858ab,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096332.igs.gerd",medium,"8548cf3e-d890-499c-9fc9-60b6790f38c4","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,21,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096332.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Aparecida de Goiânia","GERDAU AÇOS LONGOS SA","157439.0000000",GO,"",GRC,202044042,MEDIO,MPLS,618eac6c46080a1c832858ad,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096332.igs.gerd",medium,"ced6b729-a077-4d76-96ad-cf45bd8c6756","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,22,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096332.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Contagem,"GERDAU AÇOS LONGOS SA","157440.0000000",MG,"",GRC,202044043,MEDIO,MPLS,618eac6d46080a1c832858af,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096333.igs.gerd",medium,"534e0366-cad2-458d-981f-607da0dc7739","GigabitEthernet0/1.25","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,23,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096333.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.25",86400,medium
"Não",Contagem,"GERDAU AÇOS LONGOS SA","157440.0000000",MG,"",GRC,202044043,MEDIO,MPLS,618eac6e46080a1c832858b1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096333.igs.gerd",medium,"d670e8c7-f475-4dae-8217-8796c4f5398a","GigabitEthernet0/2.172","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,24,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096333.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.172",86400,medium
"Não","Rio de Janeiro","GERDAU AÇOS LONGOS SA","157441.0000000",RJ,"",GRC,202044044,MEDIO,MPLS,618eac6f46080a1c832858b3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096346.igs.gerd",medium,"92724606-d64c-4f6f-88b8-b8fb36e23e25","GigabitEthernet0/1.24","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,25,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096346.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.24",86400,medium
"Não","Rio de Janeiro","GERDAU AÇOS LONGOS SA","157441.0000000",RJ,"",GRC,202044044,MEDIO,MPLS,618eac6f46080a1c832858b5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096346.igs.gerd",medium,"5d1b9393-a532-4aeb-bf5b-0908e966f26c","GigabitEthernet0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,26,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096346.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.2",86400,medium
"Não","São Caetano do Sul","GERDAU AÇOS LONGOS SA","157596.0000000",SP,"",GRC,202044216,MEDIO,MPLS,618eac7046080a1c832858b7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096348.igs.gerd",medium,"0dfb2af0-42ab-4f45-8345-13348991b52b","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,27,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096348.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","São Caetano do Sul","GERDAU AÇOS LONGOS SA","157596.0000000",SP,"",GRC,202044216,MEDIO,MPLS,618eac7146080a1c832858b9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096348.igs.gerd",medium,"4dd3b16e-61d1-4df5-be9c-24f72375f0de","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,28,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096348.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Recife,"GERDAU ACOMINAS S A","157597.0000000",PE,"",GRC,202044217,ALTO,MPLS,618eac7246080a1c832858bb,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096349.igs.gerd",medium,"2543e7e3-249b-4d4f-982b-a1f857e077d9","GigabitEthernet0/1.22","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,29,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096349.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.22",86400,medium
"Não",Recife,"GERDAU ACOMINAS S A","157597.0000000",PE,"",GRC,202044217,ALTO,MPLS,618eac7346080a1c832858bd,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096349.igs.gerd",medium,"d8a2a302-badd-4351-b0dc-a4e9b350b9e5","GigabitEthernet0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,30,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096349.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.2",86400,medium
"Não","Divinópolis","GERDAU ACOMINAS S A","157598.0000000",MG,"",GRC,202044218,MEDIO,MPLS,618eac7446080a1c832858bf,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096350.igs.gerd",medium,"72ec66fd-2268-4686-bbb3-abad4a564cb9","GigabitEthernet0/1.66","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,31,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096350.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.66",86400,medium
"Não","Divinópolis","GERDAU ACOMINAS S A","157598.0000000",MG,"",GRC,202044218,MEDIO,MPLS,618eac7546080a1c832858c1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096350.igs.gerd",medium,"2900af79-e1ec-4cd4-a0e1-3b5d6a04d453","GigabitEthernet0/2.5","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,32,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096350.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.5",86400,medium
"Não","São José dos Campos","GERDAU AÇOS LONGOS SA","157599.0000000",SP,"",GRC,202044219,MEDIO,MPLS,618eac7646080a1c832858c3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096352.igs.gerd",medium,"4afb0714-f3d8-4910-b96b-17e0bba350a4","GigabitEthernet0/1.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,33,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096352.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.2",86400,medium
"Não","São José dos Campos","GERDAU AÇOS LONGOS SA","157599.0000000",SP,"",GRC,202044219,MEDIO,MPLS,618eac7746080a1c832858c5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096352.igs.gerd",medium,"7c3e55c5-b6ec-4bce-83c4-3c56f43e95e5","GigabitEthernet0/2.17","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,34,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096352.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.17",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS SA","157600.0000000",BA,"",GRC,202044220,MEDIO,MPLS,618eac7746080a1c832858c7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096353.igs.gerd",medium,"92f82f9c-4e7b-41f5-876b-09c6e63afbdb","FastEthernet0/3/0.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,35,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096353.igs.gerd - Link Backup com status down na interface FastEthernet0/3/0.2",86400,medium
"Não","Simões Filho","GERDAU AÇOS LONGOS SA","157600.0000000",BA,"",GRC,202044220,MEDIO,MPLS,618eac7846080a1c832858c9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096353.igs.gerd",medium,"5ad4b16d-d794-4e3c-b8a2-8ad2a9275046","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,36,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096353.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Maracanaú","GERDAU ACOMINAS S A","157601.0000000",CE,"",GRC,202044221,ALTO,MPLS,618eac7946080a1c832858cb,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096354.igs.gerd",medium,"07567940-04db-48dd-8ca5-e4a16ab04477","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,37,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096354.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Maracanaú","GERDAU ACOMINAS S A","157601.0000000",CE,"",GRC,202044221,ALTO,MPLS,618eac7a46080a1c832858cd,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096354.igs.gerd",medium,"0de4a533-bb44-4a36-9685-3f44470e3ff3","GigabitEthernet0/2.3001","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,38,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096354.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.3001",86400,medium
"Não","Porto Alegre","GERDAU ACOMINAS S A","157595.0000000",RS,"",GRC,202044223,DADOS,DADOS,618eac7b46080a1c832858cf,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096357.igs.gerd",medium,"261bd753-9436-4fe4-a2d6-a12dc261aaeb","GigabitEthernet0/0.12","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,39,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096357.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0.12",86400,medium
"Não","Porto Alegre","GERDAU ACOMINAS S A","157595.0000000",RS,"",GRC,202044223,DADOS,DADOS,618eac7c46080a1c832858d1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096357.igs.gerd",medium,"aba6b474-8552-4393-8a9a-59a7ea97c1e8","GigabitEthernet0/1.105","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,40,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096357.igs.gerd - Link Backup com status down na interface GigabitEthernet0/1.105",86400,medium
"Não","Araçariguama","GERDAU AÇOS LONGOS SA","157602.0000000",SP,"",GRC,202044224,ALTO,MPLS,618eac7d46080a1c832858d3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096351.igs.gerd",medium,"ed42d53c-0289-4989-8f8b-fd8c5cba3709","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,41,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096351.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Araçariguama","GERDAU AÇOS LONGOS SA","157602.0000000",SP,"",GRC,202044224,ALTO,MPLS,618eac7e46080a1c832858d5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096351.igs.gerd",medium,"85ecc775-7a0f-476e-a05d-a667b504e3a7","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,42,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096351.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não","Miguel Burnier","GERDAU AÇOS LONGOS SA","157603.0000000",MG,"",GRC,202044225,MEDIO,MPLS,618eac7f46080a1c832858d7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096355.igs.gerd",high,"eba0431d-9c6d-46f2-8530-d19d08f0f30d","GigabitEthernet0/1.3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,43,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096355.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/1.3",86400,high
"Não","Miguel Burnier","GERDAU AÇOS LONGOS SA","157603.0000000",MG,"",GRC,202044225,MEDIO,MPLS,618eac8046080a1c832858d9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096604.igs.gerd",high,"f67dab7e-1df5-430d-be65-47e729d9fa67","GigabitEthernet0/0.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,44,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096604.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/0.2",86400,high
"Não","Cabo de Santo Agostinho","GERDAU AÇOS LONGOS SA","157842.0000000",PE,"",GRC,202044525,MEDIO,MPLS,618eac8146080a1c832858db,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096358.igs.gerd",medium,"aa6a4d67-ccd8-406c-b28e-e05713075762","GigabitEthernet0/1.28","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,45,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096358.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.28",86400,medium
"Não","Cabo de Santo Agostinho","GERDAU AÇOS LONGOS SA","157842.0000000",PE,"",GRC,202044525,MEDIO,MPLS,618eac8146080a1c832858dd,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096358.igs.gerd",medium,"917eb5b8-fb59-4a19-a0ac-a648b9230b4e","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,46,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096358.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Tijucas,"GERDAU AÇOS LONGOS SA","157843.0000000",SC,"",GRC,202044526,MEDIO,MPLS,618eac8246080a1c832858df,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096359.igs.gerd",medium,"39c56f2c-b9d4-4567-bacd-409160a3ba8d","GigabitEthernet0/1.3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,47,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096359.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.3",86400,medium
"Não",Tijucas,"GERDAU AÇOS LONGOS SA","157843.0000000",SC,"",GRC,202044526,MEDIO,MPLS,618eac8346080a1c832858e1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096359.igs.gerd",medium,"2d46c9fa-5304-4e59-8e47-1164cba0ff9e","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,48,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096359.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Itabirito,"GERDAU AÇOS LONGOS SA","157844.0000000",MG,"",GRC,202044527,MEDIO,MPLS,618eac8446080a1c832858e3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096360.igs.gerd",medium,"82efcdea-d699-4330-9a4e-28d91c39d56e","GigabitEthernet0/1.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,49,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096360.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.2",86400,medium
"Não",Itabirito,"GERDAU AÇOS LONGOS SA","157844.0000000",MG,"",GRC,202044527,MEDIO,MPLS,618eac8546080a1c832858e5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096360.igs.gerd",medium,"7108b515-be18-4ca5-9305-e2f98c87f5d9","GigabitEthernet0/2.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,50,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096360.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.2",86400,medium
"Não","Vitória","GERDAU ACOMINAS S A","157845.0000000",ES,"",GRC,202044528,MEDIO,MPLS,618eac8646080a1c832858e7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096361.igs.gerd",medium,"c6fc93f5-90b8-47e6-afac-271c370f39f9","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,51,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096361.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não","Vitória","GERDAU ACOMINAS S A","157845.0000000",ES,"",GRC,202044528,MEDIO,MPLS,618eac8746080a1c832858e9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096361.igs.gerd",medium,"360cabd9-4e34-49e0-bae7-5372cb16e5c6","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,52,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096361.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não","Sete Lagoas","GERDAU AÇOS LONGOS SA","157846.0000000",MG,"",GRC,202044529,MEDIO,MPLS,618eac8846080a1c832858eb,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096362.igs.gerd",high,"7800979d-b28e-4bec-b0f1-6ac8cded388c","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,53,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096362.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/1",86400,high
"Não","Barão de Cocais","GERDAU AÇOS LONGOS SA","157847.0000000",MG,"",GRC,202044530,MEDIO,MPLS,618eac8946080a1c832858ed,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096363.igs.gerd",medium,"3b6abbe2-ca9a-4b24-b82e-ce4ef22356bd","GigabitEthernet0/1.2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,54,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096363.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.2",86400,medium
"Não","Barão de Cocais","GERDAU AÇOS LONGOS SA","157847.0000000",MG,"",GRC,202044530,MEDIO,MPLS,618eac8a46080a1c832858ef,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096363.igs.gerd",medium,"0e9e7ec8-d9d8-47b5-be8c-37c39de4a6f3","GigabitEthernet0/2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,55,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096363.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2",86400,medium
"Não",Cotia,"GERDAU AÇOS LONGOS SA","157852.0000000",SP,"",GRC,202044531,MEDIO,MPLS,618eac8a46080a1c832858f1,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096364.igs.gerd",medium,"76f53b3e-10a9-44b6-8ac8-2c6e1807aa4e","GigabitEthernet0/1.41","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,56,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096364.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1.41",86400,medium
"Não",Cotia,"GERDAU AÇOS LONGOS SA","157852.0000000",SP,"",GRC,202044531,MEDIO,MPLS,618eac8b46080a1c832858f3,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096364.igs.gerd",medium,"66341d3f-1aed-4b82-bfe8-88308b40538b","GigabitEthernet0/2.301","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,57,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096364.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.301",86400,medium
"Não","Araucária","GERDAU AÇOS LONGOS SA","157848.0000000",PR,"",GRC,202044532,MEDIO,MPLS,618eac8c46080a1c832858f5,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096365.igs.gerd",medium,"7ba548f3-e461-463f-81a9-965131e0c9bf","GigabitEthernet0/0","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,58,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096365.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0",86400,medium
"Não","Araucária","GERDAU AÇOS LONGOS SA","157848.0000000",PR,"",GRC,202044532,MEDIO,MPLS,618eac8d46080a1c832858f7,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096365.igs.gerd",medium,"7f0d8268-bfdf-4c92-88f8-07131d385953",Multilink1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,59,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096365.igs.gerd - Link Backup com status down na interface Multilink1",86400,medium
"Não","Mogi das Cruzes","GERDAU S A","157849.0000000",SP,"",GRC,202044533,MEDIO,MPLS,618eac8e46080a1c832858f9,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096366.igs.gerd",medium,"c7bd226b-052e-4642-ada1-8cee694ac4ac","GigabitEthernet0/0/0","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,60,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096366.igs.gerd - Link Backup com status down na interface GigabitEthernet0/0/0",86400,medium
"Não","Mogi das Cruzes","GERDAU S A","157849.0000000",SP,"",GRC,202044533,MEDIO,MPLS,618eac8f46080a1c832858fb,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636740000,"alert_manager","","",,"N/A","N/A",,"ra096366.igs.gerd",medium,"970d2fde-3a34-4f53-aaaa-1c038ac1c929","GigabitEthernet0/0/1.27","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,61,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096366.igs.gerd - Link Titular com status down na interface GigabitEthernet0/0/1.27",86400,medium
"Não",Guarulhos,"GERDAU AÇOS LONGOS SA","157850.0000000",SP,"",GRC,202044534,MEDIO,MPLS,618eac9046080a1c832858fd,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096367.igs.gerd",medium,"468f285c-8358-465d-82cb-78de1715f90a","GigabitEthernet0/1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,62,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096367.igs.gerd - Link Titular com status down na interface GigabitEthernet0/1",86400,medium
"Não",Guarulhos,"GERDAU AÇOS LONGOS SA","157850.0000000",SP,"",GRC,202044534,MEDIO,MPLS,618eac9146080a1c832858ff,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra096367.igs.gerd",medium,"baa1c7c4-eda4-42a6-94de-b36a7aad84ba","GigabitEthernet0/2.58","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,63,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra096367.igs.gerd - Link Backup com status down na interface GigabitEthernet0/2.58",86400,medium
"Não",Guararu,"SIDERURGICA LATINO AMERICANA S A SILAT","171083.0000000",CE,"",GRC,202061359,DADOS,DADOS,618eac9246080a1c83285901,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra097512.igs.gerd",medium,"771c14dd-aafa-464e-aa3e-a1f799830ebf","GigabitEthernet0/4.17","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,64,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra097512.igs.gerd - Link Titular com status down na interface GigabitEthernet0/4.17",86400,medium
"Não",Guararu,"SIDERURGICA LATINO AMERICANA S A SILAT","171083.0000000",CE,"",GRC,202061359,DADOS,DADOS,618eac9346080a1c83285903,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636739700,"alert_manager","","",,"N/A","N/A",,"ra097512.igs.gerd",medium,"55586b5a-1d98-4ae2-af97-d57cf499a113","GigabitEthernet0/5.670","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636740180_3_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,65,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",2,"ra097512.igs.gerd - Link Backup com status down na interface GigabitEthernet0/5.670",86400,medium
"Não","","","","","N/A","","","","",618ee375fa57811c983eea6e,"OPEN - GENERAL - V3",1637064042,1636754103,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}","N/A",,202061989,high,"eb0896b1-fbb2-4d72-95d1-d635ebe45b6e",1567,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636754280_467_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061989 - Edge 1567 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618ee499512a4e102e43b885,"OPEN - GENERAL - V3",1637064042,1636754404,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}","N/A",,202061989,medium,"c54241a7-44bf-4d18-a64c-ee39f068342b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636754580_504_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061989 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618ee6f1512a4e102e43b898,"OPEN - GENERAL - V3",1637064328,1636754703,"alert_manager","","",,"{""edgeId"": ""1567"", ""linkId"": ""5191"", ""interface"": ""GE3""}","N/A",,202061989,medium,"8d37036f-0e68-4dbb-bdcf-dd59dd216638",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636755180_522_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061989 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618f958eb4a8174f7a50ebd7,"OPEN - GENERAL - V3",1637063729,1636799702,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,high,"375fa3a9-c987-4986-afef-fdf4c2bfc795",1566,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636799880_1980_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202162229 - Edge 1566 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",618f96b8fa57811c983ef8b8,"OPEN - GENERAL - V3",1637063729,1636800002,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,medium,"50cf40d1-e2fd-431f-9494-32257e524bce",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636800180_2043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202162229 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618f96b9fa57811c983ef8ba,"OPEN - GENERAL - V3",1637064042,1636800002,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""5612"", ""interface"": ""GE3""}","N/A",,202162229,medium,"fa293d3b-efd2-453a-9eef-c32b8281140b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636800180_2043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202162229 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",618f9910b4a8174f7a50ebde,"OPEN - GENERAL - V3",1637064042,1636800304,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,medium,"ec7bcd09-2e81-4854-8a6c-7da5d9f4896f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636800780_2008_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202162229 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618f9911b4a8174f7a50ebe1,"OPEN - GENERAL - V3",1637064328,1636800304,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""5612"", ""interface"": ""GE3""}","N/A",,202162229,medium,"770c5371-4c7b-4451-94ee-e2aa5f17542f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636800780_2008_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202162229 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",618fec43b4a8174f7a50f284,"OPEN - GENERAL - V3",1637064925,1636821904,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}","N/A",,202061983,medium,"7234edef-8686-4cbf-b020-c44d0011947a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636822080_2729_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061983 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Tijucas,"GERDAU AÇOS LONGOS SA","157843.0000000",SC,"",GRC,202044526,MEDIO,MPLS,6190a468b4a8174f7a50ff8f,"JOB - ABERTURA ALERTA NO ALERT MANAGER INTERFACES - MPLS",0,1636869000,"alert_manager","","",,"N/A","N/A",,"ra096359.igs.gerd",high,"bdf0c001-2ddc-4db0-8fba-84302dc60cc3","GigabitEthernet0/1.3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD51c707a48f50d8866_at_1636869180_4352_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",link,"N/A",unassigned,critical,45,"search index=snmp_if mib=IF-MIB oid!=""ifStackStatus*"" oid!=""ifStackLastChange*"" oid!=""ifTableLastChange*"" earliest=-6m@m latest=@m 
| table _time host oid snmp_index value 
| eval {oid} = value, Description = host
| fields - oid value 
| bin span=5m _time 
| stats values(*) as * by _time host Description snmp_index  
| where isnotnull(ifAdminStatus) AND isnotnull(ifOperStatus) 
| dedup host snmp_index 
| table _time host Description snmp_index ifAlias ifName ifDescr ifType ifSpeed ifAdminStatus ifOperStatus FUNCAO_INTERFACE 
| eval ifDescr = replace(ifDescr, "":"", ""."")
| lookup bdi_siebel host INTERFACE as ifDescr output FUNCAO_INTERFACE SOLUCAO_ID
| where isnotnull(FUNCAO_INTERFACE) AND (FUNCAO_INTERFACE = ""Titular"" OR FUNCAO_INTERFACE = ""Backup"")
| eval value = if(ifOperStatus = ""'up'"", ""True"", ""False"")
| eval aux = ifDescr . ""|"" . FUNCAO_INTERFACE . ""|"" . value
| eval host = SOLUCAO_ID
| stats values(orig_index) as orig_index values(aux) as aux dc(aux) as qtdeLinks count(eval(value = ""True"")) as qtdeLinksUP latest(_time) as _time by host Description
| fillnull qtdeLinksUP value=0
| mvexpand aux
| eval link = mvindex(split(aux, ""|""),0), funcao = mvindex(split(aux, ""|""),1), status = mvindex(split(aux, ""|""),2)
| where status != ""True""
| eval texto = case(qtdeLinks = 1, ""Equipamento com apenas 1 link com status down na interface "" . link, qtdeLinks > 1, ""Link "" . funcao . "" com status down na interface "" . link,   true(), ""NAO IMPLEMENTADO"")
| lookup siebel SOLUCAO AS host  output ESTADO CIDADE CLIENTE_ID CLIENTE TIPO_NEGOCIO TIPO_SERVICO SERVICO SOLUCAO PRIME_ID
| eval thresholdSeverityCode = case(qtdeLinks = 1, 3, qtdeLinks > 1,  2,   true(), 2)
| eval metric = ""link"", index=link, value = ""down"", templateName = ""Template FORTINET INTERFACES"",  thresholdType = ""="", thresholdValue = ""False"", message = texto, host = Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact, dataAbertura = _time
| rename ESTADO as Estado CIDADE as Cidade CLIENTE_ID as ClienteId CLIENTE as Cliente TIPO_NEGOCIO as TipoNegocio TIPO_SERVICO as TipoServico SERVICO as Servico SOLUCAO AS Solucao PRIME_ID as PrimeId
| table _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId","N/A",new,"","",3,"ra096359.igs.gerd - Equipamento com apenas 1 link com status down na interface GigabitEthernet0/1.3",86400,high
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e302512a4e102e43fa61,"OPEN - GENERAL - V3",1637059810,1636950604,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","N/A",,202041369,medium,"56e80a05-884b-4afd-a629-a3323e882d84",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636950780_7192_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041369 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e302512a4e102e43fa64,"OPEN - GENERAL - V3",1637060719,1636950604,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}","N/A",,202041369,medium,"c1c32317-0d7a-4a75-82aa-b053b014b87b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636950780_7192_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041369 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e305512a4e102e43fa6b,"OPEN - GENERAL - V3",1637059810,1636950604,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","N/A",,202041369,high,"9ae3f712-9dae-4155-84f9-9e39d6815e10",986,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636950780_7192_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041369 - Edge 986 entrou em status OFFLINE",86400,high
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e55afa57811c983f23ad,"OPEN - GENERAL - V3",1637059810,1636950902,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2121"", ""interface"": ""GE3""}","N/A",,202041369,medium,"b7032d49-e20e-48fb-bf37-b7bc9bcac22c",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636951380_7172_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041369 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Palmas,"GERDAU AÇOS LONGOS S A","155332.0000000",TO,"N/A","SDWAN - VELOCLOUD",202041369,BAIXO,SDWAN,6191e55bfa57811c983f23af,"OPEN - GENERAL - V3",1637061040,1636950902,"alert_manager","","",,"{""edgeId"": ""986"", ""linkId"": ""2122"", ""interface"": ""GE4""}","N/A",,202041369,medium,"981f983d-924d-4668-8da1-67937e68a0a5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636951380_7172_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041369 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","Cuiabá","BANCO LOSANGO S.A. - BANCO MULTIPLO","133302.0000000",MT,"N/A",BRAD,20197427,LOSANGO,SDWAN,619225cdfa57811c983f291b,"OPEN - GENERAL - V3",1637077205,1636967703,"alert_manager","","",,"{""edgeId"": ""413"", ""linkId"": ""1057"", ""interface"": ""GE3""}","N/A",,20197427,medium,"3f615b55-c32c-4246-88ff-09ec874daadb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636967880_7757_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197427 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61923763fa57811c983f29b4,"OPEN - GENERAL - V3",1637040073,1636971902,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"3d29f6b4-43f6-449e-be91-3ffabe443aa4",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636972380_7917_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,61925f3dfa57811c983f2bf5,"OPEN - GENERAL - V3",1637058306,1636982402,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}","N/A",,202041381,high,"b14f40a2-e495-4bce-9a25-685fd0f96001",1002,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636982580_8261_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041381 - Edge 1002 entrou em status DEGRADED",86400,high
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,61926064fa57811c983f2bfa,"OPEN - GENERAL - V3",1637058306,1636982702,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}","N/A",,202041381,medium,"1d737c82-ff4f-41a4-9a5a-93ad149c2e38",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636982880_8269_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041381 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,61926065fa57811c983f2bfd,"OPEN - GENERAL - V3",1637058306,1636982702,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}","N/A",,202041381,medium,"cca8ab8c-70b5-4d50-9f35-f2133e912588",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636982880_8269_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041381 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,61926197b4a8174f7a512316,"OPEN - GENERAL - V3",1637058606,1636982702,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}","N/A",,202041381,high,"3e2c0fa8-80d8-4834-86c5-9ae7a7a4ba9a",1002,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636983180_8233_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041381 - Edge 1002 entrou em status OFFLINE",86400,high
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,619262bbb4a8174f7a512350,"OPEN - GENERAL - V3",1637058606,1636983003,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""1950"", ""interface"": ""GE3""}","Equipamento PSYS","",202041381,medium,"47691844-39df-4d42-95eb-708cb2cf8c5a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636983480_8247_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"_PCBU1709-1-1334787499_",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","{""Identificador_Primesys"": ""PCBU1709-1-1334787499"", ""Identificador_TT_Cliente"": ""47691844-39df-4d42-95eb-708cb2cf8c5a"", ""Descricao"": ""__201749053 --- 2021nov15/TESTE 1, FAVOR DESCONSIDERAR. ---- CHAMADO DE TESTE DO SPLUNK, FAVOR DESCONSIDERAR: pacaembu-cco-fw-027 - Link acusou mais de 70% de utilização de banda"", ""Responsavel"": """", ""Data_Abertura"": ""17/09/2021 14:30"", ""Solucao_Id"": ""201749053"", ""Razao_Social"": ""PACAEMBU AUTOPEÇAS LTDA"", ""Prime_Id"": ""PCBU#BLD-FORT-CCO#00""}",closed,"","",2,"202041381 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","São Luís","GERDAU AÇOS LONGOS S A","155344.0000000",MA,"N/A","SDWAN - VELOCLOUD",202041381,BAIXO,SDWAN,619262bcb4a8174f7a512352,"OPEN - GENERAL - V3",1637058606,1636983003,"alert_manager","","",,"{""edgeId"": ""1002"", ""linkId"": ""2233"", ""interface"": ""GE4""}","N/A",,202041381,medium,"c0f9e563-fb9d-4985-8e12-bd0c47dbcc4c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1636983480_8247_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041381 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,6192b398b4a8174f7a5129bb,"OPEN - GENERAL - V3",1637074804,1637004003,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}","N/A",,202062013,medium,"2881d67c-20fe-4086-88d4-4766f0a9fcaf",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637004180_8945_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062013 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Natal,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133313.0000000",RN,"N/A",BRAD,20197433,LOSANGO,SDWAN,6192d599b4a8174f7a512cad,"OPEN - GENERAL - V3",1637047863,1637012166,"alert_manager","","",,"{""edgeId"": ""411"", ""linkId"": ""1040"", ""interface"": ""GE4""}","N/A",,20197433,performance,"3b0e89d6-89f5-475f-bdc6-4c31731a9476",1040,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637012880_9233_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"20197433 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61931d15b4a8174f7a5132e8,"OPEN - GENERAL - V3",1637031904,1637031019,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}","N/A",,202058022,high,"8b47c4c2-0ca0-4b07-b349-28bc2ecc7a65",458,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031180_9839_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058022 - Edge 458 entrou em status DEGRADED",86400,high
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,61931e3a512a4e102e4413d7,"OPEN - GENERAL - V3",1637031905,1637031316,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2256"", ""interface"": ""GE4""}","N/A",,202041385,medium,"d6f10a0b-1111-42fd-8f57-9ad01b284c30",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,61931e3b512a4e102e4413da,"OPEN - GENERAL - V3",1637031905,1637031316,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2257"", ""interface"": ""GE3""}","N/A",,202041385,medium,"e4b5139a-3935-4e7d-a6e3-b791121c26eb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61931e3d512a4e102e4413e0,"OPEN - GENERAL - V3",1637031905,1637031316,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4560"", ""interface"": ""GE4""}","N/A",,202061999,medium,"5c882cbe-5493-4c8d-a257-a97a28af5f04",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061999 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61931e3e512a4e102e4413e3,"OPEN - GENERAL - V3",1637031905,1637031316,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4562"", ""interface"": ""GE3""}","N/A",,202061999,medium,"3164d89b-aa18-4ba4-aaba-6a9e379aba0a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061999 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Guarulhos,"INCOTEP IND E COM DE TUBOS ESPECIAIS DE PRECISÃO LTDA","173563.0000000",SP,"N/A","SDWAN - VELOCLOUD",202168682,FLEX,SDWAN,61931e45512a4e102e4413f5,"OPEN - GENERAL - V3",1637031904,1637031316,"alert_manager","","",,"{""edgeId"": ""464"", ""linkId"": ""1584"", ""interface"": ""GE3""}","N/A",,202168682,high,"39148b34-d77e-404d-89a5-d9c9957b0123",464,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202168682 - Edge 464 entrou em status OFFLINE",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61931e47512a4e102e4413fa,"OPEN - GENERAL - V3",1637032862,1637031316,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"f4b59b62-a64d-4be7-a276-d43cfa97ee10",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031480_9917_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","Chapecó","ICATU SEGUROS S.A.","147736.0000000",SC,"N/A","SDWAN - VELOCLOUD",201922763,"ABORDAGEM SIMPLES",SDWAN,61931f6fb4a8174f7a513303,"OPEN - GENERAL - V3",1637035504,1637031019,"alert_manager","","",,"{""edgeId"": ""622"", ""linkId"": ""1418"", ""interface"": ""GE3""}","N/A",,201922763,performance,"f7452864-2638-4267-af71-833db760c7c0",1418,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031780_9861_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"201922763 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Jundiaí","SUBCONDOMINIO SHOPPING CENTER JUNDIAI SHOPPING","155272.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041335,LOJA,SDWAN,61931f70b4a8174f7a513306,"OPEN - GENERAL - V3",1637034606,1637031019,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","N/A",,202041335,performance,"02c932c7-bfb9-4a7d-9c45-e1e9ab579404",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637031780_9861_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,619322ecfa57811c983f3ce5,"OPEN - GENERAL - V3",1637032862,1637032557,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2256"", ""interface"": ""GE4""}","N/A",,202041385,medium,"64f0fde3-cc4b-4398-87fa-c1a879397362",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637032680_9989_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,619322ecfa57811c983f3ce7,"OPEN - GENERAL - V3",1637032862,1637032557,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2257"", ""interface"": ""GE3""}","N/A",,202041385,medium,"6f54ddb3-3d87-4d37-ab68-4828c8024ad7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637032680_9989_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,6193279bb4a8174f7a513402,"OPEN - GENERAL - V3",1637034026,1637033712,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2256"", ""interface"": ""GE4""}","N/A",,202041385,medium,"d75bde97-9026-4426-ab70-0099966a4974",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637033880_9933_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Teresina,"GERDAU AÇOS LONGOS S A","155348.0000000",PI,"N/A","SDWAN - VELOCLOUD",202041385,BAIXO,SDWAN,6193279cb4a8174f7a513404,"OPEN - GENERAL - V3",1637034026,1637033712,"alert_manager","","",,"{""edgeId"": ""1006"", ""linkId"": ""2257"", ""interface"": ""GE3""}","N/A",,202041385,medium,"5a584ccc-860c-434f-ad08-04ebab2e10b3",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637033880_9933_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041385 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193279eb4a8174f7a513407,"OPEN - GENERAL - V3",1637034026,1637033712,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4560"", ""interface"": ""GE4""}","N/A",,202061999,medium,"a748db8c-4628-4e13-951d-a249cb169b54",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637033880_9933_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061999 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193279fb4a8174f7a513409,"OPEN - GENERAL - V3",1637034026,1637033712,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4562"", ""interface"": ""GE3""}","N/A",,202061999,medium,"2224a0d4-ce32-4b92-9a04-7fe96f0b0eb4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637033880_9933_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061999 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133285.0000000",PR,"N/A",BRAD,20197418,LOSANGO,SDWAN,619328c7fa57811c983f3cfd,"OPEN - GENERAL - V3",1637034332,1637034026,"alert_manager","","",,"{""edgeId"": ""1065"", ""linkId"": ""2389"", ""interface"": ""GE2""}","N/A",,20197418,medium,"49324706-7d95-4254-ab58-d826863be170",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034180_10043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197418 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133285.0000000",PR,"N/A",BRAD,20197418,LOSANGO,SDWAN,619328c8fa57811c983f3cff,"OPEN - GENERAL - V3",1637034332,1637034026,"alert_manager","","",,"{""edgeId"": ""1065"", ""linkId"": ""2390"", ""interface"": ""GE3""}","N/A",,20197418,medium,"0f6813c6-5898-4845-a1e5-beb5a422217d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034180_10043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197418 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Belo Horizonte","BANCO LOSANGO S.A. - BANCO MULTIPLO","162999.0000000",MG,"N/A",BRAD,202050954,LOSANGO,SDWAN,619328c9fa57811c983f3d01,"OPEN - GENERAL - V3",1637034332,1637034026,"alert_manager","","",,"{""edgeId"": ""1319"", ""linkId"": ""3559"", ""interface"": ""GE3""}","N/A",,202050954,medium,"a904651a-42b2-484a-8bec-674f7e3cd8bc",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034180_10043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202050954 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Belo Horizonte","BANCO LOSANGO S.A. - BANCO MULTIPLO","162999.0000000",MG,"N/A",BRAD,202050954,LOSANGO,SDWAN,619328cafa57811c983f3d03,"OPEN - GENERAL - V3",1637034332,1637034026,"alert_manager","","",,"{""edgeId"": ""1319"", ""linkId"": ""3617"", ""interface"": ""GE4""}","N/A",,202050954,medium,"91320b11-b2d8-448a-ac8b-58e74323e866",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034180_10043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202050954 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619328cbfa57811c983f3d05,"OPEN - GENERAL - V3",1637034332,1637034026,"alert_manager","","",,"{""edgeId"": ""1543"", ""linkId"": ""4487"", ""interface"": ""GE3""}","N/A",,null,medium,"1a4660a0-b92a-4a48-bf4d-da7abc7a49bf",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034180_10043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"null - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619328cdfa57811c983f3d08,"OPEN - GENERAL - V3",1637034332,1637034026,"alert_manager","","",,"{""edgeId"": ""1568"", ""linkId"": ""4268"", ""interface"": ""GE4""}","N/A",,202061992,medium,"6b9fd195-a149-44df-ad6a-20b48ba2529a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034180_10043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061992 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619328cdfa57811c983f3d0a,"OPEN - GENERAL - V3",1637034332,1637034026,"alert_manager","","",,"{""edgeId"": ""1568"", ""linkId"": ""4270"", ""interface"": ""GE3""}","N/A",,202061992,medium,"48ff42f3-bf1e-4166-b575-db0c8b94b5bc",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034180_10043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061992 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,619328d0fa57811c983f3d0e,"OPEN - GENERAL - V3",1637034332,1637034026,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,medium,"23ce7d31-b31b-4058-a392-a8206deb5576",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034180_10043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,619328d1fa57811c983f3d10,"OPEN - GENERAL - V3",1637034332,1637034026,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3602"", ""interface"": ""GE4""}","N/A",,202041328,medium,"c6ba929e-21cb-463a-96aa-f7b344df51bb",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034180_10043_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São Leopoldo","GERDAU AÇOS LONGOS S A","155345.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041382,BAIXO,SDWAN,61932b24512a4e102e4415d2,"OPEN - GENERAL - V3",1637034903,1637034606,"alert_manager","","",,"{""edgeId"": ""1001"", ""linkId"": ""2125"", ""interface"": ""GE4""}","N/A",,202041382,high,"6642e310-34c1-4954-a04e-63671be206f8",1001,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034780_10022_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041382 - Edge 1001 entrou em status DEGRADED",86400,high
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,61932b26512a4e102e4415d5,"OPEN - GENERAL - V3",1637034903,1637034606,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}","N/A",,202041366,high,"f47cf688-8781-41f9-bf9b-82966dafb3d4",983,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637034780_10022_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041366 - Edge 983 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61932c52b4a8174f7a513462,"OPEN - GENERAL - V3",1637035203,1637034903,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"63ff564a-a7f3-486b-920e-c8e0af1e3463",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637035080_9978_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","Jundiaí","SUBCONDOMINIO SHOPPING CENTER JUNDIAI SHOPPING","155272.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041335,LOJA,SDWAN,61933b8dfa57811c983f3e88,"OPEN - GENERAL - V3",1637049360,1637038205,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","N/A",,202041335,performance,"1ae7015c-7f97-4656-9bfa-7e7a260eb5d6",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637038980_10219_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","packet_loss_percent","N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Vitória da Conquista","GERDAU AÇOS LONGOS S A","154975.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040673,BAIXO,SDWAN,61934294512a4e102e441701,"OPEN - GENERAL - V3",1637041206,1637040605,"alert_manager","","",,"{""edgeId"": ""1010"", ""linkId"": ""2011"", ""interface"": ""GE3""}","N/A",,202040673,high,"060ddd67-0170-4242-a8c0-3807be1bddbf",1010,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637040780_10224_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040673 - Edge 1010 entrou em status DEGRADED",86400,high
"Não","Brasília","BANCO LOSANGO S.A. - BANCO MULTIPLO","133331.0000000",DF,"N/A",BRAD,20197440,LOSANGO,SDWAN,61934295512a4e102e441706,"OPEN - GENERAL - V3",1637040906,1637040605,"alert_manager","","",,"{""edgeId"": ""428"", ""linkId"": ""1151"", ""interface"": ""GE3""}","N/A",,20197440,high,"42b8e484-4b99-45a2-86bb-389b456f9f6a",428,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637040780_10224_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197440 - Edge 428 entrou em status DEGRADED",86400,high
"Não",Aracaju,"GERDAU AÇOS LONGOS S A","154956.0000000",SE,"N/A","SDWAN - VELOCLOUD",202040649,BAIXO,SDWAN,61934297512a4e102e44170b,"OPEN - GENERAL - V3",1637041206,1637040605,"alert_manager","","",,"{""edgeId"": ""946"", ""linkId"": ""1858"", ""interface"": ""GE4""}","N/A",,202040649,high,"2708ce98-cdad-49d6-8b6e-80a1450faa8e",946,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637040780_10224_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040649 - Edge 946 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",619343bb512a4e102e441745,"OPEN - GENERAL - V3",1637041206,1637040906,"alert_manager","","",,"{""edgeId"": ""1561"", ""linkId"": ""4120"", ""interface"": ""GE4""}","N/A",,202062021,medium,"3cc53823-0517-4ab7-9836-c403a9d25100",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041080_10236_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062021 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Fortaleza,"GERDAU AÇOS LONGOS S A","154963.0000000",CE,"N/A","SDWAN - VELOCLOUD",202040661,BAIXO,SDWAN,619343c3512a4e102e44175c,"OPEN - GENERAL - V3",1637041206,1637040906,"alert_manager","","",,"{""edgeId"": ""964"", ""linkId"": ""2274"", ""interface"": ""GE3""}","N/A",,202040661,high,"834f6d28-ffdb-4ad8-9613-9399682e9855",964,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041080_10236_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040661 - Edge 964 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",619344e7b4a8174f7a5136c4,"OPEN - GENERAL - V3",1637041505,1637041206,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4560"", ""interface"": ""GE4""}","N/A",,202061999,medium,"7884de48-461d-4133-96d2-8327e6eb8257",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041380_10174_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061999 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619344e8b4a8174f7a5136c6,"OPEN - GENERAL - V3",1637041505,1637041206,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4562"", ""interface"": ""GE3""}","N/A",,202061999,medium,"b7000bf2-0f1f-478b-b690-a1c2c08a02d7",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041380_10174_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061999 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619344ebb4a8174f7a5136ca,"OPEN - GENERAL - V3",1637041505,1637041206,"alert_manager","","",,"{""edgeId"": ""459"", ""linkId"": ""1635"", ""interface"": ""GE4""}","N/A",,202058027,medium,"d6714986-f0d1-4119-a6fd-1f8f8ca0ddc5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041380_10174_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058027 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619344ecb4a8174f7a5136cc,"OPEN - GENERAL - V3",1637041505,1637041206,"alert_manager","","",,"{""edgeId"": ""459"", ""linkId"": ""1838"", ""interface"": ""GE3""}","N/A",,202058027,medium,"ea9d8104-3cd7-434b-9ac7-6fc447c57714",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041380_10174_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058027 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Aracaju,"GERDAU AÇOS LONGOS S A","154956.0000000",SE,"N/A","SDWAN - VELOCLOUD",202040649,BAIXO,SDWAN,619344edb4a8174f7a5136ce,"OPEN - GENERAL - V3",1637041505,1637041206,"alert_manager","","",,"{""edgeId"": ""946"", ""linkId"": ""1858"", ""interface"": ""GE4""}","N/A",,202040649,medium,"d65ba381-d8ac-412b-8cda-d307db65a40a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041380_10174_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040649 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Aracaju,"GERDAU AÇOS LONGOS S A","154956.0000000",SE,"N/A","SDWAN - VELOCLOUD",202040649,BAIXO,SDWAN,619344eeb4a8174f7a5136d0,"OPEN - GENERAL - V3",1637041505,1637041206,"alert_manager","","",,"{""edgeId"": ""946"", ""linkId"": ""1981"", ""interface"": ""GE3""}","N/A",,202040649,medium,"06978217-4102-4f1b-847f-012021fdb116",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041380_10174_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040649 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619344f2b4a8174f7a5136d5,"OPEN - GENERAL - V3",1637041505,1637041206,"alert_manager","","",,"{""edgeId"": ""1560"", ""linkId"": ""4016"", ""interface"": ""GE3""}","N/A",,202061994,high,"c6cf2c01-864e-4829-92e5-481670138a07",1560,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041380_10174_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061994 - Edge 1560 entrou em status OFFLINE",86400,high
"Não","Campo Grande","GERDAU AÇOS LONGOS S A","154946.0000000",MS,"N/A","SDWAN - VELOCLOUD",202040654,BAIXO,SDWAN,619344f4b4a8174f7a5136d8,"OPEN - GENERAL - V3",1637042158,1637041206,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""1867"", ""interface"": ""GE3""}","N/A",,202040654,high,"13c5576c-149b-4ab4-8f86-a67001d30853",953,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041380_10174_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040654 - Edge 953 entrou em status OFFLINE",86400,high
"Não",Fortaleza,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133294.0000000",CE,"N/A",BRAD,20197423,LOSANGO,SDWAN,61934616fa57811c983f3f26,"OPEN - GENERAL - V3",1637042158,1637041505,"alert_manager","","",,"{""edgeId"": ""416"", ""linkId"": ""1039"", ""interface"": ""GE4""}","N/A",,20197423,medium,"e7ec57b2-3e59-48d5-9f9b-db7ff5429a07",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041680_10323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197423 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Fortaleza,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133294.0000000",CE,"N/A",BRAD,20197423,LOSANGO,SDWAN,61934617fa57811c983f3f28,"OPEN - GENERAL - V3",1637042158,1637041505,"alert_manager","","",,"{""edgeId"": ""416"", ""linkId"": ""961"", ""interface"": ""GE3""}","N/A",,20197423,medium,"f1d8a767-f75d-46d2-93c8-b2f0c2398484",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637041680_10323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197423 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Salvador,"GERDAU AÇOS LONGOS S A","154971.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040669,BAIXO,SDWAN,6193486efa57811c983f3f73,"OPEN - GENERAL - V3",0,1637042158,"alert_manager","","",,"{""edgeId"": ""999"", ""linkId"": ""2280"", ""interface"": ""GE4""}","N/A",,202040669,medium,"06bc55ef-f7b7-4b68-886d-835ed578467e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637042280_10343_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202040669 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",61934872fa57811c983f3f78,"OPEN - GENERAL - V3",1637042703,1637042158,"alert_manager","","",,"{""edgeId"": ""1561"", ""linkId"": ""4120"", ""interface"": ""GE4""}","N/A",,202062021,high,"631a11fd-95c0-4773-9102-1d3d5635f25a",1561,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637042280_10343_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062021 - Edge 1561 entrou em status DEGRADED",86400,high
"Não","Salto Grande","PB LOPES & CIA LTDA","170044.0000000",SP,"N/A","SDWAN - VELOCLOUD",202059976,SDWAN,SDWAN,61934f73fa57811c983f404d,"OPEN - GENERAL - V3",1637044506,1637043941,"alert_manager","","",,"{""edgeId"": ""1269"", ""linkId"": ""3340"", ""interface"": ""GE3""}","N/A",,202059976,medium,"21339708-53d5-42b4-ba76-8e7fa2df40b6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044080_10418_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202059976 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Caruaru,"GERDAU AÇOS LONGOS S A","154938.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040637,BAIXO,SDWAN,61934f74fa57811c983f4050,"OPEN - GENERAL - V3",1637044506,1637043941,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3200"", ""interface"": ""GE3""}","N/A",,202040637,medium,"3f42d905-7069-4192-9f7a-18ada6e2c352",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044080_10418_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040637 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Caruaru,"GERDAU AÇOS LONGOS S A","154938.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040637,BAIXO,SDWAN,61934f75fa57811c983f4053,"OPEN - GENERAL - V3",1637044506,1637043941,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3214"", ""interface"": ""GE4""}","N/A",,202040637,medium,"b5919f57-684d-4ccc-858c-df545a51c58c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044080_10418_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040637 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Cascavel,"GERDAU AÇOS LONGOS S A","154947.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040655,BAIXO,SDWAN,61934f79fa57811c983f405c,"OPEN - GENERAL - V3",1637044506,1637043941,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""1870"", ""interface"": ""GE3""}","N/A",,202040655,medium,"f85057df-4584-4ed9-807c-59fc5c22d07a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044080_10418_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040655 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Cascavel,"GERDAU AÇOS LONGOS S A","154947.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040655,BAIXO,SDWAN,61934f7afa57811c983f405f,"OPEN - GENERAL - V3",1637044506,1637043941,"alert_manager","","",,"{""edgeId"": ""955"", ""linkId"": ""2753"", ""interface"": ""GE4""}","N/A",,202040655,medium,"9d6a5f49-95c4-4412-920b-77be70950d91",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044080_10418_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040655 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61934f7ffa57811c983f406a,"OPEN - GENERAL - V3",1637044216,1637043941,"alert_manager","","",,"{""edgeId"": ""459"", ""linkId"": ""1635"", ""interface"": ""GE4""}","N/A",,202058027,high,"00c8840f-f13a-450c-8c14-faed95da3ae8",459,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044080_10418_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058027 - Edge 459 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61934f81fa57811c983f406f,"OPEN - GENERAL - V3",1637044216,1637043941,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"c0e0c047-c2ae-4b9b-9f1f-2552e2b9ca3b",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044080_10418_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status OFFLINE",86400,high
"Não","Campina Grande","GERDAU AÇOS LONGOS S A","154942.0000000",PB,"N/A","SDWAN - VELOCLOUD",202040636,BAIXO,SDWAN,619351cd512a4e102e441873,"OPEN - GENERAL - V3",1637044826,1637044506,"alert_manager","","",,"{""edgeId"": ""952"", ""linkId"": ""2202"", ""interface"": ""GE3""}","N/A",,202040636,medium,"196d0ddb-1afe-4b6a-88d5-5b6ae65c7851",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044680_10342_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040636 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Recife,"GERDAU AÇOS LONGOS S A","154943.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040641,BAIXO,SDWAN,619351d1512a4e102e44187d,"OPEN - GENERAL - V3",1637044826,1637044506,"alert_manager","","",,"{""edgeId"": ""914"", ""linkId"": ""2054"", ""interface"": ""GE3""}","N/A",,202040641,high,"964921a5-b5cc-4269-9d32-8668a2cfa3ab",914,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044680_10342_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040641 - Edge 914 entrou em status DEGRADED",86400,high
"Não","Campina Grande","GERDAU AÇOS LONGOS S A","154942.0000000",PB,"N/A","SDWAN - VELOCLOUD",202040636,BAIXO,SDWAN,619351d2512a4e102e441882,"OPEN - GENERAL - V3",1637044826,1637044506,"alert_manager","","",,"{""edgeId"": ""952"", ""linkId"": ""2202"", ""interface"": ""GE3""}","N/A",,202040636,high,"e29f15b7-9cab-4928-b2c1-0da60297a71b",952,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044680_10342_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040636 - Edge 952 entrou em status DEGRADED",86400,high
"Não","Brasília","BANCO LOSANGO S.A. - BANCO MULTIPLO","133296.0000000",DF,"N/A",BRAD,20197424,LOSANGO,SDWAN,619352fc512a4e102e4418c3,"OPEN - GENERAL - V3",1637045183,1637044826,"alert_manager","","",,"{""edgeId"": ""420"", ""linkId"": ""1175"", ""interface"": ""GE3""}","N/A",,20197424,high,"63244923-2e96-407b-9531-431ccaa659f2",420,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044980_10353_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197424 - Edge 420 entrou em status DEGRADED",86400,high
"Não","São Caetano do Sul","CONSORCIO SHOPPING SÃO CAETANO","155274.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041332,LOJA,SDWAN,619352fe512a4e102e4418c7,"OPEN - GENERAL - V3",1637045183,1637044826,"alert_manager","","",,"{""edgeId"": ""936"", ""linkId"": ""3332"", ""interface"": ""GE3""}","N/A",,202041332,high,"36d67250-6ab3-4ac7-8f57-21623b9f9bdf",936,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637044980_10353_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041332 - Edge 936 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61935428512a4e102e4418d2,"OPEN - GENERAL - V3",1637045447,1637045183,"alert_manager","","",,"{""edgeId"": ""1572"", ""linkId"": ""4560"", ""interface"": ""GE4""}","N/A",,202061999,high,"72754455-3168-43e0-b901-2f66436bc2f1",1572,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637045280_10362_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061999 - Edge 1572 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61935550512a4e102e4418d8,"OPEN - GENERAL - V3",1637045793,1637045447,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"b69730c0-6522-43e7-ad46-d56ccb13fa82",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637045580_10372_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61935682fa57811c983f4133,"OPEN - GENERAL - V3",1637046025,1637045793,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"a8bc44ac-bd06-405a-a4a8-b460d73e7693",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637045880_10488_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61935fddb4a8174f7a513845,"OPEN - GENERAL - V3",1637048714,1637048126,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"d5e78def-e01e-4344-95ee-742d7ae48447",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637048280_10405_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61936238fa57811c983f42bd,"OPEN - GENERAL - V3",1637049027,1637048714,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"919f7009-da88-4655-a378-d8caf2720b13",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637048880_10589_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","Campo Grande","PB LOPES & CIA LTDA","170045.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059977,SDWAN,SDWAN,61936363512a4e102e441994,"OPEN - GENERAL - V3",1637049360,1637049027,"alert_manager","","",,"{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}","N/A",,202059977,high,"bdd6fcad-e325-4357-b2ef-62157a15ef76",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637049180_10496_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","Rio de Janeiro","ASSOCIAÇÃO DOS LOJISTAS DO SHOPPING VILLAGE MALL","169739.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202059393,LOJA,SDWAN,61936364512a4e102e441997,"OPEN - GENERAL - V3",1637049360,1637049027,"alert_manager","","",,"{""edgeId"": ""1312"", ""linkId"": ""3525"", ""interface"": ""GE3""}","N/A",,202059393,high,"4b863537-fc6e-4193-bbac-d888dda253ce",1312,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637049180_10496_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059393 - Edge 1312 entrou em status DEGRADED",86400,high
"Não","Belo Horizonte","BANCO LOSANGO S.A. - BANCO MULTIPLO","133300.0000000",MG,"N/A",BRAD,20197426,LOSANGO,SDWAN,61936366512a4e102e44199c,"OPEN - GENERAL - V3",1637049360,1637049027,"alert_manager","","",,"{""edgeId"": ""418"", ""linkId"": ""1013"", ""interface"": ""GE3""}","N/A",,20197426,high,"be904977-0260-4c32-8372-86304d01cbae",418,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637049180_10496_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197426 - Edge 418 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",619366e4512a4e102e441a17,"OPEN - GENERAL - V3",1637050282,1637049940,"alert_manager","","",,"{""edgeId"": ""1565"", ""linkId"": ""4052"", ""interface"": ""GE4""}","N/A",,202061991,medium,"26bf6bbc-f581-48bc-a7bb-8ec7ceafb2d9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637050080_10525_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061991 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619366e4512a4e102e441a19,"OPEN - GENERAL - V3",1637050282,1637049940,"alert_manager","","",,"{""edgeId"": ""1565"", ""linkId"": ""5193"", ""interface"": ""GE3""}","N/A",,202061991,medium,"7c088d3a-da55-4cdc-ab70-f74b11f4db71",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637050080_10525_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061991 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619366e5512a4e102e441a1b,"OPEN - GENERAL - V3",1637050282,1637049940,"alert_manager","","",,"{""edgeId"": ""1569"", ""linkId"": ""4222"", ""interface"": ""GE3""}","N/A",,202062019,medium,"55fb09a4-5bb4-4178-92ed-252e5178bc3b",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637050080_10525_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062019 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619366e6512a4e102e441a1d,"OPEN - GENERAL - V3",1637050282,1637049940,"alert_manager","","",,"{""edgeId"": ""1569"", ""linkId"": ""4223"", ""interface"": ""GE4""}","N/A",,202062019,medium,"9da92bf8-87d6-4a14-8e28-ec9c228bbcb4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637050080_10525_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062019 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Araquari,"GERDAU AÇOS LONGOS S A","154937.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040635,BAIXO,SDWAN,619366ea512a4e102e441a23,"OPEN - GENERAL - V3",1637050282,1637049940,"alert_manager","","",,"{""edgeId"": ""971"", ""linkId"": ""2062"", ""interface"": ""GE3""}","N/A",,202040635,high,"63907dd0-7dd8-4b15-a399-a16c5c6f2f71",971,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637050080_10525_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040635 - Edge 971 entrou em status OFFLINE",86400,high
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,6193693d512a4e102e441a2a,"OPEN - GENERAL - V3",1637050821,1637050546,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}","N/A",,202041378,medium,"02a4941d-756e-40ee-85b6-28c18ee95838",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637050680_10548_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Governador Valadares","GERDAU AÇOS LONGOS S A","154965.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040663,BAIXO,SDWAN,61936940512a4e102e441a2e,"OPEN - GENERAL - V3",1637051139,1637050546,"alert_manager","","",,"{""edgeId"": ""967"", ""linkId"": ""2103"", ""interface"": ""GE3""}","N/A",,202040663,high,"369a2dba-1c73-4cc0-8738-6074bbb89b10",967,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637050680_10548_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040663 - Edge 967 entrou em status DEGRADED",86400,high
"Não","Novo Hamburgo","GERDAU AÇOS LONGOS S A","155331.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041368,BAIXO,SDWAN,61936941512a4e102e441a31,"OPEN - GENERAL - V3",1637051139,1637050546,"alert_manager","","",,"{""edgeId"": ""985"", ""linkId"": ""2218"", ""interface"": ""GE3""}","N/A",,202041368,high,"babb3604-2e3a-4c17-8c36-9dfea6965fef",985,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637050680_10548_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041368 - Edge 985 entrou em status DEGRADED",86400,high
"Não","Rio de Janeiro","PARKJACAREPAGUA EMPREENDIMENTO IMOBILIARIO LTDA","182725.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202188378,LOJA,SDWAN,61936b97b4a8174f7a513923,"OPEN - GENERAL - V3",1637051724,1637051139,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}","N/A",,202188378,high,"552b5d92-1fe2-4829-9812-68f1c7a5d9f2",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637051280_10506_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202188378 - Edge 2107 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,619373cbb4a8174f7a5139ec,"OPEN - GENERAL - V3",1637054134,1637053234,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"c617d059-598f-47e4-abf7-0008f96d87bc",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637053380_10579_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",619374f8fa57811c983f4434,"OPEN - GENERAL - V3",1637053828,1637053517,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",high,"f01452c5-4309-4b56-84a6-0bf495bd62c8",2088,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637053680_10742_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Edge 2088 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",619374f9fa57811c983f4437,"OPEN - GENERAL - V3",1637053828,1637053517,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5336"", ""interface"": ""GE2""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",high,"0c5f2c3c-6a66-44f8-a7d4-feb01a5f66ec",2088,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637053680_10742_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Edge 2088 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61937621b4a8174f7a5139f2,"OPEN - GENERAL - V3",1637054135,1637053828,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"fff47a18-814d-47e4-8709-c67533271597",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637053980_10598_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Barão de Cocais","GERDAU AÇOS LONGOS S A","154950.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040643,BAIXO,SDWAN,61937f84b4a8174f7a513acb,"OPEN - GENERAL - V3",1637056511,1637056223,"alert_manager","","",,"{""edgeId"": ""917"", ""linkId"": ""2316"", ""interface"": ""GE3""}","N/A",,202040643,high,"7fc57050-ce94-4b78-a052-ab38b96e4dfe",917,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637056380_10687_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040643 - Edge 917 entrou em status OFFLINE",86400,high
"Não","Ladário","PB LOPES & CIA LTDA","170046.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059978,SDWAN,SDWAN,619380af512a4e102e441c18,"OPEN - GENERAL - V3",1637056804,1637056511,"alert_manager","","",,"{""edgeId"": ""1267"", ""linkId"": ""3881"", ""interface"": ""GE3""}","N/A",,202059978,high,"f5d97c28-d306-4698-86fa-547522a8ecc8",1267,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637056680_10760_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202059978 - Edge 1267 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61938688512a4e102e441c63,"OPEN - GENERAL - V3",1637058306,1637058007,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"bb0bcef5-a162-467b-acc3-16eda12a2ea2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637058180_10812_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Porto Alegre","ICATU SEGUROS S.A.","184103.0000000",RS,"N/A","SDWAN - VELOCLOUD",202191967,"ABORDAGEM SIMPLES",SDWAN,6193868b512a4e102e441c68,"OPEN - GENERAL - V3",1637058306,1637058007,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5565"", ""interface"": ""GE3""}","N/A",,202191967,high,"0f93a1a1-614a-4149-b3a3-b8fb024e4811",2152,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637058180_10812_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202191967 - Edge 2152 entrou em status DEGRADED",86400,high
"Não",Sorocaba,"GERDAU AÇOS LONGOS S A","155347.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041384,BAIXO,SDWAN,61938a0fb4a8174f7a513bd4,"OPEN - GENERAL - V3",1637059211,1637058908,"alert_manager","","",,"{""edgeId"": ""1004"", ""linkId"": ""1978"", ""interface"": ""GE3""}","N/A",,202041384,high,"297249f0-84d2-453d-9d97-ab4baeeff981",1004,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637059080_10775_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041384 - Edge 1004 entrou em status DEGRADED",86400,high
"Não","Brasília","GERDAU AÇOS LONGOS S A","155349.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041386,BAIXO,SDWAN,61938a11b4a8174f7a513bd7,"OPEN - GENERAL - V3",1637059211,1637058908,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}","N/A",,202041386,high,"b83e5dfb-f027-4ab5-9d46-d986d8e20a84",951,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637059080_10775_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041386 - Edge 951 entrou em status DEGRADED",86400,high
"Não",Fortaleza,"GERDAU AÇOS LONGOS S A","154963.0000000",CE,"N/A","SDWAN - VELOCLOUD",202040661,BAIXO,SDWAN,61938a13b4a8174f7a513bda,"OPEN - GENERAL - V3",1637059211,1637058908,"alert_manager","","",,"{""edgeId"": ""964"", ""linkId"": ""2274"", ""interface"": ""GE3""}","N/A",,202040661,high,"2a54bcff-fd81-42c8-bff0-e49070c451cb",964,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637059080_10775_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040661 - Edge 964 entrou em status DEGRADED",86400,high
"Não","Jundiaí","SUBCONDOMINIO SHOPPING CENTER JUNDIAI SHOPPING","155272.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041335,LOJA,SDWAN,61938fea512a4e102e441d44,"OPEN - GENERAL - V3",0,1637059810,"alert_manager","","",,"{""edgeId"": ""939"", ""linkId"": ""3338"", ""interface"": ""GE3""}","N/A",,202041335,performance,"d1e4f75b-7a16-4082-8c98-296c1f46713a",3338,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637060580_10898_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",4,"202041335 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",619396f1fa57811c983f4630,"OPEN - GENERAL - V3",1637062541,1637062233,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"8ce573d4-d478-42b2-a602-30113c53c85c",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637062380_11035_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61939948512a4e102e441e1a,"OPEN - GENERAL - V3",1637063138,1637062826,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"3145c7b3-a4d7-4017-bf79-23289afdff06",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637062980_10972_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193994c512a4e102e441e20,"OPEN - GENERAL - V3",1637063138,1637062826,"alert_manager","","",,"{""edgeId"": ""1573"", ""linkId"": ""4735"", ""interface"": ""GE4""}","N/A",,202177775,high,"ef150fc6-fa7e-408c-a4eb-12ee5b85adda",1573,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637062980_10972_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202177775 - Edge 1573 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61939ba0512a4e102e441e28,"OPEN - GENERAL - V3",1637063729,1637063448,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"3d97943d-7cc1-4b19-a1c1-806c2272f52e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637063580_10990_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61939dfafa57811c983f46bd,"OPEN - GENERAL - V3",1637064328,1637064042,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"e4186b13-98d4-40a1-9e77-b59807ac73b4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637064180_11106_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61939dfefa57811c983f46c3,"OPEN - GENERAL - V3",1637064328,1637064042,"alert_manager","","",,"{""edgeId"": ""2104"", ""linkId"": ""5360"", ""interface"": ""GE4""}","N/A",,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00",high,"54f86919-76ee-4b5a-a807-305358ad1bea",2104,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637064180_11106_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202186174
FSFX#HOSPITAL-SDW-VELO-GER#00 - Edge 2104 entrou em status OFFLINE",86400,high
"Não","São Gonçalo","GERDAU AÇOS LONGOS S A","155342.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202041379,BAIXO,SDWAN,61939f28b4a8174f7a513e0c,"OPEN - GENERAL - V3",1637068226,1637064328,"alert_manager","","",,"{""edgeId"": ""996"", ""linkId"": ""2427"", ""interface"": ""GE3""}","N/A",,202041379,high,"dafa91c4-7b97-41b5-80f0-289c3b5b3417",996,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637064480_10950_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041379 - Edge 996 entrou em status OFFLINE",86400,high
"Não","São Gonçalo","GERDAU AÇOS LONGOS S A","155342.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202041379,BAIXO,SDWAN,6193a052fa57811c983f46c9,"OPEN - GENERAL - V3",1637068226,1637064623,"alert_manager","","",,"{""edgeId"": ""996"", ""linkId"": ""2427"", ""interface"": ""GE3""}","N/A",,202041379,medium,"57600458-dbae-46a7-b7ff-1b1c66994945",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637064780_11124_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041379 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São Gonçalo","GERDAU AÇOS LONGOS S A","155342.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202041379,BAIXO,SDWAN,6193a053fa57811c983f46cb,"OPEN - GENERAL - V3",1637068226,1637064623,"alert_manager","","",,"{""edgeId"": ""996"", ""linkId"": ""3195"", ""interface"": ""GE4""}","N/A",,202041379,medium,"db610089-0014-4d55-9a1a-138dd0715ac7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637064780_11124_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041379 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","GERDAU AÇOS LONGOS S A","155341.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041378,BAIXO,SDWAN,6193a17db4a8174f7a513e50,"OPEN - GENERAL - V3",1637065227,1637064925,"alert_manager","","",,"{""edgeId"": ""995"", ""linkId"": ""1953"", ""interface"": ""GE3""}","N/A",,202041378,medium,"1d7fe4e5-285e-4810-ace9-4cbc36c4969a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637065080_10969_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041378 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6193a2a8b4a8174f7a513e9c,"OPEN - GENERAL - V3",1637065544,1637065227,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"9bce57cb-71ae-4322-bbe7-6656486d0160",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637065380_10981_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São Gonçalo","GERDAU AÇOS LONGOS S A","155342.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202041379,BAIXO,SDWAN,6193a2a9b4a8174f7a513ea1,"OPEN - GENERAL - V3",1637068523,1637064925,"alert_manager","","",,"{""edgeId"": ""996"", ""linkId"": ""2427"", ""interface"": ""GE3""}","N/A",,202041379,medium,"13e640cb-16d6-4d87-9dca-8d448a6e32eb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637065380_10981_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041379 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","São Gonçalo","GERDAU AÇOS LONGOS S A","155342.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202041379,BAIXO,SDWAN,6193a2aab4a8174f7a513ea4,"OPEN - GENERAL - V3",1637068523,1637064925,"alert_manager","","",,"{""edgeId"": ""996"", ""linkId"": ""3195"", ""interface"": ""GE4""}","N/A",,202041379,medium,"ca0a05f4-5742-44e7-894f-e57e62f58ba4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637065380_10981_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041379 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6193a2aeb4a8174f7a513ead,"OPEN - GENERAL - V3",1637065544,1637065227,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}","N/A",,202061983,high,"b10f53a6-6804-4a94-839b-2eca4bcb1037",1562,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637065380_10981_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061983 - Edge 1562 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193a62cfa57811c983f4720,"OPEN - GENERAL - V3",1637066438,1637066123,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"8301f160-acee-4b58-8ec1-e2785bced28f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637066280_11181_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193a758b4a8174f7a513eef,"OPEN - GENERAL - V3",1637066737,1637066438,"alert_manager","","",,"{""edgeId"": ""1586"", ""linkId"": ""4224"", ""interface"": ""GE4""}","N/A",,202162233,medium,"bc916ccd-ef4e-4448-988a-bb80519b3550",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637066580_11017_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202162233 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193a75fb4a8174f7a513efe,"OPEN - GENERAL - V3",1637066737,1637066438,"alert_manager","","",,"{""edgeId"": ""1586"", ""linkId"": ""4224"", ""interface"": ""GE4""}","N/A",,202162233,high,"034371a2-cb3a-4271-a137-e907a610497d",1586,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637066580_11017_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202162233 - Edge 1586 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6193aadb512a4e102e441f8b,"OPEN - GENERAL - V3",1637067629,1637067322,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"d129c67b-e51f-474d-804e-76f15270dc75",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637067480_11124_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193ad34fa57811c983f47fc,"OPEN - GENERAL - V3",1637068226,1637067926,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"28a68756-27dc-451b-aa18-1516414809a1",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637068080_11247_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193ae62512a4e102e441fa5,"OPEN - GENERAL - V3",1637068823,1637068226,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,high,"ce77f118-d8ed-4e25-a998-d5eca64c18c9",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637068380_11158_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193af8cb4a8174f7a513f7f,"OPEN - GENERAL - V3",1637069134,1637068523,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"e7a9e6d4-17e7-4cfc-b97e-fd9b2d2e8b78",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637068680_11080_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Natal,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133313.0000000",RN,"N/A",BRAD,20197433,LOSANGO,SDWAN,6193b1e3512a4e102e441feb,"OPEN - GENERAL - V3",1637069428,1637069134,"alert_manager","","",,"{""edgeId"": ""411"", ""linkId"": ""1040"", ""interface"": ""GE4""}","N/A",,20197433,medium,"b8efc89f-7937-44ee-a03b-326b02d7d4f7",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637069280_11192_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197433 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6193b313fa57811c983f489b,"OPEN - GENERAL - V3",1637095508,1637069428,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,high,"b9f01f7b-50b3-4bc2-9518-12bbe3e3c62d",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637069580_11299_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062017 - Edge 1584 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6193b568b4a8174f7a513fd1,"OPEN - GENERAL - V3",1637095508,1637070040,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"b37d19b0-b7f1-4bcd-833b-7ac6f6cbce8f",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637070180_11126_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193b7c0b4a8174f7a51405c,"OPEN - GENERAL - V3",1637095806,1637070323,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"87717c5f-0f18-4c71-90e0-675f6cc80e5e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637070780_11147_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Salvador,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133329.0000000",BA,"N/A",BRAD,20197450,LOSANGO,SDWAN,6193ba1ab4a8174f7a5140a9,"OPEN - GENERAL - V3",1637077524,1637071221,"alert_manager","","",,"{""edgeId"": ""430"", ""linkId"": ""2499"", ""interface"": ""GE4""}","N/A",,20197450,medium,"894b8d23-b8d6-4e96-a809-635d5de2076d",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637071380_11169_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197450 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","","","","","N/A","","","","",6193ba1eb4a8174f7a5140ae,"OPEN - GENERAL - V3",1637072159,1637071221,"alert_manager","","",,"{""edgeId"": ""1566"", ""linkId"": ""4245"", ""interface"": ""GE4""}","N/A",,202162229,high,"3a2fcba5-f70e-40f7-9c70-787d3244a98b",1566,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637071380_11169_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202162229 - Edge 1566 entrou em status DEGRADED",86400,high
"Não","Araçatuba","GERDAU AÇOS LONGOS SA","170122.0000000",SP,"N/A",GRC,202060096,DADOS,DADOS,6193ba20b4a8174f7a5140b2,"OPEN - GENERAL - V3",1637072159,1637071221,"alert_manager","","",,"{""edgeId"": ""1733"", ""linkId"": ""4285"", ""interface"": ""GE3""}","N/A",,202060096,high,"e6884efe-97c4-40f6-ba6f-fd9a5cd543b0",1733,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637071380_11169_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202060096 - Edge 1733 entrou em status DEGRADED",86400,high
"Não",Aracaju,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133319.0000000",SE,"N/A",BRAD,20197449,LOSANGO,SDWAN,6193ba22b4a8174f7a5140b5,"OPEN - GENERAL - V3",1637072159,1637071221,"alert_manager","","",,"{""edgeId"": ""427"", ""linkId"": ""1030"", ""interface"": ""GE4""}","N/A",,20197449,high,"a6b7f2cb-7344-4a15-942d-54253b639120",427,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637071380_11169_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,13,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197449 - Edge 427 entrou em status DEGRADED",86400,high
"Não","Brasília","GERDAU AÇOS LONGOS S A","155349.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041386,BAIXO,SDWAN,6193ba24b4a8174f7a5140b8,"OPEN - GENERAL - V3",1637072159,1637071221,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}","N/A",,202041386,high,"babed93d-96df-4809-ae77-df6cc8cad862",951,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637071380_11169_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041386 - Edge 951 entrou em status DEGRADED",86400,high
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,6193bda1512a4e102e4420a5,"OPEN - GENERAL - V3",1637072729,1637072159,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}","N/A",,202062013,high,"d7d0b354-0bdf-4640-89cd-639e5d440e18",1582,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637072280_11299_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062013 - Edge 1582 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193bff2512a4e102e4420e4,"OPEN - GENERAL - V3",1637073323,1637072729,"alert_manager","","",,"{""edgeId"": ""1565"", ""linkId"": ""4052"", ""interface"": ""GE4""}","N/A",,202061991,medium,"061a5695-c0fa-439b-9475-339095ebfe20",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637072880_11322_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061991 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193bff3512a4e102e4420e6,"OPEN - GENERAL - V3",1637073323,1637072729,"alert_manager","","",,"{""edgeId"": ""1565"", ""linkId"": ""5193"", ""interface"": ""GE3""}","N/A",,202061991,medium,"6c568a66-e270-4839-849f-d5b356d8b0de",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637072880_11322_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061991 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193bff7512a4e102e4420ed,"OPEN - GENERAL - V3",1637076904,1637072159,"alert_manager","","",,"{""edgeId"": ""1564"", ""linkId"": ""4046"", ""interface"": ""GE3""}","N/A",,202061987,performance,"6bf5d57b-fbd9-4902-9e90-e837a38cabfd",4046,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637072880_11322_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202061987 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",6193c251512a4e102e4420fb,"OPEN - GENERAL - V3",1637073607,1637073323,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","N/A",,202062009,high,"a46aad2b-fd0a-44a9-952f-832eb3f499ef",1580,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637073480_11347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062009 - Edge 1580 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6193c253512a4e102e4420ff,"OPEN - GENERAL - V3",1637073607,1637073323,"alert_manager","","",,"{""edgeId"": ""1586"", ""linkId"": ""4224"", ""interface"": ""GE4""}","N/A",,202162233,high,"a88682db-9610-4e39-904b-6b1b8be460bc",1586,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637073480_11347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202162233 - Edge 1586 entrou em status OFFLINE",86400,high
"Não",Recife,"ICATU SEGUROS S.A","159551.0000000",PE,"N/A","SDWAN - VELOCLOUD",202046760,"ABORDAGEM SIMPLES",SDWAN,6193c377512a4e102e442102,"OPEN - GENERAL - V3",1637073912,1637073607,"alert_manager","","",,"{""edgeId"": ""1119"", ""linkId"": ""3944"", ""interface"": ""GE4""}","N/A",,202046760,medium,"ef42b06b-0cc0-4f6d-b5fd-8778c74233b4",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637073780_11355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202046760 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não","São Paulo","ICATU SEGUROS S.A","180688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202185145,"DUPLA ABORDAGEM",SDWAN,6193c4a9512a4e102e442116,"OPEN - GENERAL - V3",1637074804,1637073912,"alert_manager","","",,"{""edgeId"": ""1577"", ""linkId"": ""5066"", ""interface"": ""GE4""}","N/A",,202185145,high,"45f1d0fc-e302-42d8-bb3f-766573553e51",1577,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637074080_11367_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202185145 - Edge 1577 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6193c5d7512a4e102e442126,"OPEN - GENERAL - V3",1637074804,1637074280,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"1eec29b3-99ae-4957-bec9-84e40e9e57ff",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637074380_11380_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status OFFLINE",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6193c82afa57811c983f4a5a,"OPEN - GENERAL - V3",1637075104,1637074804,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,medium,"841a3733-cf2b-4d50-baf3-aaea96dd5178",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637074980_11477_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,6193c82bfa57811c983f4a5c,"OPEN - GENERAL - V3",1637075104,1637074804,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3602"", ""interface"": ""GE4""}","N/A",,202041328,medium,"cbb3cb75-1380-441b-b133-599d20975a2b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637074980_11477_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Fortaleza,"GERDAU AÇOS LONGOS S A","154963.0000000",CE,"N/A","SDWAN - VELOCLOUD",202040661,BAIXO,SDWAN,6193c955512a4e102e44216f,"OPEN - GENERAL - V3",1637076002,1637075104,"alert_manager","","",,"{""edgeId"": ""964"", ""linkId"": ""2274"", ""interface"": ""GE3""}","N/A",,202040661,medium,"628ff361-7b5b-404c-bbe5-2cc9e8c376bb",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637075280_11412_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040661 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Sinop,"GERDAU AÇOS LONGOS S A","155346.0000000",MT,"N/A","SDWAN - VELOCLOUD",202041383,BAIXO,SDWAN,6193c958512a4e102e442175,"OPEN - GENERAL - V3",1637075704,1637075104,"alert_manager","","",,"{""edgeId"": ""1003"", ""linkId"": ""2301"", ""interface"": ""GE3""}","N/A",,202041383,high,"5916be33-ac6e-4772-8c56-21bc05505187",1003,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637075280_11412_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041383 - Edge 1003 entrou em status OFFLINE",86400,high
"Não","Mossoró","GERDAU AÇOS LONGOS S A","155329.0000000",RN,"N/A","SDWAN - VELOCLOUD",202041366,BAIXO,SDWAN,6193c95b512a4e102e442179,"OPEN - GENERAL - V3",1637075704,1637075104,"alert_manager","","",,"{""edgeId"": ""983"", ""linkId"": ""2235"", ""interface"": ""GE3""}","N/A",,202041366,high,"45281f38-6247-4c5b-be5a-6759d1af7324",983,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637075280_11412_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041366 - Edge 983 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",6193ca7f512a4e102e44217d,"OPEN - GENERAL - V3",1637075704,1637075405,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""4076"", ""interface"": ""GE4""}","N/A",,202062003,medium,"202d6184-a85e-415b-a5fd-0e01ac3fdf71",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637075580_11422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062003 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193ca7f512a4e102e44217f,"OPEN - GENERAL - V3",1637075704,1637075405,"alert_manager","","",,"{""edgeId"": ""1574"", ""linkId"": ""5186"", ""interface"": ""GE3""}","N/A",,202062003,medium,"52528543-997b-4542-bb30-c6ce7a55e914",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637075580_11422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062003 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,6193ccdcb4a8174f7a5142d9,"OPEN - GENERAL - V3",1637101835,1637075704,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}","N/A",,202062013,performance,"1b8fdb3e-7828-4de4-974a-7be69b5bc4ed",4157,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637076180_11323_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202062013 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Recife,"GERDAU AÇOS LONGOS S A","155340.0000000",PE,"N/A","SDWAN - VELOCLOUD",202041377,BAIXO,SDWAN,6193d18cb4a8174f7a5142e5,"OPEN - GENERAL - V3",1637077524,1637076904,"alert_manager","","",,"{""edgeId"": ""994"", ""linkId"": ""2264"", ""interface"": ""GE3""}","N/A",,202041377,performance,"dd6b1288-af82-4a87-8f73-d7c0e621ea29",2264,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637077380_11368_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","packet_loss_percent","N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041377 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Recife,"GERDAU AÇOS LONGOS S A","155340.0000000",PE,"N/A","SDWAN - VELOCLOUD",202041377,BAIXO,SDWAN,6193d50f512a4e102e4422b1,"OPEN - GENERAL - V3",1637079606,1637077803,"alert_manager","","",,"{""edgeId"": ""994"", ""linkId"": ""2264"", ""interface"": ""GE3""}","N/A",,202041377,performance,"e4781a7c-e264-48c7-afb7-59f048d3f699",2264,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637078280_11491_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041377 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,6193d763b4a8174f7a514373,"OPEN - GENERAL - V3",1637079606,1637078703,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}","N/A",,202062013,medium,"c6fe047e-d47c-48af-8aec-8d37d61d072e",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637078880_11418_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062013 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,6193d764b4a8174f7a514375,"OPEN - GENERAL - V3",1637079606,1637078703,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4914"", ""interface"": ""GE3""}","N/A",,202062013,medium,"f1710593-2cb0-497b-a562-26c12c15ae86",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637078880_11418_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062013 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,6193d76ab4a8174f7a51437d,"OPEN - GENERAL - V3",1637079606,1637078703,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}","N/A",,202062013,high,"f9ba34a0-e230-4130-84ce-77a56b80aa5e",1582,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637078880_11418_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062013 - Edge 1582 entrou em status OFFLINE",86400,high
"Não","São Paulo","BANCO LOSANGO S.A. - BANCO MULTIPLO","133327.0000000",SP,"N/A",BRAD,20197439,LOSANGO,SDWAN,6193dae8fa57811c983f4b8f,"OPEN - GENERAL - V3",1637080204,1637079606,"alert_manager","","",,"{""edgeId"": ""409"", ""linkId"": ""1064"", ""interface"": ""GE3""}","N/A",,20197439,medium,"233d5b27-f4f4-4892-873c-9b5029d38b74",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637079780_11657_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197439 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São Paulo","BANCO LOSANGO S.A. - BANCO MULTIPLO","133327.0000000",SP,"N/A",BRAD,20197439,LOSANGO,SDWAN,6193dae9fa57811c983f4b92,"OPEN - GENERAL - V3",1637080204,1637079606,"alert_manager","","",,"{""edgeId"": ""409"", ""linkId"": ""1150"", ""interface"": ""GE4""}","N/A",,20197439,medium,"e37bc964-64c3-467b-9ada-cf938c31f7d8",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637079780_11657_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197439 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","São Paulo","BANCO LOSANGO S.A. - BANCO MULTIPLO","133327.0000000",SP,"N/A",BRAD,20197439,LOSANGO,SDWAN,6193daeffa57811c983f4b9f,"OPEN - GENERAL - V3",1637080204,1637079606,"alert_manager","","",,"{""edgeId"": ""409"", ""linkId"": ""1064"", ""interface"": ""GE3""}","N/A",,20197439,high,"70e2818f-1b91-41f6-9e6b-5f47dac3c7ce",409,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637079780_11657_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197439 - Edge 409 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193daf1fa57811c983f4ba4,"OPEN - GENERAL - V3",1637080204,1637079606,"alert_manager","","",,"{""edgeId"": ""467"", ""linkId"": ""1628"", ""interface"": ""GE3""}","N/A",,202058101,high,"cf4f76e0-f152-4ac2-91f5-0775a8d4b75c",467,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637079780_11657_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058101 - Edge 467 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193dd3e512a4e102e442381,"OPEN - GENERAL - V3",1637080507,1637080204,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","N/A",,202062007,medium,"39cec0f0-dcf3-4024-a3fb-0654c8ee5c74",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637080380_11560_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062007 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193dd3f512a4e102e442383,"OPEN - GENERAL - V3",1637080507,1637080204,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4165"", ""interface"": ""GE3""}","N/A",,202062007,medium,"91c8bec8-a9cf-4f66-91e2-efa28d1396f6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637080380_11560_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062007 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6193df9bb4a8174f7a51441c,"OPEN - GENERAL - V3",1637081728,1637080811,"alert_manager","","",,"{""edgeId"": ""460"", ""linkId"": ""3598"", ""interface"": ""SFP2""}","N/A",,202058024,high,"01b35710-5e42-4f2e-bd77-904024ea58bc",460,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637080980_11490_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058024 - Edge 460 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193df9db4a8174f7a514420,"OPEN - GENERAL - V3",1637081728,1637080811,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1582"", ""interface"": ""GE3""}","N/A",,202058019,high,"24b9cb56-7891-4ffa-addf-45fc3853b3d6",465,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637080980_11490_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058019 - Edge 465 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6193df9eb4a8174f7a514425,"OPEN - GENERAL - V3",1637081728,1637080811,"alert_manager","","",,"{""edgeId"": ""512"", ""linkId"": ""1148"", ""interface"": ""GE1""}","N/A",,202058023,high,"6a6da90a-aa03-4543-829f-dfa317834d31",512,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637080980_11490_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058023 - Edge 512 entrou em status DEGRADED",86400,high
"Não","Ribeirão Preto","CONDOMINIO CIVIL PRO INDIVISIO DO SHOPPING SANTA URSULA","155262.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041337,LOJA,SDWAN,6193e447512a4e102e4423d4,"OPEN - GENERAL - V3",1637095508,1637082004,"alert_manager","","",,"{""edgeId"": ""926"", ""linkId"": ""3377"", ""interface"": ""GE3""}","N/A",,202041337,medium,"953b296e-1443-4bf0-8c72-0701cbc53369",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637082180_11624_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041337 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Ribeirão Preto","CONDOMINIO CIVIL PRO INDIVISIO DO SHOPPING SANTA URSULA","155262.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041337,LOJA,SDWAN,6193e448512a4e102e4423d7,"OPEN - GENERAL - V3",1637095508,1637082004,"alert_manager","","",,"{""edgeId"": ""926"", ""linkId"": ""3379"", ""interface"": ""GE4""}","N/A",,202041337,medium,"f5fcad24-726c-4f3e-ab36-f5b9953acebc",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637082180_11624_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041337 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619417d7fa57811c983f5046,"OPEN - GENERAL - V3",1637095805,1637095281,"alert_manager","","",,"{""edgeId"": ""463"", ""linkId"": ""1575"", ""interface"": ""GE3""}","N/A",,202058026,high,"5be7b6fa-ad81-41ad-9cc9-1ebdaa023b18",463,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095380_12179_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058026 - Edge 463 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,619417d9fa57811c983f504b,"OPEN - GENERAL - V3",1637095508,1637095281,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"73e3d931-177c-4c94-ae83-4109c3781bbc",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095380_12179_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não","Cuiabá","ICATU SEGUROS S.A","169174.0000000",MT,"N/A","SDWAN - VELOCLOUD",202058771,"ABORDAGEM SIMPLES",SDWAN,61941903512a4e102e442850,"OPEN - GENERAL - V3",1637099136,1637095281,"alert_manager","","",,"{""edgeId"": ""1499"", ""linkId"": ""3878"", ""interface"": ""GE3""}","N/A",,202058771,performance,"fe115937-118e-4cc3-8e52-1ea38389ecbe",3878,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095680_12090_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202058771 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61941904512a4e102e442853,"OPEN - GENERAL - V3",1637099136,1637095281,"alert_manager","","",,"{""edgeId"": ""1564"", ""linkId"": ""4046"", ""interface"": ""GE3""}","N/A",,202061987,performance,"19eb857d-3bd3-4025-8c7e-91902eb835e5",4046,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095680_12090_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202061987 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","","","","","N/A","","","","",61941905512a4e102e442856,"OPEN - GENERAL - V3",1637096116,1637095281,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","N/A",,202062009,performance,"8f6fc954-982c-43f4-8083-95bd534f0f70",4254,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095680_12090_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202062009 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Brasília","GERDAU AÇOS LONGOS S A","155349.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041386,BAIXO,SDWAN,61941907512a4e102e44285d,"OPEN - GENERAL - V3",1637096116,1637095281,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2096"", ""interface"": ""GE3""}","N/A",,202041386,performance,"6b72df28-50ed-4ee0-8634-bbd0e08d04af",2096,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095680_12090_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041386 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não","Brasília","GERDAU AÇOS LONGOS S A","155349.0000000",DF,"N/A","SDWAN - VELOCLOUD",202041386,BAIXO,SDWAN,61941908512a4e102e442860,"OPEN - GENERAL - V3",1637096116,1637095281,"alert_manager","","",,"{""edgeId"": ""951"", ""linkId"": ""2097"", ""interface"": ""GE4""}","N/A",,202041386,performance,"d75371bc-0c15-4392-8b87-77fb55608b5e",2097,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095680_12090_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202041386 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não","Florianópolis","BANCO LOSANGO S.A. - BANCO MULTIPLO","133317.0000000",SC,"N/A",BRAD,20197435,LOSANGO,SDWAN,61941909512a4e102e442863,"OPEN - GENERAL - V3",1637095805,1637095508,"alert_manager","","",,"{""edgeId"": ""414"", ""linkId"": ""1050"", ""interface"": ""GE4""}","N/A",,20197435,high,"cc3fec27-b8d5-41bd-9483-3d96cfc4d9e2",414,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095680_12090_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197435 - Edge 414 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",6194190a512a4e102e442868,"OPEN - GENERAL - V3",1637095805,1637095508,"alert_manager","","",,"{""edgeId"": ""458"", ""linkId"": ""2775"", ""interface"": ""GE3""}","N/A",,202058022,high,"6bb99796-f286-475e-aa03-09b7f9cf5b6f",458,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095680_12090_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,11,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058022 - Edge 458 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61941a2fb4a8174f7a5147c4,"OPEN - GENERAL - V3",1637096776,1637095806,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}","N/A",,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"f3a189e9-3e48-4798-a434-78cd8143eec7",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095980_11996_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61941a30b4a8174f7a5147c6,"OPEN - GENERAL - V3",1637096776,1637095806,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5002"", ""interface"": ""GE2""}","N/A",,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"3cad78cf-fd90-4191-bc30-32609a1a54d8",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095980_11996_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61941a31b4a8174f7a5147c8,"OPEN - GENERAL - V3",1637096776,1637095806,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}","N/A",,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"a8839758-5cab-443a-82bd-e6106666af17",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095980_11996_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","Criciúma","GERDAU AÇOS LONGOS S A","154960.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040658,BAIXO,SDWAN,61941a32b4a8174f7a5147ca,"OPEN - GENERAL - V3",1637096776,1637095805,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2228"", ""interface"": ""GE4""}","N/A",,202040658,medium,"21f15f21-39b8-4270-938d-6efdec857ba9",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095980_11996_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040658 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Criciúma","GERDAU AÇOS LONGOS S A","154960.0000000",SC,"N/A","SDWAN - VELOCLOUD",202040658,BAIXO,SDWAN,61941a33b4a8174f7a5147cc,"OPEN - GENERAL - V3",1637096776,1637095805,"alert_manager","","",,"{""edgeId"": ""958"", ""linkId"": ""2231"", ""interface"": ""GE3""}","N/A",,202040658,medium,"37a09dc7-932c-402a-8e4d-d7e071b32d88",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095980_11996_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040658 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Montes Claros","GERDAU AÇOS LONGOS S A","154970.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040668,BAIXO,SDWAN,61941a34b4a8174f7a5147ce,"OPEN - GENERAL - V3",1637096776,1637095805,"alert_manager","","",,"{""edgeId"": ""982"", ""linkId"": ""2177"", ""interface"": ""GE3""}","N/A",,202040668,medium,"8e9985b7-217e-4e47-afa8-f10f88f519f5",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095980_11996_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040668 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Montes Claros","GERDAU AÇOS LONGOS S A","154970.0000000",MG,"N/A","SDWAN - VELOCLOUD",202040668,BAIXO,SDWAN,61941a34b4a8174f7a5147d0,"OPEN - GENERAL - V3",1637096776,1637095805,"alert_manager","","",,"{""edgeId"": ""982"", ""linkId"": ""2178"", ""interface"": ""GE4""}","N/A",,202040668,medium,"91cf90f7-3a34-4001-a9b1-16f19e9c0b31",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637095980_11996_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040668 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61941b5bfa57811c983f508c,"OPEN - GENERAL - V3",1637097021,1637095806,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}","N/A",,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"7a8cc0df-a6bf-41c0-acdf-56e1a5cb7b27",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096280_12213_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61941b5cfa57811c983f508e,"OPEN - GENERAL - V3",1637097021,1637095806,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5002"", ""interface"": ""GE2""}","N/A",,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"85d1565c-806e-4c9c-8dc4-21a0f56839e6",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096280_12213_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61941b5dfa57811c983f5090,"OPEN - GENERAL - V3",1637097021,1637095806,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}","N/A",,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"8f959416-cef2-49aa-852d-3b6e259b3bdd",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096280_12213_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61941c87b4a8174f7a5147db,"OPEN - GENERAL - V3",1637097021,1637095806,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5001"", ""interface"": ""GE1""}","N/A",,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"e35b372f-81ab-4263-9bdd-94c7c73b4965",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096580_12014_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61941c88b4a8174f7a5147dd,"OPEN - GENERAL - V3",1637097021,1637095806,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5002"", ""interface"": ""GE2""}","N/A",,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"7a5dae3f-e8da-4978-9f85-28be0c5c9c25",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096580_12014_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61941c89b4a8174f7a5147df,"OPEN - GENERAL - V3",1637097021,1637095806,"alert_manager","","",,"{""edgeId"": ""1926"", ""linkId"": ""5330"", ""interface"": ""SFP2""}","N/A",,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00",medium,"9dda94c4-a1e5-4591-89eb-b02b2264ef8e",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096580_12014_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202184562
USIM#SDW-VELO-GUARULHOS-GER#00 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61941db3b4a8174f7a5147ec,"OPEN - GENERAL - V3",1637097020,1637096776,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,medium,"e8f8e189-e21b-4747-b402-96b397342b76",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096880_12025_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61941db4b4a8174f7a5147ef,"OPEN - GENERAL - V3",1637097020,1637096776,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3602"", ""interface"": ""GE4""}","N/A",,202041328,medium,"83c09092-436d-4b45-b600-7c3ff2545c93",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096880_12025_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041328 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Caruaru,"GERDAU AÇOS LONGOS S A","154938.0000000",PE,"N/A","SDWAN - VELOCLOUD",202040637,BAIXO,SDWAN,61941db9b4a8174f7a5147fc,"OPEN - GENERAL - V3",1637097020,1637096776,"alert_manager","","",,"{""edgeId"": ""1273"", ""linkId"": ""3200"", ""interface"": ""GE3""}","N/A",,202040637,high,"930b7802-cbe4-4a9f-9d0e-69d8142dc73b",1273,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096880_12025_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040637 - Edge 1273 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61941dbbb4a8174f7a514801,"OPEN - GENERAL - V3",1637097020,1637096776,"alert_manager","","",,"{""edgeId"": ""463"", ""linkId"": ""1575"", ""interface"": ""GE3""}","N/A",,202058026,high,"c9cf227c-d2cb-4b33-bb01-a5755b8d0997",463,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637096880_12025_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058026 - Edge 463 entrou em status OFFLINE",86400,high
"Não","","","","","N/A","","","","",61941ee1512a4e102e44296a,"OPEN - GENERAL - V3",1637099136,1637096776,"alert_manager","","",,"{""edgeId"": ""1580"", ""linkId"": ""4254"", ""interface"": ""GE4""}","N/A",,202062009,performance,"27ce77d6-0270-41fa-b9a5-d7d09e1a05d4",4254,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637097180_12137_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",4,"202062009 - A perda de pacotes da interface GE4 excedeu o valor de 1%",86400,low
"Não",Bauru,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133321.0000000",SP,"N/A",BRAD,20197436,LOSANGO,SDWAN,61941ee3512a4e102e442971,"OPEN - GENERAL - V3",1637097903,1637097020,"alert_manager","","",,"{""edgeId"": ""425"", ""linkId"": ""1029"", ""interface"": ""GE4""}","N/A",,20197436,high,"e8762c51-ba9f-4a45-a531-7410cae18cc0",425,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637097180_12137_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197436 - Edge 425 entrou em status DEGRADED",86400,high
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619424fe512a4e102e442a37,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098801,1637097900,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"05c3f2fb-67cd-4d51-87e1-1add4b00421b","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619424ff512a4e102e442a39,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098801,1637097900,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"5e21a1ee-bc68-445a-a203-933ff31a43cb","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",LONDRINA,"PACAEMBU AUTOPEÇAS LTDA","108882.0000000",PR,"PACAEMBU LDA | 201749028",BSN,201749028,FILIAIS,"SEM CONTINGENCIA",61942500512a4e102e442a3b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117101,1637097900,"alert_manager","","",,"N/A","N/A",,"pacaembu-lda-fw-013",performance,"73ed07af-6ecc-4d7c-b734-22ab04dc0af7","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-lda-fw-013 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",LONDRINA,"PACAEMBU AUTOPEÇAS LTDA","108882.0000000",PR,"PACAEMBU LDA | 201749028",BSN,201749028,FILIAIS,"SEM CONTINGENCIA",61942500512a4e102e442a3d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117101,1637097900,"alert_manager","","",,"N/A","N/A",,"pacaembu-lda-fw-013",performance,"e9c0ce89-df3d-4226-89e8-2e2765c03948","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,3,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-lda-fw-013 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61942501512a4e102e442a3f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098801,1637097900,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"68d6f64b-883a-47b5-a243-b23d81f8a4e8","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",ITAJAI,"PACAEMBU AUTOPEÇAS LTDA","108885.0000000",SC,"PACAEMBU IAI | 201749030",BSN,201749030,FILIAIS,"SEM CONTINGENCIA",61942502512a4e102e442a41,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115302,1637097900,"alert_manager","","",,"N/A","N/A",,"pacaembu-iai-fw-019",performance,"ff174f25-62c0-4f3e-923a-4a4426cacbf2","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-iai-fw-019 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",ITAJAI,"PACAEMBU AUTOPEÇAS LTDA","108885.0000000",SC,"PACAEMBU IAI | 201749030",BSN,201749030,FILIAIS,"SEM CONTINGENCIA",61942503512a4e102e442a43,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115302,1637097900,"alert_manager","","",,"N/A","N/A",,"pacaembu-iai-fw-019",performance,"c68b305b-dd55-4e9c-bd25-fe9b04c563c7","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-iai-fw-019 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61942504512a4e102e442a45,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"c377bfa1-0fa4-430e-b818-0469e241fa53",lan1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-cta-fw-007 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61942505512a4e102e442a47,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099100,1637097902,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"6efb642d-ec3f-4fe4-b251-39cb232216d9",port2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não","São Paulo","BRF S A","166835.0000000",SP,"BRF MERCADO SPO | 202055618",GRC,202055618,LOJA,SDE,61942506512a4e102e442a4a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097900,"alert_manager","","",,"N/A","N/A",,"brf-spo-fw-1",performance,"f945c4e2-6bea-4f56-94c6-cc243dfd9bec","Check_INTERNET - Link-Wan-1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"brf-spo-fw-1 - A Latência da interface Check_INTERNET - Link-Wan-1 excedeu o valor do 100",86400,low
"Não","São Paulo","BRF S A","166835.0000000",SP,"BRF MERCADO SPO | 202055618",GRC,202055618,LOJA,SDE,61942507512a4e102e442a4c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097900,"alert_manager","","",,"N/A","N/A",,"brf-spo-fw-1",performance,"2aae2878-f96a-4a71-972a-a4f31ec3cbd8","Check_INTERNET - Link-Wan-2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"brf-spo-fw-1 - A Latência da interface Check_INTERNET - Link-Wan-2 excedeu o valor do 100",86400,low
"Não","São Paulo","BRF S A","166835.0000000",SP,"BRF MERCADO SPO | 202055618",GRC,202055618,LOJA,SDE,61942508512a4e102e442a4e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097900,"alert_manager","","",,"N/A","N/A",,"brf-spo-fw-1",performance,"f7157a46-cca6-4180-b497-13010534cd0b","Check_INTERNET - Link-Wan-3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"brf-spo-fw-1 - A Latência da interface Check_INTERNET - Link-Wan-3 excedeu o valor do 100",86400,low
"Não","Hortolândia","BRF S A","166836.0000000",SP,"BRF DC | 202055619",GRC,202055619,"DATA CENTER",SDE,61942508512a4e102e442a50,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097900,"alert_manager","","",,"N/A","N/A",,"brf-hort-dc-fw-1",performance,"799253ca-76a9-4c4c-a918-ebcc9385a7f9","Default_DNS - Link-WAN-T1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"brf-hort-dc-fw-1 - A Latência da interface Default_DNS - Link-WAN-T1 excedeu o valor do 100",86400,low
"Não","Hortolândia","BRF S A","166836.0000000",SP,"BRF DC | 202055619",GRC,202055619,"DATA CENTER",SDE,61942509512a4e102e442a52,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097900,"alert_manager","","",,"N/A","N/A",,"brf-hort-dc-fw-1",performance,"473750ee-bc1e-4fe2-912a-0e198a7dd1f1","Default_DNS - Link-WAN-T9","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"brf-hort-dc-fw-1 - A Latência da interface Default_DNS - Link-WAN-T9 excedeu o valor do 100",86400,low
"Não",Barueri,"TEGMA GESTAO LOGISTICA S A","173011.0000000",SP,"BRE - ALOG / DC Equinix | 202165365",SDE,202165365,SDWAN,SDE,6194250a512a4e102e442a54,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103901,1637097902,"alert_manager","","",,"N/A","N/A",,"tegma-bre-dc-hafw-1",performance,"ee88d402-2016-4f37-8b2f-a99e0689a45b",port2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-bre-dc-hafw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,6194250b512a4e102e442a56,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098504,1637097905,"alert_manager","","",,"N/A","N/A",,202165385,performance,"45ff4637-6ad3-4ec6-94e5-aef4e13a5bfd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Uberlândia","REAL MOTO PECAS LTDA","174008.0000000",MG,"UBERLANDIA | 202171306",GRC,202171306,DADOS,DADOS,6194250c512a4e102e442a58,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100603,1637097902,"alert_manager","","",,"N/A","N/A",,"greal-ula-hafw-c",performance,"d7312bf1-ecdc-4c75-a652-d5ad963b29da",port1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,17,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-ula-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não","São Paulo","REAL MOTO PECAS LTDA","174010.0000000",SP,"SAOPAULO | 202171308",GRC,202171308,DADOS,DADOS,6194250d512a4e102e442a5b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100901,1637097902,"alert_manager","","",,"N/A","N/A",,"greal-spo-hafw-c",performance,"4f9116b9-06c6-4e23-b8c0-a28f9480fc42",lan1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-spo-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Goiânia","REAL MOTO PECAS LTDA","174015.0000000",GO,"GOIANIA | 202171313",GRC,202171313,DADOS,DADOS,6194250f512a4e102e442a5e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101500,1637097902,"alert_manager","","",,"N/A","N/A",,"greal-gna-hafw-c",performance,"8be06c5f-5d05-42c8-942e-c37516943589",lan1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-gna-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,61942510512a4e102e442a61,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100602,1637097901,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"41d5579d-65f4-4b48-8bbf-4abdd800cca2","SLA Matriz - vpn-mtub-w1-w2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - A Latência da interface SLA Matriz - vpn-mtub-w1-w2 excedeu o valor do 100",86400,low
"Não","Itajaí","BRF S A","174141.0000000",SC,"BRF MERCADO IAI | 202173982",SDE,202173982,LOJA,SDE,61942511512a4e102e442a63,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097900,"alert_manager","","",,"N/A","N/A",,"brf-iai-hafw-c",performance,"19ace6d3-ad2b-4c1c-9644-74188e225c89","Check_INTERNET - Link-Wan-1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"brf-iai-hafw-c - A Latência da interface Check_INTERNET - Link-Wan-1 excedeu o valor do 100",86400,low
"Não","Itajaí","BRF S A","174141.0000000",SC,"BRF MERCADO IAI | 202173982",SDE,202173982,LOJA,SDE,61942512512a4e102e442a65,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097900,"alert_manager","","",,"N/A","N/A",,"brf-iai-hafw-c",performance,"58393cee-880f-4b18-9c0f-0d366afd4e78","Check_INTERNET - Link-Wan-2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"brf-iai-hafw-c - A Latência da interface Check_INTERNET - Link-Wan-2 excedeu o valor do 100",86400,low
"Não","Itajaí","BRF S A","174141.0000000",SC,"BRF MERCADO IAI | 202173982",SDE,202173982,LOJA,SDE,61942513512a4e102e442a67,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097900,"alert_manager","","",,"N/A","N/A",,"brf-iai-hafw-c",performance,"48887ce0-d530-4a9e-a2aa-f40413209345","Check_INTERNET - Link-Wan-3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"brf-iai-hafw-c - A Latência da interface Check_INTERNET - Link-Wan-3 excedeu o valor do 100",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174297.0000000",SP,"MIRO | 202174604",SDE,202174604,SDWAN,SDE,61942514512a4e102e442a69,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102700,1637097902,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-mro-fw-1",performance,"419d43a9-29b6-4896-b797-3734cd7da856",port2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-mro-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174298.0000000",SP,"NICOLA | 202174605",SDE,202174605,SDWAN,SDE,61942515512a4e102e442a6c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099100,1637097902,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-ncl-fw-1",performance,"cb27c905-ee48-4c08-a0b7-ca8807d129b0",wan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-ncl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Angra dos Reis","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179467.0000000",RJ,"PR06-ANGRA_DOS_REIS_ARS/IP/01094 | 202182015",SDE,202182015,"ABORDAGEM SIMPLES",FILIAL,61942516512a4e102e442a6e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099400,1637097902,"alert_manager","","",,"N/A","N/A",,"PR06-ANGRA_DOS_REIS",performance,"241f19e2-4bfd-41c6-aaea-81588095df00",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR06-ANGRA_DOS_REIS - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Petrópolis","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179468.0000000",RJ,"PETROPOLIS_PTS/IP/04431 | 202182016",SDE,202182016,"ABORDAGEM SIMPLES",FILIAL,61942517512a4e102e442a70,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108702,1637097902,"alert_manager","","",,"N/A","N/A",,"PR07-PETROPOLIS",performance,"b6106fef-f66e-4c0d-aa4b-98f6989cd6ce",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR07-PETROPOLIS - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Nova Friburgo","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179469.0000000",RJ,"PR08-NOVA_FRIBURGO_NOF/IP/05422 | 202182017",SDE,202182017,"ABORDAGEM SIMPLES",FILIAL,61942518512a4e102e442a72,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110200,1637097902,"alert_manager","","",,"N/A","N/A",,"PR08-NOVA_FRIBURGO",performance,"a9705fba-3cea-42e5-8054-a9e8552b9579",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR08-NOVA_FRIBURGO - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Macaé","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179470.0000000",RJ,"PR09-MACAE_MCE/IP/03625 | 202182018",SDE,202182018,"ABORDAGEM SIMPLES",FILIAL,61942518512a4e102e442a74,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099701,1637097902,"alert_manager","","",,"N/A","N/A",,"PR09-MACAE",performance,"763e5386-5534-4ebc-817e-763786ecbc08",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR09-MACAE - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Cabo Frio","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179473.0000000",RJ,"PR12-CABO_FRIO_CBF/IP/04614 | 202182021",SDE,202182021,"ABORDAGEM SIMPLES",FILIAL,6194251a512a4e102e442a77,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101500,1637097902,"alert_manager","","",,"N/A","N/A",,"PR12-CABO_FRIO",performance,"a1dd57e1-2f04-4ad1-b58e-f3f31184a0e7",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR12-CABO_FRIO - Link acusou mais de 70% de utilização de banda",86400,low
"Não","São Gonçalo","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179474.0000000",RJ,"PR13-SAO_GONCALO_SGO/IP/13551 | 202182022",SDE,202182022,"ABORDAGEM SIMPLES",FILIAL,6194251b512a4e102e442a79,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105101,1637097902,"alert_manager","","",,"N/A","N/A",,"PR13-SAO_GONCALO",performance,"b830591e-b7d4-4f75-92d1-693ab766cbfc",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR13-SAO_GONCALO - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Rio de Janeiro","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179461.0000000",RJ,"RJO-SEDE_RJO/IP/34386 | 202182025",SDE,202182025,"ABORDAGEM SIMPLES",SEDE,6194251c512a4e102e442a7c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097902,"alert_manager","","",,"N/A","N/A",,"RJO-SEDE",performance,"bf8a97d8-23a5-46c6-b0a6-816fda07e686",port1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"RJO-SEDE - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Niterói","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179462.0000000",RJ,"-NITEROI_NRI/IP/06217 | 202182026",SDE,202182026,"ABORDAGEM SIMPLES",FILIAL,6194251d512a4e102e442a7e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098800,1637097902,"alert_manager","","",,"N/A","N/A",,"PR01-NITEROI",performance,"25746009-79d7-474e-b878-a5c5b357adc1",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR01-NITEROI - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Duque de Caxias","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179463.0000000",RJ,"DUQUE_DE_CAXIAS_DQX/IP/12092 | 202182027",SDE,202182027,"ABORDAGEM SIMPLES",FILIAL,6194251f512a4e102e442a81,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102700,1637097902,"alert_manager","","",,"N/A","N/A",,"PR02-DUQUE_DE_CAXIAS",performance,"55ae4198-2dbe-415b-b610-a18f671cbc41",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,41,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR02-DUQUE_DE_CAXIAS - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Nova Iguaçu","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179464.0000000",RJ,"NOVA_IGUACU_NIU/IP/09498 | 202182028",SDE,202182028,"ABORDAGEM SIMPLES",FILIAL,61942520512a4e102e442a83,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099100,1637097902,"alert_manager","","",,"N/A","N/A",,"PR03-NOVA_IGUACU",performance,"6f2e507f-1848-4207-a125-8d3b158c71c5",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,42,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR03-NOVA_IGUACU - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Barra do Piraí","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179465.0000000",RJ,"BARRA_DO_PIRAI_BPI/IP/00338 | 202182029",SDE,202182029,"ABORDAGEM SIMPLES",FILIAL,61942521512a4e102e442a86,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100602,1637097902,"alert_manager","","",,"N/A","N/A",,"PR04-BARRA_DO_PIRAI",performance,"41c65ca4-eedd-49fe-964b-a15d07e5fccc",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,44,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR04-BARRA_DO_PIRAI - Link acusou mais de 70% de utilização de banda",86400,low
"Não","São Luís","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179830.0000000",MA,"SAO_LUIS_MA/IP/05925 | 202183360",SDE,202183360,"DUPLA ABORDAGEM",FILIAL,61942522512a4e102e442a88,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637097901,"alert_manager","","",,"N/A","N/A",,"RT_REG-MA01",performance,"e4e6ae26-4f67-4718-a828-4236ded6eb9a","SD_CHECK_INTERNET - OL_MPLS","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"RT_REG-MA01 - A Latência da interface SD_CHECK_INTERNET - OL_MPLS excedeu o valor do 100",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61942523512a4e102e442a8a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098504,1637097905,"alert_manager","","",,"N/A","N/A",,202183366,performance,"1d551f52-3c0f-4677-9ade-92b90bb5c113",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61942524512a4e102e442a8c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098504,1637097905,"alert_manager","","",,"N/A","N/A",,202183367,performance,"3bcbfbc2-70d1-4bab-98bb-aef449893991",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61942524512a4e102e442a8e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098504,1637097905,"alert_manager","","",,"N/A","N/A",,202183373,performance,"4acac37d-8862-484e-8bbb-cf9dd99fd4b9",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,48,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61942525512a4e102e442a90,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098504,1637097905,"alert_manager","","",,"N/A","N/A",,202183380,performance,"d4cae464-9ed3-4897-9389-f0f3880f025f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,49,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61942526512a4e102e442a92,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098504,1637097905,"alert_manager","","",,"N/A","N/A",,202183383,performance,"2c576a2a-8e08-446d-91e0-57113ec0b47b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098680_12193_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,50,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,619425e7fa57811c983f50e4,"OPEN - GENERAL - V3",0,1637098876,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4157"", ""interface"": ""GE4""}","N/A",,202062013,medium,"8e8b8fb4-0521-402a-abe3-95052e5ba293",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637098980_12311_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",2,"202062013 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Umuarama,"GERDAU AÇOS LONGOS S A","154768.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040629,BAIXO,SDWAN,619425eefa57811c983f50f2,"OPEN - GENERAL - V3",1637099136,1637098876,"alert_manager","","",,"{""edgeId"": ""1008"", ""linkId"": ""2042"", ""interface"": ""GE3""}","N/A",,202040629,high,"91b0de5d-445c-419c-9dc1-a978cf7f699a",1008,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637098980_12311_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040629 - Edge 1008 entrou em status DEGRADED",86400,high
"Não",Manaus,"GERDAU AÇOS LONGOS SA","180265.0000000",AM,"N/A","SDWAN - VELOCLOUD",202183874,FLEX,SDWAN,619425effa57811c983f50f7,"OPEN - GENERAL - V3",1637099136,1637098876,"alert_manager","","",,"{""edgeId"": ""1930"", ""linkId"": ""5144"", ""interface"": ""GE3""}","N/A",,202183874,high,"57f39cc8-7f06-437a-9b55-a35c4f482836",1930,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637098980_12311_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202183874 - Edge 1930 entrou em status DEGRADED",86400,high
"Não","Ribeirão Preto","CONDOMINIO DO SHOPPING CENTER RIBEIRAO PRETO","155266.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041326,LOJA,SDWAN,619425f1fa57811c983f50fc,"OPEN - GENERAL - V3",1637099136,1637098876,"alert_manager","","",,"{""edgeId"": ""930"", ""linkId"": ""3433"", ""interface"": ""GE3""}","N/A",,202041326,high,"bb7e4e6a-2d83-493b-8a14-9bedeab301da",930,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637098980_12311_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041326 - Edge 930 entrou em status DEGRADED",86400,high
"Não","São Caetano do Sul","CONSORCIO SHOPPING SÃO CAETANO","155274.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041332,LOJA,SDWAN,619425f3fa57811c983f5101,"OPEN - GENERAL - V3",1637099136,1637098876,"alert_manager","","",,"{""edgeId"": ""936"", ""linkId"": ""3332"", ""interface"": ""GE3""}","N/A",,202041332,high,"d531d80d-e0d9-4d3a-860c-4eaa064b4e0d",936,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637098980_12311_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041332 - Edge 936 entrou em status DEGRADED",86400,high
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",6194263dfa57811c983f513d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099400,1637098201,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"d35a9217-9383-4b35-847a-aa533bfe0dc7","UOL - port1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port1 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",6194263efa57811c983f513f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099400,1637098201,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"6b2eede7-2014-4dbc-88bd-ceffe362e9a7","UOL - port3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port3 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",6194263ffa57811c983f5141,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099400,1637098201,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"447f541b-3350-4c12-a037-38d3759cfb80","UOL - port9","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port9 excedeu o valor do 100",86400,low
"Não","São Paulo","BRF S A","166835.0000000",SP,"BRF MERCADO SPO | 202055618",GRC,202055618,LOJA,SDE,61942640fa57811c983f5143,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099701,1637098201,"alert_manager","","",,"N/A","N/A",,"brf-spo-fw-1",performance,"48bfea5f-11b0-4cfd-89fe-459f5658dc55",b,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"brf-spo-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61942646fa57811c983f514b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098805,1637098203,"alert_manager","","",,"N/A","N/A",,202165385,performance,"c2cf96b9-e9eb-4156-a6ec-63bb71f5f66d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,17,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Uberlândia","REAL MOTO PECAS LTDA","174008.0000000",MG,"UBERLANDIA | 202171306",GRC,202171306,DADOS,DADOS,61942649fa57811c983f514f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102403,1637098804,"alert_manager","","",,"N/A","N/A",,"greal-ula-hafw-c",performance,"b45837d7-3e36-46ae-8867-902340cec1e3","VPN_MTUB - vpn-hub-3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-ula-hafw-c - A Latência da interface VPN_MTUB - vpn-hub-3 excedeu o valor do 100",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,6194264efa57811c983f5155,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101500,1637098201,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"18ae7d4d-d08c-4bd3-b582-3d474f5e6a17",a,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,61942659fa57811c983f5161,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101202,1637098201,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"410e256f-0493-402b-8be6-2ef23ac09f9f",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Itaperuna,"FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179472.0000000",RJ,"PR11-ITAPERUNA_IRA/IP/00792 | 202182020",SDE,202182020,"ABORDAGEM SIMPLES",FILIAL,6194265ffa57811c983f5169,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099400,1637098201,"alert_manager","","",,"N/A","N/A",,"PR11-ITAPERUNA",performance,"bf00c90e-550b-4096-ba90-52dd08ca0e8e",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,43,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR11-ITAPERUNA - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Niterói","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179462.0000000",RJ,"-NITEROI_NRI/IP/06217 | 202182026",SDE,202182026,"ABORDAGEM SIMPLES",FILIAL,61942664fa57811c983f516f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110502,1637098201,"alert_manager","","",,"N/A","N/A",,"PR01-NITEROI",performance,"a0c699d0-c9d5-4e2e-9c8b-e85ef8c2e0a3",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,48,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR01-NITEROI - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194266bfa57811c983f5178,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098805,1637098203,"alert_manager","","",,"N/A","N/A",,202183366,performance,"29c05954-e2b2-43fc-85dd-70437cef8615",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,56,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194266cfa57811c983f517a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098805,1637098203,"alert_manager","","",,"N/A","N/A",,202183367,performance,"1b02c1f4-c0e2-4085-8571-fc96b1498f73",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,57,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194266dfa57811c983f517c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098805,1637098203,"alert_manager","","",,"N/A","N/A",,202183373,performance,"db318418-21b5-4906-87ec-79c432713d8a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,58,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194266efa57811c983f517e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098805,1637098203,"alert_manager","","",,"N/A","N/A",,202183380,performance,"19926704-2f62-4129-a261-7e296748853e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,59,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194266ffa57811c983f5180,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637098805,1637098203,"alert_manager","","",,"N/A","N/A",,202183383,performance,"6476c02e-b82a-49bf-8816-70dbb66ff2f3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637098980_12315_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,60,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Serra,"GERDAU AÇOS LONGOS S A","154977.0000000",ES,"N/A","SDWAN - VELOCLOUD",202040675,BAIXO,SDWAN,61942717fa57811c983f5187,"OPEN - GENERAL - V3",1637099461,1637099136,"alert_manager","","",,"{""edgeId"": ""1012"", ""linkId"": ""1954"", ""interface"": ""GE3""}","N/A",,202040675,high,"9c6888e3-293b-4d8a-b715-b9a32c8f40c5",1012,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637099280_12322_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040675 - Edge 1012 entrou em status DEGRADED",86400,high
"Não",Cascavel,"PACAEMBU AUTOPECAS LTDA","107148.0000000",PR,"PACAEMBU CSC | 201744379",BSN,201744379,FILIAIS,"SEM CONTINGENCIA",61942761fa57811c983f518a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099400,1637098502,"alert_manager","","",,"N/A","N/A",,"pacaembu-csc-fw-029",performance,"96dcce42-edc1-4cae-ade3-106f38eb218d",lan1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-csc-fw-029 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",61942766fa57811c983f5190,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099702,1637098502,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"685489e7-49e9-4278-96c9-7285446805b5","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61942767fa57811c983f5192,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099401,1637098502,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"d35727d1-378b-435d-a515-784aa26365f1","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61942768fa57811c983f5194,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099702,1637098502,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"f9b6e75f-8670-47a0-95a3-41df98c7d574","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",6194276afa57811c983f5197,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099400,1637098502,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"e1aa8ba4-8b1c-4f91-995b-b7c93c95c4b5",port9,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61942774fa57811c983f51a3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099104,1637098504,"alert_manager","","",,"N/A","N/A",,202165385,performance,"5bf3f2c3-b4cd-4faf-9625-6f20cc2a8fe0",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Vitória da Conquista","REAL MOTO PECAS LTDA","174021.0000000",BA,"VITORIADACONQUISTA | 202171319",GRC,202171319,DADOS,DADOS,6194277dfa57811c983f51ad,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099702,1637098502,"alert_manager","","",,"N/A","N/A",,"greal-vca-hafw-c",performance,"00b037fb-b0b4-4bf2-be72-66b74b040f4d","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-vca-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174298.0000000",SP,"NICOLA | 202174605",SDE,202174605,SDWAN,SDE,61942787fa57811c983f51b9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100002,1637098502,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-ncl-fw-1",performance,"e970d466-efee-4597-8c16-8d8c323bb5fe",port15,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,40,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-ncl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Nova Iguaçu","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179464.0000000",RJ,"NOVA_IGUACU_NIU/IP/09498 | 202182028",SDE,202182028,"ABORDAGEM SIMPLES",FILIAL,61942797fa57811c983f51ca,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104202,1637098502,"alert_manager","","",,"N/A","N/A",,"PR03-NOVA_IGUACU",performance,"fb99c58d-6892-4501-80d0-70e1ed88faac",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,56,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR03-NOVA_IGUACU - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61942799fa57811c983f51ce,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099104,1637098504,"alert_manager","","",,"N/A","N/A",,202183366,performance,"eb195e20-b52e-4f01-96f1-7b3cd63a6887",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,59,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194279afa57811c983f51d0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099104,1637098504,"alert_manager","","",,"N/A","N/A",,202183367,performance,"988bbfa1-8fff-45b2-8ebb-6ba7c6cfb7c4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,60,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194279cfa57811c983f51d2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099104,1637098504,"alert_manager","","",,"N/A","N/A",,202183373,performance,"af1026c2-eb3c-437b-b70e-3871c419d9bd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,61,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194279cfa57811c983f51d4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099104,1637098504,"alert_manager","","",,"N/A","N/A",,202183380,performance,"8228c9ec-808e-452e-bcdd-270a97c363d6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,62,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194279dfa57811c983f51d6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099104,1637098504,"alert_manager","","",,"N/A","N/A",,202183383,performance,"10ad9fc8-e513-4a26-9986-d0ce6ec2a5bc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099280_12323_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,63,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",61942888512a4e102e442adf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099702,1637098801,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"243cbf2c-91d0-4252-83aa-65d191526adc","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61942889512a4e102e442ae2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099702,1637098801,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"f9640b09-727d-4646-915b-a9b24ac1eb33","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",6194288a512a4e102e442ae4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099702,1637098801,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"e494fcf9-0a2d-4042-b9ef-51b504cbadc4","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61942891512a4e102e442aed,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099405,1637098805,"alert_manager","","",,"N/A","N/A",,202165385,performance,"1d2367db-76e6-43a8-a483-90513fe5911f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,17,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Uberlândia","REAL MOTO PECAS LTDA","174008.0000000",MG,"UBERLANDIA | 202171306",GRC,202171306,DADOS,DADOS,61942895512a4e102e442af3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637098804,"alert_manager","","",,"N/A","N/A",,"greal-ula-hafw-c",performance,"a014452a-8e7c-4717-82f4-6fb4cb18a5fa","VPN_PWM - vpn-hub-3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"greal-ula-hafw-c - A Latência da interface VPN_PWM - vpn-hub-3 excedeu o valor do 100",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619428ae512a4e102e442b15,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099405,1637098805,"alert_manager","","",,"N/A","N/A",,202183366,performance,"a5e14170-7950-4298-be8d-2d04af203738",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,55,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619428af512a4e102e442b17,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099405,1637098805,"alert_manager","","",,"N/A","N/A",,202183367,performance,"7af9ced5-323f-43a1-976f-fe711fdeb4dc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,56,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619428b0512a4e102e442b19,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099405,1637098805,"alert_manager","","",,"N/A","N/A",,202183373,performance,"b037c77c-9cba-4102-9de2-75212ea782c1",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,57,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619428b1512a4e102e442b1b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099405,1637098805,"alert_manager","","",,"N/A","N/A",,202183380,performance,"2e2488e7-729b-42dd-92fc-f33cf38edf6c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,58,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619428b1512a4e102e442b1d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099405,1637098805,"alert_manager","","",,"N/A","N/A",,202183383,performance,"b433aa80-9162-435d-8431-67901474d73d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099580_12225_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,59,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",619429b2512a4e102e442b24,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100002,1637099100,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"fa5ef534-4577-4011-8067-232351efa6c8",port2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099880_12234_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619429b8512a4e102e442b2c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099703,1637099104,"alert_manager","","",,"N/A","N/A",,202165385,performance,"eb92c6a5-c9ce-4fbc-b1d4-7e4b5c008826",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099880_12234_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Parnamirim,"REAL MOTO PECAS LTDA","174026.0000000",RN,"NATAL | 202171327",GRC,202171327,DADOS,DADOS,619429c1512a4e102e442b39,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637099102,"alert_manager","","",,"N/A","N/A",,"greal-pwm-hafw-c",performance,"e1c63aff-5f60-4e64-8af2-c6030421199a","SLA Matriz - vpn-pwm-w1-w2","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099880_12234_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"greal-pwm-hafw-c - A Latência da interface SLA Matriz - vpn-pwm-w1-w2 excedeu o valor do 100",86400,low
"Não","Macaé","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179470.0000000",RJ,"PR09-MACAE_MCE/IP/03625 | 202182018",SDE,202182018,"ABORDAGEM SIMPLES",FILIAL,619429ca512a4e102e442b45,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100002,1637099100,"alert_manager","","",,"N/A","N/A",,"PR09-MACAE",performance,"cdcf19b1-27b2-407d-8944-dc42a0967055",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099880_12234_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR09-MACAE - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619429d3512a4e102e442b52,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099703,1637099104,"alert_manager","","",,"N/A","N/A",,202183366,performance,"73a9f6ed-1786-4eb6-bfc2-2ef6bd64ed0e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099880_12234_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619429d4512a4e102e442b54,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099703,1637099104,"alert_manager","","",,"N/A","N/A",,202183367,performance,"d800da58-8f50-494d-92b9-f916eeb22c7c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099880_12234_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,48,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619429d5512a4e102e442b56,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099703,1637099104,"alert_manager","","",,"N/A","N/A",,202183373,performance,"9e335911-0212-4bd5-a6ea-83bd743d1dbf",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099880_12234_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,49,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619429d6512a4e102e442b58,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099703,1637099104,"alert_manager","","",,"N/A","N/A",,202183380,performance,"fdc93a10-3206-4299-aea6-90229bd5404a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099880_12234_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,50,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619429d6512a4e102e442b5a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637099703,1637099104,"alert_manager","","",,"N/A","N/A",,202183383,performance,"c7ee7076-dba0-4ac3-8dc4-1b292880f750",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637099880_12234_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,51,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61942ae9fa57811c983f51e2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100602,1637099400,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"25a3a19d-7feb-4ae8-8b3e-30281d362e15",port9,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100180_12348_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61942af0fa57811c983f51ea,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100002,1637099405,"alert_manager","","",,"N/A","N/A",,202165385,performance,"ba2d6617-3364-462f-8f20-a5191766fd77",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100180_12348_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174298.0000000",SP,"NICOLA | 202174605",SDE,202174605,SDWAN,SDE,61942afffa57811c983f51fb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101202,1637099400,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-ncl-fw-1",performance,"8c0ff626-ea38-4226-b8a6-5dea01882a1f",wan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100180_12348_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-ncl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Itaperuna,"FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179472.0000000",RJ,"PR11-ITAPERUNA_IRA/IP/00792 | 202182020",SDE,202182020,"ABORDAGEM SIMPLES",FILIAL,61942b04fa57811c983f5201,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102402,1637099400,"alert_manager","","",,"N/A","N/A",,"PR11-ITAPERUNA",performance,"c2902c74-c9c3-4c71-925b-28bcb7c67b50",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100180_12348_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR11-ITAPERUNA - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61942b10fa57811c983f520e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100005,1637099405,"alert_manager","","",,"N/A","N/A",,202183366,performance,"88f341cb-2bf0-44b9-a26c-c5a0604b87eb",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100180_12348_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61942b11fa57811c983f5210,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100005,1637099405,"alert_manager","","",,"N/A","N/A",,202183367,performance,"ea30e8a8-2c05-4d34-8db7-fc312c039e56",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100180_12348_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61942b12fa57811c983f5212,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100005,1637099405,"alert_manager","","",,"N/A","N/A",,202183373,performance,"c1971e3a-b9ef-40e5-a131-824fd88569be",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100180_12348_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61942b13fa57811c983f5214,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100005,1637099405,"alert_manager","","",,"N/A","N/A",,202183380,performance,"7ead6562-8df6-4d98-bf22-0db22a890acd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100180_12348_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,48,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61942b14fa57811c983f5216,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100005,1637099405,"alert_manager","","",,"N/A","N/A",,202183383,performance,"e3bdb1c3-ff6e-4262-a1a0-578a0d4511f2",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100180_12348_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,49,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",61942c07512a4e102e442ba1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100902,1637099702,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"d41b5971-616a-472e-93cd-4143d0285d42","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",61942c08512a4e102e442ba3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100902,1637099702,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"25ac0fd3-641a-4e6a-97f2-f09239d6f4a2","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61942c08512a4e102e442ba5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102401,1637099702,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"5507fe29-5ef8-42ff-a172-ae82fc17d08d","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61942c13512a4e102e442bb3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100304,1637099703,"alert_manager","","",,"N/A","N/A",,202165385,performance,"00bcb60e-e1f9-42ad-a6dd-a2d7b470f586",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Vitória da Conquista","REAL MOTO PECAS LTDA","174021.0000000",BA,"VITORIADACONQUISTA | 202171319",GRC,202171319,DADOS,DADOS,61942c18512a4e102e442bbb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102102,1637099702,"alert_manager","","",,"N/A","N/A",,"greal-vca-hafw-c",performance,"34b3edf4-90f0-4a8a-abe8-e6711dd588a6","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-vca-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61942c2d512a4e102e442bd7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100304,1637099703,"alert_manager","","",,"N/A","N/A",,202183366,performance,"7c9e96e5-312f-4245-ba11-9bf5f644a0aa",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,49,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61942c2e512a4e102e442bd9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100304,1637099703,"alert_manager","","",,"N/A","N/A",,202183367,performance,"d18dfb96-c0e5-4135-8ff3-b64bb49b5025",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,50,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61942c2f512a4e102e442bdb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100304,1637099703,"alert_manager","","",,"N/A","N/A",,202183373,performance,"eff75a67-c7c5-486e-a936-e3d7fb267e1a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,51,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61942c2f512a4e102e442bdd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100304,1637099703,"alert_manager","","",,"N/A","N/A",,202183380,performance,"a8e4d233-00f4-45c4-8195-fc730348afa0",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,52,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61942c30512a4e102e442bdf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100304,1637099703,"alert_manager","","",,"N/A","N/A",,202183383,performance,"6797bdec-3469-49e6-95d1-196ab7ae6863",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100480_12261_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,53,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61942d4afa57811c983f526b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100605,1637100002,"alert_manager","","",,"N/A","N/A",,202165385,performance,"cf175c8a-921a-4e0c-a24a-84f43f70f517",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100780_12371_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Fortaleza,"REAL MOTO PECAS LTDA","174020.0000000",CE,"FORTALEZA | 202171318",GRC,202171318,DADOS,DADOS,61942d4ffa57811c983f5271,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101201,1637100002,"alert_manager","","",,"N/A","N/A",,"greal-fla-hafw-c",performance,"bda33624-f462-41ef-97d3-2301bd7b3a18","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100780_12371_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-fla-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61942d69fa57811c983f528d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100605,1637100005,"alert_manager","","",,"N/A","N/A",,202183366,performance,"ddb38f56-bfb1-437e-8646-8887de163456",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100780_12371_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61942d6afa57811c983f528f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100605,1637100005,"alert_manager","","",,"N/A","N/A",,202183367,performance,"03fb472b-2968-4ee9-92c6-367006711b7f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100780_12371_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61942d6bfa57811c983f5291,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100605,1637100005,"alert_manager","","",,"N/A","N/A",,202183373,performance,"e98dc078-8c37-44de-bd98-ad07454ecc02",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100780_12371_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,48,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61942d6cfa57811c983f5293,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100605,1637100005,"alert_manager","","",,"N/A","N/A",,202183380,performance,"865abb7d-a206-4231-8dd9-63dcabb2b8a3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100780_12371_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,49,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61942d6dfa57811c983f5295,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100605,1637100005,"alert_manager","","",,"N/A","N/A",,202183383,performance,"c0c81803-800c-4281-a79f-2a0faca57635",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637100780_12371_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,50,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",61942e1eb4a8174f7a514992,"OPEN - GENERAL - V3",1637101249,1637100949,"alert_manager","","",,"{""edgeId"": ""467"", ""linkId"": ""1628"", ""interface"": ""GE3""}","N/A",,202058101,high,"8a5f7964-f13a-4c30-a4c8-76f5cecac585",467,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637101080_12160_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058101 - Edge 467 entrou em status DEGRADED",86400,high
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",61942e6dfa57811c983f529c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101801,1637100300,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"86ccf122-297b-4bd0-a20b-48e4ef1c1480","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61942e6efa57811c983f529f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101201,1637100300,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"8306a901-5049-4160-84ca-7aceb5cdda21","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61942e6ffa57811c983f52a1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101800,1637100300,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"a9281902-78f1-4bb5-858c-b6ee03ac4ec3","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61942e76fa57811c983f52a9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100904,1637100304,"alert_manager","","",,"N/A","N/A",,202165385,performance,"f061ddf1-c8e4-4353-b6fe-72dc6ae96ae9",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,61942e87fa57811c983f52bc,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101802,1637100300,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"6bcb414a-8e4a-44bc-b537-ba0777d50b41",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61942e93fa57811c983f52c9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100904,1637100304,"alert_manager","","",,"N/A","N/A",,202183366,performance,"75eb0e2a-1534-405f-ba73-d198b0509bc7",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61942e94fa57811c983f52cb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100904,1637100304,"alert_manager","","",,"N/A","N/A",,202183367,performance,"b14085b1-671c-4054-a17c-876b4c8e0356",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61942e95fa57811c983f52cd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100904,1637100304,"alert_manager","","",,"N/A","N/A",,202183373,performance,"d69be68d-765f-4934-9916-db8235600660",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61942e96fa57811c983f52cf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100904,1637100304,"alert_manager","","",,"N/A","N/A",,202183380,performance,"b2ac66d8-8671-4cda-a9a6-425e9598b55c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,48,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61942e97fa57811c983f52d1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637100904,1637100304,"alert_manager","","",,"N/A","N/A",,202183383,performance,"2741fc95-b1ea-4c0f-8c9d-6ce8a08d47e2",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101080_12383_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,49,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Simões Filho","GERDAU AÇOS LONGOS S A","154951.0000000",BA,"N/A","SDWAN - VELOCLOUD",202040644,BAIXO,SDWAN,61942f48b4a8174f7a514998,"OPEN - GENERAL - V3",1637101835,1637101249,"alert_manager","","",,"{""edgeId"": ""918"", ""linkId"": ""2134"", ""interface"": ""GE4""}","N/A",,202040644,medium,"b2d460c9-586f-4575-bffc-997c5d71d639",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637101380_12170_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040644 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61942f4cb4a8174f7a5149a2,"OPEN - GENERAL - V3",1637102705,1637101249,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"0e75bf3b-a6eb-4e69-832e-5282226b07b2",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637101380_12170_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status OFFLINE",86400,high
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",61942f96b4a8174f7a5149e4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101801,1637100602,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"7ab8a0eb-eb02-4933-8cbc-fc750d60f7de","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101380_12171_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61942fa0b4a8174f7a5149ef,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101202,1637100605,"alert_manager","","",,"N/A","N/A",,202165385,performance,"2956eb29-f739-48af-946e-09827ea2b6a1",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101380_12171_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61942fbab4a8174f7a514a0d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101205,1637100605,"alert_manager","","",,"N/A","N/A",,202183366,performance,"6afb731f-9517-4ee4-8b56-9b45879514a0",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101380_12171_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,44,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61942fbbb4a8174f7a514a0f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101205,1637100605,"alert_manager","","",,"N/A","N/A",,202183367,performance,"923daad7-9cd0-4ede-b1f0-df856b15e85a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101380_12171_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61942fbcb4a8174f7a514a11,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101205,1637100605,"alert_manager","","",,"N/A","N/A",,202183373,performance,"2c90ff1a-0f07-492c-ad02-6146c8eeaa5d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101380_12171_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61942fbdb4a8174f7a514a13,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101205,1637100605,"alert_manager","","",,"N/A","N/A",,202183380,performance,"77f9cd09-507f-4f44-b8d6-b858df174798",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101380_12171_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61942fbeb4a8174f7a514a15,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101205,1637100605,"alert_manager","","",,"N/A","N/A",,202183383,performance,"85416859-3eba-4db0-a87b-797116deb3f6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101380_12171_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,48,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619430bffa57811c983f52d3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101800,1637100902,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"e4dddf53-9948-4e85-986a-571163ece926","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619430c0fa57811c983f52d5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101800,1637100902,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"1c4902ec-7e0b-46a6-a4d1-b88383a08a64","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",619430c1fa57811c983f52d7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101800,1637100902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"7cd1cfda-8597-47d8-b42d-b4f87cc3e80d","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",619430c2fa57811c983f52d9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101800,1637100902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"632654d3-c9bb-4f98-92bb-0c98e8c224bd","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,3,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",619430cafa57811c983f52e2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101801,1637100902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"0ebc877f-28e8-4c3f-8d55-181c1683ce53","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",619430cafa57811c983f52e4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106302,1637100902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"c1718603-8d32-4cb0-b0e5-80003699b678","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",619430cbfa57811c983f52e6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102702,1637100902,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"d89a33ee-8a72-42d6-85f7-fd102473ffbd","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619430d4fa57811c983f52f0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101504,1637100904,"alert_manager","","",,"N/A","N/A",,202165385,performance,"26b1aa9f-e74d-43af-8c62-ac401be1ac43",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Brasília","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179475.0000000",DF,"",SDE,202182023,"ABORDAGEM SIMPLES",FILIAL,619430dffa57811c983f52fd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102101,1637100901,"alert_manager","","",,"N/A","N/A",,202182023,performance,"522e74cc-6757-4e10-a3a1-ed1f5c9cb465",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202182023 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619430e8fa57811c983f5307,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101504,1637100904,"alert_manager","","",,"N/A","N/A",,202183366,performance,"264f1903-7ab2-49ac-8cae-fde8b8f69643",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,43,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619430e9fa57811c983f5309,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101504,1637100904,"alert_manager","","",,"N/A","N/A",,202183367,performance,"08d8f174-857c-4692-be46-1c2ab0b4e8a7",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,44,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619430eafa57811c983f530b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101504,1637100904,"alert_manager","","",,"N/A","N/A",,202183373,performance,"4725604f-4eb1-4c1d-adff-5579e442b1dc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619430ebfa57811c983f530d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101504,1637100904,"alert_manager","","",,"N/A","N/A",,202183380,performance,"e005b7b2-ad1a-4eec-abb0-99194ef254b4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619430ecfa57811c983f530f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101504,1637100904,"alert_manager","","",,"N/A","N/A",,202183383,performance,"8fc459e7-6d90-42c4-bab8-1b30c966d290",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101680_12399_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",619431e3512a4e102e442c75,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102102,1637101201,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"61f1083d-1a06-42e0-9f63-1903271918e4","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",619431e5512a4e102e442c79,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102401,1637101200,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"a0665ecb-99d1-441d-b73e-d008fa3b1690","UOL - port1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port1 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",619431e6512a4e102e442c7b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102401,1637101200,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"67c98444-5fc0-4eb2-add0-e7ba25559fb3","UOL - port3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port3 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",619431e7512a4e102e442c7d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102401,1637101200,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"4408acdf-519c-4102-839a-78c77e623de3","UOL - port9","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port9 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619431ec512a4e102e442c85,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101804,1637101202,"alert_manager","","",,"N/A","N/A",,202165385,performance,"50af2c3a-7860-4c91-9035-268c2190ed47",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619431ff512a4e102e442c9d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101804,1637101205,"alert_manager","","",,"N/A","N/A",,202183366,performance,"dbe2939f-46e2-4e62-9cc2-e1e7234e9e95",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,41,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619431ff512a4e102e442c9f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101804,1637101205,"alert_manager","","",,"N/A","N/A",,202183367,performance,"97504180-13a9-4157-ab75-e41884396d02",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,42,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61943200512a4e102e442ca1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101804,1637101205,"alert_manager","","",,"N/A","N/A",,202183373,performance,"8f457796-7693-4fae-a27c-fe43426bd21d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,43,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61943201512a4e102e442ca3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101804,1637101205,"alert_manager","","",,"N/A","N/A",,202183380,performance,"40e744a1-bfcd-4a63-81f2-c6b13d9f5856",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,44,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61943202512a4e102e442ca5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637101804,1637101205,"alert_manager","","",,"N/A","N/A",,202183383,performance,"3fec15ad-2252-4aeb-bc8c-a6cdb055c130",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637101980_12312_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",6194331dfa57811c983f5317,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102401,1637101502,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"1871385a-10d5-44a1-9327-420cd384ee70","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943328fa57811c983f5324,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102105,1637101504,"alert_manager","","",,"N/A","N/A",,202165385,performance,"6e22cbbc-e8e0-4312-b015-ed26be556aee",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","São Paulo","REAL MOTO PECAS LTDA","174010.0000000",SP,"SAOPAULO | 202171308",GRC,202171308,DADOS,DADOS,61943329fa57811c983f5326,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103002,1637101500,"alert_manager","","",,"N/A","N/A",,"greal-spo-hafw-c",performance,"20114e20-8f1b-463b-8dab-3c5f960a6f67",lan1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-spo-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Goiânia","REAL MOTO PECAS LTDA","174015.0000000",GO,"GOIANIA | 202171313",GRC,202171313,DADOS,DADOS,6194332afa57811c983f5328,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104800,1637101500,"alert_manager","","",,"N/A","N/A",,"greal-gna-hafw-c",performance,"8c8af91d-1c0f-4055-bd41-a25cc1141194",lan1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-gna-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Fortaleza,"REAL MOTO PECAS LTDA","174020.0000000",CE,"FORTALEZA | 202171318",GRC,202171318,DADOS,DADOS,6194332bfa57811c983f532a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102401,1637101503,"alert_manager","","",,"N/A","N/A",,"greal-fla-hafw-c",performance,"3fa31bd7-59dd-4e86-8f37-8ca938c7c493","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-fla-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Cabo Frio","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179473.0000000",RJ,"PR12-CABO_FRIO_CBF/IP/04614 | 202182021",SDE,202182021,"ABORDAGEM SIMPLES",FILIAL,61943335fa57811c983f5336,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102402,1637101500,"alert_manager","","",,"N/A","N/A",,"PR12-CABO_FRIO",performance,"001a3af6-857a-44fb-9231-ff4928a00eec",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR12-CABO_FRIO - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194333ffa57811c983f5341,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102105,1637101504,"alert_manager","","",,"N/A","N/A",,202183366,performance,"fa313290-2bef-4306-8bdc-b8ddca1e5804",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,42,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61943340fa57811c983f5343,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102105,1637101504,"alert_manager","","",,"N/A","N/A",,202183367,performance,"e6149c87-6476-4fd2-8ea5-5d5419ebfaa0",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,43,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61943341fa57811c983f5345,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102105,1637101504,"alert_manager","","",,"N/A","N/A",,202183373,performance,"9f8a8fe6-3213-45a8-a519-55bf2e5ebd1c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,44,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61943342fa57811c983f5347,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102105,1637101504,"alert_manager","","",,"N/A","N/A",,202183380,performance,"83b60b68-b44d-4cd3-823f-dd1634eeafb2",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61943343fa57811c983f5349,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102105,1637101504,"alert_manager","","",,"N/A","N/A",,202183383,performance,"00dbf19d-b8fb-441a-8575-8483232eb100",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102280_12419_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",6194343b512a4e102e442ced,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103001,1637101800,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"0ac62f8b-2590-4b65-bd6f-5e093155cd88","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",6194343b512a4e102e442cef,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103001,1637101800,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"cb4d1aff-bece-4716-9700-c4a4945559dc","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",6194343e512a4e102e442cf3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103302,1637101800,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"25fc4b58-5b24-420e-aabd-cc71cfb1952f","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",61943440512a4e102e442cf7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103600,1637101801,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"8784c087-c5d2-48b8-a349-4dca733315c5","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",61943441512a4e102e442cf9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103600,1637101801,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"3b16cf87-fc85-437f-8320-30c4b59ed8ab","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61943444512a4e102e442cfe,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103600,1637101800,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"cc171de7-f892-44a9-b5a2-f963705f3a5d","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943449512a4e102e442d06,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102404,1637101804,"alert_manager","","",,"N/A","N/A",,202165385,performance,"76a93ee9-2ae7-49d7-b446-a7338fa55e20",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,6194344c512a4e102e442d0b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104202,1637101802,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"9aa9a755-0605-495c-9723-ef9ff064f1dd",a,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174298.0000000",SP,"NICOLA | 202174605",SDE,202174605,SDWAN,SDE,61943454512a4e102e442d16,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102700,1637101802,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-ncl-fw-1",performance,"0b89efc8-d5ed-4ab5-bb7c-ad8800137f77",port15,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-ncl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,61943458512a4e102e442d1c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104202,1637101802,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"dfaf4d52-8add-4484-9a60-8db1c5ba1ae7",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194345f512a4e102e442d25,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102404,1637101804,"alert_manager","","",,"N/A","N/A",,202183366,performance,"c4b14e10-ba87-41fa-a0a6-d13ac306b225",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194345f512a4e102e442d27,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102404,1637101804,"alert_manager","","",,"N/A","N/A",,202183367,performance,"129be52d-846b-4f60-9a98-95a0b55880f5",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61943460512a4e102e442d29,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102404,1637101804,"alert_manager","","",,"N/A","N/A",,202183373,performance,"f8dbe1e1-3394-4c09-82c1-89806d38c6a0",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,48,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61943461512a4e102e442d2b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102404,1637101804,"alert_manager","","",,"N/A","N/A",,202183380,performance,"eebe8798-68e6-429b-81db-790760064d74",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,49,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61943462512a4e102e442d2d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102404,1637101804,"alert_manager","","",,"N/A","N/A",,202183383,performance,"99f70693-e086-4ebd-b2ef-9ac7460d6e4d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102580_12329_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,50,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",61943525b4a8174f7a514aa5,"OPEN - GENERAL - V3",1637103606,1637102705,"alert_manager","","",,"{""edgeId"": ""1564"", ""linkId"": ""4046"", ""interface"": ""GE3""}","N/A",,202061987,high,"8f50580a-e88e-4df1-9700-7c040212b7de",1564,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637102880_12230_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061987 - Edge 1564 entrou em status DEGRADED",86400,high
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943582b4a8174f7a514af6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102705,1637102105,"alert_manager","","",,"N/A","N/A",,202165385,performance,"81134c26-2c50-4fad-af48-697022e25490",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102880_12236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Vitória da Conquista","REAL MOTO PECAS LTDA","174021.0000000",BA,"VITORIADACONQUISTA | 202171319",GRC,202171319,DADOS,DADOS,61943586b4a8174f7a514afb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103303,1637102102,"alert_manager","","",,"N/A","N/A",,"greal-vca-hafw-c",performance,"4e11e804-0387-433e-9e70-3576033cdd2b","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102880_12236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-vca-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","174294.0000000",SP,"IDU-UNILEVER | 202174602",SDE,202174602,SDWAN,SDE,6194358eb4a8174f7a514b05,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103002,1637102101,"alert_manager","","",,"N/A","N/A",,"tegma-idu-unl-fw-1",performance,"8bf8123a-0ef0-4071-bca2-0425f2215acd",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102880_12236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-idu-unl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174297.0000000",SP,"MIRO | 202174604",SDE,202174604,SDWAN,SDE,6194358fb4a8174f7a514b07,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103002,1637102101,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-mro-fw-1",performance,"b75fd7bc-5d75-4234-888c-23fa0cfe437d",wan1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102880_12236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-mro-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61943599b4a8174f7a514b13,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102705,1637102105,"alert_manager","","",,"N/A","N/A",,202183366,performance,"7281ba4b-8925-4a4b-8a8d-a17f44617734",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102880_12236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,43,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194359ab4a8174f7a514b15,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102703,1637102105,"alert_manager","","",,"N/A","N/A",,202183367,performance,"54fafdc9-40bb-4ce1-bde8-16fd2e34a43d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102880_12236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,44,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194359bb4a8174f7a514b17,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102705,1637102105,"alert_manager","","",,"N/A","N/A",,202183373,performance,"41321b91-1ed2-4567-90b9-33a3cd52f76a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102880_12236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194359cb4a8174f7a514b19,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102705,1637102105,"alert_manager","","",,"N/A","N/A",,202183380,performance,"862ef783-55da-46d2-a3f5-12e67d7cca90",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102880_12236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194359db4a8174f7a514b1b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637102705,1637102105,"alert_manager","","",,"N/A","N/A",,202183383,performance,"df58f36f-97ab-4fbc-84d0-873a87a75781",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637102880_12236_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","SAO JOSE DO RIO PRETO","PACAEMBU AUTOPEÇAS LTDA","108875.0000000",SP,"PACAEMBU SRR | 201748895",BSN,201748895,FILIAIS,"SEM CONTINGENCIA",61943693512a4e102e442d2f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103302,1637102401,"alert_manager","","",,"N/A","N/A",,"pacaembu-srr-fw-004",performance,"9f228e19-fa0b-4562-a5b8-d72e427d492f","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-srr-fw-004 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","SAO JOSE DO RIO PRETO","PACAEMBU AUTOPEÇAS LTDA","108875.0000000",SP,"PACAEMBU SRR | 201748895",BSN,201748895,FILIAIS,"SEM CONTINGENCIA",61943694512a4e102e442d31,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103302,1637102401,"alert_manager","","",,"N/A","N/A",,"pacaembu-srr-fw-004",performance,"8614febc-98b8-4c07-8203-db576c8b110e","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-srr-fw-004 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61943695512a4e102e442d33,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103302,1637102401,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"92ed9dcd-979a-4eb3-87e4-24b31ca1ddc9","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61943697512a4e102e442d37,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103302,1637102401,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"ef3ada7f-ca2b-489e-b0b2-10efa84b1e38","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",6194369b512a4e102e442d3c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103600,1637102401,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"7f0172fa-d38d-4a2e-857f-45ff7f439bb0","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619436a4512a4e102e442d49,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103003,1637102404,"alert_manager","","",,"N/A","N/A",,202165385,performance,"8651477a-34f5-4e9b-bc8a-9929fb5d4c78",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,619436ac512a4e102e442d55,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103002,1637102402,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"4c194371-e766-41c3-8726-6b1ce7d44dd1",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,619436af512a4e102e442d5a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103003,1637102401,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"df741dbb-4af2-4a52-ad26-e19834a85c5c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619436b6512a4e102e442d63,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103003,1637102404,"alert_manager","","",,"N/A","N/A",,202183366,performance,"d54b0477-6ab6-40bf-90ce-b55b79c22cf9",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,44,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619436b6512a4e102e442d65,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103003,1637102404,"alert_manager","","",,"N/A","N/A",,202183367,performance,"53b6020f-65ef-4626-8e9a-ac968cc83fe3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619436b7512a4e102e442d67,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103003,1637102404,"alert_manager","","",,"N/A","N/A",,202183373,performance,"86325be1-728d-407f-ab10-6e17c5003975",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619436b8512a4e102e442d69,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103003,1637102404,"alert_manager","","",,"N/A","N/A",,202183380,performance,"94fca149-fa08-4366-835f-633bcd874dd5",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619436b9512a4e102e442d6b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103003,1637102404,"alert_manager","","",,"N/A","N/A",,202183383,performance,"b3edb7da-429d-4414-9be6-8aa085485c00",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103180_12347_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,48,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",619437c3512a4e102e442d75,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103600,1637102702,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"a7a54d50-cb44-4542-8730-6ba119dcb572","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",619437c4512a4e102e442d77,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103600,1637102702,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"fc146494-f7d4-4f71-9e55-06ca40428157","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",619437c6512a4e102e442d7a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103600,1637102702,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"e0dae254-187b-434a-9dac-78bfeb96ff41","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619437cc512a4e102e442d83,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103305,1637102705,"alert_manager","","",,"N/A","N/A",,202165385,performance,"11ea24da-e8f3-421e-b271-19c32cdc2580",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174298.0000000",SP,"NICOLA | 202174605",SDE,202174605,SDWAN,SDE,619437d4512a4e102e442d8e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103601,1637102700,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-ncl-fw-1",performance,"55455da5-1f16-4efb-a37a-8cda49f09d84",port16,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-ncl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,619437d8512a4e102e442d94,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103305,1637102705,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"b37544a7-cabb-4ec1-9a30-4588d5a917cc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não","Brasília","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179475.0000000",DF,"",SDE,202182023,"ABORDAGEM SIMPLES",FILIAL,619437da512a4e102e442d97,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103601,1637102700,"alert_manager","","",,"N/A","N/A",,202182023,performance,"7d3b2233-e75b-4d32-ba93-b0940937f85b",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202182023 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619437e0512a4e102e442d9f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103305,1637102705,"alert_manager","","",,"N/A","N/A",,202183366,performance,"6faf105f-1bc6-473d-82a4-c27f9d5a36f1",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,43,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619437e0512a4e102e442da1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103305,1637102703,"alert_manager","","",,"N/A","N/A",,202183367,performance,"64032c48-fda9-46c5-ba05-938f432349d3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,44,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619437e1512a4e102e442da3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103305,1637102705,"alert_manager","","",,"N/A","N/A",,202183373,performance,"692f3273-3b66-4778-8391-9efc7c1b4d3a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,45,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619437e2512a4e102e442da5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103305,1637102705,"alert_manager","","",,"N/A","N/A",,202183380,performance,"2f750355-f1ba-45c3-8235-9b1cd3638694",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,46,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619437e3512a4e102e442da7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103305,1637102705,"alert_manager","","",,"N/A","N/A",,202183383,performance,"4c589832-8671-479b-aabf-855b5b8792bf",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103480_12355_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,47,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943901fa57811c983f53e5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103605,1637103003,"alert_manager","","",,"N/A","N/A",,202165385,performance,"1a7336ba-16e7-4e46-b358-8fe5e417e02d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103780_12471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174298.0000000",SP,"NICOLA | 202174605",SDE,202174605,SDWAN,SDE,6194390afa57811c983f53f0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103901,1637103002,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-ncl-fw-1",performance,"4b5a5698-8a57-4930-82ec-0e3a3cffd719",port15,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103780_12471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-ncl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,6194390bfa57811c983f53f2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104800,1637103002,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"6543d6b8-5ede-4326-b888-26eba5c3f604",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103780_12471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,6194390ffa57811c983f53f7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103605,1637103003,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"58a25410-f3dc-4014-9305-75c81b6de3d4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103780_12471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61943917fa57811c983f5400,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103605,1637103003,"alert_manager","","",,"N/A","N/A",,202183366,performance,"0cc2e3bb-fa42-47de-8c09-835f9996343c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103780_12471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61943918fa57811c983f5402,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103605,1637103003,"alert_manager","","",,"N/A","N/A",,202183367,performance,"5169b056-5793-438f-af17-b93bb64fb34a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103780_12471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61943919fa57811c983f5404,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103605,1637103003,"alert_manager","","",,"N/A","N/A",,202183373,performance,"cd254eb6-870c-4b70-8adf-1fcd92baf2b4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103780_12471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194391afa57811c983f5406,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103605,1637103003,"alert_manager","","",,"N/A","N/A",,202183380,performance,"10cac88f-ac0f-4b7b-bae2-b4c8b8fa3a4b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103780_12471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194391bfa57811c983f5408,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103605,1637103003,"alert_manager","","",,"N/A","N/A",,202183383,performance,"002098cd-3642-479c-83f2-df2104e2776b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637103780_12471_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61943a23fa57811c983f540e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104200,1637103302,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"2d1add7b-0fe3-4d96-9f1b-49a00474404d","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104080_12485_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61943a26fa57811c983f5412,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104200,1637103302,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"a9fd85dc-90e7-4cf6-90cb-25d480042fc7","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104080_12485_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,3,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943a30fa57811c983f541d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103905,1637103305,"alert_manager","","",,"N/A","N/A",,202165385,performance,"9f9a2d2c-2052-4633-8ce4-f17d4cac7046",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104080_12485_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,61943a3dfa57811c983f542c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103905,1637103305,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"8b9caa2e-7ed4-4803-a4cd-a43f81efd2b0",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104080_12485_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61943a44fa57811c983f5434,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103905,1637103305,"alert_manager","","",,"N/A","N/A",,202183366,performance,"6433a68c-cdac-49d8-a458-a0f2a9e2b51c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104080_12485_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61943a45fa57811c983f5436,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103905,1637103305,"alert_manager","","",,"N/A","N/A",,202183367,performance,"c5fd2a92-f573-447c-8972-46713b0162f3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104080_12485_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61943a46fa57811c983f5438,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103905,1637103305,"alert_manager","","",,"N/A","N/A",,202183373,performance,"816ae506-8219-4db3-8b01-d5740a210891",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104080_12485_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61943a47fa57811c983f543a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103905,1637103305,"alert_manager","","",,"N/A","N/A",,202183380,performance,"8e4fd049-2bc8-4808-86c0-e1fa46a59f0a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104080_12485_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61943a48fa57811c983f543c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637103905,1637103305,"alert_manager","","",,"N/A","N/A",,202183383,performance,"5665e8f0-4605-42f2-a615-499ef7501a33",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104080_12485_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",61943b01b4a8174f7a514b21,"OPEN - GENERAL - V3",1637104827,1637104205,"alert_manager","","",,"{""edgeId"": ""1047"", ""linkId"": ""1862"", ""interface"": ""GE3""}","N/A",,202058018,high,"f47e1ed9-edc1-48cd-a584-a81d338d3f32",1047,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637104380_12275_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058018 - Edge 1047 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61943b03b4a8174f7a514b24,"OPEN - GENERAL - V3",1637104827,1637104205,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","N/A",,202062007,high,"895a7f48-65d1-4a41-94b7-8930ddaecfb2",1578,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637104380_12275_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062007 - Edge 1578 entrou em status DEGRADED",86400,high
"Não",Ipatinga,"USINAS SIDERURGICAS DE MINAS GERAIS S A - USIMINAS","168437.0000000",MG,"N/A","SDWAN - VELOCLOUD",202057369,SDWAN,SDWAN,61943b05b4a8174f7a514b27,"OPEN - GENERAL - V3",1637104827,1637104205,"alert_manager","","",,"{""edgeId"": ""1757"", ""linkId"": ""4206"", ""interface"": ""GE5""}","N/A",,202057369,high,"a17b8ee2-9ac3-47c8-aa79-8471322b1c78",1757,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637104380_12275_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202057369 - Edge 1757 entrou em status DEGRADED",86400,high
"Não","Cuiabá","BANCO LOSANGO S.A. - BANCO MULTIPLO","133302.0000000",MT,"N/A",BRAD,20197427,LOSANGO,SDWAN,61943b07b4a8174f7a514b2a,"OPEN - GENERAL - V3",1637104827,1637104205,"alert_manager","","",,"{""edgeId"": ""413"", ""linkId"": ""1057"", ""interface"": ""GE3""}","N/A",,20197427,high,"c4d95655-e326-44ae-833e-6fa530091b57",413,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637104380_12275_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197427 - Edge 413 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61943b09b4a8174f7a514b2d,"OPEN - GENERAL - V3",1637104827,1637104205,"alert_manager","","",,"{""edgeId"": ""459"", ""linkId"": ""1635"", ""interface"": ""GE4""}","N/A",,202058027,high,"1cb7ae54-4bce-439c-a2a6-adb39e8dff8e",459,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637104380_12275_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058027 - Edge 459 entrou em status DEGRADED",86400,high
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",61943b42512a4e102e442e69,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105402,1637103600,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"9952ac83-19c0-4462-af42-092a814e829d","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",61943b42512a4e102e442e6b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105402,1637103600,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"3e04dd3c-2d1c-4936-9de8-81478bf24c54","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",61943b46512a4e102e442e71,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106302,1637103600,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"6c0381d2-76c7-48e0-a988-0a88d99ae651","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",61943b48512a4e102e442e74,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104501,1637103600,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"18430776-04d3-4748-a72c-af8216f2a64b","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943b4d512a4e102e442e7c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104203,1637103605,"alert_manager","","",,"N/A","N/A",,202165385,performance,"082570a4-7d79-4c55-9c8c-580cda9a9a19",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Vitória da Conquista","REAL MOTO PECAS LTDA","174021.0000000",BA,"VITORIADACONQUISTA | 202171319",GRC,202171319,DADOS,DADOS,61943b50512a4e102e442e80,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107803,1637103600,"alert_manager","","",,"N/A","N/A",,"greal-vca-hafw-c",performance,"9b6766e8-2e0e-433d-af5d-5a8710229c62","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-vca-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Itaperuna,"FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179472.0000000",RJ,"PR11-ITAPERUNA_IRA/IP/00792 | 202182020",SDE,202182020,"ABORDAGEM SIMPLES",FILIAL,61943b56512a4e102e442e89,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104500,1637103601,"alert_manager","","",,"N/A","N/A",,"PR11-ITAPERUNA",performance,"e3d76468-9aaa-4024-804e-343378711afe",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR11-ITAPERUNA - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Brasília","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179475.0000000",DF,"",SDE,202182023,"ABORDAGEM SIMPLES",FILIAL,61943b58512a4e102e442e8c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105101,1637103601,"alert_manager","","",,"N/A","N/A",,202182023,performance,"4a92d6bf-6b43-4547-b351-ea833402e775",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202182023 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61943b5c512a4e102e442e92,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104203,1637103605,"alert_manager","","",,"N/A","N/A",,202183366,performance,"c18b8049-01bb-4bce-924b-547b42abd348",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61943b5d512a4e102e442e94,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104203,1637103605,"alert_manager","","",,"N/A","N/A",,202183367,performance,"67ec695c-b08d-4bc2-901b-4090c4424f2f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61943b5e512a4e102e442e96,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104203,1637103605,"alert_manager","","",,"N/A","N/A",,202183373,performance,"5a923fa5-2233-4860-b356-dabebf9a12f2",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61943b5e512a4e102e442e98,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104203,1637103605,"alert_manager","","",,"N/A","N/A",,202183380,performance,"c1e27bd4-f0af-4566-86a0-2d5b37f16cff",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61943b5f512a4e102e442e9a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104203,1637103605,"alert_manager","","",,"N/A","N/A",,202183383,performance,"100d21c0-2cf6-4d2d-a064-1370e2a7f20a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104380_12387_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","SAO JOSE DO RIO PRETO","PACAEMBU AUTOPEÇAS LTDA","108875.0000000",SP,"PACAEMBU SRR | 201748895",BSN,201748895,FILIAIS,"SEM CONTINGENCIA",61943c76b4a8174f7a514b70,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105702,1637103902,"alert_manager","","",,"N/A","N/A",,"pacaembu-srr-fw-004",performance,"d0e618c8-e70e-4668-a719-725049fe787e","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-srr-fw-004 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","SAO JOSE DO RIO PRETO","PACAEMBU AUTOPEÇAS LTDA","108875.0000000",SP,"PACAEMBU SRR | 201748895",BSN,201748895,FILIAIS,"SEM CONTINGENCIA",61943c77b4a8174f7a514b72,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105702,1637103902,"alert_manager","","",,"N/A","N/A",,"pacaembu-srr-fw-004",performance,"6e2919bc-7c76-40fc-a843-39ede30bea05","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-srr-fw-004 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Barueri,"TEGMA GESTAO LOGISTICA S A","173011.0000000",SP,"BRE - ALOG / DC Equinix | 202165365",SDE,202165365,SDWAN,SDE,61943c85b4a8174f7a514b82,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104800,1637103901,"alert_manager","","",,"N/A","N/A",,"tegma-bre-dc-hafw-1",performance,"389cf627-2416-40f9-8eec-8b53e4a0236a",port2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-bre-dc-hafw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173019.0000000",SP,"IDU CMT | 202165374",SDE,202165374,SDWAN,SDE,61943c86b4a8174f7a514b84,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112901,1637103901,"alert_manager","","",,"N/A","N/A",,"tegma-idu-cmt-fw-1",performance,"c4b4eccc-9583-4739-8994-342ace7f58ba",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,17,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-idu-cmt-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943c87b4a8174f7a514b86,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104505,1637103905,"alert_manager","","",,"N/A","N/A",,202165385,performance,"e61d992a-ac41-4932-9b60-b66f503cb5cd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61943c95b4a8174f7a514b97,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104505,1637103905,"alert_manager","","",,"N/A","N/A",,202183366,performance,"b01521ea-3db8-44aa-aa82-5e6e930ca820",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61943c96b4a8174f7a514b99,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104505,1637103905,"alert_manager","","",,"N/A","N/A",,202183367,performance,"ffe30197-e242-4f51-80a6-1cb803a4aa7a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61943c97b4a8174f7a514b9b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104505,1637103905,"alert_manager","","",,"N/A","N/A",,202183373,performance,"cd69cad8-eaf4-4696-b7df-5752f4fe8a29",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61943c98b4a8174f7a514b9d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104505,1637103905,"alert_manager","","",,"N/A","N/A",,202183380,performance,"22c85a2d-d656-4ee3-9cb3-93b9c4387717",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61943c99b4a8174f7a514b9f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104505,1637103905,"alert_manager","","",,"N/A","N/A",,202183383,performance,"21c3ffd8-b09c-42a7-b5a0-f1f1d3dbd49f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104680_12295_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61943da4fa57811c983f5494,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105402,1637104200,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"3c3a7b52-4e45-4a5e-b73c-b666e3693342","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61943da5fa57811c983f5496,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105402,1637104200,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"5ab0cc3e-3150-4822-bfbb-fd5bfdc1591b","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61943da8fa57811c983f549a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105101,1637104200,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"e5b520cf-db1d-4a24-af23-620540c0bcf7","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61943dadfa57811c983f54a0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105702,1637104201,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"18019ad0-b299-42fd-990c-70a911c62028","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61943daffa57811c983f54a3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105101,1637104200,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"4f11c74d-6180-42df-ac17-57f479166be2","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61943db0fa57811c983f54a5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107500,1637104202,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"18fcbbce-aa6e-49d0-9e8d-9fbd7d660ddc",port9,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943db7fa57811c983f54ad,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104803,1637104203,"alert_manager","","",,"N/A","N/A",,202165385,performance,"2f4114ce-7119-4592-8c1b-a95c094c7ebd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,61943dbffa57811c983f54b7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106902,1637104202,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"91634a5e-7aae-40b7-b9a5-2562200a3954",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61943dc6fa57811c983f54bf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104803,1637104203,"alert_manager","","",,"N/A","N/A",,202183366,performance,"4fe1d8a0-5ba0-4b17-8d08-35029721bf04",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61943dc7fa57811c983f54c1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104803,1637104203,"alert_manager","","",,"N/A","N/A",,202183367,performance,"9c627e62-0da2-493b-a417-c7746adef4cb",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,40,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61943dc8fa57811c983f54c3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104803,1637104203,"alert_manager","","",,"N/A","N/A",,202183373,performance,"f799c539-db45-48e7-baa2-a22f43c94e68",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,41,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61943dc9fa57811c983f54c5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104803,1637104203,"alert_manager","","",,"N/A","N/A",,202183380,performance,"8626fda9-b532-45c4-b9e4-e0ac8d78dad7",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,42,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61943dcafa57811c983f54c7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637104803,1637104203,"alert_manager","","",,"N/A","N/A",,202183383,performance,"9c4f541a-0ecd-447e-a332-a1495cb61cfc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637104980_12515_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,43,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Natal,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133313.0000000",RN,"N/A",BRAD,20197433,LOSANGO,SDWAN,61943e85512a4e102e442ea4,"OPEN - GENERAL - V3",1637105409,1637105107,"alert_manager","","",,"{""edgeId"": ""411"", ""linkId"": ""1040"", ""interface"": ""GE4""}","N/A",,20197433,high,"bcd1b8d2-6af7-423d-9780-eaa511d456a7",411,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637105280_12410_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197433 - Edge 411 entrou em status DEGRADED",86400,high
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943ee2fa57811c983f54dd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105105,1637104505,"alert_manager","","",,"N/A","N/A",,202165385,performance,"1f73a00c-fc02-41d9-9002-44dad5a3ef41",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105280_12530_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,61943ee7fa57811c983f54e4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105105,1637104505,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"f99db25a-6345-4df4-966d-6058e9f261f2",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105280_12530_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61943ef0fa57811c983f54ee,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105105,1637104505,"alert_manager","","",,"N/A","N/A",,202183366,performance,"3d3cfde6-dd67-476c-ba9e-7d9572e41442",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105280_12530_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61943ef1fa57811c983f54f0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105105,1637104505,"alert_manager","","",,"N/A","N/A",,202183367,performance,"6e5517c7-0088-4394-b795-c86c7e339449",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105280_12530_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61943ef2fa57811c983f54f2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105105,1637104505,"alert_manager","","",,"N/A","N/A",,202183373,performance,"07633ef4-7c9d-4257-8318-ee35f536b11c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105280_12530_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61943ef3fa57811c983f54f4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105105,1637104505,"alert_manager","","",,"N/A","N/A",,202183380,performance,"4c7349f8-7c46-45c5-b4b4-c28d94c27657",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105280_12530_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61943ef4fa57811c983f54f6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105105,1637104505,"alert_manager","","",,"N/A","N/A",,202183383,performance,"bef63717-e44d-417a-ad46-993de7cf7a32",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105280_12530_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",61943fee512a4e102e442f27,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106003,1637104803,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"1732aa5c-3525-424d-b2a8-7af2a631295b","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",61943fef512a4e102e442f29,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106003,1637104803,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"d2040b13-6b7e-4c4c-9a5b-962b4ed305be","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",61943ff6512a4e102e442f34,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105702,1637104801,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"a2c00245-a2d2-42b3-8086-5de0cd7dc980","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",61943ff7512a4e102e442f36,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106302,1637104801,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"c1527b75-d372-4b00-a9ea-b0ec4f766f45","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Barueri,"TEGMA GESTAO LOGISTICA S A","173011.0000000",SP,"BRE - ALOG / DC Equinix | 202165365",SDE,202165365,SDWAN,SDE,61943ffc512a4e102e442f3f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105701,1637104800,"alert_manager","","",,"N/A","N/A",,"tegma-bre-dc-hafw-1",performance,"33a0a43f-86a4-4c91-bfa4-11e87bb77366",port2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-bre-dc-hafw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61943ffe512a4e102e442f42,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105404,1637104803,"alert_manager","","",,"N/A","N/A",,202165385,performance,"f8542342-7353-4577-be8c-1c840d952999",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174298.0000000",SP,"NICOLA | 202174605",SDE,202174605,SDWAN,SDE,61944002512a4e102e442f49,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105701,1637104800,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-ncl-fw-1",performance,"75ebec77-49d1-48f8-8814-3543442a8e6f",port15,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-ncl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,61944004512a4e102e442f4c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107200,1637104800,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"ce81c0f1-301c-4bd1-8035-e35cef8aab3b",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194400b512a4e102e442f56,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105404,1637104803,"alert_manager","","",,"N/A","N/A",,202183366,performance,"29c79a33-3eed-4055-92ed-9e491852b0d2",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194400c512a4e102e442f58,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105404,1637104803,"alert_manager","","",,"N/A","N/A",,202183367,performance,"5efb7e6b-5761-4ac8-aa24-88e1ac0af0a3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,40,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194400c512a4e102e442f5a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105404,1637104803,"alert_manager","","",,"N/A","N/A",,202183373,performance,"25391309-f0a1-4003-9675-e0a2fb589ad6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,41,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194400d512a4e102e442f5c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105404,1637104803,"alert_manager","","",,"N/A","N/A",,202183380,performance,"53f8f7f1-add0-4ab8-9fd0-10efa69f0358",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,42,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194400e512a4e102e442f5e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105404,1637104803,"alert_manager","","",,"N/A","N/A",,202183383,performance,"b13b61c9-e56b-4197-8e56-9702484fcaf4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105580_12422_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,43,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",619440dcfa57811c983f54fc,"OPEN - GENERAL - V3",1637106040,1637105737,"alert_manager","","",,"{""edgeId"": ""512"", ""linkId"": ""1148"", ""interface"": ""GE1""}","N/A",,202058023,medium,"3b833564-edbd-43b3-ae8c-33167ad17bec",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637105880_12546_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058023 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619440ddfa57811c983f54ff,"OPEN - GENERAL - V3",1637106040,1637105737,"alert_manager","","",,"{""edgeId"": ""512"", ""linkId"": ""1178"", ""interface"": ""GE2""}","N/A",,202058023,medium,"662b8f8b-d0ab-4ee0-a2c3-986885f6eaf8",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637105880_12546_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058023 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619440defa57811c983f5502,"OPEN - GENERAL - V3",1637106040,1637105737,"alert_manager","","",,"{""edgeId"": ""512"", ""linkId"": ""2755"", ""interface"": ""SFP2""}","N/A",,202058023,medium,"91720eb3-3cd2-4edf-8bc5-20fc8d98826d",SFP2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637105880_12546_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202058023 - Link SFP2 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",619440e2fa57811c983f550b,"OPEN - GENERAL - V3",1637106040,1637105737,"alert_manager","","",,"{""edgeId"": ""459"", ""linkId"": ""1635"", ""interface"": ""GE4""}","N/A",,202058027,high,"0ecc1c1e-0ec0-4ef9-88d5-0ead2f6aaa44",459,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637105880_12546_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058027 - Edge 459 entrou em status DEGRADED",86400,high
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",6194412afa57811c983f554a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106001,1637105101,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"4ccea941-93f9-4439-bc73-82d93c854ee7","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105880_12548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944137fa57811c983f5559,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105705,1637105105,"alert_manager","","",,"N/A","N/A",,202165385,performance,"8d74a77c-c12b-4472-8002-13b72355d1cf",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105880_12548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Fortaleza,"REAL MOTO PECAS LTDA","174020.0000000",CE,"FORTALEZA | 202171318",GRC,202171318,DADOS,DADOS,61944138fa57811c983f555b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106601,1637105102,"alert_manager","","",,"N/A","N/A",,"greal-fla-hafw-c",performance,"c43a0560-c4c0-4f00-8fd5-2e27af009c31","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105880_12548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-fla-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,6194413afa57811c983f555e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106300,1637105101,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"ee4be7a7-aa87-44b3-9e5c-07c2a4c94d2c",a,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105880_12548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194414afa57811c983f5570,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105705,1637105105,"alert_manager","","",,"N/A","N/A",,202183366,performance,"769e3d42-e6ba-4ede-870f-7f1d97a40c61",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105880_12548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194414bfa57811c983f5572,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105705,1637105105,"alert_manager","","",,"N/A","N/A",,202183367,performance,"17fadf39-e953-41a2-8b80-935cf0d1a9fc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105880_12548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194414cfa57811c983f5574,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105705,1637105105,"alert_manager","","",,"N/A","N/A",,202183373,performance,"dc2ac07d-08f7-452d-91ef-27b415468985",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105880_12548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,40,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194414dfa57811c983f5576,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105705,1637105105,"alert_manager","","",,"N/A","N/A",,202183380,performance,"adcd9e55-f102-41bd-a324-5531b2711570",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105880_12548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,41,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194414efa57811c983f5578,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637105705,1637105105,"alert_manager","","",,"N/A","N/A",,202183383,performance,"05d3384b-fdc8-4f0c-9735-7c9f5bbd289f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637105880_12548_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,42,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944263b4a8174f7a514bf1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106003,1637105404,"alert_manager","","",,"N/A","N/A",,202165385,performance,"f6ae8dfc-8dc5-4e16-b563-131817c8c694",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106180_12344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,6194426eb4a8174f7a514bfe,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106003,1637105401,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"723278d2-382c-42ec-85a3-4eb8df2afe4e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106180_12344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Erro de coleta no equipamento",86400,low
"Não","Brasília","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179475.0000000",DF,"",SDE,202182023,"ABORDAGEM SIMPLES",FILIAL,61944273b4a8174f7a514c05,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106300,1637105402,"alert_manager","","",,"N/A","N/A",,202182023,performance,"40d3f553-dd89-452d-b6ae-1ca003e159ed",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106180_12344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202182023 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61944277b4a8174f7a514c0b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106003,1637105404,"alert_manager","","",,"N/A","N/A",,202183366,performance,"01659d3b-820f-48b6-90fb-19a03ef89bdc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106180_12344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61944278b4a8174f7a514c0d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106003,1637105404,"alert_manager","","",,"N/A","N/A",,202183367,performance,"1380fe23-512b-4034-bd57-b1dd3025d744",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106180_12344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,40,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61944279b4a8174f7a514c0f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106003,1637105404,"alert_manager","","",,"N/A","N/A",,202183373,performance,"8244f616-eca9-4308-84e8-457c5db798cd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106180_12344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,41,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194427ab4a8174f7a514c11,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106003,1637105404,"alert_manager","","",,"N/A","N/A",,202183380,performance,"915e8b36-689e-4b51-8bce-78c6f9f0dd97",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106180_12344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,42,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194427bb4a8174f7a514c13,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106003,1637105404,"alert_manager","","",,"N/A","N/A",,202183383,performance,"c2596763-2f63-442a-84a0-5b99ca8a333e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106180_12344_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,43,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61944386fa57811c983f557e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107802,1637105702,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"6f057b35-195e-46d2-824c-a7a360ea8139","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61944388fa57811c983f5581,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106600,1637105702,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"853c95e6-8757-48b0-96f5-8c3f3003fcfe","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61944389fa57811c983f5583,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106600,1637105702,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"b8390843-9b03-44fd-ad62-e505eb3a9ea0","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944392fa57811c983f558d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106305,1637105705,"alert_manager","","",,"N/A","N/A",,202165385,performance,"5f91079d-ee62-4c23-8cbe-c294a777a35d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Goiânia","REAL MOTO PECAS LTDA","174015.0000000",GO,"GOIANIA | 202171313",GRC,202171313,DADOS,DADOS,61944394fa57811c983f5590,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107200,1637105701,"alert_manager","","",,"N/A","N/A",,"greal-gna-hafw-c",performance,"7ac03cc9-a5d2-482f-9324-152de739921d",lan1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-gna-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,6194439bfa57811c983f5598,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106305,1637105705,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"73937221-69d9-401f-a2be-c2cca9021480",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619443a4fa57811c983f55a3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106305,1637105705,"alert_manager","","",,"N/A","N/A",,202183366,performance,"1a0f8495-15fe-41e4-aa95-4324c6e692b6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619443a5fa57811c983f55a5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106305,1637105705,"alert_manager","","",,"N/A","N/A",,202183367,performance,"e6295954-c60a-4ea7-9562-3af5b69b1d4a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619443a6fa57811c983f55a7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106305,1637105705,"alert_manager","","",,"N/A","N/A",,202183373,performance,"4a4e124f-194d-447a-b77e-a7b58498bd48",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619443a7fa57811c983f55a9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106305,1637105705,"alert_manager","","",,"N/A","N/A",,202183380,performance,"153babbb-4a01-4a00-aa49-14ab58792a2d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619443a8fa57811c983f55ab,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106305,1637105705,"alert_manager","","",,"N/A","N/A",,202183383,performance,"f84b22a9-c89c-42c5-9f79-c258c8b3564d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106480_12570_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Guarulhos,"INCOTEP IND E COM DE TUBOS ESPECIAIS DE PRECISÃO LTDA","173563.0000000",SP,"N/A","SDWAN - VELOCLOUD",202168682,FLEX,SDWAN,61944461512a4e102e442fb0,"OPEN - GENERAL - V3",1637106916,1637106613,"alert_manager","","",,"{""edgeId"": ""464"", ""linkId"": ""1584"", ""interface"": ""GE3""}","N/A",,202168682,high,"8ac8577a-21a5-4499-bcd6-a491eae7b589",464,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637106780_12460_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202168682 - Edge 464 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61944463512a4e102e442fb5,"OPEN - GENERAL - V3",1637106916,1637106613,"alert_manager","","",,"{""edgeId"": ""465"", ""linkId"": ""1582"", ""interface"": ""GE3""}","N/A",,202058019,high,"6aca6943-5de1-4ee4-88d7-649f7bafb2bc",465,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637106780_12460_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202058019 - Edge 465 entrou em status DEGRADED",86400,high
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619444a6512a4e102e442ff2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107202,1637106003,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"8258e129-c70d-40f3-b2c7-673b4846ec02","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106780_12462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619444a7512a4e102e442ff4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107202,1637106003,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"7e08952f-1f41-4e9e-a3b3-217b99b498a5","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106780_12462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619444b2512a4e102e443003,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106605,1637106003,"alert_manager","","",,"N/A","N/A",,202165385,performance,"473e09c0-c704-42cc-8cb7-5b78b0026abc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106780_12462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,619444b8512a4e102e44300c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106605,1637106003,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"03c119bd-a42d-4063-b152-7666d2e69131",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106780_12462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619444bf512a4e102e443016,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106605,1637106003,"alert_manager","","",,"N/A","N/A",,202183366,performance,"6df5a158-af0a-4e6a-aaeb-74e024695243",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106780_12462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619444c0512a4e102e443018,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106605,1637106003,"alert_manager","","",,"N/A","N/A",,202183367,performance,"874d234c-74ab-4aa1-ba44-b01b4f61fd4b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106780_12462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619444c1512a4e102e44301a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106605,1637106003,"alert_manager","","",,"N/A","N/A",,202183373,performance,"5d72c338-2a5f-4c75-992a-17d4c64385cc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106780_12462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619444c1512a4e102e44301c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106605,1637106003,"alert_manager","","",,"N/A","N/A",,202183380,performance,"efc176b5-b390-4d44-8b9a-a74055f43500",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106780_12462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619444c2512a4e102e44301e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106605,1637106003,"alert_manager","","",,"N/A","N/A",,202183383,performance,"cd90a901-be2d-42e2-81fd-bde163a7dfb3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637106780_12462_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",6194458b512a4e102e443021,"OPEN - GENERAL - V3",1637107506,1637106916,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","N/A",,202062007,medium,"724e5c00-e3ca-4da8-aa76-fcb6d8d83c5b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637107080_12470_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062007 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6194458b512a4e102e443023,"OPEN - GENERAL - V3",1637107506,1637106916,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4165"", ""interface"": ""GE3""}","N/A",,202062007,medium,"4a5ea9b2-2ee1-4602-9289-86bd733e2573",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637107080_12470_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062007 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6194458f512a4e102e443028,"OPEN - GENERAL - V3",1637107506,1637106916,"alert_manager","","",,"{""edgeId"": ""1573"", ""linkId"": ""4735"", ""interface"": ""GE4""}","N/A",,202177775,high,"a849faa3-1278-47e3-b0b3-c5f2bc4a87c9",1573,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637107080_12470_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202177775 - Edge 1573 entrou em status DEGRADED",86400,high
"Não","Hortolândia","GERDAU AÇOS LONGOS S A","155355.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041392,ALTO,SDWAN,61944590512a4e102e44302a,"OPEN - GENERAL - V3",1637107506,1637106916,"alert_manager","","",,"{""edgeId"": ""924"", ""linkId"": ""4017"", ""interface"": ""SFP2""}","N/A",,202041392,high,"c37a5c43-1537-4ec6-bbc1-6de6905ef628",924,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637107080_12470_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041392 - Edge 924 entrou em status DEGRADED",86400,high
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",619445ddb4a8174f7a514c59,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107202,1637106302,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"d909486a-7408-4e98-ad4f-1e35238a80d9","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",619445dfb4a8174f7a514c5d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107202,1637106302,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"f23fd133-da81-45b7-8645-d9c29d99bd9b","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",619445e0b4a8174f7a514c5f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107802,1637106302,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"9519b6d7-5c93-414c-af57-500b38cb45df","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619445e9b4a8174f7a514c6a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106906,1637106305,"alert_manager","","",,"N/A","N/A",,202165385,performance,"c803cdaf-88d8-4218-a13b-2837684f541d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,619445f0b4a8174f7a514c72,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106906,1637106305,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"d184dd99-b573-4e57-93c7-3545ef63288a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Erro de coleta no equipamento",86400,low
"Não","Brasília","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179475.0000000",DF,"",SDE,202182023,"ABORDAGEM SIMPLES",FILIAL,619445f3b4a8174f7a514c77,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637106300,"alert_manager","","",,"N/A","N/A",,202182023,performance,"00e2a532-c144-45da-9f3c-1a81a80e9cd8",wan,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"202182023 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619445f8b4a8174f7a514c7d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106906,1637106305,"alert_manager","","",,"N/A","N/A",,202183366,performance,"9e3c852d-ef5f-4c6f-8eed-258846091e14",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619445f8b4a8174f7a514c7f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106906,1637106305,"alert_manager","","",,"N/A","N/A",,202183367,performance,"ee3a32ee-a876-47bb-8718-798ad2f950be",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619445f9b4a8174f7a514c81,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106906,1637106305,"alert_manager","","",,"N/A","N/A",,202183373,performance,"8baf5ccf-076b-4d9f-9562-6e82af842d43",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619445fab4a8174f7a514c83,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106906,1637106305,"alert_manager","","",,"N/A","N/A",,202183380,performance,"986c84a5-694d-4495-82c9-6674f3e57f06",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619445fbb4a8174f7a514c85,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637106906,1637106305,"alert_manager","","",,"N/A","N/A",,202183383,performance,"62a9c417-1db1-4b76-b16d-e99f2a442755",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107080_12372_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944713fa57811c983f55fb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107200,1637106605,"alert_manager","","",,"N/A","N/A",,202165385,performance,"5d38736e-ec0e-4391-b314-62849f9bf12d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107380_12603_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Fortaleza,"REAL MOTO PECAS LTDA","174020.0000000",CE,"FORTALEZA | 202171318",GRC,202171318,DADOS,DADOS,61944714fa57811c983f55fd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107502,1637106601,"alert_manager","","",,"N/A","N/A",,"greal-fla-hafw-c",performance,"5c681f36-ce6e-417b-9626-7bdc8c254d11","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107380_12603_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-fla-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,61944716fa57811c983f5600,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108101,1637106600,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"6296e255-a84c-4e57-9bff-9ceca4d02b16",lan1,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107380_12603_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,17,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61944723fa57811c983f560e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107204,1637106605,"alert_manager","","",,"N/A","N/A",,202183366,performance,"4e32fa7e-0e01-4c6d-be8d-4317b302591b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107380_12603_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61944724fa57811c983f5610,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107204,1637106605,"alert_manager","","",,"N/A","N/A",,202183367,performance,"0c951639-6be7-4ded-8fdf-7c5058344460",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107380_12603_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61944726fa57811c983f5612,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107204,1637106605,"alert_manager","","",,"N/A","N/A",,202183373,performance,"74921ccb-d5ba-4b1e-8b0a-bd4ff780911c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107380_12603_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61944727fa57811c983f5614,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107204,1637106605,"alert_manager","","",,"N/A","N/A",,202183380,performance,"5afc9ef4-a48c-4b94-925d-f878ce8cd3f3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107380_12603_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61944728fa57811c983f5616,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107204,1637106605,"alert_manager","","",,"N/A","N/A",,202183383,performance,"769f7a62-0f43-415d-af7a-3349f6fcb14f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107380_12603_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",619447e4512a4e102e44302f,"OPEN - GENERAL - V3",0,1637106916,"alert_manager","","",,"{""edgeId"": ""502"", ""linkId"": ""1137"", ""interface"": ""GE3""}","N/A",,201912648,performance,"e4d670ef-b360-4a41-8884-a16ae6308beb",1137,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637107680_12493_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",4,"201912648 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",Guarapuava,"GERDAU AÇOS LONGOS S A","154966.0000000",PR,"N/A","SDWAN - VELOCLOUD",202040664,BAIXO,SDWAN,619447e6512a4e102e443032,"OPEN - GENERAL - V3",1637108127,1637107506,"alert_manager","","",,"{""edgeId"": ""968"", ""linkId"": ""2224"", ""interface"": ""GE3""}","N/A",,202040664,high,"83a6fc7b-a0a0-450d-b441-006478f1b1ee",968,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637107680_12493_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040664 - Edge 968 entrou em status DEGRADED",86400,high
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",61944830b4a8174f7a514c8f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108700,1637106902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"5b488ea4-2d0b-4a18-a0e5-cf281cef023b","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",61944831b4a8174f7a514c91,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108700,1637106902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"07694b83-137d-4000-89bf-528025d41624","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",61944835b4a8174f7a514c97,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107802,1637106902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"0edef802-b19a-432b-9c4c-eda0cef4b5ec","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",61944836b4a8174f7a514c99,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107802,1637106902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"45149bc4-08de-4a2d-8750-b943eb1db1e5","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",61944839b4a8174f7a514c9d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107802,1637106902,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"d7b2d404-3aaa-4982-8129-2918422865a4","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",6194483ab4a8174f7a514ca0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107802,1637106902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"4f40f6a7-5f32-4f2a-b70c-0224d30d1893","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",6194483cb4a8174f7a514ca2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108700,1637106902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"42a2c825-a920-45e7-be57-445b5fb5c23a","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944842b4a8174f7a514caa,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107504,1637106906,"alert_manager","","",,"N/A","N/A",,202165385,performance,"a6b219d8-c488-4685-b354-28aad5ef1c30",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61944853b4a8174f7a514cbd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107504,1637106906,"alert_manager","","",,"N/A","N/A",,202183366,performance,"bbf2a7d2-8e3a-44e5-a90b-8ade1d50bc28",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61944853b4a8174f7a514cbf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107504,1637106906,"alert_manager","","",,"N/A","N/A",,202183367,performance,"779fb700-e777-45ef-aa54-53635747bbdd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61944854b4a8174f7a514cc1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107504,1637106906,"alert_manager","","",,"N/A","N/A",,202183373,performance,"1f1d5cf6-e6ac-4d77-bb85-7055585a0b8d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,40,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61944855b4a8174f7a514cc3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107504,1637106906,"alert_manager","","",,"N/A","N/A",,202183380,performance,"620fa771-8d08-425f-8bd2-872fb66b370c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,41,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61944856b4a8174f7a514cc5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107504,1637106906,"alert_manager","","",,"N/A","N/A",,202183383,performance,"6d8a1810-6007-441f-b0ed-b1bb19e28721",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107680_12387_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,42,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",61944956512a4e102e44307b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108700,1637107202,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"b69664cb-23da-45e7-b740-e71c8ad8455d","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107980_12507_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",61944957512a4e102e44307d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108700,1637107202,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"6123193d-507d-41ff-8b54-5ee1d321a834","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107980_12507_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,6194495e512a4e102e443087,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107803,1637107200,"alert_manager","","",,"N/A","N/A",,202165385,performance,"1139c4ef-169c-4b76-806f-b36e287e7097",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107980_12507_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,61944965512a4e102e443091,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108101,1637107200,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"3955405c-b553-4bb0-a906-9c5e225d5fba",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107980_12507_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194496c512a4e102e44309b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107803,1637107204,"alert_manager","","",,"N/A","N/A",,202183366,performance,"ae133b9a-ce46-4512-aa72-e54ec1647dc1",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107980_12507_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194496d512a4e102e44309d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107801,1637107204,"alert_manager","","",,"N/A","N/A",,202183367,performance,"2356f733-8af2-425a-ac49-7390c35e6eb9",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107980_12507_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194496e512a4e102e44309f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107803,1637107204,"alert_manager","","",,"N/A","N/A",,202183373,performance,"f9a48465-11ca-4c70-9a67-5f1f030090d8",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107980_12507_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194496f512a4e102e4430a1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107803,1637107204,"alert_manager","","",,"N/A","N/A",,202183380,performance,"f518913c-27e2-4c94-9ad2-f8e94643459a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107980_12507_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194496f512a4e102e4430a3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637107803,1637107204,"alert_manager","","",,"N/A","N/A",,202183383,performance,"fcba93bd-2393-493c-a077-2e511b9c54fa",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637107980_12507_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Chapecó","ICATU SEGUROS S.A.","147736.0000000",SC,"N/A","SDWAN - VELOCLOUD",201922763,"ABORDAGEM SIMPLES",SDWAN,61944a3d512a4e102e4430ac,"OPEN - GENERAL - V3",0,1637107506,"alert_manager","","",,"{""edgeId"": ""622"", ""linkId"": ""1418"", ""interface"": ""GE3""}","N/A",,201922763,performance,"dc48ee76-aa04-4bee-825f-eb3fbc952cc9",1418,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637108280_12516_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","packet_loss_percent","N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",4,"201922763 - A perda de pacotes da interface GE3 excedeu o valor de 1%",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61944a8afa57811c983f5661,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108402,1637107501,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"0a01a240-299d-4cce-89a5-fad69eb96c7d","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61944a8dfa57811c983f5665,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109001,1637107501,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"1a91dfca-91c2-4536-961a-177a78a4eabf","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944a9afa57811c983f5673,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108104,1637107504,"alert_manager","","",,"N/A","N/A",,202165385,performance,"6f0fec4c-7c50-4667-a1f9-5a51fda0eeb6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Fortaleza,"REAL MOTO PECAS LTDA","174020.0000000",CE,"FORTALEZA | 202171318",GRC,202171318,DADOS,DADOS,61944a9bfa57811c983f5675,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108402,1637107502,"alert_manager","","",,"N/A","N/A",,"greal-fla-hafw-c",performance,"9e6942ae-5994-43d2-b7a1-d839efe52b1a","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-fla-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,61944a9ffa57811c983f567b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108104,1637107500,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"69c61135-1f0f-4cd2-8360-a9faff0b0a85",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61944aa8fa57811c983f5685,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108104,1637107504,"alert_manager","","",,"N/A","N/A",,202183366,performance,"a2d5818e-46b5-4fc5-90e1-a8e577638f59",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61944aa9fa57811c983f5687,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108104,1637107504,"alert_manager","","",,"N/A","N/A",,202183367,performance,"2744f7f1-be54-4cdb-9e98-bf7febe4e77a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61944aaafa57811c983f5689,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108104,1637107504,"alert_manager","","",,"N/A","N/A",,202183373,performance,"d66f65a4-214c-44ee-8a66-85eeaf4a7735",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61944aabfa57811c983f568b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108104,1637107504,"alert_manager","","",,"N/A","N/A",,202183380,performance,"c7f8e325-87dd-4703-bbe0-997484a64afa",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61944aacfa57811c983f568d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108104,1637107504,"alert_manager","","",,"N/A","N/A",,202183383,performance,"e8c6594b-00ab-44c9-b901-24b7de224c18",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108280_12631_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","SAO JOSE DO RIO PRETO","PACAEMBU AUTOPEÇAS LTDA","108875.0000000",SP,"PACAEMBU SRR | 201748895",BSN,201748895,FILIAIS,"SEM CONTINGENCIA",61944bb2b4a8174f7a514cc7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108700,1637107802,"alert_manager","","",,"N/A","N/A",,"pacaembu-srr-fw-004",performance,"2a159b3d-3280-453f-874e-a2ac953634ae","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-srr-fw-004 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","SAO JOSE DO RIO PRETO","PACAEMBU AUTOPEÇAS LTDA","108875.0000000",SP,"PACAEMBU SRR | 201748895",BSN,201748895,FILIAIS,"SEM CONTINGENCIA",61944bb3b4a8174f7a514cc9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108700,1637107802,"alert_manager","","",,"N/A","N/A",,"pacaembu-srr-fw-004",performance,"23d23ccb-c91a-47d9-aee6-4d090b0daec1","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-srr-fw-004 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",61944bbbb4a8174f7a514cd2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108700,1637107802,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"437e9217-d1df-42fd-b1bb-3a22db44da87","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61944bbeb4a8174f7a514cd6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108700,1637107802,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"06f3823e-f9d0-4ecd-8cf9-6559de133fb1","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",61944bbfb4a8174f7a514cd8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109001,1637107802,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"00775ddb-a43e-47a4-a85f-392c5e41c65a","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",61944bc0b4a8174f7a514cda,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109001,1637107802,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"4ec17d02-5092-44b1-a0cf-fe25ea96f06e","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61944bc2b4a8174f7a514cde,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109302,1637107802,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"86726508-37c4-4f28-b16e-4429b4c73665",port9,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,17,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944bc9b4a8174f7a514ce6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108405,1637107803,"alert_manager","","",,"N/A","N/A",,202165385,performance,"60cc230e-994b-459b-9117-4dfefc5172e3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Vitória da Conquista","REAL MOTO PECAS LTDA","174021.0000000",BA,"VITORIADACONQUISTA | 202171319",GRC,202171319,DADOS,DADOS,61944bcab4a8174f7a514ce8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109601,1637107803,"alert_manager","","",,"N/A","N/A",,"greal-vca-hafw-c",performance,"91392f40-f0e6-4504-81e9-7cdc5aad58f4","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-vca-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61944bd5b4a8174f7a514cf5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108405,1637107803,"alert_manager","","",,"N/A","N/A",,202183366,performance,"19617139-bbad-411d-a935-0cb10379af46",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61944bd6b4a8174f7a514cf7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108405,1637107801,"alert_manager","","",,"N/A","N/A",,202183367,performance,"4c621998-059c-4789-91bb-4f089f53fe28",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61944bd7b4a8174f7a514cf9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108405,1637107803,"alert_manager","","",,"N/A","N/A",,202183373,performance,"9de53c46-4a9a-467c-9c59-738febfdcd68",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61944bd8b4a8174f7a514cfb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108405,1637107803,"alert_manager","","",,"N/A","N/A",,202183380,performance,"de7438c1-49a1-452f-8bbc-809bd374eb34",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,40,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61944bd9b4a8174f7a514cfd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108405,1637107803,"alert_manager","","",,"N/A","N/A",,202183383,performance,"51804b04-b221-46b9-8531-b52d3f8868f0",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108580_12419_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,41,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61944ce1b4a8174f7a514d07,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109001,1637108100,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"e96779ff-179e-493f-963d-da7ed8c91a77","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108880_12433_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944ceeb4a8174f7a514d16,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108704,1637108104,"alert_manager","","",,"N/A","N/A",,202165385,performance,"6c7fa88c-5729-4078-8681-052c22ac1655",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108880_12433_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,61944cf0b4a8174f7a514d19,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109302,1637108101,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"510a9d37-7311-43b3-bb36-2a2d4257e0bd",a,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108880_12433_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,61944cf6b4a8174f7a514d20,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109306,1637108101,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"b4c5ae15-006b-4d03-9eec-92a520faa7d5",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108880_12433_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61944cfcb4a8174f7a514d28,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108704,1637108104,"alert_manager","","",,"N/A","N/A",,202183366,performance,"89d73505-ed82-4d63-bc28-bf972ff3aaba",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108880_12433_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61944cfdb4a8174f7a514d2a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108704,1637108104,"alert_manager","","",,"N/A","N/A",,202183367,performance,"4172d38c-2634-4f6f-b226-faa31d881319",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108880_12433_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61944cfeb4a8174f7a514d2c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108704,1637108104,"alert_manager","","",,"N/A","N/A",,202183373,performance,"9e979f88-bfce-476f-941f-06db69810149",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108880_12433_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61944cffb4a8174f7a514d2e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108704,1637108104,"alert_manager","","",,"N/A","N/A",,202183380,performance,"8b92873c-051f-49af-9e81-fec2e1596759",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108880_12433_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61944cffb4a8174f7a514d30,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637108704,1637108104,"alert_manager","","",,"N/A","N/A",,202183383,performance,"29fd4ccb-5991-4e09-a086-fb8a6c77d8c1",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637108880_12433_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",61944dbfb4a8174f7a514d33,"OPEN - GENERAL - V3",1637109304,1637109010,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""4083"", ""interface"": ""GE4""}","N/A",,202062005,medium,"ad58970d-fe93-4450-9a03-0e3b1889c60a",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062005 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61944dc0b4a8174f7a514d35,"OPEN - GENERAL - V3",1637109304,1637109010,"alert_manager","","",,"{""edgeId"": ""1576"", ""linkId"": ""5301"", ""interface"": ""GE3""}","N/A",,202062005,medium,"df206363-1119-4636-975b-0acaca79c29d",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062005 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São José do Rio Preto","ICATU SEGUROS S.A","171688.0000000",SP,"N/A","SDWAN - VELOCLOUD",202062013,"DUPLA ABORDAGEM",SDWAN,61944dc2b4a8174f7a514d38,"OPEN - GENERAL - V3",1637109304,1637109010,"alert_manager","","",,"{""edgeId"": ""1582"", ""linkId"": ""4914"", ""interface"": ""GE3""}","N/A",,202062013,medium,"83a855be-1c9a-451d-83b2-2f6344db11f6",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062013 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61944dc3b4a8174f7a514d3a,"OPEN - GENERAL - V3",1637109304,1637109010,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,medium,"5344d6b9-0fb7-4a0f-a7ca-11e21b007644",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062017 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Manaus,"GERDAU AÇOS LONGOS SA","180265.0000000",AM,"N/A","SDWAN - VELOCLOUD",202183874,FLEX,SDWAN,61944dc4b4a8174f7a514d3c,"OPEN - GENERAL - V3",1637109304,1637109010,"alert_manager","","",,"{""edgeId"": ""1930"", ""linkId"": ""5144"", ""interface"": ""GE3""}","N/A",,202183874,medium,"d97d9e80-8c28-4843-b851-56de92a1da1a",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183874 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Manaus,"GERDAU AÇOS LONGOS SA","180265.0000000",AM,"N/A","SDWAN - VELOCLOUD",202183874,FLEX,SDWAN,61944dc4b4a8174f7a514d3e,"OPEN - GENERAL - V3",1637109304,1637109010,"alert_manager","","",,"{""edgeId"": ""1930"", ""linkId"": ""5208"", ""interface"": ""GE4""}","N/A",,202183874,medium,"96849a89-aba8-430f-b959-bc028ad0d53b",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202183874 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61944dc5b4a8174f7a514d40,"OPEN - GENERAL - V3",1637109304,1637109010,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5334"", ""interface"": ""GE1""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"b97dfd86-ae4d-4d49-8f31-c41cc5cb1a90",GE1,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE1 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61944dc6b4a8174f7a514d42,"OPEN - GENERAL - V3",1637109304,1637109010,"alert_manager","","",,"{""edgeId"": ""2088"", ""linkId"": ""5336"", ""interface"": ""GE2""}","N/A",,"202185773
USIM#SDW-VELO-VITORIA-GER#00",medium,"79173da0-4a75-4b3c-8617-bf18bdce5d13",GE2,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202185773
USIM#SDW-VELO-VITORIA-GER#00 - Link GE2 entrou em status UNSTABLE",86400,medium
"Não","Porto Alegre","ICATU SEGUROS S.A.","184103.0000000",RS,"N/A","SDWAN - VELOCLOUD",202191967,"ABORDAGEM SIMPLES",SDWAN,61944dc7b4a8174f7a514d44,"OPEN - GENERAL - V3",1637109304,1637109010,"alert_manager","","",,"{""edgeId"": ""2152"", ""linkId"": ""5565"", ""interface"": ""GE3""}","N/A",,202191967,medium,"60d56d75-5bc9-4395-ac11-ef382309cd4e",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",linkState,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202191967 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Rio de Janeiro","PARKJACAREPAGUA EMPREENDIMENTO IMOBILIARIO LTDA","182725.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202188378,LOJA,SDWAN,61944dceb4a8174f7a514d4c,"OPEN - GENERAL - V3",1637112016,1637109010,"alert_manager","","",,"{""edgeId"": ""2107"", ""linkId"": ""5409"", ""interface"": ""GE3""}","N/A",,202188378,high,"a7cae88f-bc96-4545-9297-a9672aa98753",2107,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202188378 - Edge 2107 entrou em status DEGRADED",86400,high
"Não",Curitiba,"CONDOMINIO PARKSHOPPING BARIGUI","155267.0000000",PR,"N/A","SDWAN - VELOCLOUD",202041328,LOJA,SDWAN,61944dd0b4a8174f7a514d4f,"OPEN - GENERAL - V3",1637112016,1637109010,"alert_manager","","",,"{""edgeId"": ""932"", ""linkId"": ""3601"", ""interface"": ""GE3""}","N/A",,202041328,high,"0830194b-e347-4cae-8ecd-6657ca6e8ca6",932,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109180_12441_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,19,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041328 - Edge 932 entrou em status DEGRADED",86400,high
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61944e02512a4e102e4431b2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109303,1637108402,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"6c2fac2d-891c-480b-b39c-a62664069b68","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109180_12547_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944e0c512a4e102e4431c0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109003,1637108405,"alert_manager","","",,"N/A","N/A",,202165385,performance,"5cd9ae48-b91e-4b27-bea1-708aff18aaa8",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109180_12547_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Fortaleza,"REAL MOTO PECAS LTDA","174020.0000000",CE,"FORTALEZA | 202171318",GRC,202171318,DADOS,DADOS,61944e0d512a4e102e4431c2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637108402,"alert_manager","","",,"N/A","N/A",,"greal-fla-hafw-c",performance,"26e71717-5fa4-4f32-8791-fa5dbfd0f272","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109180_12547_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-fla-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61944e19512a4e102e4431d2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109003,1637108405,"alert_manager","","",,"N/A","N/A",,202183366,performance,"4462c056-0b21-4187-9ab5-ccd764e485ae",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109180_12547_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61944e1a512a4e102e4431d4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109003,1637108405,"alert_manager","","",,"N/A","N/A",,202183367,performance,"ecd7bb66-4791-4c8f-b887-051ab62bde9a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109180_12547_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61944e1a512a4e102e4431d6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109003,1637108405,"alert_manager","","",,"N/A","N/A",,202183373,performance,"2b3ae114-fcf0-4cbf-ae9d-528e96ff0f04",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109180_12547_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61944e1b512a4e102e4431d8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109003,1637108405,"alert_manager","","",,"N/A","N/A",,202183380,performance,"cbce8635-f0f3-47b6-8ba1-6e433f608c9a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109180_12547_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61944e1c512a4e102e4431da,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109003,1637108405,"alert_manager","","",,"N/A","N/A",,202183383,performance,"1c6a4351-0d8a-403c-85e3-1876848741d4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109180_12547_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",61944eeb512a4e102e4431dd,"OPEN - GENERAL - V3",1637112016,1637109304,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4132"", ""interface"": ""GE4""}","N/A",,202061983,medium,"ba52f398-de19-4df5-a148-1149785d47cf",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109480_12556_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061983 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61944eec512a4e102e4431df,"OPEN - GENERAL - V3",1637112016,1637109304,"alert_manager","","",,"{""edgeId"": ""1562"", ""linkId"": ""4133"", ""interface"": ""GE3""}","N/A",,202061983,medium,"50a9fef0-1984-4d67-bf38-671bf78189ed",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109480_12556_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202061983 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Rio de Janeiro","SERIMAX DO BRASIL SERVICOS DE SOLDAGEM E FABRICACAO LTDA","179671.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202183111,SDWAN,SDWAN,61944ef2512a4e102e4431e8,"OPEN - GENERAL - V3",1637112016,1637109304,"alert_manager","","",,"{""edgeId"": ""466"", ""linkId"": ""1080"", ""interface"": ""GE3""}","N/A",,202183111,high,"f176add0-7e9d-43c7-b6d7-1c54da665efe",466,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109480_12556_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202183111 - Edge 466 entrou em status DEGRADED",86400,high
"Não","Cuiabá","GERDAU AÇOS LONGOS S A","154961.0000000",MT,"N/A","SDWAN - VELOCLOUD",202040659,BAIXO,SDWAN,61944ef5512a4e102e4431ed,"OPEN - GENERAL - V3",1637112016,1637109304,"alert_manager","","",,"{""edgeId"": ""959"", ""linkId"": ""1876"", ""interface"": ""GE3""}","N/A",,202040659,high,"862e61d0-d883-4ef1-a9f6-b8031cc93702",959,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109480_12556_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,14,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040659 - Edge 959 entrou em status OFFLINE",86400,high
"Não","Juazeiro do Norte","GERDAU AÇOS LONGOS S A","154968.0000000",CE,"N/A","SDWAN - VELOCLOUD",202040666,BAIXO,SDWAN,61944ef6512a4e102e4431f0,"OPEN - GENERAL - V3",1637112016,1637109304,"alert_manager","","",,"{""edgeId"": ""973"", ""linkId"": ""2060"", ""interface"": ""GE3""}","N/A",,202040666,high,"8abb6ab4-8fd1-4003-bb5f-b5016fc7eba5",973,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109480_12556_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,16,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040666 - Edge 973 entrou em status OFFLINE",86400,high
"Não","Rio do Sul","GERDAU AÇOS LONGOS S A","155353.0000000",SC,"N/A","SDWAN - VELOCLOUD",202041390,BAIXO,SDWAN,61944ef8512a4e102e4431f3,"OPEN - GENERAL - V3",1637112016,1637109304,"alert_manager","","",,"{""edgeId"": ""997"", ""linkId"": ""1942"", ""interface"": ""GE3""}","N/A",,202041390,high,"46b04266-a7e4-48e6-aaf7-8f53b68f00f7",997,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637109480_12556_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,18,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041390 - Edge 997 entrou em status OFFLINE",86400,high
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61944f3cb4a8174f7a514d56,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109601,1637108700,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"c8fb2920-36a5-4a38-a56e-2ca934c76c89","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61944f3cb4a8174f7a514d58,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109601,1637108700,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"e6992518-1b8b-4a25-9ea8-382100df49e7","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61944f3eb4a8174f7a514d5b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109600,1637108700,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"4f8e1425-a16c-4752-ac3f-0cbf97a0710f","UOL - port1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port1 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61944f3fb4a8174f7a514d5d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109600,1637108700,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"4dbc91b9-69b7-4b55-ab63-157352d4234b","UOL - port3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port3 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61944f40b4a8174f7a514d5f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109600,1637108700,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"8676f32e-d137-49ac-ae28-e44b7cac849d","UOL - port9","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port9 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61944f47b4a8174f7a514d67,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109307,1637108704,"alert_manager","","",,"N/A","N/A",,202165385,performance,"c6e2efe8-e576-49ba-9644-aa2ce24dc33b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61944f52b4a8174f7a514d75,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109307,1637108704,"alert_manager","","",,"N/A","N/A",,202183366,performance,"0df856e3-1816-4ab2-9985-0b7560271b0c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61944f53b4a8174f7a514d77,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109307,1637108704,"alert_manager","","",,"N/A","N/A",,202183367,performance,"3afba758-aa84-4907-b42a-a2ba22460d57",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61944f55b4a8174f7a514d79,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109307,1637108704,"alert_manager","","",,"N/A","N/A",,202183373,performance,"2085af4e-92b5-47cc-9d43-0a0e85449be5",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61944f55b4a8174f7a514d7b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109307,1637108704,"alert_manager","","",,"N/A","N/A",,202183380,performance,"b4f4e8c0-a8eb-470c-89a2-1f4da0a93a63",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61944f56b4a8174f7a514d7d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109307,1637108704,"alert_manager","","",,"N/A","N/A",,202183383,performance,"67b50cdd-dbe5-4b87-8907-3ab8d939174c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109480_12455_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","SAO JOSE DO RIO PRETO","PACAEMBU AUTOPEÇAS LTDA","108875.0000000",SP,"PACAEMBU SRR | 201748895",BSN,201748895,FILIAIS,"SEM CONTINGENCIA",61945062b4a8174f7a514d7f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109902,1637109001,"alert_manager","","",,"N/A","N/A",,"pacaembu-srr-fw-004",performance,"ffe2a193-8cb8-4f55-bc03-20db0dcbac26","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-srr-fw-004 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","SAO JOSE DO RIO PRETO","PACAEMBU AUTOPEÇAS LTDA","108875.0000000",SP,"PACAEMBU SRR | 201748895",BSN,201748895,FILIAIS,"SEM CONTINGENCIA",61945063b4a8174f7a514d81,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109902,1637109001,"alert_manager","","",,"N/A","N/A",,"pacaembu-srr-fw-004",performance,"6c84d7cf-4cdb-4a57-a4d4-b709b399df9d","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-srr-fw-004 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61945065b4a8174f7a514d85,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637109001,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"af8dea27-f1d5-4b56-865c-11fe6ec7fe8d","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61945066b4a8174f7a514d87,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637109001,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"17396019-6198-4e99-a95d-16c86cd5eace","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61945070b4a8174f7a514d92,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109601,1637109003,"alert_manager","","",,"N/A","N/A",,202165385,performance,"1610f1a9-47b3-4022-ad7e-5d85ff2e9d9e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194507bb4a8174f7a514d9f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109604,1637109003,"alert_manager","","",,"N/A","N/A",,202183366,performance,"8149429c-863a-4e8d-ac71-8fbe18b17b51",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194507bb4a8174f7a514da1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109604,1637109003,"alert_manager","","",,"N/A","N/A",,202183367,performance,"94782edb-d43d-4d3c-b212-d0e5f9a3fb7d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194507cb4a8174f7a514da3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109604,1637109003,"alert_manager","","",,"N/A","N/A",,202183373,performance,"b28b8057-771d-48ea-aa36-622756a05589",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194507db4a8174f7a514da5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109604,1637109003,"alert_manager","","",,"N/A","N/A",,202183380,performance,"1653c4f8-b61e-42aa-930c-54d0f7f9509e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194507eb4a8174f7a514da7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109604,1637109003,"alert_manager","","",,"N/A","N/A",,202183383,performance,"53bf3dbd-1133-492f-af9b-ada64628e674",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637109780_12465_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",61945184512a4e102e44320a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110500,1637109303,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"5282e5e8-6add-4014-bbff-4411c7e8cb97","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",61945185512a4e102e44320c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110500,1637109303,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"c4f4068b-0e7c-466a-abbf-2c0e7a3c3971","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",6194518b512a4e102e443215,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110801,1637109303,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"90cf818b-f979-4532-94b7-8d3774ad1a20","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61945190512a4e102e44321d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109904,1637109307,"alert_manager","","",,"N/A","N/A",,202165385,performance,"0a15763f-e23b-48b9-80e8-71c504242c30",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,61945192512a4e102e443220,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637109302,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"7cac1d7d-d5a5-42f5-933f-19f31d6d279f",a,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Volta Redonda","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179466.0000000",RJ,"PR05-VOLTA_REDONDA_VRD/IP/03801 | 202182014",SDE,202182014,"ABORDAGEM SIMPLES",FILIAL,61945198512a4e102e443229,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113501,1637109306,"alert_manager","","",,"N/A","N/A",,"PR05-VOLTA_REDONDA",performance,"8ea49acf-aa2b-4e0b-b10f-e56d8fce6859",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR05-VOLTA_REDONDA - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194519e512a4e102e443231,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109904,1637109307,"alert_manager","","",,"N/A","N/A",,202183366,performance,"8a1d5af2-c12f-4238-b4fb-b73541064d41",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194519f512a4e102e443233,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109904,1637109307,"alert_manager","","",,"N/A","N/A",,202183367,performance,"099739de-a72f-4240-9465-7891ac40db1b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194519f512a4e102e443235,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109904,1637109307,"alert_manager","","",,"N/A","N/A",,202183373,performance,"e1d957a2-1172-4c0d-828f-a4d34e8adc08",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619451a0512a4e102e443237,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109904,1637109307,"alert_manager","","",,"N/A","N/A",,202183380,performance,"ff73ce87-bfa8-4319-a0f4-16f88d1bcb58",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619451a1512a4e102e443239,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637109904,1637109307,"alert_manager","","",,"N/A","N/A",,202183383,performance,"19502f87-b6dd-49b1-b606-70a1da953a96",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110080_12578_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619452bab4a8174f7a514dbd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110801,1637109600,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"4a64cd63-701d-4ca5-9199-a0ba9a381a86","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110380_12488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619452bbb4a8174f7a514dbf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110801,1637109600,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"49e2b45a-4f5c-48f3-b4b7-28c2f039bfae","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110380_12488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619452cab4a8174f7a514dd1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110204,1637109601,"alert_manager","","",,"N/A","N/A",,202165385,performance,"27a2ba75-8deb-4045-97fe-9d8a5c325c2c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110380_12488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619452d7b4a8174f7a514de1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110204,1637109604,"alert_manager","","",,"N/A","N/A",,202183366,performance,"b0d7aeef-bca5-452a-b436-b715b706a5fd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110380_12488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619452d8b4a8174f7a514de3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110204,1637109604,"alert_manager","","",,"N/A","N/A",,202183367,performance,"c625885c-c0cd-4f0f-af57-b2a9749835dd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110380_12488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619452d9b4a8174f7a514de5,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110204,1637109604,"alert_manager","","",,"N/A","N/A",,202183373,performance,"e258119f-4194-478f-ad94-d3cca8609b2f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110380_12488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619452dab4a8174f7a514de7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110204,1637109604,"alert_manager","","",,"N/A","N/A",,202183380,performance,"4acf9b85-cc72-465d-a71d-897277926584",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110380_12488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619452dbb4a8174f7a514de9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110204,1637109604,"alert_manager","","",,"N/A","N/A",,202183383,performance,"de9715a9-497c-490b-ae15-006476a6def6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110380_12488_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","POUSO ALEGRE","PACAEMBU AUTOPEÇAS LTDA","107937.0000000",MG,"PACAEMBU PSA | 201746280",BSN,201746280,FILIAIS,"SEM CONTINGENCIA",619453eafa57811c983f57b3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637109902,"alert_manager","","",,"N/A","N/A",,"pacaembu-psa-fw-031",performance,"938445f0-266e-4298-a345-0b1191989661","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-psa-fw-031 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",619453edfa57811c983f57b7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111403,1637109902,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"78d7e532-19c0-4077-88de-5eafa8d23542","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,3,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",619453f4fa57811c983f57bf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110801,1637109902,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"ec69a7ff-5e78-4502-8537-afd568c017e2","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",619453f5fa57811c983f57c1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110801,1637109902,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"4b973762-705a-422e-beed-af4c08a4aba4","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",619453f7fa57811c983f57c4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110801,1637109902,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"0c13b5c0-7852-4e78-8c29-a111ed497d87","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",619453f9fa57811c983f57c7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637109902,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"273dd821-0f0c-4383-af2e-993af03020d5","UOL - port1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port1 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",619453fafa57811c983f57c9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637109902,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"64bfcfe7-4e3c-4030-9bcc-82831d67c86a","UOL - port9","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port9 excedeu o valor do 100",86400,low
"Não",Sinop,"PACAEMBU AUTOPEÇAS LTDA","118947.0000000",MT,"PACAEMBU SNO | 201866418",BSN,201866418,FILIAIS,"SEM CONTINGENCIA",619453fbfa57811c983f57cb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637109902,"alert_manager","","",,"N/A","N/A",,"pacaembu-sno-fw-033",performance,"a4bf00cd-b4d7-442d-9f77-d961123c44c8","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,17,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-sno-fw-033 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61945401fa57811c983f57d3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110505,1637109904,"alert_manager","","",,"N/A","N/A",,202165385,performance,"7c0bec81-7698-48bf-b341-dd44f8b8b065",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194540dfa57811c983f57e0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110505,1637109904,"alert_manager","","",,"N/A","N/A",,202183366,performance,"f9ea276b-9ce5-4e12-8391-237ecbe3d10e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194540efa57811c983f57e2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110505,1637109904,"alert_manager","","",,"N/A","N/A",,202183367,performance,"7497880e-1f6e-4533-8e05-00d1b97a2423",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194540ffa57811c983f57e4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110505,1637109904,"alert_manager","","",,"N/A","N/A",,202183373,performance,"b8788d31-cd6d-4fd0-b279-d3a6206eff38",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61945410fa57811c983f57e6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110505,1637109904,"alert_manager","","",,"N/A","N/A",,202183380,performance,"04e17369-cb13-4c28-bd2b-5353460c372a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,39,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61945411fa57811c983f57e8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110505,1637109904,"alert_manager","","",,"N/A","N/A",,202183383,performance,"7b775f56-42c8-4b01-8647-1f9360b1a43c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110680_12707_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,40,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",6194551db4a8174f7a514e35,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637110200,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"125f3364-d958-4d3a-8b6c-2dc8a76ef0d3","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",6194551eb4a8174f7a514e37,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637110200,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"458941ef-83e6-4bd0-945f-95cfa67c4a2b","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",6194551fb4a8174f7a514e39,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112301,1637110200,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"065de48f-dff5-41e1-914a-dcb82485774a","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61945529b4a8174f7a514e45,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110804,1637110204,"alert_manager","","",,"N/A","N/A",,202165385,performance,"65e41f5f-11e8-4013-ac6d-cd4db2e58793",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Vitória da Conquista","REAL MOTO PECAS LTDA","174021.0000000",BA,"VITORIADACONQUISTA | 202171319",GRC,202171319,DADOS,DADOS,6194552cb4a8174f7a514e49,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111101,1637110200,"alert_manager","","",,"N/A","N/A",,"greal-vca-hafw-c",performance,"b64a79e9-f770-4931-bf09-4d23df41b056","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-vca-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61945535b4a8174f7a514e54,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110804,1637110204,"alert_manager","","",,"N/A","N/A",,202183366,performance,"c9974697-7673-4bdc-85c9-c0631c6e752d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61945536b4a8174f7a514e56,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110804,1637110204,"alert_manager","","",,"N/A","N/A",,202183367,performance,"86562625-f654-4a45-921e-32ff87c75982",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61945537b4a8174f7a514e58,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110804,1637110204,"alert_manager","","",,"N/A","N/A",,202183373,performance,"104e4d16-b2b8-4766-b25e-28bcb8a57c8a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61945538b4a8174f7a514e5a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110804,1637110204,"alert_manager","","",,"N/A","N/A",,202183380,performance,"ce046e8e-56cc-4049-89d2-7f5b2a073eb9",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,37,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61945539b4a8174f7a514e5c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637110804,1637110204,"alert_manager","","",,"N/A","N/A",,202183383,performance,"36449a9a-20e3-446a-a4e3-6bee0c3f00e1",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637110980_12516_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,38,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,6194564eb4a8174f7a514e6b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111104,1637110505,"alert_manager","","",,"N/A","N/A",,202165385,performance,"1363bcf2-adfe-4920-bc19-2cc36379c89c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111280_12525_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61945656b4a8174f7a514e75,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111104,1637110505,"alert_manager","","",,"N/A","N/A",,202183366,performance,"546b6460-448b-4623-9267-bff45b717754",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111280_12525_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61945657b4a8174f7a514e77,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111104,1637110505,"alert_manager","","",,"N/A","N/A",,202183367,performance,"b479fa5c-665b-4839-befe-cdd06a8a85bd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111280_12525_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61945658b4a8174f7a514e79,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111104,1637110505,"alert_manager","","",,"N/A","N/A",,202183373,performance,"4fbc1b02-db87-49c2-9afc-bf3b060d8d6b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111280_12525_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61945659b4a8174f7a514e7b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111104,1637110505,"alert_manager","","",,"N/A","N/A",,202183380,performance,"1c3d0353-c2fb-47c6-b274-4aaa2523b9b3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111280_12525_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194565ab4a8174f7a514e7d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111104,1637110505,"alert_manager","","",,"N/A","N/A",,202183383,performance,"991ee585-7dc1-4a3b-8063-3539b9093dec",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111280_12525_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61945770fa57811c983f586e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112301,1637110801,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"c98da7c8-b0d9-4f9e-a4cd-cd53ef4f9ae7","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111580_12741_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",61945771fa57811c983f5870,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112301,1637110801,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"05d082e0-7069-483c-9c4f-d7fb23f16ff7","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111580_12741_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,6194577afa57811c983f587a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111405,1637110804,"alert_manager","","",,"N/A","N/A",,202165385,performance,"66ef1e32-20d6-46f3-9d47-f2edc9b83c22",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111580_12741_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61945782fa57811c983f5884,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111405,1637110804,"alert_manager","","",,"N/A","N/A",,202183366,performance,"c8c2d6e1-3693-4609-a3bf-426f2568f90a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111580_12741_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61945783fa57811c983f5886,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111405,1637110804,"alert_manager","","",,"N/A","N/A",,202183367,performance,"0c6e1d0d-4ab9-4965-ab01-aaff9f9b870c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111580_12741_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61945784fa57811c983f5888,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111405,1637110804,"alert_manager","","",,"N/A","N/A",,202183373,performance,"54ef58e3-a186-456f-819d-792980e11d7f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111580_12741_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61945785fa57811c983f588a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111405,1637110804,"alert_manager","","",,"N/A","N/A",,202183380,performance,"e7784d0e-25d9-4944-adfd-74db650e809d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111580_12741_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61945786fa57811c983f588c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111405,1637110804,"alert_manager","","",,"N/A","N/A",,202183383,performance,"ad19bad0-e3db-4563-a1fd-a105034378ff",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111580_12741_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",6194589cfa57811c983f58d4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112002,1637111101,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"a1df1445-5071-4005-aacf-c59603663384","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",6194589dfa57811c983f58d6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112301,1637111101,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"3a2e213d-c895-4b5b-aeb8-95928c3d1ba0","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Barueri,"TEGMA GESTAO LOGISTICA S A","173011.0000000",SP,"BRE - ALOG / DC Equinix | 202165365",SDE,202165365,SDWAN,SDE,619458a6fa57811c983f58e1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113501,1637111101,"alert_manager","","",,"N/A","N/A",,"tegma-bre-dc-hafw-1",performance,"dc3f1696-a07d-47d7-b73d-4c912f618431",port2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-bre-dc-hafw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619458a8fa57811c983f58e4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111704,1637111104,"alert_manager","","",,"N/A","N/A",,202165385,performance,"fd711307-bbaf-4d04-bcc3-2ad198a9606a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,17,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,619458aefa57811c983f58eb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112002,1637111101,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"5041acae-15ea-43ea-a9e2-8e00ceba8e6d",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619458b2fa57811c983f58f0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111704,1637111104,"alert_manager","","",,"N/A","N/A",,202183366,performance,"7bcd59a2-7141-41c2-bbbe-dcb3ea947744",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619458b3fa57811c983f58f2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111704,1637111104,"alert_manager","","",,"N/A","N/A",,202183367,performance,"0e850604-a921-4b12-814b-f1fb7d9474c8",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619458b4fa57811c983f58f4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111704,1637111104,"alert_manager","","",,"N/A","N/A",,202183373,performance,"6222ed8f-6875-4f13-82ba-739675672b18",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619458b5fa57811c983f58f6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111704,1637111104,"alert_manager","","",,"N/A","N/A",,202183380,performance,"91d54b27-7455-47b9-ae20-3e83d13c10ae",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619458b6fa57811c983f58f8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637111704,1637111104,"alert_manager","","",,"N/A","N/A",,202183383,performance,"cea180e1-34ca-4f3f-93a8-1fc0c4ee59be",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637111880_12748_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Rio de Janeiro","BANCO LOSANGO S.A. - BANCO MULTIPLO","133309.0000000",RJ,"N/A",BRAD,20197431,LOSANGO,SDWAN,61945977512a4e102e443281,"OPEN - GENERAL - V3",1637112336,1637112016,"alert_manager","","",,"{""edgeId"": ""423"", ""linkId"": ""1021"", ""interface"": ""GE3""}","N/A",,20197431,medium,"730a68a7-b594-4e46-be5c-d407cc67bd15",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197431 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","Rio de Janeiro","BANCO LOSANGO S.A. - BANCO MULTIPLO","133309.0000000",RJ,"N/A",BRAD,20197431,LOSANGO,SDWAN,61945978512a4e102e443284,"OPEN - GENERAL - V3",1637112336,1637112016,"alert_manager","","",,"{""edgeId"": ""423"", ""linkId"": ""1054"", ""interface"": ""GE4""}","N/A",,20197431,medium,"161bcb58-51c1-4e29-8696-fb4333fe43a5",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"20197431 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","Campina Grande","GERDAU AÇOS LONGOS S A","154942.0000000",PB,"N/A","SDWAN - VELOCLOUD",202040636,BAIXO,SDWAN,61945979512a4e102e443287,"OPEN - GENERAL - V3",1637112336,1637112016,"alert_manager","","",,"{""edgeId"": ""952"", ""linkId"": ""2202"", ""interface"": ""GE3""}","N/A",,202040636,medium,"5397458f-6108-4fa1-86cf-6e79d6d871d1",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,4,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040636 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","Campina Grande","GERDAU AÇOS LONGOS S A","154942.0000000",PB,"N/A","SDWAN - VELOCLOUD",202040636,BAIXO,SDWAN,61945979512a4e102e44328a,"OPEN - GENERAL - V3",1637112336,1637112016,"alert_manager","","",,"{""edgeId"": ""952"", ""linkId"": ""2203"", ""interface"": ""GE4""}","N/A",,202040636,medium,"3ffebed5-cf34-4e11-8b1c-4d643ff281ac",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,5,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040636 - Link GE4 entrou em status DISCONNECTED",86400,medium
"Não",Manaus,"GERDAU AÇOS LONGOS S A","154766.0000000",AM,"N/A","SDWAN - VELOCLOUD",202040627,BAIXO,SDWAN,6194597a512a4e102e44328d,"OPEN - GENERAL - V3",1637112336,1637112016,"alert_manager","","",,"{""edgeId"": ""979"", ""linkId"": ""3181"", ""interface"": ""GE3""}","N/A",,202040627,medium,"1b6bc3cd-f0bf-4c03-93cb-aaf3cb02e43f",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040627 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não",Manaus,"GERDAU AÇOS LONGOS S A","154766.0000000",AM,"N/A","SDWAN - VELOCLOUD",202040627,BAIXO,SDWAN,6194597b512a4e102e443290,"OPEN - GENERAL - V3",1637112336,1637112016,"alert_manager","","",,"{""edgeId"": ""979"", ""linkId"": ""5411"", ""interface"": ""GE4""}","N/A",,202040627,medium,"3daea3d0-f02f-430a-9912-8309ddd7b587",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202040627 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Pelotas,"GERDAU AÇOS LONGOS S A","155336.0000000",RS,"N/A","SDWAN - VELOCLOUD",202041373,BAIXO,SDWAN,6194597c512a4e102e443293,"OPEN - GENERAL - V3",1637112336,1637112016,"alert_manager","","",,"{""edgeId"": ""990"", ""linkId"": ""1846"", ""interface"": ""GE3""}","N/A",,202041373,medium,"0d32d1e8-1b34-4cf7-a504-32625bc98fc0",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041373 - Link GE3 entrou em status DISCONNECTED",86400,medium
"Não","São Gonçalo","GERDAU AÇOS LONGOS S A","155342.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202041379,BAIXO,SDWAN,6194597c512a4e102e443296,"OPEN - GENERAL - V3",1637112336,1637112016,"alert_manager","","",,"{""edgeId"": ""996"", ""linkId"": ""2427"", ""interface"": ""GE3""}","N/A",,202041379,medium,"a8735a0f-555c-4940-b546-cae47ffad1ac",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,9,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041379 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","São Gonçalo","GERDAU AÇOS LONGOS S A","155342.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202041379,BAIXO,SDWAN,6194597d512a4e102e443299,"OPEN - GENERAL - V3",1637112336,1637112016,"alert_manager","","",,"{""edgeId"": ""996"", ""linkId"": ""3195"", ""interface"": ""GE4""}","N/A",,202041379,medium,"13c1077e-6918-425b-bd3b-b07881a5fcf2",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202041379 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não",Natal,"BANCO LOSANGO S.A. - BANCO MULTIPLO","133313.0000000",RN,"N/A",BRAD,20197433,LOSANGO,SDWAN,61945981512a4e102e4432a4,"OPEN - GENERAL - V3",1637114714,1637112016,"alert_manager","","",,"{""edgeId"": ""411"", ""linkId"": ""1040"", ""interface"": ""GE4""}","N/A",,20197433,high,"b15c5933-eb36-46a2-9ff9-790804546758",411,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"20197433 - Edge 411 entrou em status OFFLINE",86400,high
"Não","Campo Grande","GERDAU AÇOS LONGOS S A","154946.0000000",MS,"N/A","SDWAN - VELOCLOUD",202040654,BAIXO,SDWAN,61945983512a4e102e4432a9,"OPEN - GENERAL - V3",1637114714,1637112016,"alert_manager","","",,"{""edgeId"": ""953"", ""linkId"": ""1867"", ""interface"": ""GE3""}","N/A",,202040654,high,"7c036da8-a08f-48e4-ba9f-6e756a1b5740",953,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112180_12640_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,17,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040654 - Edge 953 entrou em status OFFLINE",86400,high
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",619459b8512a4e102e4432db,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112301,1637111403,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"2f53d255-11b1-4081-9bf4-93ca1074499e","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112180_12639_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",619459bc512a4e102e4432e1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112301,1637111403,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"754be44a-c3b4-4a39-b575-bad6051a0704","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112180_12639_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619459c6512a4e102e4432ef,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112006,1637111405,"alert_manager","","",,"N/A","N/A",,202165385,performance,"be945889-5a06-4a66-afd3-1030bb129436",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112180_12639_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619459cc512a4e102e4432f8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112006,1637111405,"alert_manager","","",,"N/A","N/A",,202183366,performance,"fd1c5a89-9c9e-4a0b-87a9-7559cf077f0c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112180_12639_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619459cd512a4e102e4432fa,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112006,1637111405,"alert_manager","","",,"N/A","N/A",,202183367,performance,"cfb28150-8644-4673-ac54-92028718df09",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112180_12639_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619459ce512a4e102e4432fc,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112006,1637111405,"alert_manager","","",,"N/A","N/A",,202183373,performance,"022ded12-5e54-4713-8bfb-d0f85b0b424a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112180_12639_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619459cf512a4e102e4432fe,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112006,1637111405,"alert_manager","","",,"N/A","N/A",,202183380,performance,"a4c8176a-056a-4747-969d-d579c4eca8a8",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112180_12639_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619459d0512a4e102e443300,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112006,1637111405,"alert_manager","","",,"N/A","N/A",,202183383,performance,"7dfdc036-ca22-4198-93a1-87d8852f1722",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112180_12639_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Ananindeua,"GERDAU AÇOS LONGOS S A","154764.0000000",PA,"N/A","SDWAN - VELOCLOUD",202040625,BAIXO,SDWAN,61945aaafa57811c983f5902,"OPEN - GENERAL - V3",1637114714,1637112336,"alert_manager","","",,"{""edgeId"": ""941"", ""linkId"": ""2326"", ""interface"": ""GE3""}","N/A",,202040625,high,"c5277d63-f004-4bd8-a79a-16efe6506c7b",941,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637112480_12764_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040625 - Edge 941 entrou em status OFFLINE",86400,high
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61945af6fa57811c983f590c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112602,1637111700,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"d5f0b957-a6b2-4e36-9e79-6cf88bc5593d","UOL - port1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port1 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61945af7fa57811c983f590e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112602,1637111700,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"f0883098-ab43-4831-9327-17e9df4457a0","UOL - port9","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port9 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61945afffa57811c983f5917,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112303,1637111704,"alert_manager","","",,"N/A","N/A",,202165385,performance,"3c06a844-4d70-4508-a070-04fc1b85273c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Vitória da Conquista","REAL MOTO PECAS LTDA","174021.0000000",BA,"VITORIADACONQUISTA | 202171319",GRC,202171319,DADOS,DADOS,61945b00fa57811c983f5919,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112901,1637111701,"alert_manager","","",,"N/A","N/A",,"greal-vca-hafw-c",performance,"10f27d5a-1e1b-491b-bd09-696db053edbd","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-vca-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,61945b00fa57811c983f591b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112901,1637111701,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"9ee3b4b9-0083-4694-81f0-e86336ee3701","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61945b09fa57811c983f5925,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112303,1637111704,"alert_manager","","",,"N/A","N/A",,202183366,performance,"3dc9a3c1-eadd-432e-ad65-8fb06cbf8bc2",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61945b0afa57811c983f5927,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112303,1637111704,"alert_manager","","",,"N/A","N/A",,202183367,performance,"98c2d2eb-8311-47de-89d4-947cc1e921fd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61945b0bfa57811c983f5929,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112303,1637111704,"alert_manager","","",,"N/A","N/A",,202183373,performance,"3b16e603-fab6-4e58-880c-e30ef6be4b18",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61945b0cfa57811c983f592b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112303,1637111704,"alert_manager","","",,"N/A","N/A",,202183380,performance,"0a14e11b-d1b4-4ab1-a5f8-3309a9e30f70",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61945b0dfa57811c983f592d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112303,1637111704,"alert_manager","","",,"N/A","N/A",,202183383,performance,"3112adf1-fa6b-47c6-b250-ff1ae36ec0df",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112480_12766_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61945c29fa57811c983f597b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112604,1637112006,"alert_manager","","",,"N/A","N/A",,202165385,performance,"2b8908ff-e29a-478d-8204-1ee66e7e645c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112780_12775_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,61945c2bfa57811c983f597e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113801,1637112002,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"c628cd5a-2987-4771-b91d-1b118e6765b2",a,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112780_12775_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61945c36fa57811c983f598b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112604,1637112006,"alert_manager","","",,"N/A","N/A",,202183366,performance,"b8f6e7fb-2e84-40d4-b536-ce626d3da91e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112780_12775_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61945c37fa57811c983f598d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112604,1637112006,"alert_manager","","",,"N/A","N/A",,202183367,performance,"b4384739-423f-4796-9cfa-a8cf085dfa4f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112780_12775_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61945c38fa57811c983f598f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112604,1637112006,"alert_manager","","",,"N/A","N/A",,202183373,performance,"e1f27b8b-b943-488c-b084-ad02e0d17207",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112780_12775_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61945c39fa57811c983f5991,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112604,1637112006,"alert_manager","","",,"N/A","N/A",,202183380,performance,"8d10ede1-09b6-45b0-895e-baa3ec1bce69",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112780_12775_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61945c3afa57811c983f5993,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112604,1637112006,"alert_manager","","",,"N/A","N/A",,202183383,performance,"08e6afe7-7b81-4581-89b8-5d7ac1125d77",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637112780_12775_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61945d47512a4e102e443399,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112906,1637112303,"alert_manager","","",,"N/A","N/A",,202165385,performance,"7f99ef29-c1a6-485b-91b0-12696c620281",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113080_12673_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61945d52512a4e102e4433a8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112906,1637112303,"alert_manager","","",,"N/A","N/A",,202183366,performance,"d4d0e6cb-9079-4595-b15d-f15874d90644",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113080_12673_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61945d53512a4e102e4433aa,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112906,1637112303,"alert_manager","","",,"N/A","N/A",,202183367,performance,"50c716fd-c904-4165-b4e7-c3698c7df755",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113080_12673_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61945d54512a4e102e4433ac,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112906,1637112303,"alert_manager","","",,"N/A","N/A",,202183373,performance,"b39f1450-da45-40c5-b5a0-194f54144949",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113080_12673_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61945d55512a4e102e4433ae,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112906,1637112303,"alert_manager","","",,"N/A","N/A",,202183380,performance,"865e61ee-0562-4b84-a450-99eda2ce690b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113080_12673_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61945d55512a4e102e4433b0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637112906,1637112303,"alert_manager","","",,"N/A","N/A",,202183383,performance,"7ab7ab26-cd28-4af5-b2a8-b7c69565f593",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113080_12673_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61945e72512a4e102e4433c9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113203,1637112604,"alert_manager","","",,"N/A","N/A",,202165385,performance,"8e03cf74-5e27-4a90-af06-c350ca7b232b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113380_12684_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61945e7d512a4e102e4433d8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113203,1637112604,"alert_manager","","",,"N/A","N/A",,202183366,performance,"532f7815-3394-4089-93bd-73f4a7374358",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113380_12684_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61945e7e512a4e102e4433da,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113203,1637112604,"alert_manager","","",,"N/A","N/A",,202183367,performance,"20db9829-77f1-44da-a32c-593d1d3ac2c4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113380_12684_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61945e7e512a4e102e4433dc,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113203,1637112604,"alert_manager","","",,"N/A","N/A",,202183373,performance,"e05766af-a5c4-4ef9-9865-c595f7a38b9e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113380_12684_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61945e7f512a4e102e4433de,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113203,1637112604,"alert_manager","","",,"N/A","N/A",,202183380,performance,"a2bf0dbf-d763-45a6-9451-92e82577d6c0",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113380_12684_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61945e80512a4e102e4433e0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113203,1637112604,"alert_manager","","",,"N/A","N/A",,202183383,performance,"8e6fe727-889f-4f80-bc4e-d309e069a59d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113380_12684_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61945fa9b4a8174f7a514e97,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113505,1637112906,"alert_manager","","",,"N/A","N/A",,202165385,performance,"c7d2f406-c639-45ea-8f31-c905c9cca859",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113680_12613_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61945fb4b4a8174f7a514ea4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113505,1637112906,"alert_manager","","",,"N/A","N/A",,202183366,performance,"00688f78-e212-4cc2-95cc-c4299c2f44d6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113680_12613_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61945fb5b4a8174f7a514ea6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113505,1637112906,"alert_manager","","",,"N/A","N/A",,202183367,performance,"c65f4823-9eb7-4bae-a0ff-4065bd9318a5",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113680_12613_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61945fb6b4a8174f7a514ea8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113505,1637112906,"alert_manager","","",,"N/A","N/A",,202183373,performance,"5128a439-5852-403e-93cf-48d4e4618317",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113680_12613_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61945fb7b4a8174f7a514eaa,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113505,1637112906,"alert_manager","","",,"N/A","N/A",,202183380,performance,"e286ea7e-ec12-46a7-992d-f6c6abb67d00",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113680_12613_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61945fb8b4a8174f7a514eac,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113505,1637112906,"alert_manager","","",,"N/A","N/A",,202183383,performance,"18446b02-4878-4b98-86d6-08bc5452891f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113680_12613_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",619460d2fa57811c983f59e1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113202,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"f87e3754-d70e-4c99-8b9c-c31b6a103930","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113980_12812_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619460d9fa57811c983f59e9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113803,1637113203,"alert_manager","","",,"N/A","N/A",,202165385,performance,"eb60e2b0-64a0-4b74-a4db-6bfc5fa743eb",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113980_12812_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Fortaleza,"REAL MOTO PECAS LTDA","174020.0000000",CE,"FORTALEZA | 202171318",GRC,202171318,DADOS,DADOS,619460dafa57811c983f59eb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114101,1637113803,"alert_manager","","",,"N/A","N/A",,"greal-fla-hafw-c",performance,"4672570e-a22f-4390-9671-5d2c54b2728e","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113980_12812_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-fla-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Vitória da Conquista","REAL MOTO PECAS LTDA","174021.0000000",BA,"VITORIADACONQUISTA | 202171319",GRC,202171319,DADOS,DADOS,619460dbfa57811c983f59ed,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114403,1637113202,"alert_manager","","",,"N/A","N/A",,"greal-vca-hafw-c",performance,"ca6b88ed-f5b2-4e03-95d1-dddcd22111e6","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113980_12812_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-vca-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619460e2fa57811c983f59f6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113803,1637113203,"alert_manager","","",,"N/A","N/A",,202183366,performance,"dfdcbc1f-5989-4be3-a733-079c4dad9e81",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113980_12812_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619460e3fa57811c983f59f8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113803,1637113203,"alert_manager","","",,"N/A","N/A",,202183367,performance,"765586bb-00df-4175-a306-3c103f8db948",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113980_12812_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619460e4fa57811c983f59fa,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113803,1637113203,"alert_manager","","",,"N/A","N/A",,202183373,performance,"5a32ef5f-1b71-48db-aad7-a9f00582fba6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113980_12812_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619460e5fa57811c983f59fc,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113803,1637113203,"alert_manager","","",,"N/A","N/A",,202183380,performance,"7ffe605a-6acb-4b07-8f89-c8959316be61",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113980_12812_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619460e6fa57811c983f59fe,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637113803,1637113203,"alert_manager","","",,"N/A","N/A",,202183383,performance,"a6305b8f-a202-4221-be4f-a5a2141647d4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637113980_12812_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619461f8b4a8174f7a514eee,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115002,1637113501,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"494a0a82-bb12-4473-a04c-1fba73bce8ef","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619461f9b4a8174f7a514ef0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115002,1637113501,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"b3268502-975e-4fcd-a428-a7bb49c70fe7","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",619461fab4a8174f7a514ef2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113501,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"c2aacc3a-8ee1-42a6-948c-ebd8557ba990","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",619461fbb4a8174f7a514ef4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113501,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"dc77fe46-df50-4831-b272-99a91e2e08d3","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,3,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",619461fcb4a8174f7a514ef6,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115002,1637113501,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"57e8d262-795e-4faf-b041-bfd8cd938861","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61946202b4a8174f7a514efd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114403,1637113501,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"00c22fff-ce33-4cce-934c-53eb9564670c","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61946204b4a8174f7a514f00,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113501,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"fbd32a06-eb6f-4bc0-a8ac-a637d0c235b4","UOL - port1","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port1 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61946204b4a8174f7a514f02,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113501,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"3c6810e0-8b64-4acd-9bf8-ae73973bb02a","UOL - port9","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port9 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,6194620ab4a8174f7a514f09,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114104,1637113505,"alert_manager","","",,"N/A","N/A",,202165385,performance,"d8b140ca-c696-4530-8d00-d59e37a1b98e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61946213b4a8174f7a514f13,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114104,1637113505,"alert_manager","","",,"N/A","N/A",,202183366,performance,"b8a5dc0a-3817-4ee0-99df-037b0788fffb",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61946214b4a8174f7a514f15,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114104,1637113505,"alert_manager","","",,"N/A","N/A",,202183367,performance,"dc92cf38-2609-491d-a7b2-f9d4324c13e6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61946215b4a8174f7a514f17,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114104,1637113505,"alert_manager","","",,"N/A","N/A",,202183373,performance,"c6fe5d1b-df9c-47b8-9c39-13e51efaf5f2",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61946216b4a8174f7a514f19,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114104,1637113505,"alert_manager","","",,"N/A","N/A",,202183380,performance,"20fa3af3-1490-4761-8da9-ecc9da39112f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61946217b4a8174f7a514f1b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114104,1637113505,"alert_manager","","",,"N/A","N/A",,202183383,performance,"9ef31761-366f-44e5-8156-1aa799f61a54",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114280_12633_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Hortolândia","GERDAU AÇOS LONGOS S A","155355.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041392,ALTO,SDWAN,619462d7fa57811c983f5a04,"OPEN - GENERAL - V3",1637114714,1637114445,"alert_manager","","",,"{""edgeId"": ""924"", ""linkId"": ""4017"", ""interface"": ""SFP2""}","N/A",,202041392,high,"8b50624a-5873-4128-9eae-cf034606dd52",924,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637114580_12829_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202041392 - Edge 924 entrou em status OFFLINE",86400,high
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",61946325b4a8174f7a514f1f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113802,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"37e5967a-189f-47e1-8793-e5bb13493f2e","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",6194632db4a8174f7a514f28,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113802,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"0395c27f-b32e-4764-b797-7a4d2182362c","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","SAO PAULO","PACAEMBU AUTOPEÇAS LTDA","108899.0000000",SP,"PACAEMBU SPO | 201749058",BSN,201749058,MATRIZ,"DUPLA ABORDAGEM",61946331b4a8174f7a514f2d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113802,"alert_manager","","",,"N/A","N/A",,"pacaembu-spo-hafw-c",performance,"ea6048b0-094d-4026-a94f-24786993a717","UOL - port3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-spo-hafw-c - A Latência da interface UOL - port3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61946337b4a8174f7a514f35,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114403,1637113803,"alert_manager","","",,"N/A","N/A",,202165385,performance,"1bea84eb-32d1-42f3-b801-a630d3df053f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174297.0000000",SP,"MIRO | 202174604",SDE,202174604,SDWAN,SDE,6194633cb4a8174f7a514f3b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113800,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-mro-fw-1",performance,"5b043584-1134-43a7-9451-b3deb12b7340",port2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-mro-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174298.0000000",SP,"NICOLA | 202174605",SDE,202174605,SDWAN,SDE,6194633db4a8174f7a514f3d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113800,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-ncl-fw-1",performance,"5094d6e8-2c8a-4e2c-a11c-44310e449dd2",port16,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-ncl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","São Gonçalo","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179474.0000000",RJ,"PR13-SAO_GONCALO_SGO/IP/13551 | 202182022",SDE,202182022,"ABORDAGEM SIMPLES",FILIAL,6194633db4a8174f7a514f3f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114700,1637113801,"alert_manager","","",,"N/A","N/A",,"PR13-SAO_GONCALO",performance,"80dc9b94-882f-49a8-938d-cc07312c1623",lan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","bandwidth_perc_1m","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR13-SAO_GONCALO - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61946341b4a8174f7a514f44,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114403,1637113803,"alert_manager","","",,"N/A","N/A",,202183366,performance,"ff4ddc41-e4f5-42ed-9336-194257d2c69d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61946342b4a8174f7a514f46,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114403,1637113803,"alert_manager","","",,"N/A","N/A",,202183367,performance,"81825d3b-87d6-4339-8405-9d3be9f1fbcb",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61946343b4a8174f7a514f48,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114403,1637113803,"alert_manager","","",,"N/A","N/A",,202183373,performance,"4ec94b1d-3a7c-4737-9345-4a14268c09e0",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,34,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61946344b4a8174f7a514f4a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114403,1637113803,"alert_manager","","",,"N/A","N/A",,202183380,performance,"485effc2-04a4-4f30-b3ae-d45e74e3ef42",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,35,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61946345b4a8174f7a514f4c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114403,1637113803,"alert_manager","","",,"N/A","N/A",,202183383,performance,"5381f384-4b8f-472a-8e34-92857fecba1e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114580_12643_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,36,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",61946408fa57811c983f5a50,"OPEN - GENERAL - V3",1637115606,1637114715,"alert_manager","","",,"{""edgeId"": ""1584"", ""linkId"": ""4563"", ""interface"": ""GE4""}","N/A",,202062017,high,"715b2505-420e-45f1-a92c-1f7c5ef0ee44",1584,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637114880_12836_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202062017 - Edge 1584 entrou em status DEGRADED",86400,high
"Não","Caxias do Sul","GERDAU AÇOS LONGOS S A","154948.0000000",RS,"N/A","SDWAN - VELOCLOUD",202040656,BAIXO,SDWAN,61946409fa57811c983f5a53,"OPEN - GENERAL - V3",1637115606,1637114714,"alert_manager","","",,"{""edgeId"": ""956"", ""linkId"": ""1871"", ""interface"": ""GE3""}","N/A",,202040656,high,"f0c0cc6a-475b-4ac6-9e6d-9fc606663a24",956,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637114880_12836_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,7,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202040656 - Edge 956 entrou em status OFFLINE",86400,high
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",61946457fa57811c983f5a96,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115302,1637114101,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"29a140ba-abf9-42e5-a3cf-c600f9c594e3","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114880_12838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",61946458fa57811c983f5a98,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115302,1637114101,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"7d5dc37a-ad54-4d20-90f7-4680e2dffa98","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114880_12838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,6194645ffa57811c983f5aa0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114703,1637114104,"alert_manager","","",,"N/A","N/A",,202165385,performance,"646fc8b9-885b-433c-87e4-37d03e93b2f1",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114880_12838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Marituba,"REAL MOTO PECAS LTDA","174029.0000000",PA,"MARITUBA | 202171325",GRC,202171325,DADOS,DADOS,61946460fa57811c983f5aa2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116501,1637114101,"alert_manager","","",,"N/A","N/A",,"greal-mtub-hafw-c",performance,"70a4e86b-6472-41c0-8828-06390351832a",lan3,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114880_12838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","bandwidth_perc_1m","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-mtub-hafw-c - Link acusou mais de 70% de utilização de banda",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61946467fa57811c983f5aab,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114703,1637114104,"alert_manager","","",,"N/A","N/A",,202183366,performance,"5e0a4f59-3d5f-4256-8477-81791d012d55",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114880_12838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61946468fa57811c983f5aad,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114703,1637114104,"alert_manager","","",,"N/A","N/A",,202183367,performance,"69a54faf-1321-49dc-9419-a6e39e0ded79",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114880_12838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61946469fa57811c983f5aaf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114703,1637114104,"alert_manager","","",,"N/A","N/A",,202183373,performance,"ecae5123-4004-4d2a-b605-76891ca2e7cc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114880_12838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194646afa57811c983f5ab1,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114703,1637114104,"alert_manager","","",,"N/A","N/A",,202183380,performance,"e75c1f3c-4afe-4750-a168-d121c0dfa57f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114880_12838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194646bfa57811c983f5ab3,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637114703,1637114104,"alert_manager","","",,"N/A","N/A",,202183383,performance,"cb39dc22-9b4c-40f1-ae11-f8ab94d17146",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637114880_12838_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,6194657a512a4e102e4434b7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115002,1637114403,"alert_manager","","",,"N/A","N/A",,202165385,performance,"0b27063a-0c22-44f2-b4f6-1e0a7b960eaf",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115180_12743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Vitória da Conquista","REAL MOTO PECAS LTDA","174021.0000000",BA,"VITORIADACONQUISTA | 202171319",GRC,202171319,DADOS,DADOS,6194657b512a4e102e4434b9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115902,1637114403,"alert_manager","","",,"N/A","N/A",,"greal-vca-hafw-c",performance,"3c70ed28-ce78-4f5b-8b18-fcac7421b0a3","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115180_12743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,13,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-vca-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","São Bernardo do Campo","TEGMA GESTAO LOGISTICA S A","174298.0000000",SP,"NICOLA | 202174605",SDE,202174605,SDWAN,SDE,61946580512a4e102e4434c0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115302,1637114401,"alert_manager","","",,"N/A","N/A",,"tegma-sbo-ncl-fw-1",performance,"6295d23d-aae6-470b-afd4-ba700d3bb231",wan2,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115180_12743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","bandwidth_perc_1m","N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"tegma-sbo-ncl-fw-1 - Link acusou mais de 70% de utilização de banda",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,61946580512a4e102e4434c2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115005,1637114400,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"a91bdd9d-1e6e-48d4-87a3-3e23683d487a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115180_12743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61946584512a4e102e4434c7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115005,1637114403,"alert_manager","","",,"N/A","N/A",,202183366,performance,"422a50b5-918c-4a80-8d49-63bca876aa36",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115180_12743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61946584512a4e102e4434c9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115005,1637114403,"alert_manager","","",,"N/A","N/A",,202183367,performance,"4c64c6b9-7b6a-4ccc-8cf4-60bd334ca4a6",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115180_12743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61946585512a4e102e4434cb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115005,1637114403,"alert_manager","","",,"N/A","N/A",,202183373,performance,"0a9a8cd3-3988-448d-966a-87d76d266d8c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115180_12743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61946586512a4e102e4434cd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115005,1637114403,"alert_manager","","",,"N/A","N/A",,202183380,performance,"6995c620-cfe8-499b-accd-b477d964744d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115180_12743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61946587512a4e102e4434cf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115005,1637114403,"alert_manager","","",,"N/A","N/A",,202183383,performance,"7c6c2ec9-f5ab-490f-bf1f-8ab1d3cd7b89",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115180_12743_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",619466abfa57811c983f5ac0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115602,1637114700,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"56e7c7b2-2395-4b85-aa1d-0f74d11ec69f","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619466b1fa57811c983f5ac8,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115305,1637114703,"alert_manager","","",,"N/A","N/A",,202165385,performance,"d5731fdb-217e-4d41-b307-43ccb029ea49",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Fortaleza,"REAL MOTO PECAS LTDA","174020.0000000",CE,"FORTALEZA | 202171318",GRC,202171318,DADOS,DADOS,619466b2fa57811c983f5aca,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115902,1637114701,"alert_manager","","",,"N/A","N/A",,"greal-fla-hafw-c",performance,"5d19e788-31d1-4d0c-b542-5e4d7f996f52","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-fla-hafw-c - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Fortaleza,"REAL MOTO PECAS LTDA","174020.0000000",CE,"FORTALEZA | 202171318",GRC,202171318,DADOS,DADOS,619466b3fa57811c983f5acc,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115602,1637114701,"alert_manager","","",,"N/A","N/A",,"greal-fla-hafw-c",performance,"ef25caf6-4de1-4858-8b2d-9aaacf04296f","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"greal-fla-hafw-c - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,619466bdfa57811c983f5ad7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115305,1637114703,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"0eeb4432-6933-4e3f-aab8-f6c37eba669b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619466c1fa57811c983f5adc,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115305,1637114703,"alert_manager","","",,"N/A","N/A",,202183366,performance,"36f8a053-624e-457f-a8a3-158f2210351d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619466c2fa57811c983f5ade,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115305,1637114703,"alert_manager","","",,"N/A","N/A",,202183367,performance,"1e366b84-b022-4ecd-9639-be7bc665caa4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619466c3fa57811c983f5ae0,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115305,1637114703,"alert_manager","","",,"N/A","N/A",,202183373,performance,"88f2f810-4771-426e-b8b4-6fb743f2d730",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619466c4fa57811c983f5ae2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115305,1637114703,"alert_manager","","",,"N/A","N/A",,202183380,performance,"875264cb-caed-4d04-bc09-9eaf44ffd933",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619466c5fa57811c983f5ae4,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115305,1637114703,"alert_manager","","",,"N/A","N/A",,202183383,performance,"59a729ba-5a92-4cb5-b614-1439e7ca5763",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115480_12858_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","","","","","N/A","","","","",61946787512a4e102e443513,"OPEN - GENERAL - V3",1637115970,1637115606,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4164"", ""interface"": ""GE4""}","N/A",,202062007,medium,"386568bf-4f7f-434e-b5c8-0151b2702c56",GE4,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637115780_12759_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,1,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062007 - Link GE4 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",61946787512a4e102e443516,"OPEN - GENERAL - V3",1637115970,1637115606,"alert_manager","","",,"{""edgeId"": ""1578"", ""linkId"": ""4165"", ""interface"": ""GE3""}","N/A",,202062007,medium,"726f293b-be3d-4d1a-9087-bbec4354f6c4",GE3,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637115780_12759_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",linkState,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",2,"202062007 - Link GE3 entrou em status UNSTABLE",86400,medium
"Não","","","","","N/A","","","","",6194678c512a4e102e443522,"OPEN - GENERAL - V3",1637115970,1637115606,"alert_manager","","",,"{""edgeId"": ""1563"", ""linkId"": ""4121"", ""interface"": ""GE4""}","N/A",,202061985,high,"e8e334ac-40e1-430e-ba32-e505e1641c9d",1563,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637115780_12759_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",closed,"","",1,"202061985 - Edge 1563 entrou em status OFFLINE",86400,high
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619467ca512a4e102e44355e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116201,1637115002,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"a2500d55-7bab-43c8-ad1c-7a5cc954cd42","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",619467cb512a4e102e443560,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115901,1637115002,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"a91a4168-31e8-4fae-b121-231a16c12dbb","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CONTAGEM,"PACAEMBU AUTOPEÇAS LTDA","108876.0000000",MG,"PACAEMBU CEM | 201749021",BSN,201749021,FILIAIS,"SEM CONTINGENCIA",619467cb512a4e102e443562,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115901,1637115002,"alert_manager","","",,"N/A","N/A",,"pacaembu-cem-fw-005",performance,"20fab87d-ffb8-4c07-a1cc-d05db24a1eae","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cem-fw-005 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",619467ce512a4e102e443566,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115901,1637115002,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"8a76cb69-6e32-4be6-b260-ced1c63bbda3","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",619467cf512a4e102e443568,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115901,1637115002,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"d60edf3a-7603-4cd7-b493-70112f94fff1","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",619467cf512a4e102e44356a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115901,1637115002,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"e48362c6-c10c-4c65-990a-754ceaa05bf8","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,619467d5512a4e102e443572,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115605,1637115002,"alert_manager","","",,"N/A","N/A",,202165385,performance,"51e1bbfd-4fb9-4da8-937a-fac22770f221",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,619467de512a4e102e44357e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115605,1637115005,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"8dba6b33-7b77-4399-ba5c-462ed18788be",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,619467e1512a4e102e443583,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115605,1637115005,"alert_manager","","",,"N/A","N/A",,202183366,performance,"a930f12a-f68b-4b9a-a66d-edb51c225e87",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,619467e2512a4e102e443585,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115602,1637115005,"alert_manager","","",,"N/A","N/A",,202183367,performance,"0786455b-bfd1-474c-9dae-b759975ffef9",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,619467e2512a4e102e443587,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115605,1637115005,"alert_manager","","",,"N/A","N/A",,202183373,performance,"dc484df3-b32c-48b7-9e75-c40e658811e8",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,619467e3512a4e102e443589,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115605,1637115005,"alert_manager","","",,"N/A","N/A",,202183380,performance,"e881bc03-a102-40d4-b940-8c7098d34933",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,619467e4512a4e102e44358b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115605,1637115005,"alert_manager","","",,"N/A","N/A",,202183383,performance,"ee088027-757b-4713-813d-7db81bc5ff7a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637115780_12764_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Santa Maria","GERDAU AÇOS LONGOS S A","154972.0000000",RS,"N/A","SDWAN - VELOCLOUD",202040670,BAIXO,SDWAN,619468b7fa57811c983f5aec,"OPEN - GENERAL - V3",0,1637115970,"alert_manager","","",,"{""edgeId"": ""1000"", ""linkId"": ""1944"", ""interface"": ""GE3""}","N/A",,202040670,high,"ca0f6891-60cf-402a-81de-cd0f4cc0f467",1000,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637116080_12878_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,6,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202040670 - Edge 1000 entrou em status OFFLINE",86400,high
"Não","São Paulo","SHOPPING MORUMBI","155276.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041336,LOJA,SDWAN,619468b9fa57811c983f5aef,"OPEN - GENERAL - V3",0,1637115970,"alert_manager","","",,"{""edgeId"": ""1361"", ""linkId"": ""3504"", ""interface"": ""SFP2""}","N/A",,202041336,high,"cbb1a5fe-e218-4524-8a91-c86399667dd7",1361,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637116080_12878_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,8,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202041336 - Edge 1361 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",619468bbfa57811c983f5af2,"OPEN - GENERAL - V3",0,1637115970,"alert_manager","","",,"{""edgeId"": ""459"", ""linkId"": ""1635"", ""interface"": ""GE4""}","N/A",,202058027,high,"5e339d10-cec0-4fc4-bb21-03a819721430",459,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637116080_12878_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,10,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202058027 - Edge 459 entrou em status DEGRADED",86400,high
"Não","Rio das Ostras","VALLOUREC TUBULAR SOLUTIONS LTDA","168652.0000000",RJ,"N/A","SDWAN - VELOCLOUD",202058025,SDWAN,SDWAN,619468bdfa57811c983f5af5,"OPEN - GENERAL - V3",0,1637115970,"alert_manager","","",,"{""edgeId"": ""461"", ""linkId"": ""2395"", ""interface"": ""GE1""}","N/A",,202058025,high,"730522bd-efc4-42a0-91cf-c9564e484077",461,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637116080_12878_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,12,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202058025 - Edge 461 entrou em status DEGRADED",86400,high
"Não","Presidente Prudente","GERDAU AÇOS LONGOS S A","155339.0000000",SP,"N/A","SDWAN - VELOCLOUD",202041376,BAIXO,SDWAN,619468c0fa57811c983f5af9,"OPEN - GENERAL - V3",0,1637115970,"alert_manager","","",,"{""edgeId"": ""993"", ""linkId"": ""2043"", ""interface"": ""GE4""}","N/A",,202041376,high,"b2b1b456-9450-4c36-aea5-a15a9fddbb31",993,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637116080_12878_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",status,"N/A",unassigned,critical,15,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202041376 - Edge 993 entrou em status DEGRADED",86400,high
"Não","Ribeirão Preto","PACAEMBU AUTOPEÇAS LTDA","108874.0000000",SP,"PACAEMBU RPO | 201748891",BSN,201748891,FILIAIS,"SEM CONTINGENCIA",619468fffa57811c983f5afd,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116201,1637115302,"alert_manager","","",,"N/A","N/A",,"pacaembu-rpo-fw-003",performance,"d7528133-d9ab-4beb-a2d8-b2cb128562cf","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-rpo-fw-003 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61946902fa57811c983f5b01,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116201,1637115301,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"928360ed-5627-46b4-a4bd-74e245fb9937","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",61946903fa57811c983f5b03,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116201,1637115301,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"27fe58fc-4c15-4e8a-bfcd-834665e4b1f4","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",ITAJAI,"PACAEMBU AUTOPEÇAS LTDA","108885.0000000",SC,"PACAEMBU IAI | 201749030",BSN,201749030,FILIAIS,"SEM CONTINGENCIA",61946904fa57811c983f5b05,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637115302,"alert_manager","","",,"N/A","N/A",,"pacaembu-iai-fw-019",performance,"4cc34ed7-9c8e-4127-ae8e-6ad6c9b028e9","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,6,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-iai-fw-019 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",ITAJAI,"PACAEMBU AUTOPEÇAS LTDA","108885.0000000",SC,"PACAEMBU IAI | 201749030",BSN,201749030,FILIAIS,"SEM CONTINGENCIA",61946905fa57811c983f5b07,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637115302,"alert_manager","","",,"N/A","N/A",,"pacaembu-iai-fw-019",performance,"29e85d17-5c6e-4c5c-8d78-fe5c7c4e111f","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-iai-fw-019 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",61946906fa57811c983f5b09,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116802,1637115302,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"412d55f7-f5c7-4a9b-b5d1-fcd85ec41fdc","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não","CAMPO GRANDE","PACAEMBU AUTOPEÇAS LTDA.","108889.0000000",MS,"PACAEMBU CPE | 201749034",BSN,201749034,FILIAIS,"SEM CONTINGENCIA",61946906fa57811c983f5b0b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117103,1637115302,"alert_manager","","",,"N/A","N/A",,"pacaembu-cpe-fw-017",performance,"79cad0dc-2ba7-4673-a87a-faf6674ceb3b","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,9,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cpe-fw-017 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,6194690dfa57811c983f5b13,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115908,1637115305,"alert_manager","","",,"N/A","N/A",,202165385,performance,"7d595657-ab87-404d-9a1b-81ef38d3f02b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,61946916fa57811c983f5b1d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115908,1637115305,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"44ebadc0-1423-41da-a8e2-f0e58656b604",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194691afa57811c983f5b22,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115908,1637115305,"alert_manager","","",,"N/A","N/A",,202183366,performance,"7c9e29bc-e730-4e04-914a-3aff172d252b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,29,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194691bfa57811c983f5b24,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115908,1637115305,"alert_manager","","",,"N/A","N/A",,202183367,performance,"76205503-cb1d-4f6e-a463-5ea139266259",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,30,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194691cfa57811c983f5b26,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115908,1637115305,"alert_manager","","",,"N/A","N/A",,202183373,performance,"a31285b6-ccd0-4a0c-8f8c-e7710742351c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,31,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,6194691dfa57811c983f5b28,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115908,1637115305,"alert_manager","","",,"N/A","N/A",,202183380,performance,"c19b4e19-6d79-486a-a3d1-0705b36a8c09",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,32,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,6194691efa57811c983f5b2a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637115908,1637115305,"alert_manager","","",,"N/A","N/A",,202183383,performance,"2ec398c7-f253-4c15-b026-6b09f9ca7f64",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116080_12880_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,33,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61946a34b4a8174f7a514f5a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116204,1637115605,"alert_manager","","",,"N/A","N/A",,202165385,performance,"052a4415-53a2-4541-8c9c-b9ca9faa757e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116380_12709_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,12,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,61946a3ab4a8174f7a514f61,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116204,1637115605,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"b7666dc1-0742-45e5-9576-c28a68013bb8",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116380_12709_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61946a3db4a8174f7a514f66,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116204,1637115605,"alert_manager","","",,"N/A","N/A",,202183366,performance,"48b75b7b-ef2d-4382-ac00-4312e2a799a9",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116380_12709_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61946a3eb4a8174f7a514f68,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116204,1637115602,"alert_manager","","",,"N/A","N/A",,202183367,performance,"2a5fd13d-3262-4a95-99a5-509eaecfdd41",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116380_12709_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61946a3fb4a8174f7a514f6a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116204,1637115605,"alert_manager","","",,"N/A","N/A",,202183373,performance,"0a857860-7f4f-477d-8952-8d9bf6ab482b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116380_12709_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61946a40b4a8174f7a514f6c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116204,1637115605,"alert_manager","","",,"N/A","N/A",,202183380,performance,"65330320-2bbb-4dce-80ca-7664ec7faf91",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116380_12709_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61946a41b4a8174f7a514f6e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116204,1637115605,"alert_manager","","",,"N/A","N/A",,202183383,performance,"5ee247f7-2e7d-4fe9-a392-6bb1f8ced609",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116380_12709_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",61946b4e512a4e102e443611,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116802,1637115901,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"01a243d9-577b-47dc-9943-dbd73d396868","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116680_12795_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CARIACICA,"PACAEMBU AUTOPEÇAS LTDA","108887.0000000",ES,"PACAEMBU CCA | 201749032",BSN,201749032,FILIAIS,"SEM CONTINGENCIA",61946b4f512a4e102e443613,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116802,1637115901,"alert_manager","","",,"N/A","N/A",,"pacaembu-cca-fw-016",performance,"390f5026-e5b9-4a8e-9e12-98b4fbc319f4","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116680_12795_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cca-fw-016 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61946b56512a4e102e44361d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116505,1637115908,"alert_manager","","",,"N/A","N/A",,202165385,performance,"6c1dea39-f656-4ea1-ac42-85ed2137df1a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116680_12795_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,14,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,61946b5a512a4e102e443623,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116505,1637115908,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"fb36d116-752d-450b-b843-9cb1d1dce624",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116680_12795_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61946b5d512a4e102e443628,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116505,1637115908,"alert_manager","","",,"N/A","N/A",,202183366,performance,"cfbb0f03-0902-4d4d-b2eb-f47260503435",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116680_12795_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61946b5e512a4e102e44362a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116505,1637115908,"alert_manager","","",,"N/A","N/A",,202183367,performance,"4ff2af97-960a-48d0-88a9-ccd237ccefdf",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116680_12795_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61946b5f512a4e102e44362c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116505,1637115908,"alert_manager","","",,"N/A","N/A",,202183373,performance,"364da9ea-c7e3-40fa-a73f-7878985094be",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116680_12795_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61946b60512a4e102e44362e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116505,1637115908,"alert_manager","","",,"N/A","N/A",,202183380,performance,"3e398d76-15f5-4d12-aac2-2c15e0129cdd",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116680_12795_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61946b61512a4e102e443630,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116505,1637115908,"alert_manager","","",,"N/A","N/A",,202183383,performance,"efc1dad8-edcf-407e-9a7e-a45d130a075f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116680_12795_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61946c83fa57811c983f5b8e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117101,1637116201,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"0abafafe-0d25-4e05-9f5e-fa2bad0609d4","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61946c8afa57811c983f5b96,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117102,1637116201,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"dc13f1d8-f00e-4dc3-8f98-4bd9c9619b42","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,7,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CURITIBA,"PACAEMBU AUTOPEÇAS LTDA","108896.0000000",PR,"PACAEMBU CTA | 201749055",BSN,201749055,FILIAIS,"SEM CONTINGENCIA",61946c8bfa57811c983f5b98,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117102,1637116201,"alert_manager","","",,"N/A","N/A",,"pacaembu-cta-fw-007",performance,"5e731ba8-4c0e-4cda-80bf-05067059fe03","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1",latency,"N/A",unassigned,critical,8,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-cta-fw-007 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61946c8efa57811c983f5b9c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116804,1637116204,"alert_manager","","",,"N/A","N/A",,202165385,performance,"ebe03e45-3fe4-451d-b54d-7882bd41ab1e",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não","Campos dos Goytacazes","FUNDO ESPECIAL DA PROCURADORIA GERAL DO ESTADO DO RIO DE JANEIRO","179471.0000000",RJ,"PR10-CAMPOS_CPS/IP/04984 | 202182019",SDE,202182019,"ABORDAGEM SIMPLES",FILIAL,61946c92fa57811c983f5ba2,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116804,1637116204,"alert_manager","","",,"N/A","N/A",,"PR10-CAMPOS",performance,"f223a9e1-364e-468e-99e3-f5889855c57d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,16,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"PR10-CAMPOS - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61946c96fa57811c983f5ba7,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116804,1637116204,"alert_manager","","",,"N/A","N/A",,202183366,performance,"553f72a0-dbc9-40dd-ae1a-24175b045b55",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61946c97fa57811c983f5ba9,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116804,1637116204,"alert_manager","","",,"N/A","N/A",,202183367,performance,"42362661-48fd-467a-b6c3-0be4f0a72e4d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61946c98fa57811c983f5bab,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116804,1637116204,"alert_manager","","",,"N/A","N/A",,202183373,performance,"68f953dc-1acc-416c-8602-b315114bcb72",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61946c99fa57811c983f5bad,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116804,1637116204,"alert_manager","","",,"N/A","N/A",,202183380,performance,"ae5e2d30-08eb-4020-994d-e8ddce6be081",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61946c9afa57811c983f5baf,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637116804,1637116204,"alert_manager","","",,"N/A","N/A",,202183383,performance,"f23b5abe-3796-4ae1-8fd4-8ac03317b17f",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637116980_12909_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61946da6512a4e102e443645,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117401,1637116502,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"ea9c938d-f439-45e2-a9c5-ffcaee19cad7","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117280_12811_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",FORTALEZA,"PACAEMBU AUTOPEÇAS LTDA","108892.0000000",CE,"PACAEMBU FLA | 201749051",BSN,201749051,FILIAIS,"SEM CONTINGENCIA",61946da6512a4e102e443647,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637116502,"alert_manager","","",,"N/A","N/A",,"pacaembu-fla-fw-023",performance,"f6fec707-e7bf-4288-8c62-698fb325cf31","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117280_12811_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,3,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-fla-fw-023 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não","PRESIDENTE PRUDENTE","PACAEMBU AUTOPEÇAS LTDA","108893.0000000",SP,"PACAEMBU PPE | 201749052",BSN,201749052,FILIAIS,"SEM CONTINGENCIA",61946da7512a4e102e443649,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117700,1637116502,"alert_manager","","",,"N/A","N/A",,"pacaembu-ppe-fw-025",performance,"7ca1e151-c213-4031-b533-59221cfd83b9","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117280_12811_46C72AA9-4E78-4258-9E4F-71FC85DFFA71",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"pacaembu-ppe-fw-025 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61946dad512a4e102e443651,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117104,1637116505,"alert_manager","","",,"N/A","N/A",,202165385,performance,"e5efeac6-51ce-448e-b20b-af40552a1be2",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117280_12811_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,11,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61946db3512a4e102e44365a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117104,1637116505,"alert_manager","","",,"N/A","N/A",,202183366,performance,"814a4db4-7396-4c5b-8e39-9f47c5e4d579",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117280_12811_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61946db4512a4e102e44365c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117104,1637116505,"alert_manager","","",,"N/A","N/A",,202183367,performance,"3b460bd5-4ebf-46e2-bfd4-0a13619097c3",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117280_12811_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61946db4512a4e102e44365e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117104,1637116505,"alert_manager","","",,"N/A","N/A",,202183373,performance,"2a6dd794-a5df-4396-904a-ec74f9b449ec",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117280_12811_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61946db5512a4e102e443660,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117104,1637116505,"alert_manager","","",,"N/A","N/A",,202183380,performance,"1efbc911-75da-4580-b826-a04b9cfeb121",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117280_12811_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61946db6512a4e102e443662,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117104,1637116505,"alert_manager","","",,"N/A","N/A",,202183383,performance,"833c3963-96fd-4297-9e98-b0c5ea8f4ba4",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117280_12811_46C72AA9-4E78-4258-9E4F-71FC85DFFA71","HA-STATUS","N/A",unassigned,critical,23,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61946ee6fa57811c983f5bfb,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117404,1637116804,"alert_manager","","",,"N/A","N/A",,202165385,performance,"f8a3d7c8-e235-4854-a758-c60ea5d73333",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117580_12927_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,10,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,61946eeefa57811c983f5c04,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117404,1637116804,"alert_manager","","",,"N/A","N/A",,202183366,performance,"bd61147d-f10e-40f5-8845-a8667f41a355",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117580_12927_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,18,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,61946eeffa57811c983f5c06,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117404,1637116804,"alert_manager","","",,"N/A","N/A",,202183367,performance,"5f3cfb22-b6bb-4762-a2dc-f379bf2c3412",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117580_12927_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,19,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,61946ef0fa57811c983f5c08,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117404,1637116804,"alert_manager","","",,"N/A","N/A",,202183373,performance,"0cca150a-1e22-4cf4-aadd-5fadad965f46",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117580_12927_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,20,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61946ef1fa57811c983f5c0a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117404,1637116804,"alert_manager","","",,"N/A","N/A",,202183380,performance,"1b8e9b68-6cfb-4305-abf5-4088f4a17c6a",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117580_12927_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,21,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61946ef2fa57811c983f5c0c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117404,1637116804,"alert_manager","","",,"N/A","N/A",,202183383,performance,"d5124617-6da5-45be-917a-8338f0458edc",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117580_12927_79BE0EE5-F8C1-4AE0-B6F2-070C6BAEFFA1","HA-STATUS","N/A",unassigned,critical,22,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
"Não","Campo Grande","PB LOPES & CIA LTDA","170045.0000000",MS,"N/A","SDWAN - VELOCLOUD",202059977,SDWAN,SDWAN,61946fbcb4a8174f7a515005,"OPEN - GENERAL - V3",0,1637117707,"alert_manager","","",,"{""edgeId"": ""1266"", ""linkId"": ""3362"", ""interface"": ""GE3""}","N/A",,202059977,high,"55501d6f-a5e6-4a00-a956-dd86abc18d3d",1266,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637117880_12764_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,2,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202059977 - Edge 1266 entrou em status DEGRADED",86400,high
"Não","","","","","N/A","","","","",61946fbdb4a8174f7a515008,"OPEN - GENERAL - V3",0,1637117707,"alert_manager","","",,"{""edgeId"": ""467"", ""linkId"": ""1628"", ""interface"": ""GE3""}","N/A",,202058101,high,"c8649f7c-2ab9-4f0d-9594-7d72c4b6667e",467,"scheduler_cm9kcmlnby5zaXF1ZWlyYQ_YWxlcnRfbWFuYWdlcg__RMD5705c08a24595ca95_at_1637117880_12764_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",status,"N/A",unassigned,critical,3,"search index=eventosnotaveis_v2 source=""NORMALIZE - VELOCLOUD - V2"" earliest=-25m@m latest=@m

| sort 0 metric edgeId linkId interface - _time
| streamstats count by metric edgeId linkId interface
| where count <=3

| lookup templateAlarme_v2.csv metric OUTPUT occurences threshold operator severity message
| eval anomaly = case(operator=""="" AND value=threshold, ""TRUE"", 
                      operator="">"" AND value>threshold, ""TRUE"", 
                      operator="">="" AND value>=threshold, ""TRUE"", 
                      operator=""<"" AND value<threshold, ""TRUE"", 
                      operator=""<="" AND value<=threshold, ""TRUE"",
                      operator=""!="" AND value!=threshold, ""TRUE"",
                      operator=""<>"" AND value!=threshold, ""TRUE"", 
                      true(), ""FALSE"")
                      
| stats count(eval(anomaly=""TRUE"")) as triggers
        earliest(eval(if(anomaly=""TRUE"", _time, null()))) as alert_time
        latest(eval(if(anomaly=""TRUE"", count, null()))) as last_alert_event
        earliest(eval(if(anomaly=""TRUE"", value, null()))) as value
        values(occurences) as occurences
        latest(description) as solucao
        values(message) as message
        values(threshold) as threshold
        values(severity) as severity
        values(orig_index) as index
        by metric edgeId linkId interface

| where isnotnull(alert_time) AND triggers>=occurences AND last_alert_event <=2 

| eval message=replace(message,""<interface>"", interface), 
       message=replace(message,""<threshold>"", threshold), 
       message=replace(message,""<edge>"", edgeId),
       message=replace(message,""<value>"", value)
| lookup severityMapping.csv id as severity OUTPUT
       
| fields metric alert_time edgeId linkId solucao message impact priority urgency interface update severity index
| stats values(*) as * by metric edgeId linkId interface solucao

| eval update = now(),
       host = solucao,
       extras = ""{""

| foreach edgeId,linkId,interface [
    | eval extras = extras.""\""<<FIELD>>\"": \"""".'<<FIELD>>'.""\"", ""
]
| rex mode=sed field=extras ""s/, $/}/g""
| fields - edgeId,linkId,interface

| rename solucao as Solucao severity as thresholdSeverityCode alert_time as dataAbertura
| lookup Equipamentos Solucao output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description","N/A",new,"","",1,"202058101 - Edge 467 entrou em status DEGRADED",86400,high
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61947008b4a8174f7a515048,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637117101,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"728c3b0d-e3db-4531-9b90-5745ed5a3c18","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,0,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",BRASILIA,"PACAEMBU AUTOPEÇAS LTDA","108880.0000000",DF,"PACAEMBU GURX | 201749026",BSN,201749026,FILIAIS,"SEM CONTINGENCIA",61947009b4a8174f7a51504a,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637117101,"alert_manager","","",,"N/A","N/A",,"pacaembu-gurx-fw-011",performance,"608a049f-1a20-4a8b-8f8b-e54088c9e901","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,1,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-gurx-fw-011 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",LONDRINA,"PACAEMBU AUTOPEÇAS LTDA","108882.0000000",PR,"PACAEMBU LDA | 201749028",BSN,201749028,FILIAIS,"SEM CONTINGENCIA",61947009b4a8174f7a51504c,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637117101,"alert_manager","","",,"N/A","N/A",,"pacaembu-lda-fw-013",performance,"6b3b1873-0886-47bd-8191-dad4bb1a1f31","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,2,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-lda-fw-013 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",LONDRINA,"PACAEMBU AUTOPEÇAS LTDA","108882.0000000",PR,"PACAEMBU LDA | 201749028",BSN,201749028,FILIAIS,"SEM CONTINGENCIA",6194700ab4a8174f7a51504e,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637117101,"alert_manager","","",,"N/A","N/A",,"pacaembu-lda-fw-013",performance,"c3601a0e-44e6-4afb-80b8-4e5e75272dff","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,3,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-lda-fw-013 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",6194700bb4a8174f7a515050,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637117101,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"24916a48-aebf-4162-988a-83db070979a4","UOL - lan3","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,4,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - lan3 excedeu o valor do 100",86400,low
"Não",CAMPINAS,"PACAEMBU AUTOPEÇAS LTDA","108883.0000000",SP,"PACAEMBU CAS | 201749029",BSN,201749029,FILIAIS,"SEM CONTINGENCIA",6194700cb4a8174f7a515052,"JOB - ABERTURA ALERTA NO ALERT MANAGER",0,1637117101,"alert_manager","","",,"N/A","N/A",,"pacaembu-cas-fw-014",performance,"ff0cf3b6-693b-442c-bb66-994ce0f61d32","UOL - wan","scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4",latency,"N/A",unassigned,critical,5,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",new,"","",4,"pacaembu-cas-fw-014 - A Latência da interface UOL - wan excedeu o valor do 100",86400,low
"Não",Indaiatuba,"TEGMA GESTAO LOGISTICA S A","173049.0000000",SP,"",SDE,202165385,SDWAN,SDE,61947015b4a8174f7a51505d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117705,1637117104,"alert_manager","","",,"N/A","N/A",,202165385,performance,"9f78a9ec-2bc7-4ae6-a001-016669ad617b",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,15,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202165385 - Erro de coleta no equipamento",86400,low
"Não",Recife,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179836.0000000",PE,"",SDE,202183366,"DUPLA ABORDAGEM",FILIAL,6194701db4a8174f7a515067,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117705,1637117104,"alert_manager","","",,"N/A","N/A",,202183366,performance,"08dd1317-4ff1-4f20-8e0d-c43bce7026cf",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,24,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183366 - Erro de coleta no equipamento",86400,low
"Não",Teresina,"POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179837.0000000",PI,"",SDE,202183367,"DUPLA ABORDAGEM",FILIAL,6194701eb4a8174f7a515069,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117705,1637117104,"alert_manager","","",,"N/A","N/A",,202183367,performance,"6340b075-e125-4024-b3ab-ea146568fda1",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,25,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183367 - Erro de coleta no equipamento",86400,low
"Não","Porto Alegre","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179843.0000000",RS,"",SDE,202183373,"DUPLA ABORDAGEM",FILIAL,6194701fb4a8174f7a51506b,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117705,1637117104,"alert_manager","","",,"N/A","N/A",,202183373,performance,"f356702e-2f63-48a8-bd08-583c0f93d43c",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,26,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183373 - Erro de coleta no equipamento",86400,low
"Não","Maceió","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179850.0000000",AL,"",SDE,202183380,"DUPLA ABORDAGEM",FILIAL,61947020b4a8174f7a51506d,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117705,1637117104,"alert_manager","","",,"N/A","N/A",,202183380,performance,"0711b669-ebeb-4608-9651-ab596a2cdf1d",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,27,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183380 - Erro de coleta no equipamento",86400,low
"Não","Belém","POSTAL SAUDE - CAIXA DE ASSISTENCIA E SAUDE DOS EMPREGADOS DOS CORREIOS","179853.0000000",PA,"",SDE,202183383,"DUPLA ABORDAGEM",FILIAL,61947021b4a8174f7a51506f,"JOB - ABERTURA ALERTA NO ALERT MANAGER",1637117705,1637117104,"alert_manager","","",,"N/A","N/A",,202183383,performance,"cd0c11b9-e10e-4eed-adc4-68ff21331488",StandAlone,"scheduler_ZmVybmFuZG8uZ2VybWFuZG8_YWxlcnRfbWFuYWdlcg__RMD5e832cec94d0f18be_at_1637117880_12766_1F69BF71-6512-4B3B-A8DC-565C717BAAF4","HA-STATUS","N/A",unassigned,critical,28,"search index=eventosnotaveis earliest=-15m@m latest=@m Origem=""*"" orig_host=*
| rename orig_host as host orig_index as index 
| eval templateName = ""Template FORTINET"" 
| table _time host metric index value templateName
| dedup _time host metric index value templateName

| lookup Equipamentos Solucao as host output Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where isnotnull(Solucao)
| join max=0 type=inner templateName metric 
    [| inputlookup TemplateAlarme 
    | eval metric = thresholdMetric]
    | eval thresholdIndex = if(thresholdIndex = ""*"", index, thresholdIndex)
    | where thresholdIndex = index
    | eval Trigger=case(thresholdType=""="" AND value=thresholdValue, ""TRUE"", thresholdType="">"" AND value>thresholdValue, ""TRUE"", thresholdType="">="" AND value>=thresholdValue, ""TRUE"", thresholdType=""<"" AND value<thresholdValue, ""TRUE"", thresholdType=""<="" AND value<=thresholdValue, ""TRUE"",thresholdType=""!="" AND value!=thresholdValue, ""TRUE"",thresholdType=""<>"" AND value!=thresholdValue, ""TRUE"", 1=1, ""FALSE"") 
| eval duration = tonumber(trim(thresholdDuration)) + 1 
| eval data_duration = relative_time(now(), ""-"" + duration + ""m@m"")
| fillnull value=""""
| dedup metric index host value _time Trigger data_duration duration templateName thresholdDuration thresholdMessage thresholdSeverityCode thresholdType thresholdValue Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| stats count(eval(_time >=data_duration)) as Total 
        count(eval(Trigger=""TRUE"" AND _time >= data_duration )) as TotalAlarmado 
        earliest(eval(if(value != thresholdValue, value, null()))) as value 
        earliest(_time) as _time 
        earliest(thresholdDuration) as duration 
        by host metric index templateName thresholdSeverityCode thresholdType thresholdValue thresholdMessage Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| where (TotalAlarmado = Total AND Total !=0) 
| fillnull value="""" 
| sort 0 - thresholdSeverityCode 
| stats first(_time) as _time first(value) as value first(templateName) as templateName first(thresholdSeverityCode) as thresholdSeverityCode first(thresholdType) as thresholdType first(thresholdValue) as thresholdValue first(thresholdMessage) as thresholdMessage first(duration) as duration by host metric index Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Location PrimeId Description
| eval impact = case(thresholdSeverityCode = 4, ""performance"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval priority = case(thresholdSeverityCode = 4, ""informational"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval urgency = case(thresholdSeverityCode = 4, ""low"" , thresholdSeverityCode = 3, ""high"" , thresholdSeverityCode = 2, ""medium"", thresholdSeverityCode = 1, ""low"", true(), ""N/A"")
| eval severity = impact
| eval message = thresholdMessage
| eval thresholdIndex = index
| `FormatarMensagemAlertManager(message)`
| eval message = message, dataAbertura = _time
| rename Location as Localidade, Description as host
| fields _time dataAbertura host metric index value templateName thresholdSeverityCode thresholdType thresholdValue message metric severity impact urgency duration Estado Cidade ClienteId Cliente TipoNegocio TipoServico Servico Solucao Localidade PrimeId
| where isnotnull(Solucao)
| eval host = if(host == """", Solucao, host)","N/A",closed,"","",4,"202183383 - Erro de coleta no equipamento",86400,low
